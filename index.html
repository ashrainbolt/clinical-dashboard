<!DOCTYPE html>
<html lang="en" class="bg-gray-50 dark:bg-gray-900">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Clinical Dashboard</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide icons CDN -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Marked.js (Markdown parser) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
      font-weight: 600;
      margin-top: 1.25em;
      margin-bottom: 0.5em;
    }
    .prose h1 { font-size: 1.5em; }
    .prose h2 { font-size: 1.25em; }
    .prose h3 { font-size: 1.1em; }
    .prose ul { list-style-type: disc; padding-left: 1.5em; }
    .prose ol { list-style-type: decimal; padding-left: 1.5em; }
    .prose strong { font-weight: 600; }
    .scratchpad-resize {
      resize: vertical;
      min-height: 6rem;
      max-height: 30vh;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

  <!-- Sidebar -->
  <aside class="fixed left-0 top-0 h-full w-56 bg-white dark:bg-gray-800 shadow-lg flex flex-col z-40">
    <div class="flex items-center h-16 px-4 border-b border-gray-200 dark:border-gray-700">
      <span class="font-bold text-lg">Clinical Dashboard</span>
      <button id="theme-toggle" class="ml-auto p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Theme">
        <i data-lucide="moon" class="w-5 h-5"></i>
      </button>
    </div>
    <nav class="flex-1 py-4 px-2 space-y-1 overflow-y-auto">
      <button class="sidebar-link w-full text-left px-4 py-2 rounded hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="dashboard">Dashboard</button>
      <button class="sidebar-link w-full text-left px-4 py-2 rounded hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="favorites">Favorites</button>
      <button class="sidebar-link w-full text-left px-4 py-2 rounded hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="recents">Recently Viewed</button>
      <button class="sidebar-link w-full text-left px-4 py-2 rounded hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="interventions">Interventions</button>
      <button class="sidebar-link w-full text-left px-4 py-2 rounded hover:bg-teal-100 dark:hover:bg-teal-900" data-tab="scratchpad"><span class="inline-flex items-center"><i data-lucide="edit-3" class="w-4 h-4 mr-2"></i>Scratchpad</span></button>
    </nav>
    <div class="p-4 border-t border-gray-200 dark:border-gray-700">
      <input id="search-box" type="text" placeholder="Search..." class="w-full px-3 py-2 rounded border border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none" />
    </div>
  </aside>

  <!-- Main content -->
  <main class="ml-56 min-h-screen p-8 transition-colors duration-300">
    <!-- Used this session -->
    <div id="used-this-session" class="mb-4"></div>
    <!-- Dynamic content area -->
    <div id="content-area"></div>
  </main>

  <!-- Modal -->
  <div id="scenario-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-3xl w-full relative p-6 max-h-[90vh] flex flex-col">
      <button id="close-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
      <h2 id="modal-title" class="text-xl font-bold mb-2"></h2>
      <div id="modal-body" class="text-gray-800 dark:text-gray-200 overflow-y-auto"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden"></div>

  <script>
    // ---- STATE AND DATA ----
    const state = {
      favorites: [],
      checkedScenarios: [],
      recentlyViewed: [],
      contentMap: new Map(),
      currentView: 'dashboard',
      currentOpenScenario: null,
      scratchpadContent: '', // content for scratchpad
      scratchpadMode: 'write', // or 'preview'
    };

    // Color mappings for scenarios
    const colorMap = {
      indigo: { border: "border-l-4 border-indigo-500" },
      green: { border: "border-l-4 border-green-500" },
      yellow: { border: "border-l-4 border-yellow-500" },
      orange: { border: "border-l-4 border-orange-500" },
      red: { border: "border-l-4 border-red-500" },
      blue: { border: "border-l-4 border-blue-500" },
    };

    // ... clinicalData and interventionsData here (unchanged for brevity) ...
    // [CUT FOR BREVITY: use the clinicalData and interventionsData from previous code]

    // ---- DOM REFERENCES ----
    const dom = {
      contentArea: document.getElementById('content-area'),
      searchBox: document.getElementById('search-box'),
      toast: document.getElementById('toast'),
      scenarioModal: document.getElementById('scenario-modal'),
      modalTitle: document.getElementById('modal-title'),
      modalBody: document.getElementById('modal-body'),
      closeModal: document.getElementById('close-modal'),
      usedThisSession: document.getElementById('used-this-session'),
      themeToggle: document.getElementById('theme-toggle'),
    };

    // ---- STATE PERSISTENCE ----
    function saveFavorites() {
      localStorage.setItem('clinicalFavorites', JSON.stringify(state.favorites));
    }
    function saveRecents() {
      localStorage.setItem('clinicalRecents', JSON.stringify(state.recentlyViewed));
    }
    function saveScratchpad() {
      localStorage.setItem('clinicalScratchpad', state.scratchpadContent);
    }
    function loadState() {
      const savedFavorites = localStorage.getItem('clinicalFavorites');
      if (savedFavorites) state.favorites = JSON.parse(savedFavorites);
      const savedRecents = localStorage.getItem('clinicalRecents');
      if (savedRecents) state.recentlyViewed = JSON.parse(savedRecents);
      const savedScratchpad = localStorage.getItem('clinicalScratchpad');
      if (savedScratchpad !== null) state.scratchpadContent = savedScratchpad;
    }

    // ---- INITIALIZATION ----
    function initializeDataMap() {
      clinicalData.forEach(s => state.contentMap.set(s.id, s));
      interventionsData.forEach(s => state.contentMap.set(s.id, s));
    }

    // ---- RENDERING ----
    // ... createScenarioCard, renderCardList, renderDashboard, renderUsedThisSession, openModal, etc. (unchanged) ...
    // [CUT FOR BREVITY: use same functions as previous code]

    // ---- SCRATCHPAD ----
    function renderScratchpad() {
      dom.contentArea.className = '';
      dom.contentArea.innerHTML = `
        <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow p-6">
          <div class="flex items-center mb-3">
            <i data-lucide="edit-3" class="w-5 h-5 text-teal-500 mr-2"></i>
            <h2 class="text-lg font-bold flex-1">Scratchpad</h2>
            <button id="toggle-scratchpad-mode" class="text-xs px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded hover:bg-teal-100 dark:hover:bg-teal-700 mr-2">
              ${state.scratchpadMode === 'write' ? 'Preview' : 'Edit'}
            </button>
            <button id="clear-scratchpad" class="text-xs text-red-500 hover:underline">Clear</button>
          </div>
          <div id="scratchpad-write-area" class="${state.scratchpadMode === 'write' ? '' : 'hidden'}">
            <textarea id="scratchpad-textarea"
              class="w-full p-3 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 rounded scratchpad-resize text-sm font-mono"
              rows="8"
              placeholder="Type notes, scripts, or plans here... (Markdown supported)">${state.scratchpadContent || ''}</textarea>
            <div class="flex mt-3 gap-2">
              <button id="copy-scratchpad" class="flex items-center text-xs px-3 py-1 bg-indigo-100 dark:bg-indigo-900 rounded text-indigo-700 dark:text-indigo-200 hover:bg-indigo-200 dark:hover:bg-indigo-800">
                <i data-lucide="copy" class="w-4 h-4 mr-1"></i>Copy
              </button>
              <button id="download-scratchpad" class="flex items-center text-xs px-3 py-1 bg-green-100 dark:bg-green-900 rounded text-green-700 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800">
                <i data-lucide="download" class="w-4 h-4 mr-1"></i>Download
              </button>
            </div>
          </div>
          <div id="scratchpad-preview-area" class="prose prose-sm dark:prose-invert max-w-none ${state.scratchpadMode === 'preview' ? '' : 'hidden'} p-2 border border-dashed border-gray-300 dark:border-gray-600 rounded min-h-[6rem] bg-gray-50 dark:bg-gray-900">
            ${marked.parse(state.scratchpadContent || '_Nothing here yet. Type in Edit mode!_')}
          </div>
        </div>
      `;
      lucide.createIcons();

      // Events
      document.getElementById('toggle-scratchpad-mode')?.addEventListener('click', () => {
        state.scratchpadMode = (state.scratchpadMode === 'write') ? 'preview' : 'write';
        renderScratchpad();
      });
      document.getElementById('clear-scratchpad')?.addEventListener('click', () => {
        if (confirm('Clear all notes in your scratchpad?')) {
          state.scratchpadContent = '';
          saveScratchpad();
          renderScratchpad();
          showToast('Scratchpad cleared.', true);
        }
      });
      document.getElementById('scratchpad-textarea')?.addEventListener('input', (e) => {
        state.scratchpadContent = e.target.value;
        saveScratchpad();
      });
      document.getElementById('copy-scratchpad')?.addEventListener('click', () => {
        copyToClipboard(state.scratchpadContent);
      });
      document.getElementById('download-scratchpad')?.addEventListener('click', () => {
        downloadScratchpad();
      });
    }

    function downloadScratchpad() {
      const blob = new Blob([state.scratchpadContent], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'scratchpad.md';
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      showToast('Scratchpad downloaded.', true);
    }

    // ---- TABS & VIEWS ----
    function switchView(viewId) {
      state.currentView = viewId;
      document.querySelectorAll('.sidebar-link').forEach(link => {
        const isSelected = link.dataset.tab === viewId;
        link.classList.toggle('bg-indigo-100', isSelected && viewId !== 'scratchpad');
        link.classList.toggle('dark:bg-indigo-800', isSelected && viewId !== 'scratchpad');
        link.classList.toggle('bg-teal-100', isSelected && viewId === 'scratchpad');
        link.classList.toggle('dark:bg-teal-900', isSelected && viewId === 'scratchpad');
        link.classList.toggle('text-indigo-700', isSelected && viewId !== 'scratchpad');
        link.classList.toggle('dark:text-indigo-200', isSelected && viewId !== 'scratchpad');
        link.classList.toggle('text-teal-700', isSelected && viewId === 'scratchpad');
        link.classList.toggle('dark:text-teal-200', isSelected && viewId === 'scratchpad');
        link.classList.toggle('font-semibold', isSelected);
      });

      renderUsedThisSession();

      if (viewId === 'dashboard') {
        renderDashboard();
        return;
      } else if (viewId === 'scratchpad') {
        renderScratchpad();
        return;
      }
      let items = [];
      let message = 'No items found.';
      if (viewId === 'favorites') {
        items = state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
        message = 'No favorites yet. Click the star on a card to add one.';
      } else if (viewId === 'recents') {
        items = state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
        message = 'No recently viewed scenarios.';
      } else if (viewId === 'interventions') {
        items = Array.from(state.contentMap.values()).filter(item => item.category === 'Intervention');
        message = 'No interventions found.';
      }
      renderCardList(dom.contentArea, items, message);
    }

    // ---- SEARCH ----
    dom.searchBox?.addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase().trim();
      if (!q) {
        switchView(state.currentView);
        return;
      }
      if (state.currentView === 'scratchpad') {
        // ignore search in scratchpad
        return;
      }
      const filtered = Array.from(state.contentMap.values()).filter(
        item =>
          item.title.toLowerCase().includes(q) ||
          (item.content && item.content.toLowerCase().includes(q)) ||
          (item.tags && item.tags.some(tag => tag.toLowerCase().includes(q)))
      );
      renderUsedThisSession();
      renderCardList(dom.contentArea, filtered, 'No matches found for your search.');
    });

    // ---- UTILITIES ----
    function showToast(message, isSubtle = false) {
      dom.toast.textContent = message;
      dom.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${isSubtle ? 'bg-gray-600 dark:bg-gray-700' : 'bg-green-500'}`;
      dom.toast.classList.remove('hidden');
      setTimeout(() => { dom.toast.classList.add('opacity-0'); }, 2700);
      setTimeout(() => { 
        dom.toast.classList.add('hidden');
        dom.toast.classList.remove('opacity-0');
      }, 3000);
    }

    function copyToClipboard(text) {
      const cleanedText = text.replace(/###\s/g, '').replace(/\*\*/g, '');
      const textArea = document.createElement('textarea');
      textArea.value = cleanedText;
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) showToast("Copied to clipboard!", false);
        else showToast("Failed to copy.", true);
      } catch (err) {
        showToast("Failed to copy.", true);
      }
      document.body.removeChild(textArea);
    }

    // ---- THEME ----
    function applyTheme(isDark) {
      if (isDark) {
        document.documentElement.classList.add('dark');
        dom.themeToggle.innerHTML = '<i data-lucide="sun" class="w-5 h-5"></i>';
      } else {
        document.documentElement.classList.remove('dark');
        dom.themeToggle.innerHTML = '<i data-lucide="moon" class="w-5 h-5"></i>';
      }
      lucide.createIcons();
    }
    dom.themeToggle?.addEventListener('click', () => {
      const isDarkMode = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
      applyTheme(isDarkMode);
    });

    // ---- MAIN ----
    function main() {
      loadState();
      initializeDataMap();
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', () => switchView(link.dataset.tab));
      });
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(savedTheme === 'dark' || (savedTheme === null && prefersDark));
      switchView(state.currentView || 'dashboard');
      renderUsedThisSession();
      lucide.createIcons();
    }
    document.addEventListener('DOMContentLoaded', main);

    // Restore scratchpad mode on reload if wanted (optional; can add to loadState)
  </script>
</body>
</html>
