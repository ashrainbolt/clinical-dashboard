<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicalX: Interactive Dashboard v4.4 (Full Functionality)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .modal-content, .toast-notification { animation: slide-up 0.3s ease-out; }
        @keyframes slide-up { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .scenario-card { transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s; }
        .scenario-card:hover { transform: translateY(-5px); }
        .modal-body::-webkit-scrollbar, #notes-view::-webkit-scrollbar { width: 8px; }
        
        body { background-color: #f3f4f6; color: #1f2937; }
        .scenario-card, .modal-content, #timer-section, #notes-view, .content-section { background-color: white; border: 1px solid #e5e7eb; }
        .scenario-card:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .tab-button-container { background-color: #e5e7eb; }
        .tab-button.active { background-color: white; color: #4f46e5; }
        .tab-button { color: #4b5563; }
        .sticky-header { background-color: rgba(243, 244, 246, 0.8); backdrop-filter: blur(8px); }
        input, textarea { background-color: #f9fafb; border-color: #d1d5db; color: #111827; }
        input::placeholder, textarea::placeholder { color: #6b7280; }
        .modal-body::-webkit-scrollbar-track, #notes-view::-webkit-scrollbar-track { background: #e5e7eb; }
        .modal-body::-webkit-scrollbar-thumb, #notes-view::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #e5e7eb; }
        .modal-header, .modal-footer { border-color: #e5e7eb; }

        .dark body { background-color: #111827; color: #d1d5db; }
        .dark .scenario-card, .dark .modal-content, .dark #timer-section, .dark #notes-view, .dark .content-section { background-color: #1f2937; border: 1px solid #374151; }
        .dark .scenario-card:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -1px rgba(0,0,0,0.15); }
        .dark .tab-button-container { background-color: #374151; }
        .dark .tab-button.active { background-color: #4f46e5; color: white; }
        .dark .tab-button { color: #d1d5db; }
        .dark .sticky-header { background-color: rgba(17, 24, 39, 0.8); }
        .dark input, .dark textarea { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        .dark input::placeholder, .dark textarea::placeholder { color: #9ca3af; }
        .dark .modal-body::-webkit-scrollbar-track, #notes-view::-webkit-scrollbar-track { background: #2d3748; }
        .dark .modal-body::-webkit-scrollbar-thumb, .dark #notes-view::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px; border: 2px solid #2d3748; }
        .dark .modal-header, .dark .modal-footer { border-color: #374151; }
        
        #modalBody h3, #notes-view h3, .content-section h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .dark #modalBody h3, .dark #notes-view h3, .dark .content-section h3 { color: #9ca3af; }
        #modalBody h4, #notes-view h4, .content-section h4 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .dark #modalBody h4, .dark #notes-view h4, .dark .content-section h4 { color: #8b94a3; }
        #modalBody p, #modalBody li, #notes-view p, .content-section p { margin-bottom: 0.75rem; line-height: 1.6; }
        #modalBody ol, #modalBody ul, .content-section ul { padding-left: 1.5rem; list-style-type: disc; }
        .favorite-star.favorited i { fill: #facc15; color: #facc15; }
        .intervention-link { color: #60a5fa; text-decoration: underline; cursor: pointer; font-weight: 600; }

        .author-control { display: none !important; }
        .author-mode-active .author-control { display: flex !important; }
        #author-mode-toggle.active svg { color: #4f46e5; }

        #notes-widget-content {
            transition: opacity 0.3s, transform 0.3s;
        }
        
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-6 relative">
            <h1 class="text-4xl md:text-5xl font-bold">ClinicalX Dashboard</h1>
            <p class="text-lg md:text-xl text-gray-500 dark:text-gray-400 mt-2">Your Real-Time Guide for Care Coaching</p>
            <div id="user-id-display" class="text-xs text-gray-400 dark:text-gray-600 mt-1 font-mono">Connecting...</div>
            <div class="absolute top-0 right-0 flex items-center space-x-2">
                <button id="author-mode-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Author Mode">
                    <i data-lucide="pencil" class="h-6 w-6"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Theme">
                    <i data-lucide="sun" id="theme-icon-light" class="h-6 w-6 hidden"></i>
                    <i data-lucide="moon" id="theme-icon-dark" class="h-6 w-6"></i>
                </button>
            </div>
        </header>

        <div id="timer-section" class="max-w-md mx-auto p-4 rounded-2xl mb-8">
            <div id="timer-display" class="text-5xl font-mono text-center mb-3">20:00</div>
            <div class="flex flex-wrap justify-center items-center gap-2">
                <button id="start-pause-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-full transition-colors">Start</button>
                <button id="reset-btn" class="bg-gray-500 hover:bg-gray-400 text-white font-bold py-2 px-4 rounded-full transition-colors">Reset</button>
                <div class="w-full border-t border-gray-200 dark:border-gray-700 my-2"></div>
                <button class="timer-preset-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm py-1 px-3 rounded-full" data-time="120">2 min</button>
                <button class="timer-preset-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm py-1 px-3 rounded-full" data-time="300">5 min</button>
                <button class="timer-preset-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm py-1 px-3 rounded-full" data-time="600">10 min</button>
                <button class="timer-preset-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm py-1 px-3 rounded-full" data-time="900">15 min</button>
                <button class="timer-preset-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm py-1 px-3 rounded-full" data-time="1200">20 min</button>
            </div>
        </div>

        <div class="sticky-header sticky top-0 backdrop-blur-sm py-4 z-10">
            <div class="max-w-5xl mx-auto">
                <div class="relative mb-4">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-5 w-5 text-gray-500 dark:text-gray-400"></i>
                    </div>
                    <input type="text" id="searchInput" class="focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 pr-3 py-3 rounded-full" placeholder="Search all content...">
                </div>
                <div class="tab-button-container flex justify-center space-x-1 p-1 rounded-full overflow-x-auto">
                    <button id="tab-zones" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors active">Zones</button>
                    <button id="tab-toolkit" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Toolkit</button>
                    <button id="tab-scripts" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Session Scripts</button>
                    <button id="tab-mi" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">MI</button>
                    <button id="tab-coping" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Coping Skills</button>
                    <button id="tab-favorites" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Favorites</button>
                    <button id="tab-recent" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Recent</button>
                </div>
            </div>
        </div>

        <div id="content-area" class="mt-8">
            <div id="zones-view" class="view-content">
                <div id="zone-selection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                <div id="scenarios-display" class="hidden mt-8">
                    <button id="backButton" class="mb-6 bg-gray-500 hover:bg-gray-400 text-white font-bold py-2 px-4 rounded-full transition-colors flex items-center space-x-2"><i data-lucide="arrow-left" class="h-5 w-5"></i><span>Back to Zones</span></button>
                    <div class="flex justify-between items-center">
                        <h2 id="zoneTitle" class="text-4xl font-bold mb-6"></h2>
                        <button id="add-scenario-to-zone-btn" class="author-control bg-indigo-600 hover:bg-indigo-500 text-white font-bold p-2 rounded-full transition-colors -mt-6" title="Add New Scenario to this Zone">
                            <i data-lucide="plus" class="h-6 w-6"></i>
                        </button>
                    </div>
                    <div id="scenarios-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>
            </div>
            <div id="toolkit-view" class="view-content hidden"></div>
            <div id="scripts-view" class="view-content hidden"></div>
            <div id="mi-view" class="view-content hidden"></div>
            <div id="coping-view" class="view-content hidden"></div>
            <div id="favorites-view" class="view-content hidden"></div>
            <div id="recent-view" class="view-content hidden"></div>
        </div>
    </div>

    <div id="scenarioModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content rounded-2xl shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="modal-header flex justify-between items-center p-5 border-b">
                <h3 id="modalTitle" class="text-2xl font-bold flex-1 pr-4"></h3>
                <div class="flex items-center">
                    <button id="modal-edit-btn" class="author-control text-gray-500 hover:text-indigo-500 transition-colors p-2" title="Edit Scenario">
                        <i data-lucide="file-pen-line" class="h-6 w-6"></i>
                    </button>
                    <button id="modal-favorite-btn" class="favorite-star text-gray-500 hover:text-yellow-400 transition-colors p-2" title="Favorite">
                        <i data-lucide="star" class="h-7 w-7"></i>
                    </button>
                    <button id="closeModal" class="text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white transition-colors p-2 ml-2" title="Close">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
            </div>
            <div id="modalBody" class="modal-body p-6 overflow-y-auto">
                 <!-- Main content injected here -->
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content rounded-2xl shadow-xl w-full max-w-2xl flex flex-col">
            <div class="modal-header flex justify-between items-center p-5 border-b">
                <h3 id="editModalTitle" class="text-2xl font-bold">Create Scenario</h3>
                <button id="closeEditModal" class="text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white transition-colors p-2 ml-2" title="Close">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="editScenarioTitle" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="editScenarioTitle" class="w-full rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter scenario title...">
                </div>
                <div>
                    <label for="editScenarioContent" class="block text-sm font-medium mb-1">Content (Markdown supported)</label>
                    <textarea id="editScenarioContent" rows="10" class="w-full rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter content. Use ### for headers, * for bullet points..."></textarea>
                </div>
            </div>
            <div class="modal-footer p-4 border-t flex justify-end space-x-2">
                <button id="cancelEdit" class="bg-gray-500 hover:bg-gray-400 text-white font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
                <button id="saveEdit" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-full transition-colors">Save</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content rounded-2xl shadow-xl w-full max-w-sm flex flex-col">
            <div class="p-6 text-center">
                <i data-lucide="alert-triangle" class="h-12 w-12 text-red-500 mx-auto mb-4"></i>
                <h3 id="confirmModalTitle" class="text-lg font-bold mb-2">Are you sure?</h3>
                <p id="confirmModalText" class="text-sm text-gray-500 dark:text-gray-400">This action cannot be undone.</p>
            </div>
            <div class="modal-footer p-4 flex justify-center space-x-4">
                <button id="confirmCancel" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 font-bold py-2 px-6 rounded-full transition-colors">Cancel</button>
                <button id="confirmAction" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-full transition-colors">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg"></div>

    <!-- Floating Notes Widget -->
    <div id="notes-widget-container" class="fixed bottom-5 right-5 z-40">
        <button id="notes-widget-toggle" class="bg-indigo-600 text-white rounded-full p-4 shadow-lg hover:bg-indigo-500 transition-colors flex items-center justify-center">
            <i data-lucide="notebook" class="h-6 w-6"></i>
        </button>
        <div id="notes-widget-content" class="hidden absolute bottom-0 right-0 w-80 h-96 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl flex flex-col origin-bottom-right">
            <div class="flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700">
                <h4 class="font-semibold text-gray-800 dark:text-gray-200">Session Scratchpad</h4>
                <button id="notes-widget-close" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
                    <i data-lucide="x" class="h-5 w-5 text-gray-500 dark:text-gray-400"></i>
                </button>
            </div>
            <textarea id="scratchpad-textarea" class="w-full h-full p-3 bg-transparent focus:outline-none resize-none" placeholder="Jot down your session notes here..."></textarea>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- POPULATED & REVISED DATA ---
        const clinicalData = {
            "Red": {
                title: "🔴 Red Zone – Immediate Risk & Crisis",
                color: "red",
                scenarios: [
                    {
                        id: "suicidal-ideation-assessment",
                        title: "Suicidal Ideation – Safety Assessment",
                        content: `
                            <h3>Opening and Assessment Questions</h3>
                            <p>“Before we go any deeper, our priority is always your safety. I’d like to ask a few direct questions to help us understand what’s happening and how to keep you safe. Is that okay?”</p>
                            <p>“Thank you for telling me. I know that’s not easy. Have you wished you were dead or that you could go to sleep and not wake up?”</p>
                            <p>“Have you actually had any thoughts of killing yourself?”</p>
                            <p>“In the past 48 hours, have you been thinking about how you might do this?”</p>
                            <p>“In the past 48 hours, have you had these thoughts and had some intention of acting on them?”</p>
                            <p>“On a scale of 1-5, with 1 meaning you feel you can stay safe and 5 meaning you might make an attempt today, where would you place yourself right now?”</p>
                            <h3>Safety Planning Questions</h3>
                            <p>“Let's think about a safety plan together. What are some early signs you notice when things start to spiral for you?”</p>
                            <p>“What can you try on your own that sometimes helps, even a little? Maybe something creative, watching a funny video, or just wrapping up in a cozy blanket?”</p>
                            <p>“Who is someone you could reach out to if things feel too big to hold alone, even just to sit with you or check in?”</p>
                            <p>“When things get dark, what’s one thing—or one person—that reminds you there’s still a reason to hang on?”</p>
                            <h3>Closure</h3>
                            <p>“Thank you for staying with this. I know it’s not easy, and I really appreciate how honest you’ve been. You’ve done something really important by talking about this instead of holding it in.”</p>
                        `
                    },
                    {
                        id: "self-harm-urges",
                        title: "Self-Harm Urges (Non-Suicidal Self-Injury)",
                        content: `
                            <h3>Checking In</h3>
                            <p>“Thank you for telling me. I need to ask directly: Are you having urges to hurt yourself right now?”</p>
                            <p>“When you have the urge to self-harm, is it because you want to die, or is it more about coping with intense pain or feeling numb?”</p>
                            <h3>Validation</h3>
                            <p>“That urge makes complete sense given everything you’re carrying. It sounds like a part of you is just trying to survive and find relief, even if it’s in a way that ends up hurting you. Let’s see if we can work with that part in a safer way.”</p>
                            <h3>Offering Alternatives</h3>
                            <p>“Sometimes our body needs a very strong sensation to release that tension. We could try something from the <a class="intervention-link" data-id="tipp-skill">TIPP skills</a>, like holding ice or splashing really cold water on your face. Would you be open to trying that?”</p>
                            <p>“Remember, urges are like waves—they build, peak, and eventually become less intense. Let’s try to ride this wave out together. You don’t have to act on it; just notice it rise and watch it start to come down. I'm here with you.”</p>
                        `
                    },
                    {
                        id: "hallucinations-perceptual-experiences",
                        title: "Hallucinations or Disturbing Perceptual Experiences",
                        content: `
                            <h3>Acknowledge and Check for Safety</h3>
                            <p>“Thank you for telling me that. I can imagine this feels really intense and scary. I want you to know I’m here with you, and I believe that you’re experiencing this.”</p>
                            <p>“I need to ask for safety: Are the things you’re hearing or seeing telling you to hurt yourself or anyone else?”</p>
                            <h3>Grounding in the Present</h3>
                            <p>“Let’s try something together to bring you into the here and now with me, okay? Can you put your feet flat on the floor? Press them down a little and just notice that sensation of the ground beneath you. You’re right here, in this moment, with me. We’re safe right now.”</p>
                        `
                    },
                    {
                        id: "acute-medical-crisis",
                        title: "Acute Medical Crisis",
                        content: `
                            <h3>Taking Action</h3>
                            <p>“Okay, I can hear that something serious might be happening physically. The most important thing right now is getting you medical help immediately.”</p>
                            <p>“This is urgent. Are you able to call 911 right now? Is there someone with you who can call for you?”</p>
                            <p>“It sounds like you can’t call on your own, so I am going to get you help. Do I have your permission to call 911 for you right now to get an ambulance? I'll need to tell them where you are.”</p>
                        `
                    },
                    {
                        id: "substance-overdose-intoxication",
                        title: "Substance Overdose or Severe Intoxication",
                        content: `
                            <h3>Assessing the Situation</h3>
                            <p>“I can tell this is serious, and I’m very concerned that you might be experiencing a medical emergency from the substances you took.”</p>
                            <p>“This is urgent. Are you able to call 911 right now for medical attention? Or is there someone with you who can call?”</p>
                            <h3>Staying Connected</h3>
                            <p>“Stay with me, okay? Help is on the way. Try to stay awake and keep talking to me. I know you’re very drowsy, but just focus on my voice. You’re doing great, just hang in there.”</p>
                        `
                    },
                    {
                        id: "unsafe-home-environment-dv",
                        title: "Unsafe Home Environment / Domestic Violence",
                        content: `
                            <h3>Validation and Safety Check</h3>
                            <p>“Thank you for sharing this with me. I can’t imagine how hard it was to say that out loud. I want you to know I believe you, and you didn’t deserve any of this.”</p>
                            <p>“Let's think about safety first. Are you safe right now? Is the person who hurt you nearby or likely to return soon?”</p>
                            <h3>Providing Options</h3>
                            <p>“You know your situation best, and I’m here to support whatever you choose to do. There are people who can help. For example, have you heard of the National Domestic Violence Hotline? They have advocates available 24/7 at 1-800-799-7233 who can help you make a safety plan or find local resources.”</p>
                        `
                    },
                    {
                        id: "child-abuse-neglect-disclosure",
                        title: "Child Abuse or Neglect Disclosure",
                        content: `
                            <h3>Explaining Mandated Reporting</h3>
                            <p>“Thank you for telling me that. It’s incredibly brave of you. Because you shared this, I need to let you know that I’m required by law to report it to make sure the child is safe. This isn’t to get anyone in trouble; it’s to protect them.”</p>
                            <p>“What this means is that I will write down what you told me and contact Child Protective Services. They may need to ask more questions to make sure everyone is safe. I know that might sound scary, but my goal and their goal is protection.”</p>
                            <h3>Supporting You</h3>
                            <p>“How are you feeling now that you’ve shared that? It’s a lot, I know. Whatever you’re feeling – scared, relieved, angry – it’s completely understandable. You are not in any trouble for telling me.”</p>
                        `
                    },
                    {
                        id: "threat-of-harm-to-others",
                        title: "Threat of Harm to Others (Homicidal Ideation)",
                        content: `
                            <h3>Clarifying and Explaining Duty to Protect</h3>
                            <p>“I hear you saying you want to hurt someone. I take that very seriously, and my job is to keep everyone safe. I need to ask you a few questions to understand better.”</p>
                            <p>“Because you’re talking about harming someone else, I have a responsibility to make sure that person stays safe. This may mean I have to involve other professionals or authorities right away. I want us to work together on this if possible.”</p>
                            <h3>De-escalation</h3>
                            <p>“I get that you’re extremely angry. That anger is telling us something important—you feel deeply hurt or wronged. I’m here to listen to that. Let’s slow this down and sit with what’s coming up, instead of letting it boil over.”</p>
                        `
                    },
                    {
                        id: "under-the-influence-non-crisis",
                        title: "Under the Influence (Non-Crisis)",
                        content: `
                            <h3>Checking In and Stating Policy</h3>
                            <p>“Hi. I’m just checking in with you briefly. It was noticed in group that [specific observation, e.g., 'you seemed a bit sleepy']. How are you doing right now?”</p>
                            <p>“Because it appears you’re under the influence, and in line with our group policy for everyone’s safety, I am going to need you to log off from the group session for the rest of today. This isn’t a punishment, but a necessary step for the group environment.”</p>
                            <h3>Safety Assessment Before Log-off</h3>
                            <p>“Before you go, my top priority is to make sure you’re going to be safe. Are you in a safe place physically right now? Is there someone with you, or someone you can contact if you need help?”</p>
                        `
                    }
                ]
            },
            "Orange": {
                title: "🟠 Orange Zone – High Distress",
                color: "orange",
                scenarios: [
                    {
                        id: "highly-agitated-escalating",
                        title: "Highly Agitated or Escalating",
                        content: `
                            <h3>Centering and Slowing Down</h3>
                            <p>“I can see how agitated you are. Let’s take a pause for a second. I’m right here with you. You don’t have to go through this moment alone.”</p>
                            <p>“It’s okay to feel everything you’re feeling. I just want to help you not feel so overwhelmed by it all at once. Can we try to take one slow breath together?”</p>
                            <h3>After Calming Slightly</h3>
                            <p>“That was a lot. You did really well slowing down just now. I know you’re still upset, but you’re also in control right now—you’re talking to me and breathing, and that’s a big win.”</p>
                        `
                    },
                    {
                        id: "acute-anxiety-panic-attack",
                        title: "Acute Anxiety or Panic Attack",
                        content: `
                            <h3>Normalizing and Reassuring</h3>
                            <p>“What you’re experiencing is a panic attack. It feels really scary, I know, but I promise it’s not life-threatening and it will pass. You are going to be okay. I’m right here with you.”</p>
                            <h3>Grounding in the Present</h3>
                            <p>“Let’s ground you in the room right now using your senses. Can you try the <a class="intervention-link" data-id="grounding-54321">5-4-3-2-1 technique</a> with me? Let’s start by naming five things you can see around you.”</p>
                            <h3>Giving Permission to Pause</h3>
                            <p>“We don’t need to unpack the 'why' right now. In fact, we shouldn’t. The only goal is to help you feel safer in your body. We can use skills like <a class="intervention-link" data-id="tipp-skill">TIPP</a> to help calm your system down.”</p>
                        `
                    },
                    {
                        id: "unusual-thoughts-mild-paranoia",
                        title: "Unusual Thoughts (Mild Paranoia or Cognitive Distortions)",
                        content: `
                            <h3>Validating the Distress</h3>
                            <p>“That sounds really troubling. It must feel scary to think that might be true. Thank you for telling me what’s going through your mind.”</p>
                            <h3>Gently Offering a Different Perspective</h3>
                            <p>“Let’s look at that together. You feel like everyone in group hates you, and I know it can really feel that way. May I share what I’ve observed? I’ve seen group members show you care... I’m not seeing evidence of hate, though I know feelings can be super convincing.”</p>
                            <h3>Affirming the Client</h3>
                            <p>“You’re not ‘crazy’ for having these thoughts. Our minds do all kinds of weird things under stress. The fact that you can question it and talk about it with me shows you have a lot of insight and courage.”</p>
                        `
                    },
                    {
                        id: "trauma-reaction-flashback",
                        title: "Trauma Reaction / Flashback",
                        content: `
                            <h3>Grounding in Present Safety</h3>
                            <p>“Hey, you’re here with me. You’re safe right now. It looks like you’re remembering something really scary, but I want you to try to notice the room we’re in. That thing isn’t happening to you right this second, even though it feels like it is.”</p>
                            <h3>Orienting to Time and Place</h3>
                            <p>“Let's use your breath to anchor you. Take a deep breath if you can. You’re breathing in the year 2025. You’re [client’s name], and you’re here with me, not back in that situation. That was then, and this is now. Can you try saying out loud, ‘I’m here now’?”</p>
                        `
                    },
                    {
                        id: "sexual-assault-disclosure",
                        title: "Sexual Assault Disclosure (Trauma Processing in the Moment)",
                        content: `
                            <h3>Listening and Validating</h3>
                            <p>“I’m so sorry that happened to you. Thank you for trusting me enough to tell me. I can’t imagine how terrible that was, and how heavy it must be to carry.”</p>
                            <p>“I want to be very clear: What happened is not your fault. You did not deserve that. The blame is 100% on the person who hurt you.”</p>
                            <h3>Empowering Choices</h3>
                            <p>“I want you to have control over what happens next. If you want help reporting it or getting medical care, I can help with that. If you just wanted to tell someone and not take further action right now, that’s okay too. Whatever you want to do, I’m here to support it.”</p>
                        `
                    },
                    {
                        id: "relational-rupture-conflict",
                        title: "Relational Rupture / Intense Interpersonal Conflict",
                        content: `
                            <h3>Validating the Emotion</h3>
                            <p>“It sounds like you’re really hurt and angry about what happened. That’s completely understandable – when someone we care about does something like that, it can feel awful and infuriating.”</p>
                            <p>“Anyone would be upset in your situation. It shows how much this relationship matters to you; you wouldn’t feel this strongly if you didn’t care.”</p>
                            <h3>Offering Support</h3>
                            <p>“I know how painful conflict with someone you care about can be. We’ll let your therapist know what’s going on so they can help you navigate it, too. You’re not alone in this.”</p>
                        `
                    },
                    {
                        id: "triggered-by-group-content",
                        title: "Triggered by Group Content",
                        content: `
                            <h3>Normalizing the Experience</h3>
                            <p>“It makes a lot of sense that you felt triggered by what came up in group. Sometimes other people’s stories can stir up feelings or memories we didn’t expect. That doesn’t mean anything is wrong with you – it means you’re human and you have experiences that were touched by that topic.”</p>
                            <h3>Affirming Their Coping</h3>
                            <p>“I’m really glad you took a break and talked to me about it. That’s a healthy response to feeling overwhelmed. You honored your limits, and that’s a really good thing to do for yourself.”</p>
                        `
                    },
                    {
                        id: "conflict-in-group-or-with-staff",
                        title: "Conflict in Group or with Staff",
                        content: `
                            <h3>Validating and Holding Space</h3>
                            <p>"It makes sense that you’d feel activated after what happened in group. I want to hold space for that with you."</p>
                            <h3>Planning a Constructive Follow-Up</h3>
                            <p>“If you feel up to it, we can talk about how to address this. Would you want to speak with the person one-on-one with a mediator present, like me or your therapist? Or would you prefer to write down what you feel and share it that way?”</p>
                            <h3>Affirming Self-Advocacy</h3>
                            <p>“I’m really glad you told me how you feel. You have every right to speak up when something isn’t okay for you. We can work on a plan to make sure you feel heard.”</p>
                        `
                    },
                    {
                        id: "anger-and-irritability",
                        title: "Anger and Irritability (beyond mild agitation)",
                        content: `
                            <h3>Acknowledging the Emotion</h3>
                            <p>“It sounds like you’ve been feeling a lot of anger lately – like a constant simmering. That must be exhausting. It’s okay to feel angry. Anger is a normal emotion that often comes when we feel hurt, trapped, or disrespected.”</p>
                            <h3>Inviting Insight</h3>
                            <p>“Do you have a sense of what might be underneath the anger? Often there’s pain or fear hiding under it. If not, that's okay too. We can still work with the feeling itself.”</p>
                            <p>“To help focus your energy, we could explore the <a class="intervention-link" data-id="circles-of-control">Circles of Control</a> to see what parts of this situation you have power over.”</p>
                        `
                    }
                ]
            },
            "Yellow": {
                title: "🟨 Yellow Zone – Moderate Challenges",
                color: "yellow",
                scenarios: [
                    {
                        id: "manipulative-testing-behaviors",
                        title: "“Manipulative” or Testing Behaviors",
                        content: `
                            <h3>Looking for the Unmet Need</h3>
                            <p>“It seems like you really need something right now – maybe reassurance, or to feel in control? I want to understand what you need, because I don’t think you’re doing these things for no reason.”</p>
                            <h3>Reframing the Behavior</h3>
                            <p>“I don’t see you as ‘manipulative.’ I see someone who’s trying very hard to get their needs met, maybe in ways that have worked in the past. How about we skip the part where you have to escalate things to get me to care – because I already care. You have my full attention.”</p>
                            <h3>Encouraging Direct Communication</h3>
                            <p>“I want you to know that if you need something, you can ask me as plainly as possible. We could even practice using a tool like <a class="intervention-link" data-id="dear-man">DEAR MAN</a> to help structure the request.”</p>
                        `
                    },
                    {
                        id: "shut-down-withdrawn-minimizing",
                        title: "Shut Down, Withdrawn, or Minimizing",
                        content: `
                            <h3>Gently Noticing</h3>
                            <p>“I notice you’re getting really quiet, or you keep saying you’re fine. Sometimes when we do that, it’s because the feelings are too big or too hard to put into words. Does that feel true for you right now?”</p>
                            <p>“It’s okay if you don’t feel like talking. We can sit here together in the quiet for a bit if that’s what you need. There's no pressure.”</p>
                            <h3>Exploring Connection</h3>
                            <p>“When you feel up to it, let’s think of one small way to feel a bit more connected. Is there anyone – even an acquaintance – you could send a simple text to later today, just to say hi?”</p>
                        `
                    },
                    {
                        id: "shame-self-hatred-guilt",
                        title: "Shame, Self-Hatred, or Guilt",
                        content: `
                            <h3>Validating and Normalizing</h3>
                            <p>“It sounds like you’re holding yourself to an impossible standard. Whatever you did, or think you did, it doesn’t make you worthless or evil. It makes you human.”</p>
                            <h3>Practicing Self-Compassion</h3>
                            <p>“Think about what you would say to a close friend if they were feeling exactly what you’re feeling. You deserve that same kindness. What if you tried talking to yourself in that gentle way, maybe saying something like, ‘It’s okay to feel this. I’m here for you’?”</p>
                            <p>“We can also try to create some distance from these thoughts using a skill like <a class="intervention-link" data-id="act-defusion">ACT Defusion</a>, like noticing 'I'm having the thought that...' to separate yourself from the thought.”</p>
                        `
                    },
                    {
                        id: "hopelessness-despair",
                        title: "Hopelessness or Despair (without active suicidal intent)",
                        content: `
                            <h3>Borrowing Hope</h3>
                            <p>“It sounds like you are in a really dark place right now. Sometimes when we can't feel hope for ourselves, we have to borrow it from others. Is it okay if I believe that things can change, even if you don’t believe it today? I’ve seen people come out of pits like this, and I’ll hold onto that hope for you.”</p>
                            <h3>Focusing on the Immediate</h3>
                            <p>“When the future looks blank, let’s not even worry about it right now. Let’s just focus on getting through today, or even just the next hour. What is one small, basic thing we can do right now?”</p>
                        `
                    },
                    {
                        id: "obsessive-compulsive-thoughts",
                        title: "Obsessive-Compulsive Thoughts",
                        content: `
                            <h3>Normalizing the Experience</h3>
                            <p>“It sounds like your brain is stuck on a loop. Those kinds of intrusive thoughts can be really exhausting and frightening. You’re not crazy – these thoughts happen to a lot of people, and they don’t reflect your character or true intentions. The fact that they upset you is actually a sign that they go against your values.”</p>
                            <h3>Planning for Therapy</h3>
                            <p>“This is something that can really improve with the right techniques, like Exposure and Response Prevention therapy. It would be great to tell your therapist or psychiatrist about this if you haven’t already, so they can support you.”</p>
                        `
                    },
                    {
                        id: "negative-thought-loops-rumination",
                        title: "Negative Thought Loops / Rumination",
                        content: `
                            <h3>Gently Interrupting the Loop</h3>
                            <p>“I notice your mind keeps circling around this. It’s like you’re stuck in a thought loop, which can be really draining. Let’s try to hit the pause button on those thoughts for just a moment, if we can.”</p>
                            <h3>Using a Skill</h3>
                            <p>“To help get some distance from these thoughts, we can use a technique from <a class="intervention-link" data-id="act-defusion">ACT Defusion</a>. For example, you can label the thought by saying to yourself, 'Ah, there's the 'not good enough' story again.' This helps you see it as just a story, not a fact.”</p>
                        `
                    },
                    {
                        id: "eating-disorder-moderate",
                        title: "Eating Disorder (Moderate)",
                        content: `
                            <h3>Addressing the Topic Gently</h3>
                            <p>“You mentioned some concerns around eating and body image. I know that can be really sensitive to talk about, and I want you to know I’m here to support you, not judge you. A lot of people struggle with this, and you’re not alone.”</p>
                            <h3>Offering Assurance</h3>
                            <p>“I know this is scary, but you’re not alone in it. We care about you, and we want you to be healthy and happy. You deserve to nourish your body and to live without this burden.”</p>
                        `
                    },
                    {
                        id: "neurodivergent-challenges",
                        title: "Neurodivergent Challenges (ADHD/Autism Spectrum)",
                        content: `
                            <h3>Coping with Sensory Overload</h3>
                            <p>“It sounds like your senses are getting overwhelmed right now. Are the lights or sounds bothering you? It's okay to dim the lights, wear headphones, or use a hoodie to feel more comfortable. Please do what you need to regulate.”</p>
                            <h3>Encouraging Self-Acceptance</h3>
                            <p>“I know you sometimes feel like you’re ‘too weird’ or ‘broken’ because of how your brain works. You’re not. Your brain is different, and while that can be hard, it can also be powerful. You see the world in a unique way.”</p>
                        `
                    },
                    {
                        id: "off-topic-distractible",
                        title: "Off-Topic / Distractible (Difficulty Staying Focused)",
                        content: `
                            <h3>Kindly Refocusing</h3>
                            <p>“I notice we jumped to a different topic just now. That’s okay – our brains do that sometimes, especially when we hit something uncomfortable. Let’s gently steer back to what we were talking about earlier, because I think it was important.”</p>
                            <h3>Prioritizing</h3>
                            <p>“I can see you have a lot on your mind. Since we have limited time, let’s prioritize. What’s the most important thing you want to focus on today? We can even write it down to help us remember.”</p>
                        `
                    }
                ]
            },
            "Green": {
                title: "💚 Green Zone – Growth & Skill-Building",
                color: "green",
                scenarios: [
                    {
                        id: "political-global-events-anxiety",
                        title: "Political/Global Events Anxiety",
                        content: `
                            <h3>Validating the Feeling</h3>
                            <p>“It makes complete sense that you’re feeling anxious given what’s happening in the world. These are heavy times, and your feelings are a very understandable response.”</p>
                            <h3>Focusing on What You Can Control</h3>
                            <p>“Let's think about the <a class="intervention-link" data-id="circles-of-control">Circles of Control</a>. We can’t single-handedly solve these big issues, but we can control our own actions. What is one small, concrete action you could take in your own life that might help you feel a little less helpless?”</p>
                        `
                    },
                    {
                        id: "chronic-pain-health-challenges",
                        title: "Chronic Pain or Health Challenges",
                        content: `
                            <h3>Acknowledging the Struggle</h3>
                            <p>“Dealing with chronic pain is really tough. Not only are you physically hurting, but it wears on you emotionally too. It’s completely valid to feel frustrated, exhausted, or down about it.”</p>
                            <h3>Discussing Coping</h3>
                            <p>“What helps, even a little, on the days when the pain is more manageable? Is there anything—a heating pad, a short walk, a good TV show—that gives you even a small bit of relief or comfort?”</p>
                            <p>“Sometimes practicing <a class="intervention-link" data-id="radical-acceptance">Radical Acceptance</a> of the pain, just for this moment, can reduce the suffering that comes from fighting it.”</p>
                        `
                    },
                    {
                        id: "struggling-to-identify-express-needs",
                        title: "Struggling to Identify or Express Needs",
                        content: `
                            <h3>Highlighting the Pattern</h3>
                            <p>“It sounds like you often find yourself feeling unsatisfied because your needs aren’t met, but at the same time, it's hard to even know or say what those needs are. First, I want to reassure you: your needs matter.”</p>
                            <h3>Practicing in the Moment</h3>
                            <p>“Let’s practice right now in a small way: How are you feeling in this moment with me? Do you need anything? A break, a slower pace? This is a safe space to practice.”</p>
                            <p>“We can use the <a class="intervention-link" data-id="nvc-framework">Nonviolent Communication (NVC) Framework</a> to help. It breaks it down into Observations, Feelings, Needs, and Requests.”</p>
                        `
                    },
                    {
                        id: "enmeshed-dependent-relationships",
                        title: "Enmeshed or Dependent Relationships",
                        content: `
                            <h3>Validating the Experience</h3>
                            <p>“It sounds like you feel really tangled up in this relationship, like it's hard to tell where you end and they begin. That can be comforting at times, but also confusing. It's something we can work on.”</p>
                            <h3>Exploring Solutions</h3>
                            <p>“This seems like a great opportunity to explore <a class="intervention-link" data-id="boundary-setting">Boundary Setting</a>. It’s not about pushing them away, but about creating a healthy space for you to be your own person within the relationship.”</p>
                        `
                    },
                    {
                        id: "feeling-directionless-stuck",
                        title: "Feeling Directionless or “Stuck” in Life",
                        content: `
                            <h3>Normalizing the Feeling</h3>
                            <p>“A lot of people go through periods where they feel lost or directionless. It can be really unsettling. It’s okay to not have everything figured out.”</p>
                            <h3>Exploring Values</h3>
                            <p>“Sometimes, our direction becomes clearer when we focus on what we truly value in life. What’s most important to you as a person? Kindness? Creativity? Security?”</p>
                            <p>“We can also use a technique like the 'Miracle Question': If a miracle happened tonight and you woke up with a clear sense of direction, what’s the first small thing you’d notice that was different?”</p>
                        `
                    },
                    {
                        id: "time-management-organization",
                        title: "Time Management and Organization",
                        content: `
                            <h3>Framing the Goal</h3>
                            <p>“It’s great that you want to get more organized and manage your time better. These are skills that can make life so much less stressful, and they are absolutely learnable.”</p>
                            <h3>Introducing Techniques</h3>
                            <p>“Let's try breaking a big task into tiny chunks. Instead of ‘Write essay,’ the first step is just ‘Open a Word doc.’ That’s it. What do you think?”</p>
                            <p>“Have you heard of the Pomodoro Technique? You work for 25 minutes, then take a 5-minute break. Knowing a break is coming can make it easier to focus.”</p>
                        `
                    },
                    {
                        id: "decision-making",
                        title: "Decision-Making",
                        content: `
                            <h3>Framing the Challenge</h3>
                            <p>“Decision-making can be really stressful, especially if you’re afraid of making the wrong choice. It’s great that you want to work on this; being more confident in your decisions can reduce a lot of anxiety.”</p>
                            <h3>Using Tools</h3>
                            <p>“For big decisions, it helps to clarify what factors are most important to you. We can make a simple pros and cons list, or even score the options based on your values.”</p>
                            <p>“It’s also good to listen to both your head and your gut. Your gut feeling is often your subconscious pulling from past experiences. What is your gut telling you about this?”</p>
                        `
                    },
                    {
                        id: "perfectionism",
                        title: "Perfectionism",
                        content: `
                            <h3>Acknowledging the Double-Edged Sword</h3>
                            <p>“It sounds like you have very high standards for yourself. On one hand, that drive can push you to achieve great things. On the other, it can be really exhausting and make you avoid things for fear of not doing them perfectly.”</p>
                            <h3>Challenging the Mindset</h3>
                            <p>“Let's try a new motto: ‘Done is better than perfect.’ Could you try to submit something that's 'good enough' instead of flawless?”</p>
                            <p>“Let's also practice some <a class="intervention-link" data-id="self-compassion">Self-Compassion</a>. You likely speak to yourself very harshly when you make a mistake. What would you say to your best friend in the same situation?”</p>
                        `
                    },
                    {
                        id: "life-transitions",
                        title: "Life Transitions",
                        content: `
                            <h3>Normalizing the Anxiety</h3>
                            <p>“Big changes, even exciting ones, can be really unsettling. It’s totally normal to feel anxious or unsure when you’re stepping into a new phase of life. You’re stepping into the unknown.”</p>
                            <h3>Drawing on Past Strengths</h3>
                            <p>“Remember that even though the situation is new, you’re bringing all your skills and wisdom with you. Think about other transitions you’ve navigated in the past. What helped you then? You’ve done hard things before.”</p>
                        `
                    },
                    {
                        id: "building-healthy-habits-routines",
                        title: "Building Healthy Habits & Routines",
                        content: `
                            <h3>Praising the Goal</h3>
                            <p>“It’s fantastic that you want to build healthy habits. That’s a huge step toward improving your day-to-day life. Routines can give you a sense of stability and make positive actions feel almost automatic.”</p>
                            <h3>Starting Small</h3>
                            <p>“The key is to start with something so small it’s almost impossible to say no. Instead of aiming for a 30-minute workout, what if you started with just 5 minutes of stretching each morning?”</p>
                            <h3>Using Accountability</h3>
                            <p>“It can really help to track your habits. Maybe a simple checklist in a journal or an app where you can see your streak. Would something like that motivate you?”</p>
                        `
                    }
                ]
            }
        };

        const interventionsData = {
            "Distress Tolerance": [
                {
                    id: "tipp-skill",
                    title: "TIPP Skill",
                    content: `
                        <h3>Let's try the TIPP skill</h3>
                        <p>“When you feel completely overwhelmed and your emotions are at a 10, we can use a skill called TIPP to help your body's chemistry change and calm down quickly. Would you be willing to try it with me?”</p>
                        <h4>Temperature</h4>
                        <p>“The 'T' stands for Temperature. The quickest way to do this is to change your body temperature dramatically. If you can, try splashing very cold water on your face, or hold an ice cube in your hand for about 30 seconds. This activates a 'dive response' in your body that will naturally slow your heart rate.”</p>
                        <h4>Intense Exercise</h4>
                        <p>“The 'I' is for Intense Exercise. If you're feeling a lot of restless, angry, or anxious energy, let's burn it off for just 60 seconds. We could do some quick jumping jacks, run in place, or do push-ups against the wall. The goal is to get your heart rate up and then let it come down.”</p>
                        <h4>Paced Breathing</h4>
                        <p>“The first 'P' is for Paced Breathing. We're going to slow your breathing way down, making your exhale much longer than your inhale. Let's try it: Breathe in through your nose for a count of 4... and now breathe out slowly through your mouth for a count of 6. Let's do that a few more times.”</p>
                        <h4>Paired Muscle Relaxation</h4>
                        <p>“The last 'P' is for Paired Muscle Relaxation. As you breathe in, I want you to tense up a group of muscles really tight. Then, as you breathe out, you let them go completely. Let's try with your hands: breathe in and make tight fists, squeezing hard... now breathe out and let your hands go completely limp. Notice how different that feels.”</p>
                    `
                },
                {
                    id: "radical-acceptance",
                    title: "Radical Acceptance",
                    content: `
                        <h3>Let's talk about Radical Acceptance</h3>
                        <p>“Sometimes we turn pain into suffering by fighting against a reality we can't change. Radical acceptance is about acknowledging the facts of the situation, without judging or approving of them. It’s about letting go of the fight.”</p>
                        <p>“Could we try it, just for this moment? Can you say to yourself, 'This is what happened. I cannot change it.' How does it feel to stop fighting that reality, just for a second?”</p>
                    `
                }
            ],
            "Interpersonal Skills": [
                {
                    id: "dear-man",
                    title: "DEAR MAN",
                    content: `
                        <h3>Let's use DEAR MAN to structure your request.</h3>
                        <p>“When you need to ask for something important or say no, it can be helpful to have a clear structure. Let's walk through the DEAR MAN steps for your situation.”</p>
                        <p><strong>Describe:</strong> “First, let's just Describe the facts. What is the specific, objective situation, without any judgment?”</p>
                        <p><strong>Express:</strong> “Next, Express your feelings clearly using 'I-statements'. For example, 'I feel frustrated when this happens.'”</p>
                        <p><strong>Assert:</strong> “Now, Assert what you need or want. Be direct and clear.”</p>
                        <p><strong>Reinforce:</strong> “Then, Reinforce why this is a good idea. Explain the positive outcome if your request is met.”</p>
                        <p><strong>(Stay) Mindful:</strong> “As you talk, stay Mindful of your goal. Don't get sidetracked into old arguments.”</p>
                        <p><strong>Appear Confident:</strong> “Try to Appear Confident, even if you're nervous. Use a steady tone and good eye contact.”</p>
                        <p><strong>Negotiate:</strong> “Finally, be ready to Negotiate. Be willing to listen and find a compromise that still meets your core need.”</p>
                    `
                },
                {
                    id: "nvc-framework",
                    title: "Nonviolent Communication (NVC) Framework",
                    content: `
                        <h3>Let's try the NVC Framework.</h3>
                        <p>“This is a way to communicate that can help you get your needs met and connect with others. It has four steps.”</p>
                        <p><strong>Observations:</strong> “First, what did you Observe? Let's state just the facts, like a camera would see, without any of our judgments or stories.”</p>
                        <p><strong>Feelings:</strong> “When that happened, what specific Feeling came up for you? Try to use an emotion word, like 'sad,' 'angry,' or 'scared.'”</p>
                        <p><strong>Needs:</strong> “That feeling is pointing to an unmet Need. What universal need wasn't being met? Maybe a need for respect, understanding, or connection?”</p>
                        <p><strong>Requests:</strong> “Knowing that, what specific, doable Request could you make? What do you want the other person to do?”</p>
                    `
                },
                {
                    id: "boundary-setting",
                    title: "Boundary Setting",
                    content: `
                        <h3>Let's explore setting a boundary here.</h3>
                        <p>“It sounds like you're feeling [resentful/exhausted], which is often a sign that a boundary might be needed. Setting a boundary isn't about being mean; it's about protecting your well-being.”</p>
                        <p>“First, let's identify what you need. Do you need more time, more space, or for someone to speak to you differently?”</p>
                        <p>“Now, how can we communicate that clearly and kindly? We can use an 'I-statement.' For example, 'I feel overwhelmed, so I need to take some time for myself tonight.'”</p>
                        <p>“It's normal to feel guilty when you first start. Remember, it’s not selfish to protect your energy. It's necessary.”</p>
                    `
                }
            ],
            "Cognitive & ACT": [
                {
                    id: "act-defusion",
                    title: "Defusion (from ACT)",
                    content: `
                        <h3>Let's try to get some distance from that thought.</h3>
                        <p>“When a difficult thought gets sticky and feels like an absolute fact, we can use a skill called defusion to see it as just a thought, not a command. Would you be willing to try one?”</p>
                        <p>“Try adding this little phrase at the beginning of the thought: 'I'm having the thought that...' So, 'I'm a failure' becomes 'I'm having the thought that I'm a failure.' Say that to yourself a few times. What do you notice?”</p>
                        <p>“Another way is to thank your mind. When the thought pops up, you can say, 'Thanks, mind, for that thought.' It sounds silly, but it can take away some of its power.”</p>
                    `
                },
                {
                    id: "thought-challenging",
                    title: "Thought Challenging",
                    content: `
                        <h3>Let's put that thought on trial.</h3>
                        <p>“Right now, that thought feels 100% true. But let's act like a detective and examine the evidence. What facts or experiences make you believe this thought is true?”</p>
                        <p>“Okay, now let's look at the evidence against it. What experiences might suggest this thought isn't the whole truth, or that there's another way to look at it?”</p>
                        <p>“Given all the evidence, what’s a more balanced or realistic way to think about this situation?”</p>
                    `
                },
                {
                    id: "circles-of-control",
                    title: "Circles of Control, Influence, and Concern",
                    content: `
                        <h3>Let's figure out where to focus your energy.</h3>
                        <p>“It sounds like you're dealing with a really tough situation where a lot feels out of your hands. Let's map it out using three circles.”</p>
                        <p>“In the very middle is your Circle of Control. This is what you have direct power over: your own actions, your responses, your attitude. Let's list those things.”</p>
                        <p>“The next circle out is your Circle of Influence. These are things you can have an impact on but don't fully control, like a conversation with someone.”</p>
                        <p>“The outer circle is the Circle of Concern. These are things that worry you but you have no control over, like the past or other people's choices.”</p>
                        <p>“Looking at this map, where are you spending most of your energy? What would it be like to shift more of your focus into your Circle of Control?”</p>
                    `
                }
            ],
            "Grounding & Somatic": [
                {
                    id: "grounding-54321",
                    title: "5-4-3-2-1 Technique",
                    content: `
                        <h3>Let's ground ourselves in the present moment.</h3>
                        <p>“When your mind is spinning or you feel disconnected, this technique can bring you back to the here and now by using your senses. Let's do it together.”</p>
                        <p>“First, look around and name <strong>five</strong> things you can see.”</p>
                        <p>“Next, notice <strong>four</strong> things you can feel. It could be your feet on the floor, the texture of your shirt, or the chair supporting you.”</p>
                        <p>“Now, listen for <strong>three</strong> things you can hear.”</p>
                        <p>“What are <strong>two</strong> things you can smell right now?”</p>
                        <p>“Finally, what is <strong>one</strong> thing you can taste?”</p>
                    `
                },
                {
                    id: "self-compassion",
                    title: "Self-Compassion",
                    content: `
                        <h3>Let's try a moment of self-compassion.</h3>
                        <p>“It sounds like you're being really hard on yourself right now. Let's try treating yourself with the same kindness you'd give to a good friend.”</p>
                        <p>“First, just acknowledge the pain by saying to yourself, 'This is a moment of suffering. This really hurts.'”</p>
                        <p>“Next, remind yourself that you're not alone in this feeling. 'Suffering is a part of life. Other people feel this way too.'”</p>
                        <p>“Finally, offer yourself some kindness. You can put a hand on your heart and say, 'May I be kind to myself in this moment.' What gentle words do you need to hear right now?”</p>
                    `
                }
            ],
            "Session Scripts": [
                {
                    id: "boundary-setting-script",
                    title: "Boundary Setting Scripts",
                    content: `
                        <h3>Foundational Role Setting</h3>
                        <p><strong>Standard:</strong> “Before we get started—my role isn’t for processing, but to make sure you’re safe and help get you grounded so you can rejoin group. We’ve got about 20 minutes, can you tell me what’s going on?”</p>
                        <p><strong>For Distressed Clients:</strong> “I may not be the best person to unpack all of it, but I can offer support, check in on safety, and help you find your footing before heading back to group. What feels most important to say out loud right now?”</p>
                        <h3>Trauma-Dumping Containment</h3>
                        <p><strong>Mid-Session Redirect:</strong> “I really hear that this is painful... but because we only have a few minutes... I want to be careful we don’t go too deep here and leave you feeling more overwhelmed.”</p>
                        <p><strong>Gentle Wall:</strong> “I know it can feel urgent to get it all out, but my role is to support you in feeling safe—not to unpack everything... let's just focus on helping you get grounded enough to move forward.”</p>
                    `
                },
                {
                    id: "end-of-session-script",
                    title: "End-of-Session Scripts",
                    content: `
                        <h3>Survey Hand-off</h3>
                        <p>“Before you go back to group, I do have a brief survey that I’m required to provide. It's very short, just a thumbs up or a thumbs down. Do you see the link in the chat?”</p>
                        <h3>For a Client Still in Distress</h3>
                        <p><strong>Heavy:</strong> “You’re still carrying a lot — I see that. We haven’t solved everything, and we’re not supposed to in these few minutes. I just want to make sure that what you’re feeling now is something you can handle for now. Does it feel safe enough for you to wrap up, even if it’s still heavy?”</p>
                        <p><strong>Distress:</strong> “I don’t want to send you back in this state. Why don’t we take another minute here? We can try another grounding technique or even get additional support if you need it. My priority is that you leave feeling safe enough.”</p>
                    `
                }
            ],
            "MI": [
                {
                    id: "mi-ambivalence",
                    title: "Exploring Ambivalence",
                    content: `
                        <h3>Let's explore both sides of this.</h3>
                        <p>“It sounds like there's a part of you that wants to make a change, and another part that's hesitant or sees good reasons to stay the same. That's completely normal. My role isn't to convince you, but to help you explore your own thoughts.”</p>
                        <p>“On one hand, you mentioned that [current behavior] is helping you by [positive reason]. Could you tell me more about that side of it?”</p>
                        <p>“And on the other hand, you said you're worried about [negative consequence]. How does that fit in with your value of [client's stated value]?”</p>
                    `
                },
                {
                    id: "mi-scaling-questions",
                    title: "Scaling Questions",
                    content: `
                        <h3>Let's use a scale to get a clearer picture.</h3>
                        <p>“On a scale of 0 to 10, where 0 is not at all important and 10 is the most important thing in your life right now, how important is it for you to make this change?”</p>
                        <p>“Okay, so you're at a [number]. That's interesting. Why a [number] and not a [lower number]?”</p>
                        <p>“Now, on another scale from 0 to 10, where 0 is not at all confident and 10 is completely confident, how confident are you that you could make this change if you decided to?”</p>
                        <p>“What would it take to get you from a [confidence number] to a [higher number]?”</p>
                    `
                },
                {
                    id: "mi-miracle-question",
                    title: "The Miracle Question",
                    content: `
                        <h3>Let's try a little thought experiment.</h3>
                        <p>“Imagine that tonight while you're asleep, a miracle happens, and the problem that's been bothering you is completely solved. You don't know that a miracle happened, but when you wake up tomorrow morning, what's the very first small thing you would notice that would tell you things are different?”</p>
                        <p>“What else would you notice? What would someone close to you notice different about you?”</p>
                    `
                }
            ],
            "Coping Skills": [
                {
                    id: "coping-problem-solving",
                    title: "Structured Problem-Solving",
                    content: `
                        <h3>Let's break this problem down.</h3>
                        <p>“When a problem feels too big, it can be overwhelming. Let's try to tackle it with a structured approach.”</p>
                        <p><strong>1. Define the Problem:</strong> “First, let's state the problem as clearly and specifically as possible. What is the one main issue we're trying to solve?”</p>
                        <p><strong>2. Brainstorm Solutions:</strong> “Next, let's brainstorm every possible solution we can think of, no matter how silly or small. No judgment here, just ideas.”</p>
                        <p><strong>3. Evaluate Options:</strong> “Okay, looking at our list, what are the pros and cons of each of these options?”</p>
                        <p><strong>4. Choose One Step:</strong> “Based on that, which option feels like the best first step to try? It doesn't have to be the perfect solution, just a good starting point.”</p>
                        <p><strong>5. Make a Plan:</strong> “What exactly will you do? When will you do it? Let's make it a concrete plan.”</p>
                    `
                },
                {
                    id: "coping-gratitude",
                    title: "Savoring & Gratitude",
                    content: `
                        <h3>Let's shift our focus for a moment.</h3>
                        <p>“Sometimes when we're focused on problems, we miss the small positive moments. Let's try to practice noticing the good.”</p>
                        <p><strong>Savoring:</strong> “Can you think of one small positive thing that happened today or this week, no matter how tiny? Let's just sit with that memory for a moment. What did it feel like in your body? What details do you remember?”</p>
                        <p><strong>Gratitude:</strong> “Another practice is to think of three things that went well today. They don't have to be big. Maybe your coffee was good, or you saw a cute dog. What are three good things from your day?”</p>
                    `
                },
                {
                    id: "coping-window-of-tolerance",
                    title: "Window of Tolerance",
                    content: `
                        <h3>Let's talk about your Window of Tolerance.</h3>
                        <p>“Imagine your nervous system has a 'Window of Tolerance'—an optimal zone where you can think clearly and manage emotions. When stress gets too high, you might get pushed above it into 'hyper-arousal,' feeling anxious or overwhelmed. Or you might drop below it into 'hypo-arousal,' feeling numb or shut down.”</p>
                        <p>“Right now, where do you feel you are? Inside the window, or a little above or below it?”</p>
                        <p>“The goal of our skills is to recognize when you're outside your window and use them to gently guide yourself back inside.”</p>
                    `
                }
            ]
        };
        // --- END OF POPULATED DATA ---

        const dom = {
            body: document.body,
            html: document.documentElement,
            zonesView: document.getElementById('zones-view'),
            toolkitView: document.getElementById('toolkit-view'),
            scriptsView: document.getElementById('scripts-view'),
            miView: document.getElementById('mi-view'),
            copingView: document.getElementById('coping-view'),
            favoritesView: document.getElementById('favorites-view'),
            recentView: document.getElementById('recent-view'),
            tabZones: document.getElementById('tab-zones'),
            tabToolkit: document.getElementById('tab-toolkit'),
            tabScripts: document.getElementById('tab-scripts'),
            tabMi: document.getElementById('tab-mi'),
            tabCoping: document.getElementById('tab-coping'),
            tabFavorites: document.getElementById('tab-favorites'),
            tabRecent: document.getElementById('tab-recent'),
            zoneSelection: document.getElementById('zone-selection'),
            scenariosDisplay: document.getElementById('scenarios-display'),
            backButton: document.getElementById('backButton'),
            zoneTitle: document.getElementById('zoneTitle'),
            scenariosGrid: document.getElementById('scenarios-grid'),
            addScenarioToZoneBtn: document.getElementById('add-scenario-to-zone-btn'),
            searchInput: document.getElementById('searchInput'),
            modal: document.getElementById('scenarioModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalBody: document.getElementById('modalBody'),
            closeModal: document.getElementById('closeModal'),
            modalFavoriteBtn: document.getElementById('modal-favorite-btn'),
            modalEditBtn: document.getElementById('modal-edit-btn'),
            timerDisplay: document.getElementById('timer-display'),
            startPauseBtn: document.getElementById('start-pause-btn'),
            resetBtn: document.getElementById('reset-btn'),
            timerPresetBtns: document.querySelectorAll('.timer-preset-btn'),
            themeToggle: document.getElementById('theme-toggle'),
            themeIconLight: document.getElementById('theme-icon-light'),
            themeIconDark: document.getElementById('theme-icon-dark'),
            toast: document.getElementById('toast'),
            authorModeToggle: document.getElementById('author-mode-toggle'),
            editModal: document.getElementById('editModal'),
            editModalTitle: document.getElementById('editModalTitle'),
            closeEditModal: document.getElementById('closeEditModal'),
            editScenarioTitle: document.getElementById('editScenarioTitle'),
            editScenarioContent: document.getElementById('editScenarioContent'),
            cancelEdit: document.getElementById('cancelEdit'),
            saveEdit: document.getElementById('saveEdit'),
            confirmModal: document.getElementById('confirmModal'),
            confirmModalTitle: document.getElementById('confirmModalTitle'),
            confirmModalText: document.getElementById('confirmModalText'),
            confirmCancel: document.getElementById('confirmCancel'),
            confirmAction: document.getElementById('confirmAction'),
            // New notes widget elements
            notesWidgetContainer: document.getElementById('notes-widget-container'),
            notesWidgetToggle: document.getElementById('notes-widget-toggle'),
            notesWidgetContent: document.getElementById('notes-widget-content'),
            notesWidgetClose: document.getElementById('notes-widget-close'),
            scratchpadTextarea: document.getElementById('scratchpad-textarea'),
        };

        const state = {
            currentView: 'zones',
            currentZone: null,
            favorites: [],
            scratchpadNote: "", // New state for the persistent note
            recentlyViewed: [],
            customContent: {},
            isAuthorMode: false,
            timer: { id: null, timeRemaining: 1200, isPaused: true, initialTime: 1200 },
            currentOpenScenario: null,
            confirmCallback: null,
            saveTimeout: null,
        };

        let userDocRef;

        async function initFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyBr3hTkM_2PlRreFvgK9kk4s4bQvx5y8xw",
                authDomain: "my-dashboard-app-e1d1f.firebaseapp.com",
                projectId: "my-dashboard-app-e1d1f",
                storageBucket: "my-dashboard-app-e1d1f.appspot.com",
                messagingSenderId: "969081281658",
                appId: "1:969081281658:web:d479a7b003805625f02fc3"
            };
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userId = user.uid;
                    userDocRef = doc(db, `users/${userId}`);
                    initApp(db, userDocRef);
                    const userIdDisplay = document.getElementById('user-id-display');
                    if (userIdDisplay) userIdDisplay.textContent = `UserID: ${userId.substring(0, 8)}...`;
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error during anonymous sign-in:", error);
                        document.body.innerHTML = '<div class="text-center p-8 text-red-500">Could not sign in. Please refresh.</div>';
                    }
                }
            });
        }

        function initApp(db, docRef) {
            userDocRef = docRef;
            onSnapshot(docRef, (doc) => {
                const data = doc.data() || {};
                state.favorites = data.favorites || [];
                state.scratchpadNote = data.scratchpadNote || ""; // Load scratchpad note
                state.recentlyViewed = data.recentlyViewed || [];
                state.theme = data.theme || 'dark';
                state.customContent = data.customContent || {};

                dom.scratchpadTextarea.value = state.scratchpadNote; // Populate textarea
                applyTheme();
                renderAll();
            }, (error) => {
                console.error("Error listening to user data:", error);
            });

            updateTimerDisplay();
            setupEventListeners();
            lucide.createIcons();
        }

        function getAllContent() {
            const allContent = {};
            for (const zoneKey in clinicalData) {
                allContent[zoneKey] = [...clinicalData[zoneKey].scenarios.map(s => ({...s, category: zoneKey, color: clinicalData[zoneKey].color, id: s.id}))];
            }
            for (const categoryKey in interventionsData) {
                if (!allContent[categoryKey]) allContent[categoryKey] = [];
                allContent[categoryKey].push(...interventionsData[categoryKey].map(i => ({...i, category: categoryKey, color: 'indigo', id: i.id})));
            }
            for (const customId in state.customContent) {
                const item = state.customContent[customId];
                if (!allContent[item.category]) allContent[item.category] = [];
                allContent[item.category].push({...item, color: 'purple'});
            }
            return allContent;
        }

        function findScenarioById(id) {
            const allContent = getAllContent();
            for (const category in allContent) {
                const found = allContent[category].find(item => item.id === id);
                if (found) return found;
            }
            return null;
        }

        async function saveStateToFirestore() {
            if (!userDocRef) return;
            try {
                await setDoc(userDocRef, {
                    favorites: state.favorites,
                    scratchpadNote: state.scratchpadNote, // Save scratchpad note
                    recentlyViewed: state.recentlyViewed,
                    theme: state.theme,
                    customContent: state.customContent
                }, { merge: true });
            } catch (error) {
                console.error("Error saving state to Firestore: ", error);
                showToast("Error: Could not save changes.");
            }
        }

        function renderAll() {
            renderAllInView(state.currentView);
            lucide.createIcons();
        }

        function createAddButton(category) {
            const btn = document.createElement('button');
            btn.className = 'author-control bg-indigo-600 hover:bg-indigo-500 text-white font-bold p-2 rounded-full transition-colors absolute top-0 right-0 -mt-4 mr-4';
            btn.innerHTML = `<i data-lucide="plus" class="h-6 w-6"></i>`;
            btn.title = "Add New Scenario";
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditModal(null, category);
            });
            return btn;
        }

        function renderZones() {
            dom.zoneSelection.innerHTML = '';
            Object.keys(clinicalData).forEach(zoneKey => {
                const zone = clinicalData[zoneKey];
                const card = document.createElement('div');
                card.className = `zone-card bg-${zone.color}-500/10 dark:bg-${zone.color}-800/20 border border-${zone.color}-200 dark:border-${zone.color}-600 p-6 rounded-2xl cursor-pointer hover:bg-${zone.color}-500/20 dark:hover:bg-${zone.color}-700/30`;
                card.innerHTML = `<h2 class="text-3xl font-bold text-${zone.color}-600 dark:text-${zone.color}-400">${zone.title}</h2><p class="text-gray-500 dark:text-${zone.color}-300 mt-2">${zoneKey} Zone</p>`;
                card.dataset.zone = zoneKey;
                card.addEventListener('click', () => showScenarios(zoneKey));
                dom.zoneSelection.appendChild(card);
            });
        }

        function renderToolkit() {
            dom.toolkitView.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'relative';
            container.appendChild(createAddButton('Toolkit'));

            const allContent = getAllContent();
            const toolkitCategories = Object.keys(interventionsData).filter(cat => !['Session Scripts', 'MI', 'Coping Skills'].includes(cat));

            toolkitCategories.forEach(category => {
                const categoryEl = document.createElement('div');
                categoryEl.className = 'mb-8';
                categoryEl.innerHTML = `<h2 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 border-b border-gray-300 dark:border-gray-700 pb-2 mb-4">${category}</h2>`;
                const gridEl = document.createElement('div');
                gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
                const items = allContent[category] || [];
                items.forEach(item => {
                    gridEl.appendChild(createScenarioCard(item));
                });
                categoryEl.appendChild(gridEl);
                container.appendChild(categoryEl);
            });
            dom.toolkitView.appendChild(container);
        }

        function renderScripts() {
            dom.scriptsView.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'relative';
            container.appendChild(createAddButton('Session Scripts'));

            const allContent = getAllContent();
            const items = allContent['Session Scripts'] || [];
            const gridEl = document.createElement('div');
            gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            items.forEach(item => {
                gridEl.appendChild(createScenarioCard(item));
            });
            container.appendChild(gridEl);
            dom.scriptsView.appendChild(container);
        }

        function renderMi() {
            dom.miView.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'relative';
            container.appendChild(createAddButton('MI'));

            const allContent = getAllContent();
            const items = allContent['MI'] || [];
            const gridEl = document.createElement('div');
            gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            items.forEach(item => {
                gridEl.appendChild(createScenarioCard(item));
            });
            container.appendChild(gridEl);
            dom.miView.appendChild(container);
        }

        function renderCoping() {
            dom.copingView.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'relative';
            container.appendChild(createAddButton('Coping Skills'));

            const allContent = getAllContent();
            const items = allContent['Coping Skills'] || [];
            const gridEl = document.createElement('div');
            gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            items.forEach(item => {
                gridEl.appendChild(createScenarioCard(item));
            });
            container.appendChild(gridEl);
            dom.copingView.appendChild(container);
        }

        function renderFavorites() { renderCardList(dom.favoritesView, state.favorites.map(findScenarioById).filter(Boolean), "You haven't favorited any scenarios yet."); }
        function renderRecent() { renderCardList(dom.recentView, state.recentlyViewed.map(findScenarioById).filter(Boolean), "You haven't viewed any scenarios recently."); }
        
        function renderCardList(container, items, emptyMessage) {
            container.innerHTML = '';
            container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            if (items.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">${emptyMessage}</p>`;
                return;
            }
            items.forEach(item => {
                if (item) container.appendChild(createScenarioCard(item));
            });
        }

        function showScenarios(zoneKey) {
            state.currentZone = zoneKey;
            const allContent = getAllContent();
            const zoneData = clinicalData[zoneKey];
            const items = allContent[zoneKey] || [];

            dom.zoneSelection.classList.add('hidden');
            dom.scenariosDisplay.classList.remove('hidden');
            dom.zoneTitle.textContent = zoneData.title;
            dom.zoneTitle.className = `text-4xl font-bold mb-6 text-${zoneData.color}-600 dark:text-${zoneData.color}-400`;
            dom.scenariosGrid.innerHTML = '';
            items.forEach(item => {
                dom.scenariosGrid.appendChild(createScenarioCard(item));
            });
        }

        function createScenarioCard(scenario) {
            const isFavorited = state.favorites.includes(scenario.id);
            const card = document.createElement('div');
            card.className = `scenario-card p-4 rounded-lg cursor-pointer flex flex-col justify-between relative`;
            let cardColorClass = `border-${scenario.color}-500/30`;
            if (scenario.isCustom) cardColorClass = `border-purple-500/50`;

            card.innerHTML = `
                <div class="absolute top-1 right-1 flex space-x-1">
                    <button class="author-control edit-custom-btn text-gray-400 hover:text-indigo-500 p-1" title="Edit"><i data-lucide="file-pen-line" class="h-4 w-4"></i></button>
                    <button class="author-control delete-custom-btn text-gray-400 hover:text-red-500 p-1" title="Delete"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                </div>
                <h3 class="font-semibold pr-12">${scenario.title}</h3>
                <div class="favorite-star self-end mt-2 text-gray-400 dark:text-gray-600 ${isFavorited ? 'favorited' : ''}">
                    <i data-lucide="star" class="h-5 w-5"></i>
                </div>`;

            card.querySelector('.favorite-star').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(scenario.id);
            });
            card.addEventListener('click', () => openModal(scenario));

            if (scenario.isCustom) {
                card.querySelector('.edit-custom-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(scenario);
                });
                card.querySelector('.delete-custom-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirmModal("Delete Scenario?", `Are you sure you want to delete "${scenario.title}"?`, () => {
                        delete state.customContent[scenario.id];
                        saveStateToFirestore();
                        showToast("Scenario deleted.");
                    });
                });
            } else {
                card.querySelector('.edit-custom-btn').remove();
                card.querySelector('.delete-custom-btn').remove();
            }
            return card;
        }

        function openModal(scenario) {
            state.currentOpenScenario = scenario;
            dom.modalTitle.textContent = scenario.title;
            dom.modalBody.innerHTML = scenario.isCustom ? marked.parse(scenario.content) : scenario.content;
            dom.modal.classList.remove('hidden');
            dom.modalEditBtn.style.display = scenario.isCustom ? 'flex' : 'none';
            updateModalFavoriteButton();
            addToRecentlyViewed(scenario.id);
            lucide.createIcons();
        }

        function hideModal() { dom.modal.classList.add('hidden'); state.currentOpenScenario = null; }

        function toggleFavorite(id) {
            const favIndex = state.favorites.indexOf(id);
            if (favIndex > -1) state.favorites.splice(favIndex, 1);
            else state.favorites.push(id);
            saveStateToFirestore();
        }

        function updateModalFavoriteButton() {
            if (!state.currentOpenScenario) return;
            dom.modalFavoriteBtn.classList.toggle('favorited', state.favorites.includes(state.currentOpenScenario.id));
        }

        function addToRecentlyViewed(id) {
            state.recentlyViewed = [id, ...state.recentlyViewed.filter(t => t !== id)].slice(0, 8);
            saveStateToFirestore();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(state.timer.timeRemaining / 60);
            const seconds = state.timer.timeRemaining % 60;
            dom.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            dom.startPauseBtn.textContent = state.timer.isPaused ? 'Start' : 'Pause';
        }

        function timerTick() {
            if (!state.timer.isPaused && state.timer.timeRemaining > 0) {
                state.timer.timeRemaining--;
                updateTimerDisplay();
            } else if (state.timer.timeRemaining <= 0) {
                clearInterval(state.timer.id);
                state.timer.id = null;
                new Tone.Synth().toDestination().triggerAttackRelease("C4", "8n");
                showToast("Timer finished!");
            }
        }

        function startPauseTimer() {
            if (state.timer.isPaused) {
                if (!state.timer.id) state.timer.id = setInterval(timerTick, 1000);
                state.timer.isPaused = false;
            } else {
                clearInterval(state.timer.id);
                state.timer.id = null;
                state.timer.isPaused = true;
            }
            updateTimerDisplay();
        }

        function resetTimer() {
            clearInterval(state.timer.id);
            state.timer.id = null;
            state.timer.timeRemaining = state.timer.initialTime;
            state.timer.isPaused = true;
            updateTimerDisplay();
        }

        function setTimer(seconds) {
            clearInterval(state.timer.id);
            state.timer.id = null;
            state.timer.timeRemaining = seconds;
            state.timer.initialTime = seconds;
            state.timer.isPaused = true;
            updateTimerDisplay();
        }

        function filterContent(query) {
            const normalizedQuery = query.toLowerCase().trim();
            const allContent = getAllContent();
            let searchResults = [];

            for (const category in allContent) {
                searchResults.push(...allContent[category].filter(item => 
                    item.title.toLowerCase().includes(normalizedQuery) || 
                    item.content.toLowerCase().includes(normalizedQuery)
                ));
            }
            const currentViewEl = document.querySelector('.view-content:not(.hidden)');
            renderCardList(currentViewEl, searchResults, `No results found for "${query}".`);
            lucide.createIcons();
        }

        function showToast(message) {
            dom.toast.textContent = message;
            dom.toast.classList.remove('hidden');
            setTimeout(() => dom.toast.classList.add('hidden'), 3000);
        }

        function switchView(viewName) {
            state.currentView = viewName;
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            document.getElementById(`tab-${viewName}`).classList.add('active');
            dom.searchInput.value = '';
            renderAllInView(viewName);
        }

        function renderAllInView(viewName) {
            switch(viewName) {
                case 'zones': renderZones(); dom.scenariosDisplay.classList.add('hidden'); dom.zoneSelection.classList.remove('hidden'); break;
                case 'toolkit': renderToolkit(); break;
                case 'scripts': renderScripts(); break;
                case 'mi': renderMi(); break;
                case 'coping': renderCoping(); break;
                case 'favorites': renderFavorites(); break;
                case 'recent': renderRecent(); break;
            }
            lucide.createIcons();
        }

        function applyTheme() {
            if (state.theme === 'dark') {
                dom.body.classList.add('dark');
                dom.themeIconLight.classList.add('hidden');
                dom.themeIconDark.classList.remove('hidden');
            } else {
                dom.body.classList.remove('dark');
                dom.themeIconLight.classList.remove('hidden');
                dom.themeIconDark.classList.add('hidden');
            }
        }

        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            applyTheme();
            saveStateToFirestore();
        }

        function toggleAuthorMode() {
            state.isAuthorMode = !state.isAuthorMode;
            dom.body.classList.toggle('author-mode-active', state.isAuthorMode);
            dom.authorModeToggle.classList.toggle('active', state.isAuthorMode);
            showToast(`Author Mode ${state.isAuthorMode ? 'Enabled' : 'Disabled'}`);
            renderAll();
        }

        function openEditModal(scenario = null, category = null) {
            dom.editModalTitle.textContent = scenario ? 'Edit Scenario' : 'Create Scenario';
            dom.editScenarioTitle.value = scenario ? scenario.title : '';
            dom.editScenarioContent.value = scenario ? scenario.content : '';
            dom.editModal.dataset.editingId = scenario ? scenario.id : '';
            dom.editModal.dataset.category = category || (scenario ? scenario.category : 'Toolkit');
            dom.editModal.classList.remove('hidden');
        }

        function closeEditModal() { dom.editModal.classList.add('hidden'); }

        function saveCustomScenario() {
            const title = dom.editScenarioTitle.value.trim();
            const content = dom.editScenarioContent.value.trim();
            const category = dom.editModal.dataset.category;
            const editingId = dom.editModal.dataset.editingId;

            if (!title || !content) {
                showToast("Title and content cannot be empty.");
                return;
            }

            const id = editingId || `custom_${Date.now()}`;
            state.customContent[id] = { id, title, content, category, isCustom: true };
            saveStateToFirestore();
            closeEditModal();
            showToast(`Scenario ${editingId ? 'updated' : 'created'}!`);
        }

        function showConfirmModal(title, text, onConfirm) {
            dom.confirmModalTitle.textContent = title;
            dom.confirmModalText.textContent = text;
            state.confirmCallback = onConfirm;
            dom.confirmModal.classList.remove('hidden');
            lucide.createIcons();
        }

        function hideConfirmModal() {
            dom.confirmModal.classList.add('hidden');
            state.confirmCallback = null;
        }

        // --- New Notes Widget Logic ---
        function toggleNotesWidget(forceOpen = false) {
            const isHidden = dom.notesWidgetContent.classList.contains('hidden');
            if (forceOpen) {
                if (isHidden) {
                    dom.notesWidgetContent.classList.remove('hidden');
                    dom.notesWidgetToggle.classList.add('hidden');
                    // Animate in
                    setTimeout(() => {
                        dom.notesWidgetContent.classList.remove('opacity-0', 'scale-95');
                    }, 10);
                }
            } else {
                if (isHidden) {
                    dom.notesWidgetContent.classList.remove('hidden');
                    dom.notesWidgetToggle.classList.add('hidden');
                    setTimeout(() => {
                        dom.notesWidgetContent.classList.remove('opacity-0', 'scale-95');
                    }, 10);
                } else {
                    dom.notesWidgetContent.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        dom.notesWidgetContent.classList.add('hidden');
                        dom.notesWidgetToggle.classList.remove('hidden');
                    }, 300);
                }
            }
        }

        function saveScratchpadNote() {
            state.scratchpadNote = dom.scratchpadTextarea.value;
            // Debounce saving to Firestore
            clearTimeout(state.saveTimeout);
            state.saveTimeout = setTimeout(() => {
                saveStateToFirestore();
                showToast("Note saved!", true);
            }, 1000);
        }
        
        function setupEventListeners() {
            dom.tabZones.addEventListener('click', () => switchView('zones'));
            dom.tabToolkit.addEventListener('click', () => switchView('toolkit'));
            dom.tabScripts.addEventListener('click', () => switchView('scripts'));
            dom.tabMi.addEventListener('click', () => switchView('mi'));
            dom.tabCoping.addEventListener('click', () => switchView('coping'));
            dom.tabFavorites.addEventListener('click', () => switchView('favorites'));
            dom.tabRecent.addEventListener('click', () => switchView('recent'));
            dom.backButton.addEventListener('click', () => { dom.scenariosDisplay.classList.add('hidden'); dom.zoneSelection.classList.remove('hidden'); });
            dom.closeModal.addEventListener('click', hideModal);
            dom.modal.addEventListener('click', (e) => { if (e.target === dom.modal) hideModal(); });
            dom.closeEditModal.addEventListener('click', closeEditModal);
            dom.cancelEdit.addEventListener('click', closeEditModal);
            dom.saveEdit.addEventListener('click', saveCustomScenario);
            dom.confirmCancel.addEventListener('click', hideConfirmModal);
            dom.confirmAction.addEventListener('click', () => {
                if (state.confirmCallback) state.confirmCallback();
                hideConfirmModal();
            });
            document.addEventListener('keydown', (e) => { 
                if (e.key === 'Escape') {
                    if (!dom.modal.classList.contains('hidden')) hideModal();
                    if (!dom.editModal.classList.contains('hidden')) closeEditModal();
                    if (!dom.confirmModal.classList.contains('hidden')) hideConfirmModal();
                    if (!dom.notesWidgetContent.classList.contains('hidden')) toggleNotesWidget();
                }
            });
            dom.modalFavoriteBtn.addEventListener('click', () => toggleFavorite(state.currentOpenScenario.id));
            dom.modalEditBtn.addEventListener('click', () => openEditModal(state.currentOpenScenario));
            dom.addScenarioToZoneBtn.addEventListener('click', () => openEditModal(null, state.currentZone));
            dom.startPauseBtn.addEventListener('click', startPauseTimer);
            dom.resetBtn.addEventListener('click', resetTimer);
            dom.timerPresetBtns.forEach(btn => btn.addEventListener('click', () => setTimer(parseInt(btn.dataset.time))));
            dom.searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                if (!query) renderAllInView(state.currentView);
                else filterContent(query);
            });
            dom.themeToggle.addEventListener('click', toggleTheme);
            dom.authorModeToggle.addEventListener('click', toggleAuthorMode);
            document.body.addEventListener('click', (e) => {
                const link = e.target.closest('.intervention-link');
                if (link) {
                    e.preventDefault();
                    const scenario = findScenarioById(link.dataset.id);
                    if (scenario) openModal(scenario);
                }
            });

            // New Notes Widget Listeners
            dom.notesWidgetToggle.addEventListener('click', () => toggleNotesWidget());
            dom.notesWidgetClose.addEventListener('click', () => toggleNotesWidget());
            dom.scratchpadTextarea.addEventListener('input', saveScratchpadNote);
        }

        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
