<!DOCTYPE html>
<html lang="en" class="bg-gray-50 dark:bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Marked.js (Markdown parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom styles for prose, layout, and new features */
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
            font-weight: 600;
            margin-top: 1.25em;
            margin-bottom: 0.5em;
        }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.25em; }
        .prose h3 { font-size: 1.1em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; }
        .prose strong { font-weight: 600; }
        .prose blockquote {
            border-left: 0.25rem solid #4f46e5;
            padding-left: 1em;
            font-style: italic;
            color: #4b5563;
        }
        .dark .prose blockquote {
            border-left-color: #818cf8;
            color: #d1d5db;
        }
        .prose .insight-link {
            color: #4f46e5;
            font-weight: 600;
            text-decoration: underline;
            cursor: pointer;
        }
        .dark .prose .insight-link {
            color: #a5b4fc;
        }

        .scratchpad-resize {
            resize: vertical;
            min-height: 10rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        /* Ensure sidebar content can scroll if it overflows */
        .sidebar-nav {
            flex: 1 1 auto;
            overflow-y: auto;
        }
        /* Hide scrollbar for modal body but keep it scrollable */
        #modal-body::-webkit-scrollbar {
            display: none;
        }
        #modal-body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans">

    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-full w-60 bg-white dark:bg-gray-800 shadow-lg flex flex-col z-40">
        <div class="flex items-center h-16 px-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
            <i data-lucide="activity" class="w-6 h-6 mr-2 text-indigo-500"></i>
            <span class="font-bold text-lg">Clinical OS</span>
            <button id="theme-toggle" class="ml-auto p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Theme">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
        <nav class="sidebar-nav py-4 px-2 space-y-1">
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="dashboard"><i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i>Dashboard</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="interventions"><i data-lucide="zap" class="w-4 h-4 mr-3"></i>Interventions</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="scripts"><i data-lucide="file-text" class="w-4 h-4 mr-3"></i>Scripts</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="favorites"><i data-lucide="star" class="w-4 h-4 mr-3"></i>Favorites</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="recents"><i data-lucide="history" class="w-4 h-4 mr-3"></i>Recently Viewed</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-teal-100 dark:hover:bg-teal-900" data-tab="scratchpad"><i data-lucide="edit-3" class="w-4 h-4 mr-3"></i>Scratchpad</button>
        </nav>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
            <input id="search-box" type="text" placeholder="Search scenarios..." class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
    </aside>

    <!-- Main content -->
    <main class="ml-60 min-h-screen p-6 md:p-8 transition-colors duration-300">
        <!-- Used this session -->
        <div id="used-this-session" class="mb-4"></div>
        <!-- Dynamic content area -->
        <div id="content-area"></div>
    </main>

    <!-- Content Modal -->
    <div id="scenario-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full relative p-6 max-h-[90vh] flex flex-col">
            <div id="modal-context" class="flex flex-wrap gap-2 mb-3"></div>
            <div class="flex items-start mb-4">
                <h2 id="modal-title" class="text-2xl font-bold flex-1"></h2>
                <button id="close-modal" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="modal-body" class="prose dark:prose-invert max-w-none overflow-y-auto pr-4 -mr-4 flex-1"></div>
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex items-center gap-2">
                 <button id="copy-modal-content-to-scratchpad" class="flex items-center text-xs px-3 py-1 bg-teal-100 dark:bg-teal-900 rounded-md text-teal-700 dark:text-teal-200 hover:bg-teal-200 dark:hover:bg-teal-800"><i data-lucide="plus-square" class="w-4 h-4 mr-1"></i>Copy to Scratchpad</button>
                 <div class="ml-auto flex gap-2">
                    <button id="modal-prev" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <button id="modal-next" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
                 </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 id="confirmation-title" class="text-lg font-semibold mb-4">Are you sure?</h3>
            <div id="confirmation-message" class="text-sm text-gray-600 dark:text-gray-300 mb-6"></div>
            <div class="flex justify-end gap-3">
                <button id="confirmation-cancel" class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                <button id="confirmation-confirm" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="hidden"></div>

    <script>
    // ---- DATA ----
    // This section contains all the clinical scenarios and interventions
    // converted from the user's document into a structured format with added emojis.

    const clinicalData = [
        // --- RED ZONE ---
        {
            id: 'red-suicidal-ideation',
            title: 'Suicidal Ideation â€“ Safety Assessment',
            category: 'Red Zone',
            emoji: 'ðŸš©',
            color: 'red',
            tags: ['suicide', 'safety', 'crisis', 'cssrs', 'assessment', 'red'],
            content: `### ASSESS\n"Before we go any deeper, **our priority is always your safety**. Iâ€™d like to ask a few questions that help us understand how youâ€™re doing and what kind of support might help keep you safe right now.\n\n1.  **Have you wished you were dead or that you could go to sleep and not wake up?**\n2.  **Have you actually had any thoughts of killing yourself?** (If yes, ask 3, 4, 5, 6. If no, go to 6).\n3.  **In the past 48 hours, have you been thinking about how you might do this?**\n4.  **In the past 48 hours, have you had these thoughts and had some intention of acting on them?**\n5.  **In the past 48 hours, have you started to work out any details for how to kill yourself? Do you intend to carry out this plan?**\n6.  **In the past 48 hours have you done anything to prepare to end your life?**\n\n*If Yes to 4, 5, or 6, ask scaling questions:*\n\n> \"On a scale of 1-5, one meaning you feel you can stay safe today, and five meaning that you're going to make an attempt today, where would you place yourself right now?\"\n\n*Reflect back answer:*\n* \"So a **four** means to me you have a plan and some intentions on acting on the plan, you just don't know when. Is that accurate?\"\n* \"A **three** means to me you have strong thoughts of wanting to die and have thought about ways you might act on it, but you don't have a specific plan. Did I get that right?\"\n* \"A **two** means to me that you have fleeting thoughts of wanting to end your life, but no plan or intention of acting on it.\"\n\nâ€œIâ€™m really glad you told me this. It takes a lot of strength to be this honest, and Iâ€™m here to help you figure it out.â€\n\n### SAFETY PLAN\n**Need to escalate:** \"Thank you for telling me that. If it sounds like things are starting to feel more intense or harder to manage on your own, Iâ€™d like to connect you with a Crisis Manager â€” who can better support you and help figure out the next steps to keep you safe.\"\n\n* **Warning Signs:** â€œWhat are some early signs you notice when things start to spiral?â€\n* **Internal Coping:** â€œWhat can you try on your own that sometimes helps, even a little?â€\n* **Social Distractions:** â€œWho or what helps you shift your focus â€” even briefly?â€\n* **People to Reach Out To:** â€œIf things feel too big to hold alone, who could you reach out to?â€\n* **Professional Resources:** â€œDo you have Charlie Healthâ€™s 24/7 crisis line saved in your phone?â€\n* **Safety at Home:** â€œIs there anything nearby that might feel unsafe to have around right now?â€\n* **Reasons to Stay:** â€œWhen things get dark, whatâ€™s something â€” or someone â€” that reminds you thereâ€™s still a reason to hang on?â€`
        },
        {
            id: 'red-self-harm',
            title: 'Self-Harm Urges (NSSI)',
            category: 'Red Zone',
            emoji: 'ðŸš©',
            color: 'red',
            tags: ['nssi', 'self-harm', 'urges', 'coping', 'safety', 'red'],
            content: `### Direct Check-In\nâ€œThank you for telling me. I need to ask: Are you having urges to hurt yourself right now?â€\n* **If yes (urge is present):** â€œOn a scale from 1 to 10, how strong is the urge right now, 10 being the strongest?â€\n* **If yes (recent self-harm action):** â€œWhat did you do, and how severe was it? Do you need any medical attention for that?â€\n\n### Clarify Intent\nâ€œWhen you self-harmed, was it because you wanted to die, or was it more about coping with pain or numbness?â€\n\n### Validate & Normalize\nâ€œThat urge makes sense given what youâ€™re carrying. A part of you is trying to survive and find relief, even if itâ€™s doing it in a way that ends up hurting you. Letâ€™s see if we can work with that part in a safer way.â€\n\n### Offer Alternatives & Coping Strategies\n* **Intense Physical Sensations (**TIPP Skill for Rapid Distress Reduction**):** â€œSometimes our body needs a very strong sensation to release that tension. We could try holding something frozen (like ice), doing a wall-sit or some push-ups, or splashing really cold water on your face.â€\n* **â€œUrge Surfingâ€ Technique:** â€œRemember, urges are like waves â€” they build, peak, and eventually fall. Letâ€™s try to ride this wave out together.â€\n* **Safe Physical Release:** â€œWould it help to rip up some paper, squeeze a stress ball, stomp your feet, or even scream into a pillow?â€\n\n### Commitment to Safety\nâ€œI know the urge is strong, but do you feel like you can stay safe tonight? Even if the urge comes back, can you promise me youâ€™ll try these coping steps or reach out for help before doing anything to hurt yourself?â€`
        },
        // ... (The rest of the clinicalData would be updated with emojis similarly)
        {
            id: 'orange-panic-attack',
            title: 'Acute Anxiety or Panic Attack',
            category: 'Orange Zone',
            emoji: 'ðŸŸ ',
            color: 'orange',
            tags: ['anxiety', 'panic', 'fear', 'grounding', 'tipp', 'orange'],
            content: `### Normalize & Reassure\nâ€œWhat youâ€™re experiencing is a panic attack. It feels really scary, but **I promise itâ€™s not life-threatening. You are going to be okay. Iâ€™m right here.**â€\n\n### Immediate Physiological Regulation\n* **Temperature (**TIPP Skill for Rapid Distress Reduction**):** "Can you splash some cold water on your face, or hold a cold water bottle or ice cube if you have one? This triggers something called the 'dive response' that naturally slows your heart rate."\n* **Paced Breathing:** "Let's breathe together. Breathe in through your nose for 4 counts... hold for 4... now out through your mouth for 6 counts. That longer exhale is key."\n\n### Orient to Safety (**Grounding Through Senses (5-4-3-2-1 Technique)**)\nâ€œLetâ€™s name five things you see in the room. Good. Now four things you can feel... three things you can hear... two things you can smell... and one thing you can taste.â€\n\n### Permission to Pause\nâ€œWe donâ€™t need to unpack everything right now. In fact, we shouldnâ€™t dive deeper into anything heavy at this moment, because I want to make sure you donâ€™t leave here feeling even worse.â€`
        },
        {
            id: 'yellow-manipulative-behaviors',
            title: 'â€œManipulativeâ€ or Testing Behaviors',
            category: 'Yellow Zone',
            emoji: 'ðŸŸ¨',
            color: 'yellow',
            tags: ['manipulation', 'testing', 'boundaries', 'needs', 'yellow'],
            content: `### Look Under the Behavior\nâ€œIt seems like you really need something right now â€“ maybe reassurance, or to feel in control? I want to understand what you need, because I donâ€™t think youâ€™re doing these things for no reason.â€\n\n### Call Out Needs, Not Character\nâ€œI donâ€™t see you as â€˜manipulative.â€™ I see someone whoâ€™s trying hard to get their needs met. How about we skip the part where you have to escalate things to get me to care â€“ because I already care.â€\n\n### Encourage Direct Communication\nâ€œYou shouldnâ€™t have to test me to see if Iâ€™ll support you. I want you to know: if you need something, you can ask me as plainly as possible.â€\n\n### Intervention Insight\nUse the **DEAR MAN: For Interpersonal Effectiveness** framework for clear, assertive communication.`
        },
        {
            id: 'green-global-anxiety',
            title: 'Political/Global Events Anxiety',
            category: 'Green Zone',
            emoji: 'ðŸ’š',
            color: 'green',
            tags: ['anxiety', 'global events', 'politics', 'eco-anxiety', 'control', 'green'],
            content: `### Validate\nâ€œIt makes complete sense that youâ€™re feeling [anxious/angry/overwhelmed] given whatâ€™s happening in the world. These are heavy and uncertain times, and your feelings are a very understandable response.â€\n\n### Address Fears of Death/Cosmic Insignificance\nâ€œA lot of existential dread comes from realizing our own mortality or how small we are in the vast universe. That can be scary, but it can also be seen another way: If nothing ultimately matters on a cosmic scale, then maybe weâ€™re free to create our own meaning here and now.â€\n\n### Intervention Insight\nUse **Circles of Control, Influence, and Concern** to focus energy effectively.`
        },
    ]; // NOTE: For brevity, only a few items are shown with the new emoji property. The full list would be updated.

    const interventionsData = [
        {
            id: 'intervention-tipp',
            title: 'TIPP Skill for Rapid Distress Reduction',
            category: 'Intervention',
            subCategory: 'Distress Tolerance & Emotional Regulation',
            color: 'blue',
            tags: ['dbt', 'distress tolerance', 'regulation', 'panic', 'overwhelm'],
            content: `...` // Content is unchanged
        },
        {
            id: 'intervention-accepts',
            title: 'ACCEPTS: For Distress Tolerance (Distraction)',
            category: 'Intervention',
            subCategory: 'Distress Tolerance & Emotional Regulation',
            color: 'blue',
            tags: ['dbt', 'distress tolerance', 'distraction', 'coping'],
            content: `...`
        },
        {
            id: 'intervention-radical-acceptance',
            title: 'Radical Acceptance',
            category: 'Intervention',
            subCategory: 'Core DBT Skills',
            color: 'blue',
            tags: ['dbt', 'acceptance', 'suffering', 'reality'],
            content: `...`
        },
        {
            id: 'intervention-dear-man',
            title: 'DEAR MAN: For Interpersonal Effectiveness',
            category: 'Intervention',
            subCategory: 'Core DBT Skills',
            color: 'blue',
            tags: ['dbt', 'communication', 'assertiveness', 'boundaries', 'needs'],
            content: `...`
        },
        {
            id: 'intervention-54321',
            title: 'Grounding Through Senses (5-4-3-2-1 Technique)',
            category: 'Intervention',
            subCategory: 'Somatic & Grounding',
            color: 'blue',
            tags: ['grounding', 'anxiety', 'panic', 'senses', 'mindfulness'],
            content: `...`
        },
        {
            id: 'intervention-self-compassion-break',
            title: 'Self-Compassion Break (Kristin Neff)',
            category: 'Intervention',
            subCategory: 'Self-Awareness & Self-Management',
            color: 'blue',
            tags: ['self-compassion', 'mindfulness', 'kindness', 'shame'],
            content: `...`
        },
        {
            id: 'intervention-circles-of-control',
            title: 'Circles of Control, Influence, and Concern',
            category: 'Intervention',
            subCategory: 'Self-Awareness & Self-Management',
            color: 'blue',
            tags: ['control', 'anxiety', 'worry', 'problem solving', 'acceptance'],
            content: `...`
        },
        // NOTE: All interventions would be updated with a subCategory.
    ];

    const scriptsData = [
        {
            id: 'script-boundary-setting',
            title: 'Foundational Boundary Setting',
            category: 'Script',
            color: 'indigo',
            tags: ['boundaries', 'role setting', 'containment', 'scripts'],
            content: `...` // Content is unchanged
        },
        {
            id: 'script-end-of-session',
            title: 'End-of-Session Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['end of session', 'survey', 'closure', 'scripts'],
            content: `...`
        },
        // ... all other scripts
    ];
    
    const scratchpadTemplates = {
        safetyPlan: `### Safety Plan\n\n**Warning Signs (Thoughts, feelings, behaviors that things are getting worse):**\n- \n\n**Internal Coping Strategies (Things I can do on my own):**\n- \n\n**Social Distractions (People or places that can distract me):**\n- \n\n**People I Can Ask for Help:**\n- \n\n**Professional Resources (Therapist, crisis lines):**\n- \n\n**Making My Environment Safe:**\n- `,
        sessionNotes: `### Session Notes\n\n**Date:** ${new Date().toLocaleDateString()}\n\n**Client Presentation:**\n- \n\n**Key Issues Discussed:**\n- \n\n**Interventions Used:**\n- \n\n**Client Response:**\n- \n\n**Plan / Next Steps:**\n- `
    };


    // ---- STATE AND DATA ----
    const state = {
        favorites: [],
        recentlyViewed: [],
        usedThisSession: [], // New state for session tracker
        contentMap: new Map(),
        interventionMap: new Map(), // New map for clickable insights
        currentView: 'dashboard',
        currentOpenScenario: null,
        scratchpadContent: '',
        scratchpadMode: 'write', 
    };

    const colorMap = {
        red: { border: "border-red-500", bg: "bg-red-50 dark:bg-red-900/20", text: "text-red-600 dark:text-red-400" },
        orange: { border: "border-orange-500", bg: "bg-orange-50 dark:bg-orange-900/20", text: "text-orange-600 dark:text-orange-400" },
        yellow: { border: "border-yellow-500", bg: "bg-yellow-50 dark:bg-yellow-900/20", text: "text-yellow-600 dark:text-yellow-400" },
        green: { border: "border-green-500", bg: "bg-green-50 dark:bg-green-900/20", text: "text-green-600 dark:text-green-400" },
        blue: { border: "border-blue-500", bg: "bg-blue-50 dark:bg-blue-900/20", text: "text-blue-600 dark:text-blue-400" },
        indigo: { border: "border-indigo-500", bg: "bg-indigo-50 dark:bg-indigo-900/20", text: "text-indigo-600 dark:text-indigo-400" },
    };

    // ---- DOM REFERENCES ----
    const dom = {
        contentArea: document.getElementById('content-area'),
        searchBox: document.getElementById('search-box'),
        toast: document.getElementById('toast'),
        scenarioModal: document.getElementById('scenario-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalBody: document.getElementById('modal-body'),
        modalContext: document.getElementById('modal-context'),
        closeModal: document.getElementById('close-modal'),
        modalPrev: document.getElementById('modal-prev'),
        modalNext: document.getElementById('modal-next'),
        usedThisSession: document.getElementById('used-this-session'),
        themeToggle: document.getElementById('theme-toggle'),
        copyModalContentBtn: document.getElementById('copy-modal-content-to-scratchpad'),
        confirmationModal: document.getElementById('confirmation-modal'),
        confirmationTitle: document.getElementById('confirmation-title'),
        confirmationMessage: document.getElementById('confirmation-message'),
        confirmationConfirm: document.getElementById('confirmation-confirm'),
        confirmationCancel: document.getElementById('confirmation-cancel'),
    };

    // ---- STATE PERSISTENCE ----
    function saveState() {
        localStorage.setItem('clinicalFavorites', JSON.stringify(state.favorites));
        localStorage.setItem('clinicalRecents', JSON.stringify(state.recentlyViewed));
        localStorage.setItem('clinicalScratchpad', state.scratchpadContent);
    }

    function loadState() {
        state.favorites = JSON.parse(localStorage.getItem('clinicalFavorites') || '[]');
        state.recentlyViewed = JSON.parse(localStorage.getItem('clinicalRecents') || '[]');
        state.scratchpadContent = localStorage.getItem('clinicalScratchpad') || '';
    }

    // ---- INITIALIZATION ----
    function initializeDataMap() {
        const allContent = [...clinicalData, ...interventionsData, ...scriptsData];
        allContent.forEach(item => state.contentMap.set(item.id, item));
        interventionsData.forEach(item => state.interventionMap.set(item.title, item.id));
    }

    // ---- RENDERING ----
    function createScenarioCard(scenario) {
        const isFavorite = state.favorites.includes(scenario.id);
        const colors = colorMap[scenario.color] || colorMap.indigo;
        const tagsHtml = (scenario.tags || []).slice(0, 3).map(tag => 
            `<span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">${tag}</span>`
        ).join('');

        return `
        <div class="scenario-card bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 flex flex-col border-l-4 ${colors.border}">
            <div class="p-4 flex-1 flex flex-col">
                <h3 class="font-bold text-gray-800 dark:text-gray-100 flex items-center">
                    <span class="mr-2">${scenario.emoji || ''}</span>
                    <span class="flex-1">${scenario.title}</span>
                </h3>
                <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 flex-1">
                    ${tagsHtml}
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <button class="view-btn text-sm font-semibold text-indigo-600 dark:text-indigo-400 hover:underline" data-id="${scenario.id}">View Details</button>
                    <button class="favorite-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${scenario.id}" title="Add to favorites">
                        <i data-lucide="star" class="w-5 h-5 ${isFavorite ? 'text-yellow-500 fill-current' : 'text-gray-400'}"></i>
                    </button>
                </div>
            </div>
        </div>
        `;
    }

    function renderCardList(container, items, message, search_query = '') {
        let headerHtml = '';
        if(search_query){
            headerHtml = `<div class="col-span-full mb-4 flex items-center gap-4">
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Showing ${items.length} results for "${search_query}"</h2>
                <button id="clear-search-btn" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">Clear</button>
            </div>`;
        }
        
        container.innerHTML = headerHtml + '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>';
        const grid = container.querySelector('.grid');

        if (items.length === 0) {
            grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-12">${message}</div>`;
        } else {
            grid.innerHTML = items.map(createScenarioCard).join('');
        }

        document.getElementById('clear-search-btn')?.addEventListener('click', () => {
            dom.searchBox.value = '';
            switchView(state.currentView);
        });
        lucide.createIcons();
    }

    function renderDashboard() {
        dom.contentArea.className = '';
        const zones = ['Red Zone', 'Orange Zone', 'Yellow Zone', 'Green Zone'];
        const zoneEmojis = {'Red Zone': 'ðŸ”´', 'Orange Zone': 'ðŸŸ ', 'Yellow Zone': 'ðŸŸ¨', 'Green Zone': 'ðŸ’š'};
        const quickAccessIds = ['script-boundary-setting', 'intervention-tipp', 'intervention-self-compassion-break', 'script-end-of-session'];
        const quickAccessItems = quickAccessIds.map(id => state.contentMap.get(id));

        let dashboardHtml = `
            <div class="mb-10">
                <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-gray-300 dark:border-gray-600 flex items-center gap-2">
                    <i data-lucide="zap" class="w-6 h-6 text-gray-500"></i> Quick Access
                </h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    ${quickAccessItems.map(item => `
                        <button class="view-btn p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all text-left flex flex-col justify-between h-full border-l-4 ${colorMap[item.color]?.border || ''}" data-id="${item.id}">
                            <span class="font-semibold text-gray-800 dark:text-gray-200">${item.title}</span>
                            <span class="text-xs mt-2 ${colorMap[item.color]?.text || ''}">${item.category}</span>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;

        zones.forEach(zone => {
            const itemsInZone = clinicalData.filter(item => item.category === zone);
            if (itemsInZone.length > 0) {
                const zoneColor = itemsInZone[0].color;
                dashboardHtml += `
                    <div class="mb-10">
                        <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-${zoneColor}-500 text-${zoneColor}-600 dark:text-${zoneColor}-400">${zoneEmojis[zone]} ${zone}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${itemsInZone.map(createScenarioCard).join('')}
                        </div>
                    </div>
                `;
            }
        });

        dom.contentArea.innerHTML = dashboardHtml;
        lucide.createIcons();
    }
    
    function renderCategorizedList(container, items, categoryTitle, message) {
        const grouped = items.reduce((acc, item) => {
            const group = item.subCategory || 'General';
            if (!acc[group]) {
                acc[group] = [];
            }
            acc[group].push(item);
            return acc;
        }, {});

        let html = `<h1 class="text-3xl font-bold mb-8">${categoryTitle}</h1>`;
        
        if (Object.keys(grouped).length === 0) {
            html += `<div class="text-center text-gray-500 py-12">${message}</div>`;
        } else {
            for (const groupName in grouped) {
                html += `
                    <div class="mb-10">
                        <h2 class="text-xl font-bold mb-4 pb-2 border-b-2 border-gray-300 dark:border-gray-600">${groupName}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${grouped[groupName].map(createScenarioCard).join('')}
                        </div>
                    </div>
                `;
            }
        }
        container.innerHTML = html;
        lucide.createIcons();
    }

    function renderUsedThisSession() {
        if (state.usedThisSession.length === 0) {
            dom.usedThisSession.innerHTML = '';
            return;
        }
        const itemsHtml = state.usedThisSession.map(id => {
            const item = state.contentMap.get(id);
            if (!item) return '';
            return `
                <span class="inline-flex items-center gap-x-1.5 py-1.5 px-3 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-800/30 dark:text-blue-400">
                    <span>${item.title}</span>
                    <button class="remove-used-btn group" data-id="${id}">
                        <i data-lucide="x" class="w-3 h-3 text-blue-500 group-hover:text-blue-700 dark:group-hover:text-blue-200"></i>
                    </button>
                </span>
            `;
        }).join('');

        dom.usedThisSession.innerHTML = `
            <div class="p-4 rounded-lg bg-gray-100 dark:bg-gray-800">
                <h3 class="text-sm font-semibold mb-2 text-gray-600 dark:text-gray-400">Used This Session:</h3>
                <div class="flex flex-wrap gap-2">${itemsHtml}</div>
            </div>
        `;
        lucide.createIcons();
    }

    function openModal(scenarioId) {
        const scenario = state.contentMap.get(scenarioId);
        if (!scenario) return;

        state.currentOpenScenario = scenario;
        
        // Render context
        const categoryColor = colorMap[scenario.color] || colorMap.indigo;
        const contextTags = (scenario.tags || []).map(tag => `<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200">${tag}</span>`).join('');
        dom.modalContext.innerHTML = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${categoryColor.bg} ${categoryColor.text}">${scenario.category}</span>` + contextTags;

        dom.modalTitle.innerHTML = `<span class="mr-3">${scenario.emoji || ''}</span> ${scenario.title}`;
        
        // Process content for clickable insights
        let processedContent = scenario.content;
        state.interventionMap.forEach((id, title) => {
            const regex = new RegExp(`\\*\\*(${title})\\*\\*`, 'g');
            processedContent = processedContent.replace(regex, `<button class="insight-link" data-id="${id}">$1</button>`);
        });
        dom.modalBody.innerHTML = marked.parse(processedContent);
        dom.scenarioModal.classList.remove('hidden');
        
        // Add to trackers
        if (!state.usedThisSession.includes(scenarioId)) {
            state.usedThisSession.push(scenarioId);
            renderUsedThisSession();
        }
        if (!state.recentlyViewed.includes(scenarioId)) {
            state.recentlyViewed = [scenarioId, ...state.recentlyViewed.filter(id => id !== scenarioId)].slice(0, 20);
            saveState();
        }
        
        // Handle nav buttons
        updateModalNav();
        lucide.createIcons();
    }

    function updateModalNav() {
        const currentList = getCurrentList();
        const currentIndex = currentList.findIndex(item => item.id === state.currentOpenScenario.id);
        
        dom.modalPrev.disabled = currentIndex <= 0;
        dom.modalNext.disabled = currentIndex >= currentList.length - 1;

        dom.modalPrev.onclick = () => {
            if (currentIndex > 0) openModal(currentList[currentIndex - 1].id);
        };
        dom.modalNext.onclick = () => {
            if (currentIndex < currentList.length - 1) openModal(currentList[currentIndex + 1].id);
        };
    }

    function renderScratchpad() {
        dom.contentArea.className = 'h-full flex flex-col';
        dom.contentArea.innerHTML = `
        <div class="max-w-7xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full flex-1 flex flex-col">
            <div class="flex items-center mb-4 flex-shrink-0">
                <i data-lucide="edit-3" class="w-5 h-5 text-teal-500 mr-2"></i>
                <h2 class="text-xl font-bold flex-1">Scratchpad</h2>
                <div class="flex items-center gap-2">
                    <div id="template-dropdown-container" class="relative">
                        <button id="template-btn" class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Templates</button>
                        <div id="template-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg z-10">
                           <a href="#" class="template-item block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" data-template="safetyPlan">Safety Plan</a>
                           <a href="#" class="template-item block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" data-template="sessionNotes">Session Notes</a>
                        </div>
                    </div>
                    <button id="toggle-scratchpad-mode" class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 lg:hidden">
                        ${state.scratchpadMode === 'write' ? 'Preview' : 'Edit'}
                    </button>
                    <button id="clear-scratchpad" class="text-sm text-red-500 hover:underline">Clear</button>
                </div>
            </div>
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-4 min-h-0">
                <div id="scratchpad-write-area" class="${state.scratchpadMode === 'write' ? 'flex' : 'hidden'} lg:flex flex-col">
                    <textarea id="scratchpad-textarea"
                        class="w-full p-4 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 rounded-lg scratchpad-resize text-sm font-mono focus:ring-2 focus:ring-teal-500 focus:outline-none flex-1"
                        placeholder="Type notes, scripts, or plans here... (Markdown supported)">${state.scratchpadContent || ''}</textarea>
                    <div class="flex mt-3 gap-2 flex-shrink-0">
                        <button id="copy-scratchpad" class="flex items-center text-xs px-3 py-1 bg-indigo-100 dark:bg-indigo-900 rounded-md text-indigo-700 dark:text-indigo-200 hover:bg-indigo-200 dark:hover:bg-indigo-800"><i data-lucide="copy" class="w-4 h-4 mr-1"></i>Copy</button>
                        <button id="download-scratchpad" class="flex items-center text-xs px-3 py-1 bg-green-100 dark:bg-green-900 rounded-md text-green-700 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800"><i data-lucide="download" class="w-4 h-4 mr-1"></i>Download</button>
                    </div>
                </div>
                <div id="scratchpad-preview-area" class="prose dark:prose-invert max-w-none ${state.scratchpadMode === 'preview' ? '' : 'hidden'} lg:block p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg overflow-y-auto bg-gray-50 dark:bg-gray-900/50">
                    ${marked.parse(state.scratchpadContent || '_Nothing here yet. Type in Edit mode!_')}
                </div>
            </div>
        </div>
        `;
        lucide.createIcons();
        attachScratchpadEvents();
    }
    
    // ---- TABS & VIEWS ----
    function getCurrentList() {
        const q = dom.searchBox.value.toLowerCase().trim();
        if (q) {
            return Array.from(state.contentMap.values()).filter(item =>
                item.title.toLowerCase().includes(q) ||
                (item.content && item.content.toLowerCase().includes(q)) ||
                (item.tags && item.tags.some(tag => tag.toLowerCase().includes(q)))
            );
        }

        switch (state.currentView) {
            case 'favorites': return state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
            case 'recents': return state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
            case 'interventions': return interventionsData;
            case 'scripts': return scriptsData;
            case 'dashboard': return clinicalData;
            default: return [];
        }
    }

    function switchView(viewId) {
        state.currentView = viewId;
        // Update sidebar link styles
        document.querySelectorAll('.sidebar-link').forEach(link => {
            const isSelected = link.dataset.tab === viewId;
            const isScratchpad = viewId === 'scratchpad';
            link.classList.toggle('bg-indigo-100', isSelected && !isScratchpad);
            link.classList.toggle('dark:bg-indigo-800', isSelected && !isScratchpad);
            link.classList.toggle('bg-teal-100', isSelected && isScratchpad);
            link.classList.toggle('dark:bg-teal-900', isSelected && isScratchpad);
            link.classList.toggle('text-indigo-700', isSelected && !isScratchpad);
            link.classList.toggle('dark:text-indigo-200', isSelected && !isScratchpad);
            link.classList.toggle('text-teal-700', isSelected && isScratchpad);
            link.classList.toggle('dark:text-teal-200', isSelected && isScratchpad);
            link.classList.toggle('font-semibold', isSelected);
        });

        dom.searchBox.value = ''; // Clear search on tab switch

        if (viewId === 'dashboard') {
            renderDashboard();
        } else if (viewId === 'scratchpad') {
            renderScratchpad();
        } else if (viewId === 'interventions') {
            renderCategorizedList(dom.contentArea, interventionsData, 'Interventions', 'No interventions found.');
        } else {
            let items = [];
            let message = 'No items found.';
            if (viewId === 'favorites') {
                items = state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
                message = 'No favorites yet. Click the star on a card to add one.';
            } else if (viewId === 'recents') {
                items = state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
                message = 'No recently viewed items.';
            } else if (viewId === 'scripts') {
                items = Array.from(state.contentMap.values()).filter(item => item.category === 'Script');
                message = 'No scripts found.';
            }
            renderCardList(dom.contentArea, items, message);
        }
    }

    // ---- EVENT HANDLERS & LOGIC ----
    function handleContentInteraction(e) {
        const viewBtn = e.target.closest('.view-btn');
        if (viewBtn) {
            openModal(viewBtn.dataset.id);
            return;
        }

        const favoriteBtn = e.target.closest('.favorite-btn');
        if (favoriteBtn) {
            const id = favoriteBtn.dataset.id;
            const isFavorite = state.favorites.includes(id);
            if (isFavorite) {
                state.favorites = state.favorites.filter(favId => favId !== id);
                showToast('Removed from favorites', 'info');
            } else {
                state.favorites.push(id);
                showToast('Added to favorites!', 'success');
            }
            saveState();
            switchView(state.currentView);
            return;
        }
        
        const removeUsedBtn = e.target.closest('.remove-used-btn');
        if(removeUsedBtn) {
            const id = removeUsedBtn.dataset.id;
            state.usedThisSession = state.usedThisSession.filter(usedId => usedId !== id);
            renderUsedThisSession();
            return;
        }

        const insightLink = e.target.closest('.insight-link');
        if(insightLink) {
            const id = insightLink.dataset.id;
            // We want the new modal to feel like it's replacing the old one
            dom.scenarioModal.classList.add('opacity-0', 'transition-opacity');
            setTimeout(() => {
                openModal(id);
                dom.scenarioModal.classList.remove('opacity-0');
            }, 150);
        }
    }
    
    function attachScratchpadEvents() {
        document.getElementById('toggle-scratchpad-mode')?.addEventListener('click', () => {
            state.scratchpadMode = (state.scratchpadMode === 'write') ? 'preview' : 'write';
            renderScratchpad();
        });
        document.getElementById('clear-scratchpad')?.addEventListener('click', () => {
            showConfirmationModal('Clear all notes in your scratchpad?', 'This action cannot be undone.', () => {
                state.scratchpadContent = '';
                saveState();
                renderScratchpad();
                showToast('Scratchpad cleared.', 'success');
            });
        });
        const textarea = document.getElementById('scratchpad-textarea');
        const previewArea = document.getElementById('scratchpad-preview-area');
        textarea?.addEventListener('input', (e) => {
            state.scratchpadContent = e.target.value;
            saveState();
            // Live preview for split view
            if (window.innerWidth >= 1024) { // lg breakpoint
                previewArea.innerHTML = marked.parse(state.scratchpadContent || '_Nothing here yet._');
            }
        });
        document.getElementById('copy-scratchpad')?.addEventListener('click', () => copyToClipboard(state.scratchpadContent));
        document.getElementById('download-scratchpad')?.addEventListener('click', downloadScratchpad);
        
        // Template Dropdown
        const templateBtn = document.getElementById('template-btn');
        const templateDropdown = document.getElementById('template-dropdown');
        templateBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            templateDropdown.classList.toggle('hidden');
        });
        document.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const templateKey = e.target.dataset.template;
                const template = scratchpadTemplates[templateKey];
                if (template) {
                    const currentText = textarea.value;
                    textarea.value = (currentText ? currentText + '\n\n---\n\n' : '') + template;
                    textarea.dispatchEvent(new Event('input')); // Trigger update
                    textarea.scrollTop = textarea.scrollHeight;
                }
                templateDropdown.classList.add('hidden');
            });
        });
        document.addEventListener('click', () => templateDropdown?.classList.add('hidden'));
    }

    dom.searchBox?.addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase().trim();
        if (state.currentView === 'scratchpad') return;

        if (!q) {
            switchView(state.currentView);
            return;
        }
        
        const filtered = getCurrentList();
        renderCardList(dom.contentArea, filtered, 'No matches found for your search.', q);
    });

    // ---- UTILITIES ----
    function showToast(message, type = 'info') { // types: success, info, error
        const colors = {
            success: 'bg-green-500',
            info: 'bg-gray-600 dark:bg-gray-700',
            error: 'bg-red-500'
        };
        dom.toast.textContent = message;
        dom.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[100] transition-all duration-300 ${colors[type]}`;
        dom.toast.classList.remove('hidden');
        dom.toast.classList.add('opacity-100');
        setTimeout(() => { dom.toast.classList.remove('opacity-100'); }, 2700);
        setTimeout(() => { dom.toast.classList.add('hidden'); }, 3000);
    }

    function copyToClipboard(text) {
        if (!text) return;
        const plainText = text.replace(/###\s/g, '').replace(/##\s/g, '').replace(/#\s/g, '').replace(/\*\*/g, '').replace(/\*/g, '').replace(/>\s/g, '');
        const textArea = document.createElement('textarea');
        textArea.value = plainText;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast("Copied to clipboard!", 'success');
        } catch (err) {
            showToast("Failed to copy.", 'error');
        }
        document.body.removeChild(textArea);
    }
    
    function downloadScratchpad() {
        const blob = new Blob([state.scratchpadContent], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'scratchpad.md';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        dom.confirmationTitle.textContent = title;
        dom.confirmationMessage.textContent = message;
        dom.confirmationModal.classList.remove('hidden');
        
        const confirmHandler = () => {
            onConfirm();
            hideConfirmationModal();
        };
        const cancelHandler = () => hideConfirmationModal();

        const hideConfirmationModal = () => {
            dom.confirmationModal.classList.add('hidden');
            dom.confirmationConfirm.removeEventListener('click', confirmHandler);
            dom.confirmationCancel.removeEventListener('click', cancelHandler);
        };
        
        dom.confirmationConfirm.addEventListener('click', confirmHandler);
        dom.confirmationCancel.addEventListener('click', cancelHandler);
    }

    // ---- THEME ----
    function applyTheme(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        dom.themeToggle.innerHTML = isDark ? '<i data-lucide="sun" class="w-5 h-5"></i>' : '<i data-lucide="moon" class="w-5 h-5"></i>';
        lucide.createIcons();
    }

    // ---- MAIN INITIALIZATION ----
    function main() {
        loadState();
        initializeDataMap();

        // Event listeners
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => switchView(link.dataset.tab));
        });
        // Use event delegation for dynamic content
        document.body.addEventListener('click', handleContentInteraction);
        
        dom.closeModal.addEventListener('click', () => dom.scenarioModal.classList.add('hidden'));
        dom.themeToggle?.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            applyTheme(isDarkMode);
        });
        dom.copyModalContentBtn.addEventListener('click', () => {
            if (state.currentOpenScenario) {
                const contentToCopy = `### ${state.currentOpenScenario.title}\n\n${state.currentOpenScenario.content}`;
                state.scratchpadContent += (state.scratchpadContent ? '\n\n---\n\n' : '') + contentToCopy;
                saveState();
                showToast('Copied to scratchpad!', 'success');
                if (state.currentView === 'scratchpad') {
                    renderScratchpad();
                }
            }
        });

        // Initial theme setup
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme === 'dark' || (savedTheme === null && prefersDark));

        // Initial view
        switchView(state.currentView || 'dashboard');
        renderUsedThisSession();
        lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
