// utils.js
export function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

/**
 * Basic HTML sanitizer: escapes HTML special characters
 */
export function sanitizeHTML(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// render.js
import { sanitizeHTML } from './utils.js';
import { getAllContent } from './data.js'; // implement data.js to export clinicalData & interventionsData

/**
 * Renders the Zones overview into a container
 * PERF: Cache getAllContent().zones to avoid repeated data fetches on each render
 */
export function renderZones(container) {
  const allZones = getAllContent().zones; // consider caching outside this function
  container.innerHTML = '';
  const frag = document.createDocumentFragment(); // PERF: Use fragment to minimize reflows
  Object.values(allZones).forEach(zone => {
    const card = document.createElement('div');
    card.className = `p-6 rounded-2xl border bg-${zone.color}-500/10 dark:bg-${zone.color}-800/20 border-${zone.color}-200 dark:border-${zone.color}-600 cursor-pointer`;
    card.innerHTML = `
      <h3 class="text-2xl font-bold text-${zone.color}-600 dark:text-${zone.color}-400">${sanitizeHTML(zone.title)}</h3>
      <p class="text-gray-500 dark:text-${zone.color}-300 mt-2">Click to view scenarios</p>
    `;
    card.addEventListener('click', () => showZoneScenarios(zone)); // ensure showZoneScenarios is defined/imported
    frag.appendChild(card);
  });
  container.appendChild(frag);
}

/**
 * Renders toolkit categories with accordions
 */
export function renderToolkit(container) {
  const toolkit = getAllContent().toolkit;
  container.innerHTML = '';
  Object.entries(toolkit).forEach(([category, items]) => {
    const section = document.createElement('section');
    const header = document.createElement('header');
    header.className = 'flex justify-between p-4 bg-gray-100 dark:bg-gray-800 cursor-pointer';
    header.innerHTML = `<h4 class="font-semibold">${sanitizeHTML(category)}</h4><span>â–¼</span>`;
    const list = document.createElement('div');
    list.className = 'hidden p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4';
    const listFrag = document.createDocumentFragment();
    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'p-4 border rounded-lg';
      card.innerHTML = `
        <h5 class="font-semibold">${sanitizeHTML(item.title)}</h5>
        <p class="text-sm text-gray-600">${sanitizeHTML(item.content.replace(/<[^>]*>/g, '').slice(0, 100))}...</p>
      `;
      card.addEventListener('click', () => openItemModal(item)); // ensure openItemModal exists
      listFrag.appendChild(card);
    });
    list.appendChild(listFrag);
    header.addEventListener('click', () => list.classList.toggle('hidden'));
    section.className = 'mb-4';
    section.append(header, list);
    container.appendChild(section);
  });
}

/**
 * Renders generic category views
 */
export function renderGenericView(container, categoryKey) {
  const items = (getAllContent().other[categoryKey] || []);
  container.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
  const gridFrag = document.createDocumentFragment();
  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'p-4 border rounded-lg';
    card.innerHTML = `
      <h5 class="font-semibold">${sanitizeHTML(item.title)}</h5>
      <p class="text-sm text-gray-600">${sanitizeHTML(item.content.replace(/<[^>]*>/g, '').slice(0, 100))}...</p>
    `;
    card.addEventListener('click', () => openItemModal(item));
    gridFrag.appendChild(card);
  });
  grid.appendChild(gridFrag);
  if (!items.length) {
    grid.innerHTML = '<p class="text-center text-gray-500">No items in this category.</p>';
  }
  container.appendChild(grid);
}

/**
 * Helper to open a modal for a scenario or item
 * SECURITY: Assumes item.content is safe HTML; consider sanitizing or using DOM methods
 */
function openItemModal(item) {
  const modal = document.getElementById('scenarioModal');
  const titleEl = document.getElementById('modalTitle');
  const bodyEl = document.getElementById('modalBody');
  titleEl.textContent = item.title;
  bodyEl.innerHTML = item.content;
  modal.classList.remove('hidden');
}

/**
 * Handler to show scenarios for a specific zone
 * CODE: Duplicate logic with renderGenericView; consider refactoring common card creation
 */
function showZoneScenarios(zone) {
  const container = document.getElementById('content-area');
  container.innerHTML = `<h2 class="text-3xl font-bold mb-4">${sanitizeHTML(zone.title)}</h2>`;
  const grid = document.createElement('div');
  grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
  const frag = document.createDocumentFragment();
  zone.scenarios.forEach(s => {
    const card = document.createElement('div');
    card.className = 'p-4 border rounded-lg';
    card.innerHTML = `
      <h5 class="font-semibold">${sanitizeHTML(s.title)}</h5>
      <p class="text-sm text-gray-600">${sanitizeHTML(s.content.replace(/<[^>]*>/g, '').slice(0, 100))}...</p>
    `;
    card.addEventListener('click', () => openItemModal(s));
    frag.appendChild(card);
  });
  grid.appendChild(frag);
  container.appendChild(grid);
}
