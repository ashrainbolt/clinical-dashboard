<!DOCTYPE html>
<html lang="en" class="bg-gray-50 dark:bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Marked.js (Markdown parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom styles for prose and layout */
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
            font-weight: 600;
            margin-top: 1.25em;
            margin-bottom: 0.5em;
        }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.25em; }
        .prose h3 { font-size: 1.1em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; }
        .prose strong { font-weight: 600; }
        .prose blockquote {
            border-left: 0.25rem solid #4f46e5;
            padding-left: 1em;
            font-style: italic;
            color: #4b5563;
        }
        .dark .prose blockquote {
            border-left-color: #818cf8;
            color: #d1d5db;
        }

        .scratchpad-resize {
            resize: vertical;
            min-height: 6rem;
            max-height: 50vh;
            overflow-y: auto;
        }
        /* Ensure sidebar content can scroll if it overflows */
        .sidebar-nav {
            flex: 1 1 auto;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans">

    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-full w-60 bg-white dark:bg-gray-800 shadow-lg flex flex-col z-40">
        <div class="flex items-center h-16 px-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
            <i data-lucide="activity" class="w-6 h-6 mr-2 text-indigo-500"></i>
            <span class="font-bold text-lg">Clinical OS</span>
            <button id="theme-toggle" class="ml-auto p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Theme">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
        <nav class="sidebar-nav py-4 px-2 space-y-1">
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="dashboard"><i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i>Dashboard</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="interventions"><i data-lucide="zap" class="w-4 h-4 mr-3"></i>Interventions</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="scripts"><i data-lucide="file-text" class="w-4 h-4 mr-3"></i>Scripts</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="favorites"><i data-lucide="star" class="w-4 h-4 mr-3"></i>Favorites</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="recents"><i data-lucide="history" class="w-4 h-4 mr-3"></i>Recently Viewed</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-teal-100 dark:hover:bg-teal-900" data-tab="scratchpad"><i data-lucide="edit-3" class="w-4 h-4 mr-3"></i>Scratchpad</button>
        </nav>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
            <input id="search-box" type="text" placeholder="Search scenarios..." class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
    </aside>

    <!-- Main content -->
    <main class="ml-60 min-h-screen p-6 md:p-8 transition-colors duration-300">
        <!-- Used this session -->
        <div id="used-this-session" class="mb-4"></div>
        <!-- Dynamic content area -->
        <div id="content-area"></div>
    </main>

    <!-- Content Modal -->
    <div id="scenario-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full relative p-6 max-h-[90vh] flex flex-col">
            <div class="flex items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold flex-1"></h2>
                <button id="close-modal" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-body" class="prose dark:prose-invert max-w-none overflow-y-auto pr-4 -mr-4"></div>
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex gap-2">
                 <button id="copy-modal-content-to-scratchpad" class="flex items-center text-xs px-3 py-1 bg-teal-100 dark:bg-teal-900 rounded-md text-teal-700 dark:text-teal-200 hover:bg-teal-200 dark:hover:bg-teal-800">
                    <i data-lucide="plus-square" class="w-4 h-4 mr-1"></i>Copy to Scratchpad
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 id="confirmation-title" class="text-lg font-semibold mb-4">Are you sure?</h3>
            <div id="confirmation-message" class="text-sm text-gray-600 dark:text-gray-300 mb-6"></div>
            <div class="flex justify-end gap-3">
                <button id="confirmation-cancel" class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                <button id="confirmation-confirm" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="hidden"></div>

    <script>
    // ---- DATA ----
    // This section contains all the clinical scenarios and interventions
    // converted from the user's document into a structured format.

    const clinicalData = [
        // --- RED ZONE ---
        {
            id: 'red-suicidal-ideation',
            title: 'Suicidal Ideation – Safety Assessment',
            category: 'Red Zone',
            color: 'red',
            tags: ['suicide', 'safety', 'crisis', 'cssrs', 'assessment', 'red'],
            content: `
### ASSESS
"Before we go any deeper, **our priority is always your safety**. I’d like to ask a few questions that help us understand how you’re doing and what kind of support might help keep you safe right now.

1.  **Have you wished you were dead or that you could go to sleep and not wake up?**
2.  **Have you actually had any thoughts of killing yourself?** (If yes, ask 3, 4, 5, 6. If no, go to 6).
3.  **In the past 48 hours, have you been thinking about how you might do this?**
4.  **In the past 48 hours, have you had these thoughts and had some intention of acting on them?**
5.  **In the past 48 hours, have you started to work out any details for how to kill yourself? Do you intend to carry out this plan?**
6.  **In the past 48 hours have you done anything to prepare to end your life?**

*If Yes to 4, 5, or 6, ask scaling questions:*

> "On a scale of 1-5, one meaning you feel you can stay safe today, and five meaning that you're going to make an attempt today, where would you place yourself right now?"

*Reflect back answer:*
* "So a **four** means to me you have a plan and some intentions on acting on the plan, you just don't know when. Is that accurate?"
* "A **three** means to me you have strong thoughts of wanting to die and have thought about ways you might act on it, but you don't have a specific plan. Did I get that right?"
* "A **two** means to me that you have fleeting thoughts of wanting to end your life, but no plan or intention of acting on it."

“I’m really glad you told me this. It takes a lot of strength to be this honest, and I’m here to help you figure it out.”

### SAFETY PLAN
**Need to escalate:** "Thank you for telling me that. If it sounds like things are starting to feel more intense or harder to manage on your own, I’d like to connect you with a Crisis Manager — who can better support you and help figure out the next steps to keep you safe."

* **Warning Signs:** “What are some early signs you notice when things start to spiral?”
* **Internal Coping:** “What can you try on your own that sometimes helps, even a little?”
* **Social Distractions:** “Who or what helps you shift your focus — even briefly?”
* **People to Reach Out To:** “If things feel too big to hold alone, who could you reach out to?”
* **Professional Resources:** “Do you have Charlie Health’s 24/7 crisis line saved in your phone?”
* **Safety at Home:** “Is there anything nearby that might feel unsafe to have around right now?”
* **Reasons to Stay:** “When things get dark, what’s something — or someone — that reminds you there’s still a reason to hang on?”
`
        },
        {
            id: 'red-self-harm',
            title: 'Self-Harm Urges (Non-Suicidal Self-Injury)',
            category: 'Red Zone',
            color: 'red',
            tags: ['nssi', 'self-harm', 'urges', 'coping', 'safety', 'red'],
            content: `
### Direct Check-In
“Thank you for telling me. I need to ask: Are you having urges to hurt yourself right now?”
* **If yes (urge is present):** “On a scale from 1 to 10, how strong is the urge right now, 10 being the strongest?”
* **If yes (recent self-harm action):** “What did you do, and how severe was it? Do you need any medical attention for that?”

### Clarify Intent
“When you self-harmed, was it because you wanted to die, or was it more about coping with pain or numbness?”

### Validate & Normalize
“That urge makes sense given what you’re carrying. A part of you is trying to survive and find relief, even if it’s doing it in a way that ends up hurting you. Let’s see if we can work with that part in a safer way.”

### Offer Alternatives & Coping Strategies
* **Intense Physical Sensations (TIPP skills):** “Sometimes our body needs a very strong sensation to release that tension. We could try holding something frozen (like ice), doing a wall-sit or some push-ups, or splashing really cold water on your face.”
* **“Urge Surfing” Technique:** “Remember, urges are like waves — they build, peak, and eventually fall. Let’s try to ride this wave out together.”
* **Safe Physical Release:** “Would it help to rip up some paper, squeeze a stress ball, stomp your feet, or even scream into a pillow?”

### Commitment to Safety
“I know the urge is strong, but do you feel like you can stay safe tonight? Even if the urge comes back, can you promise me you’ll try these coping steps or reach out for help before doing anything to hurt yourself?”
`
        },
        // ... more red zone items
        {
            id: 'red-under-influence',
            title: 'Under the Influence (Non-Crisis)',
            category: 'Red Zone',
            color: 'red',
            tags: ['substance', 'intoxication', 'policy', 'safety', 'red'],
            content: `
### Immediate Safety Check
"Hi. I'm just checking in with you briefly. It was noticed in group that [specific observation, e.g., 'you seemed a bit sleepy']. How are you doing right now?"

### Stating the Need to Log Off (Clear, Kind, Firm)
"Because it appears you're under the influence right now, and in line with the group policy for everyone's safety and benefit, I am going to need you to log off from the group session for the rest of today."
"This isn't a punishment, but it's a necessary step to ensure your well-being and to maintain the group's therapeutic environment."

### Brief Safety Assessment (Essential before log-off)
"Before you log off for the day, my top priority is to make sure you're going to be safe. Are you in a safe place physically right now? Is there anyone with you, or someone responsible you can contact if you start to feel unwell or need help?"

### Explain Next Steps
“Because you were under the influence and had to step out of group, I will let your primary therapist know what happened, just so they’re in the loop and can support you.”
`
        },
        // --- ORANGE ZONE ---
        {
            id: 'orange-agitated',
            title: 'Highly Agitated or Escalating',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['agitation', 'escalation', 'anger', 'distress', 'orange'],
            content: `
### Center and Slow the Moment
“I can see (or hear) how agitated you are. Let’s take a pause for a second. I’m right here with you. You don’t have to go through this moment alone.”

### Acknowledge the Anger/Frustration
“That energy and anger you’re feeling right now — it makes sense. Something important is going on inside you and it’s demanding to be heard.”

### Keep Voice Calm & Assuring
“I’m not going anywhere. I know you’re really upset, and it’s okay. Let’s stay right here. You’re safe with me to let it out, as long as we keep each other safe.”

### After Calming Slightly – Reflection
“That was a lot. You did really well slowing down just now. This is hard stuff, and you’re handling it. When you’re ready, maybe we can figure out what you need next or how I can help further.”
`
        },
        {
            id: 'orange-panic-attack',
            title: 'Acute Anxiety or Panic Attack',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['anxiety', 'panic', 'fear', 'grounding', 'tipp', 'orange'],
            content: `
### Normalize & Reassure
“What you’re experiencing is a panic attack. It feels really scary, but **I promise it’s not life-threatening. You are going to be okay. I’m right here.**”

### Immediate Physiological Regulation (TIPP Skills)
* **Temperature:** "Can you splash some cold water on your face, or hold a cold water bottle or ice cube if you have one? This triggers something called the 'dive response' that naturally slows your heart rate."
* **Paced Breathing:** "Let's breathe together. Breathe in through your nose for 4 counts... hold for 4... now out through your mouth for 6 counts. That longer exhale is key."

### Orient to Safety (5-4-3-2-1 technique)
“Let’s name five things you see in the room. Good. Now four things you can feel... three things you can hear... two things you can smell... and one thing you can taste.”

### Permission to Pause
“We don’t need to unpack everything right now. In fact, we shouldn’t dive deeper into anything heavy at this moment, because I want to make sure you don’t leave here feeling even worse.”
`
        },
        // ... more orange zone items
        // --- YELLOW ZONE ---
        {
            id: 'yellow-manipulative-behaviors',
            title: '“Manipulative” or Testing Behaviors',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['manipulation', 'testing', 'boundaries', 'needs', 'yellow'],
            content: `
### Look Under the Behavior
“It seems like you really need something right now – maybe reassurance, or to feel in control? I want to understand what you need, because I don’t think you’re doing these things for no reason.”

### Call Out Needs, Not Character
“I don’t see you as ‘manipulative.’ I see someone who’s trying hard to get their needs met. How about we skip the part where you have to escalate things to get me to care – because I already care.”

### Encourage Direct Communication
“You shouldn’t have to test me to see if I’ll support you. I want you to know: if you need something, you can ask me as plainly as possible.”

### Intervention Insight
Use the **DEAR MAN** framework for clear, assertive communication.
`
        },
        {
            id: 'yellow-shame-guilt',
            title: 'Shame, Self-Hatred, or Guilt',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['shame', 'guilt', 'self-compassion', 'worthlessness', 'yellow'],
            content: `
### Validate
“It sounds like you’re holding yourself to an impossible standard. Whatever you did (or think you did), it doesn’t make you worthless or evil. It makes you human.”

### Get Specific
“Can we talk about what’s making you feel so ashamed? What do you believe you did that’s so unforgivable?”

### Self-Compassion
“Think about what you would say to a close friend if they were feeling exactly what you’re feeling. You deserve that same kindness. What if you tried talking to yourself in that gentle way, maybe saying something like ‘It’s okay to feel this. I’m here for you.’?”

### Intervention Insight
* Use **ACT Defusion** ("I'm having the thought that...") to create distance from thoughts.
* Apply **Cognitive Reframing: Behavior vs. Identity** to separate actions from self-worth.
`
        },
        // ... more yellow zone items
        // --- GREEN ZONE ---
        {
            id: 'green-global-anxiety',
            title: 'Political/Global Events Anxiety',
            category: 'Green Zone',
            color: 'green',
            tags: ['anxiety', 'global events', 'politics', 'eco-anxiety', 'control', 'green'],
            content: `
### Validate
“It makes complete sense that you’re feeling [anxious/angry/overwhelmed] given what’s happening in the world. These are heavy and uncertain times, and your feelings are a very understandable response.”

### Address Fears of Death/Cosmic Insignificance
“A lot of existential dread comes from realizing our own mortality or how small we are in the vast universe. That can be scary, but it can also be seen another way: If nothing ultimately matters on a cosmic scale, then maybe we’re free to create our own meaning here and now.”

### Intervention Insight
Use **Circles of Control, Influence, and Concern** to focus energy effectively.
`
        },
        {
            id: 'green-life-transitions',
            title: 'Life Transitions',
            category: 'Green Zone',
            color: 'green',
            tags: ['transition', 'change', 'graduation', 'new job', 'anxiety', 'green'],
            content: `
### Normalize Anxiety
“Big changes – even positive ones – can be really unsettling. It’s totally normal to feel anxious or unsure when you’re entering a new phase of life. You’re basically stepping into the unknown.”

### Use Old Skills in New Ways
“Remember that even though the context is changing, you’re bringing all your accumulated skills and wisdom with you. Think about other transitions you’ve navigated in the past... What helped you then?”

### Build a Support System
“In times of change, leaning on support is key. Stay connected with your old friends/colleagues even as you make new ones. Talk to people who’ve been through similar transitions.”
`
        },
        // ... more green zone items
    ];

    const interventionsData = [
        {
            id: 'intervention-tipp',
            title: 'TIPP Skill for Rapid Distress Reduction',
            category: 'Intervention',
            color: 'blue',
            tags: ['dbt', 'distress tolerance', 'regulation', 'panic', 'overwhelm'],
            content: `
### Core Rationale
TIPP skills directly target the body's acute stress response, changing your body chemistry and creating a window to re-engage your thinking brain.

### T - Temperature
"First, let's try to change your body temperature. The idea is to create a sudden shift. If you can, go splash some cold water on your face - really let it cover your cheeks and the area under your eyes. This can help slow your heart rate down very quickly when you're agitated."

### I - Intense Exercise
"If you're feeling a lot of restless, built-up energy, a very short burst of exercise can help. Could you do some jumping jacks, run in place as fast as you can, or even just tense and release all your big muscle groups very hard and fast?"

### P - Paced Breathing
"Now, let's focus on slowing your breath. We're going to make your exhale longer than your inhale. Try breathing in deeply through your nose for 4 seconds, and then breathe out very slowly and gently through your mouth for 6 seconds."

### P - Paired Muscle Relaxation
"As you continue breathing slowly, when you breathe in, tense a group of muscles. Let's try that with your hands and arms; inhale through your nose, make tight fists. Hold that tension. Now as you exhale, slowly release the squeeze. Notice the difference."
`
        },
        {
            id: 'intervention-dear-man',
            title: 'DEAR MAN: For Interpersonal Effectiveness',
            category: 'Intervention',
            color: 'blue',
            tags: ['dbt', 'communication', 'assertiveness', 'boundaries', 'needs'],
            content: `
### Core Rationale
A structured way to ask for something you want or to say "no" effectively and assertively.

### D - Describe
"Just the facts. What is the specific, objective situation? (e.g., 'The last three times we planned to meet, you cancelled on the day.')"

### E - Express
"Clearly state your feelings using 'I-statements'. (e.g., 'I feel frustrated and a bit hurt when this happens.')"

### A - Assert
"Clearly state what you need or want. Be direct. (e.g., 'I would like us to find a way to make our plans more reliable...')"

### R - Reinforce
"Explain the positive outcome if your request is met. (e.g., 'It would help me feel more secure in our friendship...')"

### M - (Stay) Mindful
"Keep your focus on your goal. Avoid getting sidetracked."

### A - Appear Confident
"Use a confident tone and body language, even if you feel nervous."

### N - Negotiate
"Be willing to listen and find a workable compromise, but don't give up on your core need."
`
        },
        // ... more interventions
    ];

    const scriptsData = [
        {
            id: 'script-boundary-setting',
            title: 'Foundational Boundary Setting',
            category: 'Script',
            color: 'indigo',
            tags: ['boundaries', 'role setting', 'containment', 'scripts'],
            content: `
### Standard Framing
“Before we get started—my role isn’t for processing, but to make sure you’re safe and help get you grounded so you can rejoin group. We’ve got about 20 minutes, can you tell me what’s going on that brought you to reach out for support?”

### For Clients Expecting Therapy
“My role’s a bit different than a therapist’s—I’m not here to fully process, but I am here to check in on your safety and help you feel a little more steady before heading back to group. Want to tell me what’s weighing on you today?”

### Quick Boundary Phrases
* "I can’t go deep with you here, but I can help you feel safer and more grounded right now."
* "Let’s slow it down together. I’m here to help steady things—not unpack everything."
`
        },
        {
            id: 'script-stabilize',
            title: 'Stabilization Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['stabilize', 'grounding', 'containment', 'validation', 'scripts'],
            content: `
### Validate & Contain
“You’ve been dealing with a lot, and your mind and body are hitting a limit. That’s okay. There’s no rush to fix anything right now. We’re not trying to erase that heaviness — but to hold it in a way that feels manageable enough for this moment."

### Slow Nervous System
“Let’s take a moment to slow things down together. There’s no rush here and no pressure to fix anything. Let's try one slow breath together. Inhale and notice your lungs filling... hold it for a second... now exhale nice and slow."

### Empower & Redirect
“Your courage in acknowledging how intense this feels is really powerful. Remember, our goal isn’t to solve everything right now — it’s just to get you steady enough that you can leave here feeling a bit more centered.”
`
        },
        // ... more scripts
    ];


    // ---- STATE AND DATA ----
    const state = {
        favorites: [],
        checkedScenarios: [],
        recentlyViewed: [],
        contentMap: new Map(),
        currentView: 'dashboard',
        currentOpenScenario: null,
        scratchpadContent: '',
        scratchpadMode: 'write', 
    };

    const colorMap = {
        red: { border: "border-l-4 border-red-500", bg: "bg-red-50 dark:bg-red-900/20" },
        orange: { border: "border-l-4 border-orange-500", bg: "bg-orange-50 dark:bg-orange-900/20" },
        yellow: { border: "border-l-4 border-yellow-500", bg: "bg-yellow-50 dark:bg-yellow-900/20" },
        green: { border: "border-l-4 border-green-500", bg: "bg-green-50 dark:bg-green-900/20" },
        blue: { border: "border-l-4 border-blue-500", bg: "bg-blue-50 dark:bg-blue-900/20" },
        indigo: { border: "border-l-4 border-indigo-500", bg: "bg-indigo-50 dark:bg-indigo-900/20" },
    };

    // ---- DOM REFERENCES ----
    const dom = {
        contentArea: document.getElementById('content-area'),
        searchBox: document.getElementById('search-box'),
        toast: document.getElementById('toast'),
        scenarioModal: document.getElementById('scenario-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalBody: document.getElementById('modal-body'),
        closeModal: document.getElementById('close-modal'),
        usedThisSession: document.getElementById('used-this-session'),
        themeToggle: document.getElementById('theme-toggle'),
        copyModalContentBtn: document.getElementById('copy-modal-content-to-scratchpad'),
        confirmationModal: document.getElementById('confirmation-modal'),
        confirmationTitle: document.getElementById('confirmation-title'),
        confirmationMessage: document.getElementById('confirmation-message'),
        confirmationConfirm: document.getElementById('confirmation-confirm'),
        confirmationCancel: document.getElementById('confirmation-cancel'),
    };

    // ---- STATE PERSISTENCE ----
    function saveState() {
        localStorage.setItem('clinicalFavorites', JSON.stringify(state.favorites));
        localStorage.setItem('clinicalRecents', JSON.stringify(state.recentlyViewed));
        localStorage.setItem('clinicalScratchpad', state.scratchpadContent);
    }

    function loadState() {
        const savedFavorites = localStorage.getItem('clinicalFavorites');
        if (savedFavorites) state.favorites = JSON.parse(savedFavorites);
        const savedRecents = localStorage.getItem('clinicalRecents');
        if (savedRecents) state.recentlyViewed = JSON.parse(savedRecents);
        const savedScratchpad = localStorage.getItem('clinicalScratchpad');
        if (savedScratchpad !== null) state.scratchpadContent = savedScratchpad;
    }

    // ---- INITIALIZATION ----
    function initializeDataMap() {
        clinicalData.forEach(s => state.contentMap.set(s.id, s));
        interventionsData.forEach(s => state.contentMap.set(s.id, s));
        scriptsData.forEach(s => state.contentMap.set(s.id, s));
    }

    // ---- RENDERING ----
    function createScenarioCard(scenario) {
        const isFavorite = state.favorites.includes(scenario.id);
        const colors = colorMap[scenario.color] || colorMap.indigo;
        return `
        <div class="scenario-card bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 flex flex-col ${colors.border}">
            <div class="p-4 flex-1 flex flex-col">
                <h3 class="font-bold text-gray-800 dark:text-gray-100 flex-1">${scenario.title}</h3>
                <div class="mt-3 flex justify-between items-center">
                    <button class="view-btn text-sm text-indigo-600 dark:text-indigo-400 hover:underline" data-id="${scenario.id}">View Details</button>
                    <button class="favorite-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${scenario.id}" title="Add to favorites">
                        <i data-lucide="star" class="w-5 h-5 ${isFavorite ? 'text-yellow-500 fill-current' : 'text-gray-400'}"></i>
                    </button>
                </div>
            </div>
        </div>
        `;
    }

    function renderCardList(container, items, message) {
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
        if (items.length === 0) {
            container.innerHTML = `<div class="col-span-full text-center text-gray-500 py-12">${message}</div>`;
            return;
        }
        container.innerHTML = items.map(createScenarioCard).join('');
        lucide.createIcons();
    }

    function renderDashboard() {
        dom.contentArea.className = '';
        const zones = ['Red Zone', 'Orange Zone', 'Yellow Zone', 'Green Zone'];
        let dashboardHtml = '';

        zones.forEach(zone => {
            const itemsInZone = clinicalData.filter(item => item.category === zone);
            if (itemsInZone.length > 0) {
                const zoneColor = itemsInZone[0].color;
                dashboardHtml += `
                    <div class="mb-10">
                        <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-${zoneColor}-500 text-${zoneColor}-600 dark:text-${zoneColor}-400">${zone}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${itemsInZone.map(createScenarioCard).join('')}
                        </div>
                    </div>
                `;
            }
        });

        dom.contentArea.innerHTML = dashboardHtml;
        lucide.createIcons();
    }

    function renderUsedThisSession() {
        // This function can be expanded later if needed
    }

    function openModal(scenarioId) {
        const scenario = state.contentMap.get(scenarioId);
        if (!scenario) return;

        state.currentOpenScenario = scenario;
        dom.modalTitle.textContent = scenario.title;
        dom.modalBody.innerHTML = marked.parse(scenario.content);
        dom.scenarioModal.classList.remove('hidden');
        
        // Add to recently viewed
        state.recentlyViewed = [scenarioId, ...state.recentlyViewed.filter(id => id !== scenarioId)].slice(0, 20);
        saveState();
        switchView(state.currentView); // Re-render to update recents if visible
    }

    function renderScratchpad() {
        dom.contentArea.className = '';
        dom.contentArea.innerHTML = `
        <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <div class="flex items-center mb-4">
                <i data-lucide="edit-3" class="w-5 h-5 text-teal-500 mr-2"></i>
                <h2 class="text-xl font-bold flex-1">Scratchpad</h2>
                <div class="flex items-center gap-2">
                    <button id="toggle-scratchpad-mode" class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                        ${state.scratchpadMode === 'write' ? 'Preview' : 'Edit'}
                    </button>
                    <button id="clear-scratchpad" class="text-sm text-red-500 hover:underline">Clear</button>
                </div>
            </div>
            <div id="scratchpad-write-area" class="${state.scratchpadMode === 'write' ? '' : 'hidden'}">
                <textarea id="scratchpad-textarea"
                    class="w-full p-4 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 rounded-lg scratchpad-resize text-sm font-mono focus:ring-2 focus:ring-teal-500 focus:outline-none"
                    rows="12"
                    placeholder="Type notes, scripts, or plans here... (Markdown supported)">${state.scratchpadContent || ''}</textarea>
                <div class="flex mt-3 gap-2">
                    <button id="copy-scratchpad" class="flex items-center text-xs px-3 py-1 bg-indigo-100 dark:bg-indigo-900 rounded-md text-indigo-700 dark:text-indigo-200 hover:bg-indigo-200 dark:hover:bg-indigo-800">
                        <i data-lucide="copy" class="w-4 h-4 mr-1"></i>Copy
                    </button>
                    <button id="download-scratchpad" class="flex items-center text-xs px-3 py-1 bg-green-100 dark:bg-green-900 rounded-md text-green-700 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800">
                        <i data-lucide="download" class="w-4 h-4 mr-1"></i>Download
                    </button>
                </div>
            </div>
            <div id="scratchpad-preview-area" class="prose dark:prose-invert max-w-none ${state.scratchpadMode === 'preview' ? '' : 'hidden'} p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg min-h-[12rem] bg-gray-50 dark:bg-gray-900/50">
                ${marked.parse(state.scratchpadContent || '_Nothing here yet. Type in Edit mode!_')}
            </div>
        </div>
        `;
        lucide.createIcons();

        // Re-attach events for scratchpad
        document.getElementById('toggle-scratchpad-mode')?.addEventListener('click', () => {
            state.scratchpadMode = (state.scratchpadMode === 'write') ? 'preview' : 'write';
            renderScratchpad();
        });
        document.getElementById('clear-scratchpad')?.addEventListener('click', () => {
            showConfirmationModal('Clear all notes in your scratchpad?', 'This action cannot be undone.', () => {
                state.scratchpadContent = '';
                saveState();
                renderScratchpad();
                showToast('Scratchpad cleared.', 'success');
            });
        });
        document.getElementById('scratchpad-textarea')?.addEventListener('input', (e) => {
            state.scratchpadContent = e.target.value;
            saveState();
        });
        document.getElementById('copy-scratchpad')?.addEventListener('click', () => copyToClipboard(state.scratchpadContent));
        document.getElementById('download-scratchpad')?.addEventListener('click', downloadScratchpad);
    }

    // ---- TABS & VIEWS ----
    function switchView(viewId) {
        state.currentView = viewId;
        document.querySelectorAll('.sidebar-link').forEach(link => {
            const isSelected = link.dataset.tab === viewId;
            const isScratchpad = viewId === 'scratchpad';
            
            link.classList.toggle('bg-indigo-100', isSelected && !isScratchpad);
            link.classList.toggle('dark:bg-indigo-800', isSelected && !isScratchpad);
            link.classList.toggle('bg-teal-100', isSelected && isScratchpad);
            link.classList.toggle('dark:bg-teal-900', isSelected && isScratchpad);
            link.classList.toggle('text-indigo-700', isSelected && !isScratchpad);
            link.classList.toggle('dark:text-indigo-200', isSelected && !isScratchpad);
            link.classList.toggle('text-teal-700', isSelected && isScratchpad);
            link.classList.toggle('dark:text-teal-200', isSelected && isScratchpad);
            link.classList.toggle('font-semibold', isSelected);
        });

        renderUsedThisSession();
        dom.searchBox.value = ''; // Clear search on tab switch

        if (viewId === 'dashboard') {
            renderDashboard();
            return;
        } else if (viewId === 'scratchpad') {
            renderScratchpad();
            return;
        }

        let items = [];
        let message = 'No items found.';
        if (viewId === 'favorites') {
            items = state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
            message = 'No favorites yet. Click the star on a card to add one.';
        } else if (viewId === 'recents') {
            items = state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
            message = 'No recently viewed items.';
        } else if (viewId === 'interventions') {
            items = Array.from(state.contentMap.values()).filter(item => item.category === 'Intervention');
            message = 'No interventions found.';
        } else if (viewId === 'scripts') {
            items = Array.from(state.contentMap.values()).filter(item => item.category === 'Script');
            message = 'No scripts found.';
        }
        renderCardList(dom.contentArea, items, message);
    }

    // ---- EVENT HANDLERS & LOGIC ----
    function handleContentInteraction(e) {
        const target = e.target;
        if (target.closest('.view-btn')) {
            openModal(target.closest('.view-btn').dataset.id);
        }
        if (target.closest('.favorite-btn')) {
            const id = target.closest('.favorite-btn').dataset.id;
            const isFavorite = state.favorites.includes(id);
            if (isFavorite) {
                state.favorites = state.favorites.filter(favId => favId !== id);
                showToast('Removed from favorites', 'info');
            } else {
                state.favorites.push(id);
                showToast('Added to favorites!', 'success');
            }
            saveState();
            // Re-render current view to reflect favorite change
            switchView(state.currentView);
        }
    }

    dom.searchBox?.addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase().trim();
        if (state.currentView === 'scratchpad') return;

        if (!q) {
            switchView(state.currentView);
            return;
        }
        
        const filtered = Array.from(state.contentMap.values()).filter(
            item =>
                item.title.toLowerCase().includes(q) ||
                (item.content && item.content.toLowerCase().includes(q)) ||
                (item.tags && item.tags.some(tag => tag.toLowerCase().includes(q)))
        );
        renderCardList(dom.contentArea, filtered, 'No matches found for your search.');
    });

    // ---- UTILITIES ----
    function showToast(message, type = 'info') { // types: success, info, error
        const colors = {
            success: 'bg-green-500',
            info: 'bg-gray-600 dark:bg-gray-700',
            error: 'bg-red-500'
        };
        dom.toast.textContent = message;
        dom.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${colors[type]}`;
        dom.toast.classList.remove('hidden');
        dom.toast.classList.add('opacity-100');
        setTimeout(() => { dom.toast.classList.remove('opacity-100'); }, 2700);
        setTimeout(() => { dom.toast.classList.add('hidden'); }, 3000);
    }

    function copyToClipboard(text) {
        // Basic Markdown to plain text conversion
        const plainText = text
            .replace(/###\s/g, '')
            .replace(/##\s/g, '')
            .replace(/#\s/g, '')
            .replace(/\*\*/g, '')
            .replace(/\*/g, '')
            .replace(/_>/g, '');

        const textArea = document.createElement('textarea');
        textArea.value = plainText;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showToast("Copied to clipboard!", 'success');
        } catch (err) {
            showToast("Failed to copy.", 'error');
        }
        document.body.removeChild(textArea);
    }
    
    function downloadScratchpad() {
        const blob = new Blob([state.scratchpadContent], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'scratchpad.md';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        showToast('Scratchpad downloaded.', 'success');
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        dom.confirmationTitle.textContent = title;
        dom.confirmationMessage.textContent = message;
        dom.confirmationModal.classList.remove('hidden');
        
        const confirmHandler = () => {
            onConfirm();
            hideConfirmationModal();
        };
        
        const cancelHandler = () => {
            hideConfirmationModal();
        };

        const hideConfirmationModal = () => {
            dom.confirmationModal.classList.add('hidden');
            dom.confirmationConfirm.removeEventListener('click', confirmHandler);
            dom.confirmationCancel.removeEventListener('click', cancelHandler);
        };
        
        dom.confirmationConfirm.addEventListener('click', confirmHandler);
        dom.confirmationCancel.addEventListener('click', cancelHandler);
    }


    // ---- THEME ----
    function applyTheme(isDark) {
        if (isDark) {
            document.documentElement.classList.add('dark');
            dom.themeToggle.innerHTML = '<i data-lucide="sun" class="w-5 h-5"></i>';
        } else {
            document.documentElement.classList.remove('dark');
            dom.themeToggle.innerHTML = '<i data-lucide="moon" class="w-5 h-5"></i>';
        }
        lucide.createIcons();
    }

    // ---- MAIN INITIALIZATION ----
    function main() {
        loadState();
        initializeDataMap();

        // Event listeners
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => switchView(link.dataset.tab));
        });
        dom.contentArea.addEventListener('click', handleContentInteraction);
        dom.closeModal.addEventListener('click', () => dom.scenarioModal.classList.add('hidden'));
        dom.themeToggle?.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            applyTheme(isDarkMode);
        });
        dom.copyModalContentBtn.addEventListener('click', () => {
            if (state.currentOpenScenario) {
                const contentToCopy = `### ${state.currentOpenScenario.title}\n\n${state.currentOpenScenario.content}`;
                state.scratchpadContent += (state.scratchpadContent ? '\n\n---\n\n' : '') + contentToCopy;
                saveState();
                showToast('Copied to scratchpad!', 'success');
                if (state.currentView === 'scratchpad') {
                    renderScratchpad(); // Refresh if on scratchpad view
                }
            }
        });

        // Initial theme setup
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme === 'dark' || (savedTheme === null && prefersDark));

        // Initial view
        switchView(state.currentView || 'dashboard');
        renderUsedThisSession();
        lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
