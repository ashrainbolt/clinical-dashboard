// Firebase Libraries
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- DATA STRUCTURES (Static content) ---
const clinicalData = {
    "Red": {
        title: "ğŸ”´ Red Zone â€“ Immediate Risk & Crisis",
        color: "red",
        scenarios: [
            {
                title: "Suicidal Ideation â€“ Safety Assessment",
                content: `
                    <h3>ASSESS</h3>
                    <p>"Before we go any deeper, <strong>our priority is always your safety</strong>. Iâ€™d like to ask a few questions that help us <strong>understand how youâ€™re doing and what kind of support might help keep you safe right now.</strong></p>
                    <ol class='list-decimal list-inside space-y-2 mt-2'>
                        <li>Have you wished you were dead or that you could go to sleep and not wake up?</li>
                        <li>Have you <strong>actually had any thoughts of killing yourself?</strong></li>
                        <li>In the past 48 hours, <strong>have you been thinking about how you might do this?</strong></li>
                        <li>In the past 48 hours, <strong>have you had these thoughts and had some intention of acting on them?</strong></li>
                        <li><strong>In the past 48 hours, have you started to work out any details for how to kill yourself?</strong> Do you intend to carry out this plan?</li>
                        <li>In the past 48 hours <strong>have you done anything to prepare to end your life?</strong></li>
                    </ol>
                    <p class='mt-2'>* If <strong>Yes to 4, 5, or 6?</strong> Ask scaling questions:</p>
                    <p>"On a scale of 1-5, <strong>one meaning you feel you can stay safe today, and five meaning that you're going to make an attempt today, where would you place yourself right now?</strong>"</p>
                    <h4>Reflect back answer:</h4>
                    <ul>
                        <li>"So a four means to me you have a plan and some intentions on acting on the plan, you just donâ€™t know when. Is that accurate?"</li>
                        <li>"A three means to me you have strong thoughts of wanting to die and have thought about ways you might act on it, but you donâ€™t have a specific plan. Did I get that right?"</li>
                        <li>"A two means to me that you have fleeting thoughts of wanting to end your life, but no plan or intention of acting on it."</li>
                    </ul>
                    <p>â€œIâ€™m really glad you told me this. It takes a lot of strength to be this honest, and Iâ€™m here to help you figure it out.â€</p>
                    <h3 class='mt-4'>SAFETY PLAN</h3>
                    <p><strong>Need to escalate:</strong> â€œThank you for telling me that. If it sounds like things are starting to feel more intense or harder to manage on your own, Iâ€™d like to connect you with a Crisis Manager â€” who can better support you and help figure out the next steps to keep you safe.â€</p>
                    <ul>
                        <li><strong>Warning Signs:</strong> â€œWhat are some earlyã€å†å†å†å†å†What are some early signs you notice when things start to spiral?â€ â€” Maybe isolating/ feeling numb or detached.</li>
                        <li><strong>Internal Coping:</strong> â€œWhat can you try on your own that sometimes helps, even a little â€” engaging in something creative, putting on funny animal videos or stand-up clips, taking a hot shower, organizing a small space, or wrap up in something cozy and allow yourself to rest?â€</li>
                        <li><strong>Social Distractions:</strong> â€œWho or what helps you shift your focus â€” even briefly? A friend, a safe space, a show, a pet?â€</li>
                        <li><strong>People to Reach Out To:</strong> â€œIf things feel too big to hold alone, who could you reach out to â€” even just to sit with you or check in?â€</li>
                        <li><strong>Professional Resources:</strong> â€œDo you have Charlie Healthâ€™s 24/7 crisis line saved in your phone? If youâ€™d like, I can text it to you right now so itâ€™s already saved in your phone.â€</li>
                        <li><strong>Safety at Home:</strong> â€œIs there anything nearby that might feel unsafe to have around right now â€” something we could move, lock up, or ask someone to hold onto for a while?â€</li>
                        <li><strong>Reasons to Stay:</strong> â€œWhen things get dark, whatâ€™s something â€” or someone â€” that reminds you thereâ€™s still a reason to hang on?â€</li>
                    </ul>
                    <h3>CLOSURE & FOLLOW-UP</h3>
                    <p>â€œThank you for staying with this. I know itâ€™s not easy, and I really appreciate how honest youâ€™ve been.â€</p>
                    <p><strong>If no immediate risk:</strong> â€œLetâ€™s make sure your safety plan is saved somewhere easy to find â€” and Iâ€™ll send a quick update to your therapist so theyâ€™re looped in and can follow up with you.â€</p>
                    <p><strong>If escalated to Crisis Manager:</strong> â€œTheyâ€™ll take it from here, but Iâ€™ll stay until theyâ€™re with you so youâ€™re not left alone in this.â€</p>
                    <p>â€œYouâ€™ve done something really important by talking about this instead of holding it in. That shows strength â€” and you donâ€™t have to go through this alone.â€</p>
                `,
                id: "suicidal-ideation"
            },
            {
                title: "Self-Harm Urges (Non-Suicidal Self-Injury)",
                content: `
                    <h3>Direct Check-In</h3>
                    <p>â€œThank you for telling me. I need to ask: Are you having urges to hurt yourself right now?â€</p>
                    <p>If yes: â€œOn a scale from 1 to 10, how strong is the urge right now, 10 being the strongest?â€</p>
                    <p>â€œHave you acted on that urge today or recently?â€</p>
                    <p>If yes: â€œWhat did you do, and how severe was it? Do you need any medical attention for that (any injury or bleeding that needs care)?â€</p>
                    <h3>Clarify Intent</h3>
                    <p>â€œWhen you self-harmed, was it because you wanted to die, or was it more about coping with pain or numbness?â€</p>
                    <h3>Validate & Normalize</h3>
                    <p>â€œIt sounds like everything is feeling really intense right now. Iâ€™m really glad youâ€™re talking about it instead of keeping it inside or acting on it alone.â€</p>
                    <p>â€œThat urge makes sense given what youâ€™re carrying. A part of you is trying to survive and find relief, even if itâ€™s doing it in a way that ends up hurting you. Letâ€™s see if we can work with that part in a safer way.â€</p>
                    <h3>Offer Alternatives & Coping Strategies</h3>
                    <p>Ask Their Coping: â€œWhat usually helps even a little when you feel this urge? Maybe we can try one of those things together now.â€</p>
                    <p>Intense Physical Sensations (<a class="intervention-link" data-intervention="TIPP Skill">TIPP Skill</a>): â€œSometimes our body needs a very strong sensation to release that tension. We could try holding something frozen (like ice), doing a wall-sit or some push-ups, or splashing really cold water on your face. If the feelings are overwhelming, an intense sensory jolt can ground you for a moment.â€</p>
                    <p>If they feel numb or disconnected: â€œIf youâ€™re feeling really numb, we might try something stimulating: hold a strong scent under your nose (like an essential oil or even vinegar), chew a piece of something very sour or spicy, or name as many objects around you as you can as fast as possible. It might feel odd, but it can activate your senses.â€</p>
                    <p>â€œUrge Surfingâ€ Technique: â€œRemember, urges are like waves â€” they build, peak, and eventually fall. Letâ€™s try to ride this wave out together. You donâ€™t have to act on it; just notice it rise and watch it start to come down. Iâ€™m here with you through it.â€</p>
                    <p>Quick Grounding Distraction: â€œLetâ€™s give your brain a short break. Can you name for me five things you see in the room around you that are [pick a color]? (e.g., anything thatâ€™s blue).â€</p>
                    <p>Safe Physical Release: â€œSometimes doing something physical can help release the feeling safely. Would it help to rip up some paper, squeeze a stress ball, stomp your feet, or even scream into a pillow? Letâ€™s channel that energy out without hurting yourself.â€</p>
                    <h3>Reduce Access to Harm Means</h3>
                    <p>â€œDo you have anything nearby that youâ€™ve thought about using to hurt yourself? Would it help if we moved those out of reach, just for now, so itâ€™s a little harder to act on the urge?â€</p>
                    <h3>Strengthen Support</h3>
                    <p>â€œWho or what helps you feel a bit more stable when you get like this? Is there a friend or family member you might reach out to after this, or a safe place you can go where youâ€™re not alone?â€</p>
                    <h3>Commitment to Safety</h3>
                    <p>â€œI know the urge is strong, but do you feel like you can stay safe tonight (or until you see your therapist next)? Even if the urge comes back, can you promise me youâ€™ll try these coping steps or reach out for help before doing anything to hurt yourself?â€</p>
                    <h3>Encourage and Affirm</h3>
                    <p>â€œIâ€™m really proud of you for being open about this â€” it takes a lot of courage to face these urges and choose not to give in. Every time you ride the wave or use a tool instead of hurting yourself, itâ€™s a victory. Youâ€™re showing so much strength by just staying with me and trying. You deserve to stay safe, and youâ€™re not alone. We will get through this, one moment at a time.â€</p>
                `,
                id: "self-harm-urges"
            },
            {
                title: "Hallucinations or Disturbing Perceptual Experiences",
                content: `
                    <h3>Acknowledge Experience (Donâ€™t Dismiss)</h3>
                    <p>â€œThank you for telling me. I can imagine this feels really intense and scary. I want you to know Iâ€™m here with you, and I believe that youâ€™re experiencing this.â€</p>
                    <h3>Safety Check (Calm & Direct)</h3>
                    <p>â€œAre the things youâ€™re hearing or seeing telling you to hurt yourself or anyone else?â€</p>
                    <p>â€œDo you feel safe in your body and environment right now?â€</p>
                    <p>â€œAre you able to recognize that what youâ€™re experiencing might be a hallucination, or does it feel completely real to you?â€</p>
                    <h3>Orient to Present (Ground in Shared Reality)</h3>
                    <p>â€œLetâ€™s try something together to bring you into the here and now with me, okay? For example, can you look around the room and name one thing you see thatâ€™s familiar to you?â€</p>
                    <p>â€œPut your feet flat on the floor for me. Press them down a little and notice that sensation. Feel that? Youâ€™re right here, in this moment, with me. Weâ€™re safe right now.â€</p>
                    <p>If theyâ€™re hearing voices: â€œI know you hear those voices, but try to also hear my voice. Focus on my voice and the sound of my words right now. Weâ€™re in this room (or on this call) together.â€</p>
                    <h3>Calm Reassurance</h3>
                    <p>â€œYouâ€™re doing really well. Iâ€™m going to stay right here with you. The things youâ€™re perceiving can feel real, but I want you to keep noticing the ground under your feet, the sound of my voice. Weâ€™re in the present moment.â€</p>
                    <h3>Close the Loop</h3>
                    <p>â€œYou did a great job staying with me through that. That took a lot of strength. I know it was intense, but you came back to right now, and Iâ€™m really proud of you for that. Youâ€™re safe here. If it happens again, remember youâ€™re not alone and it will pass. We will let your therapist know about this so they can help you find ways to cope if these experiences continue.â€</p>
                `,
                id: "hallucinations"
            },
            {
                title: "Acute Medical Crisis",
                content: `
                    <h3>Immediate Action â€“ Take Charge</h3>
                    <p>â€œOkay, I see/hear that something serious might be happening physically. The most important thing right now is getting you medical help immediately.â€</p>
                    <h3>Instruct to Call Emergency</h3>
                    <p>â€œAre you able to call 911 (or your local emergency number) right now? Is there someone with you who can call for you?â€</p>
                    <p>If they cannot call: â€œIt sounds like you canâ€™t call on your own. Iâ€™m going to get you help. Do I have your permission to call 911 for you right now to get an ambulance? Iâ€™ll need to tell them where you are.â€</p>
                    <p>Obtain location: â€œTell me your exact address (and any apartment or room number) so the paramedics can find you quickly.â€</p>
                    <h3>Keep Them Engaged While Help Comes</h3>
                    <p>â€œHelp is on the way. Iâ€™m right here with you. Try to stay as calm as you can â€“ focus on taking slow breaths with me if possible. Inâ€¦ and outâ€¦ nice and easy.â€</p>
                    <p>â€œIf you start to feel worse or anything changes, tell me immediately. Iâ€™m staying on the line until help arrives.â€</p>
                    <p>â€œIf you can, unlock your door so the medics can get in. And if thereâ€™s a neighbor or someone nearby, let them know whatâ€™s happening if possible.â€</p>
                    <h3>After Emergency Arrives (Closing)</h3>
                    <p>â€œIt sounds like the paramedics are there with you now. Youâ€™re in good hands. Iâ€™m going to let you go so they can take over. Iâ€™ll make sure our team knows what happened. Youâ€™re going to get the care you need â€“ you did the right thing. Iâ€™ll be thinking of you, and weâ€™ll follow up as soon as we can to see how youâ€™re doing.â€</p>
                `,
                id: "acute-medical-crisis"
            },
            {
                title: "Substance Overdose or Severe Intoxication",
                content: `
                    <h3>Recognize Seriousness (Calm & Clear)</h3>
                    <p>â€œI can tell this is serious. Iâ€™m very concerned that you might be experiencing a medical emergency from substances.â€</p>
                    <p>â€œYou mentioned you took [X amount of Y]. That can be dangerous.â€</p>
                    <h3>Instruct to Call Emergency</h3>
                    <p>â€œThis is urgent. Are you able to call 911 right now for medical attention? Or is there someone with you who can call?â€</p>
                    <p>If they cannot call: â€œIf you canâ€™t call, I will. I need to get you an ambulance right now. Is it okay if I call 911 for you? Iâ€™ll need your exact location and any info on what you took.â€</p>
                    <p>Get essential info: â€œWhatâ€™s the address where you are right now? And do you know exactly what substance(s) you took, about how much, and roughly when? Iâ€™ll pass that to the paramedics â€“ itâ€™s really important for your treatment.â€</p>
                    <p>Naloxone (If Opioid Overdose suspected): â€œIf this might be an opioid overdose and if you or anyone there has Naloxone (Narcan) and knows how to use it, please use it now while we wait for the ambulance.â€</p>
                    <h3>Keep Them Awake & Oriented</h3>
                    <p>â€œStay with me, okay? Help is coming. Try to stay awake and keep talking to me. I know youâ€™re very drowsy, but focus on my voice. Youâ€™re doing great, just hang in there a little longer.â€</p>
                    <p>â€œIf you can, try to take some slow breaths. In through your nose, out through your mouthâ€¦ good. Keep breathing.â€</p>
                    <p>â€œIs your door unlocked for the paramedics? If youâ€™re able to, unlock it or have someone ready to open it for them.â€</p>
                    <h3>After Emergency Takes Over</h3>
                    <p>â€œThe paramedics are with you now? Okay. Theyâ€™re going to take care of you. Iâ€™m going to step back and let them do that. Youâ€™re in good hands. I know this is scary, but youâ€™re getting the help you need. Iâ€™ll make sure your care team knows what happened so we can support you after this. Take care â€“ youâ€™re not alone and youâ€™re going to get through this.â€</p>
                `,
                id: "substance-overdose"
            },
            {
                title: "Unsafe Home Environment / Domestic Violence",
                content: `
                    <h3>Express Empathy and Belief</h3>
                    <p>â€œThank you for sharing this with me. I canâ€™t imagine how hard it was to say that out loud. I want you to know I believe you, and you didnâ€™t deserve any of this.â€</p>
                    <p>â€œItâ€™s incredibly brave of you to talk about whatâ€™s happening at home. Youâ€™re not at fault for their behavior.â€</p>
                    <h3>Assess Immediate Safety</h3>
                    <p>â€œAre you safe right now? Is the person who hurt you nearby or likely to return soon?â€</p>
                    <p>â€œAre there children or anyone else in the home who might also be in danger right now?â€</p>
                    <p>If immediate danger: â€œYour safety is the number one priority. If you think youâ€™re in immediate danger, we should consider calling 911. Do you feel like you need emergency help right now to stay safe?â€</p>
                    <h3>Provide Control & Options</h3>
                    <p>â€œYou know your situation best, and Iâ€™m here to support whatever you choose to do. There are people who specialize in helping in situations like yours. For example, have you heard of the National Domestic Violence Hotline? They have advocates 24/7 at 1-800-799-7233 who can help you make a safety plan or find resources. We can call them together if you want, or I can give you that information to reach out when youâ€™re ready.â€</p>
                    <p>â€œIs there a friend or family member you trust whom you could stay with, or at least talk to, about whatâ€™s happening?â€</p>
                    <p>â€œIf you ever feel unsafe and need to leave quickly, do you have a bag with essentials and important documents prepared? We can brainstorm that if you want.â€</p>
                    <h3>Empower & Validate</h3>
                    <p>â€œYou are not alone and there are people who want to help. You deserve to be safe. None of this is your fault â€” the responsibility lies with the person hurting you.â€</p>
                    <p>â€œWhatever you decide, Iâ€™ll support you. Youâ€™re doing the right thing by reaching out. Weâ€™ll also let your primary therapist know what youâ€™ve shared (unless you have concerns about that) so that we can all be on the same page to help keep you safe.â€</p>
                    <h3>Commitment</h3>
                    <p>â€œUntil we figure out longer-term steps, can you promise me youâ€™ll prioritize your safety? If things get dangerous, please get out and get somewhere safe if you can, and call emergency services. Youâ€™re important, and we want you alive and okay.â€</p>
                    <h3>Closing Assurance</h3>
                    <p>â€œIâ€™m really glad you told me. You didnâ€™t deserve any of this, and you deserve support. We will do everything we can to help you be safe. Youâ€™re not alone in this.â€</p>
                `,
                id: "unsafe-home"
            },
            {
                title: "Child Abuse or Neglect Disclosure",
                content: `
                    <h3>Respond with Care</h3>
                    <p>â€œThank you for telling me that. I know itâ€™s not easy to talk about. I am so sorry this happened to you (or to that child). No one, especially no child, should have to go through that. Itâ€™s absolutely not your fault, and you didnâ€™t deserve that.â€</p>
                    <h3>Explain Mandated Reporting (Transparent and Reassuring)</h3>
                    <p>â€œI need you to know: because you shared this, Iâ€™m required by law to take steps to report it to the proper authorities so that the child can get help and be safe. This isnâ€™t to get anyone in trouble; itâ€™s to protect you/them and make sure it doesnâ€™t continue. As a mandated reporter, I have to let child protection professionals know when a minor is being hurt or is in danger.â€</p>
                    <p>â€œWhat this means is that I will write down what you told me and contact Child Protective Services (or the appropriate agency) after our conversation. They may need to ask more questions to make sure everyone is safe.â€</p>
                    <p>â€œI know that might sound scary, but my goal and their goal is to keep you (or that child) safe. You are not in any trouble for telling me â€“ in fact, you did exactly the right thing by telling someone. This is how we can get help.â€</p>
                    <h3>Support the Clientâ€™s Emotions</h3>
                    <p>â€œHow are you feeling now that youâ€™ve shared that? Itâ€™s a lot, I know. Whatever youâ€™re feeling â€“ scared, relieved, angry â€“ itâ€™s completely understandable.â€</p>
                    <p>â€œIâ€™m here with you. Youâ€™re not alone in dealing with this anymore.â€</p>
                    <h3>Empower & Involve (If appropriate)</h3>
                    <p>â€œIf you want, we can talk about what happens next or any worries you have. I canâ€™t control what CPS or others do, but I can be here with you through the process. We can also involve your therapist; they will definitely want to support you through this as well.â€</p>
                    <p>â€œIs there someone you feel safe with that youâ€™d like to have with you for support after this call? I want to make sure youâ€™re not alone if you donâ€™t want to be.â€</p>
                    <h3>Closing Reassurance</h3>
                    <p>â€œI know this was a big step to tell me. You were very brave to speak up. Remember: you didnâ€™t do anything wrong by telling the truth. Whatâ€™s wrong is that it happened to you (or is happening to that child), and now we have a chance to get help. Youâ€™re not alone, and weâ€™re going to do everything we can to make sure youâ€™re safe.â€</p>
                `,
                id: "child-abuse"
            },
            {
                title: "Threat of Harm to Others (Homicidal Ideation)",
                content: `
                    <h3>Immediate Clarification (Calm & Firm)</h3>
                    <p>â€œI hear you saying you want to hurt someone. I take that very seriously, and I need to ask you a few questions to understand better, because my job is to keep everyone safe.â€</p>
                    <p>â€œAre you talking about a specific person? Who are you thinking of harming?â€</p>
                    <p>â€œHave you thought about how you would do it? Do you have a plan in mind?â€</p>
                    <p>â€œDo you have access to any weapons or tools (like guns or knives) that youâ€™ve thought about using?â€</p>
                    <p>â€œOn a scale of 1 to 10, how strong is the urge or intent to act on this right now?â€</p>
                    <h3>Duty to Protect Explanation</h3>
                    <p>â€œOkay, I need you to know: because youâ€™re talking about harming someone else, I have a responsibility to make sure that person (and everyone) stays safe. That may mean involving other professionals or authorities right away. I want us to work together on this if possible.â€</p>
                    <h3>Offer Emergency Help</h3>
                    <p>â€œDo you feel like you might actually act on these thoughts soon? If you do, we should get you emergency help right now. I can call 911 to help keep you and everyone safe. Would you be willing to accept that help?â€</p>
                    <p>If resistant to emergency intervention: â€œI understand youâ€™re furious. I canâ€™t let anyone get hurt, including you. I might have to notify the police or a crisis team about what youâ€™ve told me to ensure everyoneâ€™s safety. I wanted to tell you that directly because I respect you and I want you to know whatâ€™s happening.â€</p>
                    <h3>De-escalate Anger</h3>
                    <p>â€œI get that youâ€™re extremely angry. That anger is telling us something important â€” you feel deeply hurt or wronged. Iâ€™m here to listen to that. Letâ€™s slow this down and sit with whatâ€™s coming up, instead of letting it boil over or go numb. Tell me whatâ€™s fueling this anger so strongly.â€</p>
                    <p>â€œNo one is saying your feelings arenâ€™t valid. You have every right to feel angry. Letâ€™s talk about it, because acting on it violently could ruin your life as well. I donâ€™t want that for you.â€</p>
                    <p>â€œYouâ€™re picturing getting revenge because youâ€™re in a lot of pain. I hear that. Hurting someone might feel like it would release that pain or justice, but it could also create more problems for you. Letâ€™s find a way to deal with this that doesnâ€™t destroy your life or anyone elseâ€™s.â€</p>
                    <h3>Negotiate a Safety Plan</h3>
                    <p>â€œCan you promise me you will not act on these thoughts, at least for now, and letâ€™s focus on what you need? I want to help you find a better way to handle this anger. Maybe we involve your therapist or someone you trust right after this, so youâ€™re not alone with these feelings.â€</p>
                    <p>â€œIf you feel like youâ€™re going to hurt them, please call 911 or go somewhere safe away from the person. We can let someone know to protect that person, but Iâ€™d much rather help you get through this without anyone getting hurt.â€</p>
                    <h3>Follow-Up and Reporting</h3>
                    <p>â€œI know you might not want me to, but I will have to inform my team (and possibly the authorities) about what you told me, because I care about everyoneâ€™s safety. My hope is that this helps get you more support too, not just protect the other person.â€</p>
                    <h3>Close (Supportive, not Judging)</h3>
                    <p>â€œI want you to know Iâ€™m not against you. In fact, Iâ€™m on your side â€“ the part of you that doesnâ€™t want to throw your life away on this. Thank you for being honest with me. Youâ€™re dealing with incredibly powerful feelings. Weâ€™re going to do everything we can to keep you and everyone safe. Youâ€™re not alone in this, even if you feel enraged and hurt. Weâ€™ll get you help to deal with these feelings safely.â€</p>
                `,
                id: "threat-of-harm"
            },
            {
                title: "Under the Influence (Non-Crisis)",
                content: `
                    <h3>Immediate Safety Check</h3>
                    <p>"Hi. Iâ€™m just checking in with you briefly. It was noticed in group that [specific observation, e.g., â€˜you seemed a bit sleepy,â€™ or â€˜it looked like you were having a hard time following the discussionâ€™]. How are you doing right now?"</p>
                    <p>"Part of my role is to support everyone in group. Itâ€™s really important for group that everyone can be fully present and engaged. Can you tell me a bit about how youâ€™re feeling at this moment?"</p>
                    <p><strong>Potential overdose / danger:</strong> â€œBased on what youâ€™re telling me, Iâ€™m concerned for your safety. We might need to get medical help.â€ (Pivot to Substance Overdose scenario if needed.)</p>
                    <h3>If Client Admits Use or Impairment is Clear</h3>
                    <p>"As you know, our group policy requires members to be sober and not under the influence during sessions. This is mainly to make sure you and everyone else can participate safely and get the full benefit of the therapy."</p>
                    <p>"My main priorities right now are your immediate safety and ensuring the group remains a focused therapeutic space."</p>
                    <h3>Stating the Need to Log Off (Clear, Kind, Firm - Non-negotiable)</h3>
                    <p>"Because it appears youâ€™re under the influence right now, and in line with the group policy for everyoneâ€™s safety and benefit, I am going to need you to log off from the group session for the rest of today."</p>
                    <p>"This isnâ€™t a punishment, but itâ€™s a necessary step to ensure your well-being and to maintain the groupâ€™s therapeutic environment. We need all members to be fully present and sober to participate."</p>
                    <h3>Brief Safety Assessment (Essential before log-off)</h3>
                    <p>"Before you log off for the day, my top priority is to make sure youâ€™re going to be safe. Are you in a safe place physically right now? Is there anyone with you, or someone responsible you can contact if you start to feel unwell or need help?"</p>
                    <h3>Explain Next Steps</h3>
                    <p>â€œBecause you were under the influence and had to step out of group, I will let your primary therapist know what happened, just so theyâ€™re in the loop and can support you. They might want to check in with you about it later and help you plan for moving forward.â€</p>
                    <p>â€œAfter we hang up, is there someone who can be with you or check on you? If not, is there something safe and calming you can do for the rest of the day/night? Iâ€™d feel better knowing youâ€™re just resting or in a safe space while this wears off.â€</p>
                    <h3>Encourage Self-Compassion & Support</h3>
                    <p>â€œItâ€™s easy to feel down on yourself in moments like this, but youâ€™re not alone and youâ€™re not the first person to use [substance]. The important thing is youâ€™re safe. We care about you and want to help you get back on track.â€</p>
                    <p>â€œIf youâ€™re up for it later, maybe think about what led you to use today and we can talk about better ways to handle that urge next time. But for now, just focus on taking care of yourself.â€</p>
                    <h3>Close on a Positive Note</h3>
                    <p>â€œIâ€™m glad we could talk even for a little bit. Make sure you get some rest, drink water, maybe eat something light when you can. Youâ€™re going to be okay. Weâ€™ll talk again soon, and your therapist will also reach out to support you. Youâ€™re not alone, okay? Take care of yourself.â€</p>
                `,
                id: "under-influence"
            }
        ]
    },
    "Orange": {
        title: "ğŸŸ  Orange Zone â€“ High Distress",
        color: "orange",
        scenarios: [
            {
                title: "Highly Agitated or Escalating",
                content: `
                    <h3>Center and Slow the Moment</h3>
                    <p>â€œI can see (or hear) how agitated you are. Letâ€™s take a pause for a second. Iâ€™m right here with you. You donâ€™t have to go through this moment alone.â€</p>
                    <p>â€œItâ€™s okay to feel everything youâ€™re feeling. I just want to help you not feel so overwhelmed by it all at once. Can we try to take one slow breath together?â€</p>
                    <h3>Acknowledge the Anger/Frustration</h3>
                    <p>â€œThat energy and anger youâ€™re feeling right now â€” it makes sense. Something important is going on inside you and itâ€™s demanding to be heard.â€</p>
                    <p>â€œThis anger is telling us something important. I hear that youâ€™ve been pushed to your limit. Iâ€™m listening.â€</p>
                    <h3>Keep Voice Calm & Assuring</h3>
                    <p>â€œIâ€™m not going anywhere. I know youâ€™re really upset, and itâ€™s okay. Letâ€™s stay right here. Youâ€™re safe with me to let it out, as long as we keep each other safe.â€</p>
                    <p>If they are pacing or shaking: â€œItâ€™s okay if you need to move. Iâ€™ll move a bit with you. Letâ€™s walk together and breathe, no rush.â€</p>
                    <h3>Encourage Expression vs. Explosion</h3>
                    <p>â€œLetâ€™s slow this down and sit with whatâ€™s coming up, instead of letting it boil over or shutting it down. Whatâ€™s the strongest thing on your mind right now? Iâ€™m here to listen.â€</p>
                    <p>â€œYou donâ€™t have to hold back â€” I can handle whatever it is. Go ahead and tell me whatâ€™s going on, Iâ€™m listening.â€</p>
                    <h3>Validation</h3>
                    <p>â€œAnyone in your situation would feel upset. Itâ€™s okay to feel this. We just want to keep it from hurting you or anyone else while itâ€™s so strong.â€</p>
                    <p>â€œYou have every right to feel the way you do. Letâ€™s channel it in a way that helps you, not hurts you.â€</p>
                    <h3>Grounding in Present</h3>
                    <p>If they seem disoriented by emotion: â€œLook at me for a second and take a breath. Weâ€™re right here, in this room (or on this call). Youâ€™re doing okay. Just keep breathing. Thatâ€™s it.â€</p>
                    <h3>After Calming Slightly â€“ Reflection</h3>
                    <p>â€œThat was a lot. You did really well slowing down just now. This is hard stuff, and youâ€™re handling it. When youâ€™re ready, maybe we can figure out what you need next or how I can help further.â€</p>
                    <p>â€œI know youâ€™re still upset, but youâ€™re also in control right now â€” youâ€™re talking to me and breathing, and thatâ€™s a big win. Weâ€™ll let your therapist know how hard this was for you today so they can support you more with it.â€</p>
                `,
                id: "highly-agitated"
            },
            {
                title: "Acute Anxiety or Panic Attack",
                content: `
                    <h3>Immediate Physiological Regulation (<a class="intervention-link" data-intervention="TIPP Skill">TIPP Skills</a>)</h3>
                    <p>"Right now, your body is in fight-or-flight mode. Letâ€™s try something called TIPP to help calm your nervous system quickly."</p>
                    <p>"First, letâ€™s try Temperature. Can you splash some cold water on your face, or hold a cold water bottle or ice cube if you have one? This triggers something called the â€˜dive responseâ€™ that naturally slows your heart rate."</p>
                    <p>[If they canâ€™t access cold, continue with breathing]</p>
                    <p>"Now letâ€™s try Paced Breathing. Weâ€™re going to breathe together in a way that tells your nervous system itâ€™s safe to calm down. Breathe in through your nose for 4 countsâ€¦ hold for a secondâ€¦ and out through your mouth for 6 counts. Letâ€™s do that a few times."</p>
                    <h3>Normalize & Reassure</h3>
                    <p>â€œWhat youâ€™re experiencing is a panic attack. It feels really scary, but I promise itâ€™s not life-threatening. You are going to be okay. Iâ€™m right here.â€</p>
                    <h3>Orient to Safety (<a class="intervention-link" data-intervention="5-4-3-2-1 Technique">5-4-3-2-1 Technique</a>)</h3>
                    <p>â€œLetâ€™s name five things you see in the room. Good. Now four things you can feelâ€¦ three things you can hearâ€¦ two things you can smellâ€¦ and one thing you can taste.â€</p>
                    <h3>Permission to Pause</h3>
                    <p>â€œWe donâ€™t need to unpack everything right now. In fact, we shouldnâ€™t dive deeper into anything heavy at this moment, because I want to make sure you donâ€™t leave here feeling even worse.â€</p>
                `,
                id: "acute-anxiety"
            }
            // Add other Orange Zone scenarios as needed from document
        ]
    },
    "Yellow": {
        title: "ğŸŸ¨ Yellow Zone â€“ Moderate Challenges",
        color: "yellow",
        scenarios: [
            {
                title: "Resistant / Ambivalent About Therapy",
                content: `
                    <h3>Acknowledge Autonomy</h3>
                    <p>â€œItâ€™s okay if youâ€™re not sure about this or even if you donâ€™t want help right now. Youâ€™re in control here â€“ Iâ€™m not going to force anything on you.â€</p>
                    <h3>Gently Explore Resistance</h3>
                    <p>â€œCan I ask, whatâ€™s your biggest concern about accepting help? If youâ€™d rather not say, thatâ€™s fine, but if we talk about it, maybe we can address it together.â€</p>
                    <h3>Subtle Encouragement</h3>
                    <p>â€œYouâ€™ve been fighting your battles alone for a while. Thatâ€™s impressive. Needing or accepting help doesnâ€™t make you weak â€“ if anything, it can lighten the load so you can keep going strong.â€</p>
                    <h3>End on Respect</h3>
                    <p>â€œI respect you for being honest that youâ€™re not into this right now. Thatâ€™s actually really helpful for me to know. How about we check in about it later? If you decide you want something from me, just say the word.â€</p>
                `,
                id: "resistant-therapy"
            }
            // Add other Yellow Zone scenarios as needed from document
        ]
    },
    "Green": {
        title: "ğŸ’š Green Zone â€“ Growth & Skill-Building",
        color: "green",
        scenarios: [
            {
                title: "Political/Global Events Anxiety",
                content: `
                    <h3>Validate</h3>
                    <p>â€œIt makes complete sense that youâ€™re feeling [anxious/angry/overwhelmed] given whatâ€™s happening in the world. These are heavy and uncertain times, and your feelings are a very understandable response.â€</p>
                    <h3>Focus on Control vs. Concern</h3>
                    <p>â€œOne thing that can help is to separate what you can control from what you canâ€™t. We canâ€™t single-handedly solve [the big issue], but we can control small actions in our own lives.â€</p>
                    <h3>Encourage Active Coping</h3>
                    <p>â€œSometimes taking action, even tiny ones, can restore a sense of control. It might be donating $5 to a cause, signing a petition, or simply helping a neighbor.â€</p>
                    <h3>Set Healthy Boundaries with Media</h3>
                    <p>â€œHow much news are you consuming daily? It might be worth setting some boundaries. Maybe choose one reliable news summary a day, and give yourself permission to unplug after that.â€</p>
                `,
                id: "political-anxiety"
            }
            // Add other Green Zone scenarios as needed from document
        ]
    }
};

const interventionsData = {
    "Distress Tolerance": [
        {
            title: "TIPP Skill",
            content: `
                <h4>Temperature, Intense Exercise, Paced Breathing, Paired Muscle Relaxation</h4>
                <p>Use for rapid physiological de-escalation when emotions are intensely overwhelming.</p>
                <p><strong>T - Temperature:</strong> "Sometimes the body just needs a jolt to interrupt the overwhelm. Letâ€™s try a quick temperature shock: we could splash a bit of cold water on your face or hold this cold bottle against your skin. That sudden sensation might help your system reset just enough."</p>
                <p><strong>I - Intense Exercise:</strong> "Letâ€™s use your body to help calm things down. Try clenching all your muscles tight for a few seconds â€” squeeze your fists, arms, even your legs â€” and then release. Weâ€™ll do it together. That kind of full-body tension and release can let out some of the intensity youâ€™re feeling."</p>
                <p><strong>P - Paced Breathing:</strong> "Letâ€™s slow your breath. Breathe in for 4 counts, and breathe out slowly for 6 counts. The longer exhale calms your nervous system."</p>
                <p><strong>P - Paired Muscle Relaxation:</strong> "As you breathe in, tense a muscle group, like your fists. As you breathe out, release the tension completely. Notice the difference."</p>
            `,
            id: "tipp-skill"
        },
        {
            title: "ACCEPTS (Distraction)",
            content: `
                <h4>Activities, Contributing, Comparisons, Emotions, Pushing Away, Thoughts, Sensations</h4>
                <p>Use to temporarily distract from distress until youâ€™re in a better state to cope.</p>
                <p><strong>A - Activities:</strong> "Letâ€™s find something to do that takes your focus â€” maybe a puzzle, a game, or cleaning something small."</p>
                <p><strong>C - Contributing:</strong> "Doing something small for someone else can shift your mood. Could you send a kind text or help someone out?"</p>
                <p><strong>C - Comparisons:</strong> "Think about a time you felt worse than this. How did you get through it then?"</p>
                <p><strong>E - Emotions:</strong> "Letâ€™s stir up a different emotion. Want to watch a funny video or listen to an upbeat song?"</p>
                <p><strong>P - Pushing Away:</strong> "Imagine putting this problem in a box and setting it aside for just 10 minutes."</p>
                <p><strong>T - Thoughts:</strong> "Fill your mind with something else â€” count backwards from 100 by 7s, or name all the states you can think of."</p>
                <p><strong>S - Sensations:</strong> "Grab something with a strong sensation â€” a sour candy, a cold drink, a textured object â€” and focus on how it feels."</p>
            `,
            id: "accepts"
        },
        {
            title: "Radical Acceptance",
            content: `
                <h4>Accepting Reality As It Is</h4>
                <p>Use when fighting reality increases suffering.</p>
                <p>"Sometimes things are what they are, even if we hate it. Radical acceptance isnâ€™t approval â€” itâ€™s just saying, â€˜This is happening.â€™ What would it feel like to stop wrestling with that fact, just for now?â€</p>
                <p>"Letâ€™s try saying it out loud: â€˜This is how it is right now.â€™ Notice what happens when you stop pushing against it."</p>
            `,
            id: "radical-acceptance"
        },
        {
            title: "Opposite Action",
            content: `
                <h4>Acting Opposite to Emotional Urges</h4>
                <p>Use when emotions push you toward unhelpful actions.</p>
                <p>"If fear says â€˜hide,â€™ whatâ€™s the opposite? Maybe we take one small step out. If anger says â€˜yell,â€™ maybe we whisper instead. Whatâ€™s one opposite action you could try right now?â€</p>
            `,
            id: "opposite-action"
        }
    ],
    "Grounding & Somatic": [
        {
            title: "5-4-3-2-1 Technique",
            content: `
                <h4>Anchoring in the Present Using All Five Senses</h4>
                <p>Use for high anxiety, flashbacks, or feeling disconnected.</p>
                <p>"Letâ€™s ground ourselves in the present moment. Take a slow breath, and letâ€™s find:<ul><li><strong>5</strong> things you can see right now.</li><li><strong>4</strong> things you can feel or touch.</li><li><strong>3</strong> things you can hear.</li><li><strong>2</strong> things you can smell.</li><li><strong>1</strong> thing you can taste.</li></ul>"</p>
            `,
            id: "5-4-3-2-1"
        },
        {
            title: "Somatic Anchors",
            content: `
                <h4>Simple Somatic Anchors</h4>
                <p>Immediate ways to connect with the present moment using bodily sensations.</p>
                <p><strong>Noticing Feet on Floor:</strong> "Right now, wherever you are, just bring your attention down to your feet. Can you feel them on the floor...? Notice the sensation of contact... Just let your feet connect you to the ground..."</p>
                <p><strong>Butterfly Tapping (Butterfly Hug):</strong> "Hereâ€™s a simple way to offer yourself some comfort, itâ€™s called the Butterfly Hug... cross your arms over your chest... Now, start gently tapping your hands, one after the other, in a slow, rhythmic way... As you do this, just notice the sensation..."</p>
                <p><strong>Hand on Heart:</strong> "If it feels comfortable... you might try placing a hand gently on your heart, or perhaps on your belly... Just notice the warmth... Notice your breath moving under your hand."</p>
                <p><strong>Pressing Fingertips Together:</strong> "Try gently pressing the tips of your fingers on one hand against the tips of your fingers on the other. Just notice the sensation of that contact. You can do this very discreetly."</p>
            `,
            id: "somatic-anchors"
        },
        {
            title: "Mindful Body Scan",
            content: `
                <h4>Mindful Body Scan</h4>
                <p>A technique involving bringing non-judgmental awareness to sensations throughout the body, part by part.</p>
                <p><strong>When to use:</strong> To increase body awareness, promote relaxation, ground in the present, manage chronic pain (adapted).</p>
                <p>"We can try a Mindful Body Scan. This involves bringing gentle, curious attention to different parts of your body, just noticing any sensations without trying to change them. Would you be open to that?"</p>
                <p>"Find a comfortable position... Letâ€™s start by bringing your attention to your feet... Just notice any sensations there â€“ warmth, coolness, pressure, tingling... Now slowly move your attention up to your ankles... your lower legs..." (Continue guiding through body parts).</p>
                <p>"If your mind wanders, gently bring it back to the part of the body weâ€™re focusing on."</p>
                <p>(For Chronic Pain adaptation): "If youâ€™re open to it, we could try a gentle Body Scan, but with a focus on â€˜breathing intoâ€™ areas of discomfort with kindness, or noticing areas that donâ€™t hurt, rather than trying to change anything."</p>
            `,
            id: "mindful-body-scan"
        },
        {
            title: "Orienting",
            content: `
                <h4>Orienting</h4>
                <p>Actively noticing and engaging with the immediate environment through the senses to establish safety and presence.</p>
                <p><strong>When to use:</strong> Dissociation, flashbacks, depersonalization/derealization, high anxiety.</p>
                <p>"Letâ€™s remind yourself of a few key things to help you connect to the present. Can you say this out loud, or to yourself: â€˜I am [Your Name]. Today is [Date], [Year]. The time is approximately [Time]. I am in [Your current location, e.g., â€˜my bedroom at homeâ€™]. I am safe right nowâ€™."</p>
                <p>"Focus on my voice. My name is [Your Name], and Iâ€™m here with you on this call."</p>
                <p>"Letâ€™s try to connect with your senses. Whatâ€™s one thing you can see clearly right now? Describe it to me."</p>
                <p>"Whatâ€™s one thing you can physically feel? Maybe the texture of your clothes or the chair youâ€™re sitting on?"</p>
            `,
            id: "orienting"
        },
        {
            title: "The 'Voo' Sound for Physiological Calming",
            content: `
                <h4>The "Voo" Sound</h4>
                <p>Making a low, vibrating "Voo" sound on the exhale to stimulate the vagus nerve and promote parasympathetic (calming) activation.</p>
                <p><strong>When to use:</strong> Anxiety, feeling "revved up," needing to settle the nervous system.</p>
                <p>"Letâ€™s try a simple sound that can help to calm your nervous system. Itâ€™s sometimes called the â€˜Vooâ€™ sound, and the vibration it creates can be very soothing. Would you be willing to try it with me for a few breaths?"</p>
                <p>"First, just take a comfortable, easy breath in through your nose, letting your belly expand a little."</p>
                <p>"Now, as you breathe out slowly and fully, I want you to make a low, gentle, vibrating â€˜Vooooooooooâ€™ sound. Imagine the sound of a distant foghorn, or a low hum. Let the sound be long and smooth, and try to feel the vibration in your chest and throat."</p>
            `,
            id: "voo-sound"
        }
    ],
    "Cognitive & ACT": [
        {
            title: "Defusion (from ACT)",
            content: `
                <h4>Creating Distance from Unhelpful Thoughts</h4>
                <p>Use when fused with thoughts, treating them as literal truths.</p>
                <p><strong>"Iâ€™m having the thought that...":</strong> "Letâ€™s try something with that painful thought that keeps popping up. Say to yourself, â€˜Iâ€™m noticing that Iâ€™m having the thought that ______,â€™ and fill in the blank with the thought. It might sound awkward, but putting â€˜Iâ€™m having the thought thatâ€¦â€™ in front of the idea can give you a bit of distance from it."</p>
                <p><strong>Thanking Your Mind:</strong> "I know it sounds funny, but you might try thanking your mind for that thought. Like, â€˜Thanks mind, for trying to protect me,â€™ even if the thought is really negative. Sometimes a little mental nod or even a humorous â€˜thanksâ€™ can make the thought feel less powerful."</p>
                <p><strong>Silly Voice:</strong> "Sometimes taking a really powerful negative thought and saying it repeatedly in a silly voice... or singing it to the tune of â€˜Happy Birthday,â€™ can help strip away its seriousness."</p>
            `,
            id: "defusion-act"
        },
        {
            title: "Cognitive Reframing",
            content: `
                <h4>Looking at Situations from Different Angles</h4>
                <p>Use when thoughts feel heavy or limiting.</p>
                <p>"Sometimes our thoughts can get us stuck in one way of seeing things... Letâ€™s try switching lenses for a moment: If this situation wasnâ€™t a total failure, what else could it be? A learning opportunity? A misunderstanding?"</p>
                <p>"I hear that your current view is that [clientâ€™s negative interpretation]... What are some other possible ways to see this situation?"</p>
            `,
            id: "cognitive-reframing"
        },
        {
            title: "Values Clarification",
            content: `
                <h4>Identifying Core Values</h4>
                <p>Use when feeling stuck or directionless.</p>
                <p>"When things feel confusing or stuck, sometimes connecting with what truly matters can be like finding a compass. If you think about the kind of person you want to be... what qualities or principles are most important? (e.g., Kindness, Courage, Connection, Growth...)"</p>
                <p>"Of those values, which 1-3 feel most important or relevant to you right now?"</p>
            `,
            id: "values-clarification"
        }
    ],
    "Interpersonal Skills": [
        {
            title: "DEAR MAN",
            content: `
                <h4>A Structured Way to Ask for Something or Say "No" Assertively</h4>
                <p>Use for setting boundaries or addressing conflict.</p>
                <ul>
                    <li><strong>D</strong>escribe the facts.</li>
                    <li><strong>E</strong>xpress your feelings (â€˜I feelâ€¦â€™).</li>
                    <li><strong>A</strong>ssert what you need clearly.</li>
                    <li><strong>R</strong>einforce the positive outcome.</li>
                    <li>(Stay) <strong>M</strong>indful of your goal.</li>
                    <li><strong>A</strong>ppear confident.</li>
                    <li><strong>N</strong>egotiate if needed.</li>
                </ul>
            `,
            id: "dear-man"
        },
        {
            title: "NVC Framework",
            content: `
                <h4>Nonviolent Communication Framework</h4>
                <p>Use for expressing needs and empathizing with others.</p>
                <p><strong>Observation:</strong> "Letâ€™s start with just the facts... what did you see or hear, without adding interpretation?"</p>
                <p><strong>Feeling:</strong> "When that happened, what did you feel? Try an emotion word."</p>
                <p><strong>Need:</strong> "What need wasnâ€™t met? Respect? Understanding? Connection?"</p>
                <p><strong>Request:</strong> "Whatâ€™s one specific thing you could ask for?"</p>
            `,
            id: "nvc-framework"
        },
        {
            title: "Self-Compassion Break",
            content: `
                <h4>A Brief Practice for Self-Kindness</h4>
                <p>Use when feeling shame or self-criticism.</p>
                <p><strong>Acknowledge Pain:</strong> "Right now, it sounds like youâ€™re really struggling. Can we say, â€˜This is a moment of sufferingâ€™?"</p>
                <p><strong>Common Humanity:</strong> "Youâ€™re not alone in this â€” lots of people feel this way sometimes."</p>
                <p><strong>Self-Kindness:</strong> "What would you say to a friend? Try saying it to yourself: â€˜Itâ€™s okay, Iâ€™m here for me.â€™â€</p>
            `,
            id: "self-compassion-break"
        }
    ],
    "Coach Tools": [
        {
            title: "Boundary Setting",
            content: `
                <h4>Boundary Setting</h4>
                <p>Scripts for setting boundaries with clients.</p>
                <ul>
                    <li>"I see you requested a CC, Iâ€™m wondering what you are looking for with our connection."</li>
                    <li>"I want to pause you for just a sec â€“ I hear how heavy this is, and I also want to make sure we use our 20 minutes in a way that helps you feel steadier, not more overwhelmed."</li>
                    <li>"My role here is a bit different from a therapistâ€™s. Iâ€™m not here to do a deep dive or give you formal therapy right now â€” Iâ€™m here to check on your safety and help you feel a little steadier before you head back to group."</li>
                    <li>"I canâ€™t go deep with you here, but I can help you feel safer and more grounded right now."</li>
                    <li>"Letâ€™s slow it down together. Iâ€™m here to help steady things â€” not unpack everything."</li>
                </ul>
            `,
            id: "boundary-setting"
        },
        {
            title: "Stabilize",
            content: `
                <h4>Stabilize</h4>
                <p>Techniques to help stabilize the client.</p>
                <ul>
                    <li>"Youâ€™ve been dealing with a lot, and your mind and body are hitting a limit. Thatâ€™s okay. Thereâ€™s no rush to fix anything right now. Weâ€™re not trying to erase that heaviness â€” but to hold it in a way that feels manageable enough for this moment."</li>
                    <li>"We wonâ€™t dive deeper into this right now because I want to make sure you donâ€™t leave this space feeling worse. Letâ€™s focus on what you need most in this moment to feel a little more steady."</li>
                    <li>"It sounds like your mindâ€™s spinning fast rn and thereâ€™s a lot of fear showing up. Letâ€™s slow this down and find one thing we can do to help you feel more grounded during the time we have together."</li>
                    <li>"Letâ€™s take a moment to slow things down together. Thereâ€™s no rush here and no pressure to fix anything. Letâ€™s try one slow breath together. Inhale and notice your lungs filling... hold it for a second... now exhale nice and slow."</li>
                </ul>
            `,
            id: "stabilize"
        }
    ]
};

// --- DOM ELEMENTS & STATE ---
const dom = {
    modal: document.getElementById("modal"),
    modalTitle: document.getElementById("modal-title"),
    modalContent: document.getElementById("modal-content"),
    closeModalBtn: document.getElementById("close-modal-btn"),
    redBtn: document.getElementById("red-btn"),
    orangeBtn: document.getElementById("orange-btn"),
    yellowBtn: document.getElementById("yellow-btn"),
    greenBtn: document.getElementById("green-btn"),
    toolkitBtn: document.getElementById("toolkit-btn"),
    scenarioList: document.getElementById("scenario-list"),
    interventionList: document.getElementById("intervention-list"),
    saveBtn: document.getElementById("save-btn"),
    noteInput: document.getElementById("note-input"),
    notesList: document.getElementById("notes-list")
};

let state = {
    currentZone: null,
    currentScenario: null,
    notes: []
};

// --- FUNCTIONS ---
function openModal(title, content) {
    dom.modal.classList.remove("hidden");
    dom.modalTitle.textContent = title;
    dom.modalContent.innerHTML = content;
    linkInterventions(dom.modalContent);
}

function closeModal() {
    dom.modal.classList.add("hidden");
}

function renderScenarios(zone) {
    dom.scenarioList.innerHTML = "";
    clinicalData[zone].scenarios.forEach(scenario => {
        const li = document.createElement("li");
        li.textContent = scenario.title;
        li.classList.add("cursor-pointer", "hover:text-gray-300");
        li.addEventListener("click", () => openModal(scenario.title, scenario.content));
        dom.scenarioList.appendChild(li);
    });
}

function renderInterventions() {
    dom.interventionList.innerHTML = "";
    Object.keys(interventionsData).forEach(category => {
        const categoryDiv = document.createElement("div");
        categoryDiv.innerHTML = `<h3 class="text-lg font-semibold mt-4">${category}</h3>`;
        const ul = document.createElement("ul");
        ul.classList.add("ml-4");
        interventionsData[category].forEach(intervention => {
            const li = document.createElement("li");
            li.textContent = intervention.title;
            li.classList.add("cursor-pointer", "hover:text-gray-300");
            li.addEventListener("click", () => openModal(intervention.title, intervention.content));
            ul.appendChild(li);
        });
        categoryDiv.appendChild(ul);
        dom.interventionList.appendChild(categoryDiv);
    });
}

function linkInterventions(container) {
    const interventionTitles = Object.values(interventionsData).flat().map(i => i.title);
    container.querySelectorAll("p, li").forEach(element => {
        let text = element.innerHTML;
        interventionTitles.forEach(title => {
            const regex = new RegExp(`\\b${title}\\b`, "gi");
            text = text.replace(regex, `<a class="intervention-link text-blue-500 underline cursor-pointer" data-intervention="${title}">${title}</a>`);
        });
        element.innerHTML = text;
    });
    container.querySelectorAll(".intervention-link").forEach(link => {
        link.addEventListener("click", () => {
            const intervention = Object.values(interventionsData).flat().find(i => i.title === link.dataset.intervention);
            if (intervention) openModal(intervention.title, intervention.content);
        });
    });
}

function saveNote() {
    const note = dom.noteInput.value.trim();
    if (note) {
        state.notes.push({ text: note, timestamp: new Date().toISOString() });
        dom.noteInput.value = "";
        renderNotes();
    }
}

function renderNotes() {
    dom.notesList.innerHTML = "";
    state.notes.forEach((note, index) => {
        const li = document.createElement("li");
        li.textContent = `${new Date(note.timestamp).toLocaleString()} - ${note.text}`;
        li.classList.add("border-b", "py-2");
        dom.notesList.appendChild(li);
    });
}

// --- FIREBASE SETUP ---
const firebaseConfig = {
    // Your Firebase configuration object here
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

signInAnonymously(auth).catch(error => console.error("Error signing in anonymously:", error));

onAuthStateChanged(auth, (user) => {
    if (user) {
        const notesRef = doc(db, "notes", user.uid);
        onSnapshot(notesRef, (doc) => {
            if (doc.exists()) {
                state.notes = doc.data().notes || [];
                renderNotes();
            }
        });
    }
});

// --- EVENT LISTENERS ---
dom.closeModalBtn.addEventListener("click", closeModal);
dom.redBtn.addEventListener("click", () => {
    state.currentZone = "Red";
    renderScenarios("Red");
});
dom.orangeBtn.addEventListener("click", () => {
    state.currentZone = "Orange";
    renderScenarios("Orange");
});
dom.yellowBtn.addEventListener("click", () => {
    state.currentZone = "Yellow";
    renderScenarios("Yellow");
});
dom.greenBtn.addEventListener("click", () => {
    state.currentZone = "Green";
    renderScenarios("Green");
});
dom.toolkitBtn.addEventListener("click", renderInterventions);
dom.saveBtn.addEventListener("click", saveNote);
