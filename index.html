<!DOCTYPE html>
<html lang="en" class="bg-gray-50 dark:bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Marked.js (Markdown parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom styles for prose, layout, and new features */
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
            font-weight: 600;
            margin-top: 1.25em;
            margin-bottom: 0.5em;
        }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.25em; }
        .prose h3 { font-size: 1.1em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; }
        .prose strong { font-weight: 600; }
        .prose blockquote {
            border-left: 0.25rem solid #4f46e5;
            padding-left: 1em;
            font-style: italic;
            color: #4b5563;
        }
        .dark .prose blockquote {
            border-left-color: #818cf8;
            color: #d1d5db;
        }
        .prose .insight-link {
            color: #4f46e5;
            font-weight: 600;
            text-decoration: underline;
            cursor: pointer;
        }
        .dark .prose .insight-link {
            color: #a5b4fc;
        }

        .scratchpad-resize {
            resize: vertical;
            min-height: 10rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        .sidebar-nav {
            flex: 1 1 auto;
            overflow-y: auto;
        }
        
        /* Modal Animation */
        .modal-hidden {
            display: none;
        }
        .modal-visible {
            display: flex;
        }
        .modal-content {
            transition: all 0.3s ease-out;
        }

        /* Card Animation */
        .card-container {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Interactive Checklist Styles */
        .interactive-checklist li {
            list-style-type: none;
            margin-left: -1.5em;
            display: flex;
            align-items: flex-start;
        }
        .interactive-checklist li label {
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            width: 100%;
        }
        .interactive-checklist li .checkbox-custom {
            flex-shrink: 0;
            margin-top: 0.25em;
            margin-right: 0.75em;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #6b7280;
            border-radius: 0.25rem;
            cursor: pointer;
            display: inline-block;
            position: relative;
        }
        .dark .interactive-checklist li .checkbox-custom {
            border-color: #9ca3af;
        }
        .interactive-checklist li input[type="checkbox"]:checked + .checkbox-custom {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .interactive-checklist li input[type="checkbox"]:checked + .checkbox-custom::after {
            content: '‚úì';
            font-size: 1rem;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .interactive-checklist li input[type="checkbox"] {
            display: none;
        }
        .interactive-checklist li .checkbox-text {
            flex: 1;
        }
        
        /* Collapsible Section Styles */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .collapsible-header .lucide {
            transition: transform 0.3s ease;
        }
        .collapsible-header.collapsed .lucide {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            max-height: 1000px; /* Or a large enough value */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, visibility 0s linear 0s, opacity 0.3s ease;
            visibility: visible;
            opacity: 1;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            visibility: hidden;
            opacity: 0;
            transition: max-height 0.3s ease-in-out, visibility 0s linear 0.3s, opacity 0.3s ease;
        }
        mark {
            background-color: #fef08a; /* yellow-200 */
            padding: 0.1em 0.2em;
            border-radius: 0.2em;
        }
        .dark mark {
            background-color: #facc15; /* yellow-400 */
            color: #1f2937; /* gray-800 */
        }
        
        /* Floating Scratchpad Styles */
        #floating-scratchpad-modal .drag-handle {
            cursor: move;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans">

    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-full w-60 bg-white dark:bg-gray-800 shadow-lg flex flex-col z-40">
        <div class="flex items-center h-16 px-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
            <i data-lucide="activity" class="w-6 h-6 mr-2 text-indigo-500"></i>
            <span class="font-bold text-lg">Clinical OS</span>
            <button id="theme-toggle" class="ml-auto p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Theme">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
        <nav class="sidebar-nav py-4 px-2 space-y-1">
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="dashboard"><i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i>Dashboard</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="interventions"><i data-lucide="zap" class="w-4 h-4 mr-3"></i>Interventions</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="scripts"><i data-lucide="file-text" class="w-4 h-4 mr-3"></i>Scripts</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="psychoeducation"><i data-lucide="book-open" class="w-4 h-4 mr-3"></i>Psychoed</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="favorites"><i data-lucide="star" class="w-4 h-4 mr-3"></i>Favorites</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="recents"><i data-lucide="history" class="w-4 h-4 mr-3"></i>Recently Viewed</button>
            <button id="scratchpad-toggle-btn" class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-teal-100 dark:hover:bg-teal-900" data-tab="scratchpad"><i data-lucide="edit-3" class="w-4 h-4 mr-3"></i>Scratchpad</button>
        </nav>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
            <input id="search-box" type="text" placeholder="Search scenarios..." class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
    </aside>

    <!-- Main content -->
    <main class="ml-60 min-h-screen p-6 md:p-8 transition-colors duration-300">
        <div class="flex justify-between items-center mb-4">
            <!-- Used this session -->
            <div id="used-this-session-container" class="flex-1"></div>
            <!-- In-Session Timer -->
            <div id="session-timer-container" class="flex items-center gap-2 p-2 rounded-lg bg-green-100 dark:bg-green-900 transition-colors duration-500">
                <i data-lucide="timer" class="w-5 h-5"></i>
                <span id="session-timer" class="font-mono font-semibold text-lg">00:00</span>
                <button id="timer-toggle-btn" title="Start/Pause Timer" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="play" class="w-4 h-4"></i>
                </button>
                <button id="timer-reset-btn" title="Reset Timer" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <!-- Dynamic content area -->
        <div id="content-area" class="card-container"></div>
    </main>

    <!-- Content Modal -->
    <div id="scenario-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-50 p-4 modal-hidden">
        <div id="modal-content-wrapper" class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full relative p-6 max-h-[90vh] flex flex-col modal-content opacity-0 scale-95">
            <div id="modal-context" class="flex flex-wrap gap-2 mb-3"></div>
            <div class="flex items-start mb-4">
                <h2 id="modal-title" class="text-2xl font-bold flex-1"></h2>
                <button id="close-modal" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="modal-body" class="prose dark:prose-invert max-w-none overflow-y-auto pr-4 -mr-4 flex-1"></div>
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex items-center gap-2">
                 <button id="copy-modal-content-to-scratchpad" class="flex items-center text-xs px-3 py-1 bg-teal-100 dark:bg-teal-900 rounded-md text-teal-700 dark:text-teal-200 hover:bg-teal-200 dark:hover:bg-teal-800"><i data-lucide="plus-square" class="w-4 h-4 mr-1"></i>Copy to Scratchpad</button>
                 <button id="add-annotation-btn" class="flex items-center text-xs px-3 py-1 bg-yellow-100 dark:bg-yellow-900 rounded-md text-yellow-700 dark:text-yellow-200 hover:bg-yellow-200 dark:hover:bg-yellow-800"><i data-lucide="sticky-note" class="w-4 h-4 mr-1"></i>Add Note</button>
                 <div class="ml-auto flex gap-2">
                    <button id="modal-prev" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <button id="modal-next" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
                 </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Access Add Modal -->
    <div id="quick-access-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-50 p-4 modal-hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full relative p-6 max-h-[90vh] flex flex-col modal-content opacity-0 scale-95">
            <div class="flex items-center mb-4">
                <h2 class="text-2xl font-bold flex-1">Add to Quick Access</h2>
                <button id="close-quick-access-modal" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <input id="quick-access-search" type="text" placeholder="Search all items..." class="w-full px-3 py-2 mb-4 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <div id="quick-access-list" class="flex-1 overflow-y-auto -mr-4 pr-4 space-y-2"></div>
        </div>
    </div>

    <!-- Annotation Modal -->
    <div id="annotation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-[60] p-4 modal-hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-lg modal-content opacity-0 scale-95">
            <h3 id="annotation-modal-title" class="text-lg font-semibold mb-4">Add/Edit Note</h3>
            <textarea id="annotation-textarea" class="w-full p-2 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 rounded-lg text-sm" rows="6" placeholder="Your private notes for this item..."></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button id="annotation-cancel" class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                <button id="annotation-save" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-[60] p-4 modal-hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm modal-content opacity-0 scale-95">
            <h3 id="confirmation-title" class="text-lg font-semibold mb-4">Are you sure?</h3>
            <div id="confirmation-message" class="text-sm text-gray-600 dark:text-gray-300 mb-6"></div>
            <div class="flex justify-end gap-3">
                <button id="confirmation-cancel" class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                <button id="confirmation-confirm" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Floating Scratchpad -->
    <div id="floating-scratchpad-modal" class="fixed top-20 left-[20%] w-full max-w-xl z-[70] modal-hidden">
        <div id="floating-scratchpad-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl flex flex-col modal-content opacity-0 scale-95">
            <div class="drag-handle flex items-center p-4 border-b border-gray-200 dark:border-gray-700 cursor-move">
                <i data-lucide="edit-3" class="w-5 h-5 text-teal-500 mr-2"></i>
                <h2 class="text-xl font-bold flex-1">Scratchpad</h2>
                <button id="close-scratchpad-btn" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="floating-scratchpad-body" class="p-6">
                <!-- Content will be injected here by renderFloatingScratchpad -->
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="hidden"></div>

    <script>
    // ---- DATA ----
    const clinicalData = [
        // --- RED ZONE ---
        {
            id: 'red-suicidal-ideation',
            title: 'Suicidal Ideation ‚Äì Safety Assessment',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['suicide', 'safety', 'crisis', 'cssrs', 'assessment', 'red'],
            content: `### ASSESS\n"Before we go any deeper, **our priority is always your safety**. I‚Äôd like to ask a few questions that help us understand how you‚Äôre doing and what kind of support might help keep you safe right now.\n\n1.  **Have you wished you were dead or that you could go to sleep and not wake up?**\n2.  **Have you actually had any thoughts of killing yourself?** (If yes, ask 3, 4, 5, 6. If no, go to 6).\n3.  **In the past 48 hours, have you been thinking about how you might do this?**\n4.  **In the past 48 hours, have you had these thoughts and had some intention of acting on them?**\n5.  **In the past 48 hours, have you started to work out any details for how to kill yourself? Do you intend to carry out this plan?**\n6.  **In the past 48 hours have you done anything to prepare to end your life?**\n\n*If Yes to 4, 5, or 6, ask scaling questions:*\n\n> \"On a scale of 1-5, one meaning you feel you can stay safe today, and five meaning that you're going to make an attempt today, where would you place yourself right now?\"\n\n*Reflect back answer:*\n* \"So a **four** means to me you have a plan and some intentions on acting on the plan, you just don't know when. Is that accurate?\"\n* \"A **three** means to me you have strong thoughts of wanting to die and have thought about ways you might act on it, but you don't have a specific plan. Did I get that right?\"\n* \"A **two** means to me that you have fleeting thoughts of wanting to end your life, but no plan or intention of acting on it.\"\n\n‚ÄúI‚Äôm really glad you told me this. It takes a lot of strength to be this honest, and I‚Äôm here to help you figure it out.‚Äù\n\n### SAFETY PLAN\n**Need to escalate:** \"Thank you for telling me that. If it sounds like things are starting to feel more intense or harder to manage on your own, I‚Äôd like to connect you with a Crisis Manager ‚Äî who can better support you and help figure out the next steps to keep you safe.\"\n\n* **Warning Signs:** ‚ÄúWhat are some early signs you notice when things start to spiral?‚Äù\n* **Internal Coping:** ‚ÄúWhat can you try on your own that sometimes helps, even a little?‚Äù\n* **Social Distractions:** ‚ÄúWho or what helps you shift your focus ‚Äî even briefly?‚Äù\n* **People to Reach Out To:** ‚ÄúIf things feel too big to hold alone, who could you reach out to?‚Äù\n* **Professional Resources:** ‚ÄúDo you have Charlie Health‚Äôs 24/7 crisis line saved in your phone?‚Äù\n* **Safety at Home:** ‚ÄúIs there anything nearby that might feel unsafe to have around right now?‚Äù\n* **Reasons to Stay:** ‚ÄúWhen things get dark, what‚Äôs something ‚Äî or someone ‚Äî that reminds you there‚Äôs still a reason to hang on?‚Äù`
        },
        {
            id: 'red-self-harm',
            title: 'Self-Harm Urges (Non-Suicidal Self-Injury)',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['nssi', 'self-harm', 'urges', 'coping', 'safety', 'red'],
            content: `### Direct Check-In\n‚ÄúThank you for telling me. I need to ask: Are you having urges to hurt yourself right now?‚Äù\n* **If yes (urge is present):** ‚ÄúOn a scale from 1 to 10, how strong is the urge right now, 10 being the strongest?‚Äù\n* **If yes (recent self-harm action):** ‚ÄúWhat did you do, and how severe was it? Do you need any medical attention for that?‚Äù\n\n### Clarify Intent\n‚ÄúWhen you self-harmed, was it because you wanted to die, or was it more about coping with pain or numbness?‚Äù\n\n### Validate & Normalize\n‚ÄúThat urge makes sense given what you‚Äôre carrying. A part of you is trying to survive and find relief, even if it‚Äôs doing it in a way that ends up hurting you. Let‚Äôs see if we can work with that part in a safer way.‚Äù\n\n### Offer Alternatives & Coping Strategies\n* **Intense Physical Sensations:** ‚ÄúSometimes our body needs a very strong sensation to release that tension. We could try the **TIPP Skill for Rapid Distress Reduction**.‚Äù\n* **‚ÄúUrge Surfing‚Äù Technique:** ‚ÄúRemember, urges are like waves ‚Äî they build, peak, and eventually fall. Let‚Äôs try to ride this wave out together using the **Name the Urge, Challenge the Urge** technique.‚Äù\n* **Safe Physical Release:** ‚ÄúWould it help to rip up some paper, squeeze a stress ball, stomp your feet, or even scream into a pillow?‚Äù\n\n### Harm Reduction (If urge is overwhelming)\n"I hear that the urge feels too strong to resist completely right now. The priority is to keep you as safe as possible. Is there a way to get through this moment with less harm? For example, instead of [more severe method], could you try holding ice very tightly, or drawing on your skin with a red marker?"\n\n### Commitment to Safety\n‚ÄúI know the urge is strong, but do you feel like you can stay safe tonight? Even if the urge comes back, can you promise me you‚Äôll try these coping steps or reach out for help before doing anything to hurt yourself?‚Äù`
        },
        {
            id: 'red-imminent-risk',
            title: 'Imminent Risk of Harm (Active Crisis)',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['imminent risk', 'active crisis', 'de-escalation', 'emergency', 'safety', 'red'],
            content: `### Goal: Keep them engaged, slow the process, get help.\n"I am so glad you told me what's happening. I am here with you. Please stay on the line with me. We are going to figure this out together, one step at a time. My number one priority is your safety."\n\n### Step 1: Slow Things Down\n"I hear how much pain you're in. There is no rush to do anything right now. Can we just pause for a second? Just for one breath. Can you do that with me? Just one slow breath in... and out. Thank you. You're doing a great job."\n\n### Step 2: Express Empathy & Concern\n"It sounds like things have become completely unbearable. I can't imagine how much you must be hurting to get to this point. I am very, very concerned about you right now."\n\n### Step 3: Introduce the Idea of Help\n"You don't have to carry this all by yourself. Because I'm so concerned, I need to get you more support right now. I am going to contact emergency services to get someone to you. I will stay on the line with you the entire time. We will get through this together."\n\n### Step 4: If possible, create distance from means\n"While we wait for help to arrive, would you be willing to do something for me? It would help me feel a little less worried. Would you be willing to put the [pills/object] down, maybe just on the other side of the room? You don't have to get rid of them, just create a little space for a moment."\n\n### Intervention Insight\n* This entire process is an application of **The Seven-Stage Crisis Intervention Model** in real-time.\n* Use **Verbal De-escalation Techniques** throughout the conversation.`
        },
        {
            id: 'red-hallucinations',
            title: 'Hallucinations or Disturbing Perceptual Experiences',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['psychosis', 'hallucinations', 'voices', 'paranoia', 'safety', 'red'],
            content: `### Acknowledge Experience (Don‚Äôt Dismiss)\n‚ÄúThank you for telling me. I can imagine this feels really intense and scary. I want you to know I‚Äôm here with you, and I believe that you‚Äôre experiencing this.‚Äù\n\n### Safety Check (Calm & Direct)\n‚ÄúAre the things you‚Äôre hearing or seeing telling you to hurt yourself or anyone else?‚Äù\n\n### Orient to Present (Ground in Shared Reality)\n‚ÄúLet‚Äôs try something together to bring you into the here and now with me, okay? Put your feet flat on the floor for me. Press them down a little and notice that sensation. You‚Äôre right here, in this moment, with me. We‚Äôre safe right now. We can try a **Simple Somatic Anchors** technique.‚Äù\n\n### Calm Reassurance\n‚ÄúYou‚Äôre doing really well. I‚Äôm going to stay right here with you. The things you‚Äôre perceiving can feel real, but I want you to keep noticing the ground under your feet, the sound of my voice. We‚Äôre in the present moment.‚Äù`
        },
        {
            id: 'red-medical-crisis',
            title: 'Acute Medical Crisis',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['medical', 'emergency', '911', 'crisis', 'safety', 'red'],
            content: `### Immediate Action ‚Äì Take Charge\n‚ÄúOkay, I see/hear that something serious might be happening physically. The most important thing right now is getting you medical help immediately.‚Äù\n\n### Instruct to Call Emergency\n‚ÄúAre you able to call 911 (or your local emergency number) right now? Is there someone with you who can call for you?‚Äù\n\n### Offer to Call\n‚ÄúIt sounds like you can‚Äôt call on your own. I‚Äôm going to get you help. Do I have your permission to call 911 for you right now to get an ambulance?‚Äù\n\n### Keep Them Engaged While Help Comes\n‚ÄúHelp is on the way. I‚Äôm right here with you. Try to stay as calm as you can ‚Äì focus on taking slow breaths with me if possible. In‚Ä¶ and out‚Ä¶ nice and easy.‚Äù`
        },
        {
            id: 'red-overdose',
            title: 'Substance Overdose or Severe Intoxication',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['overdose', 'substance', 'intoxication', 'emergency', '911', 'red'],
            content: `### Recognize Seriousness\n‚ÄúI can tell this is serious. I‚Äôm very concerned that you might be experiencing a medical emergency from substances.‚Äù\n\n### Instruct to Call Emergency\n‚ÄúThis is urgent. Are you able to call 911 right now for medical attention? Or is there someone with you who can call?‚Äù\n\n### Naloxone (If Opioid Overdose suspected)\n‚ÄúIf this might be an opioid overdose and if you or anyone there has Naloxone (Narcan) and knows how to use it, please use it now while we wait for the ambulance.‚Äù\n\n### Keep Them Awake & Oriented\n‚ÄúStay with me, okay? Help is coming. Try to stay awake and keep talking to me. I know you‚Äôre very drowsy, but focus on my voice.‚Äù`
        },
        {
            id: 'red-unsafe-home',
            title: 'Unsafe Home Environment / Domestic Violence',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['dv', 'domestic violence', 'abuse', 'safety', 'home', 'red'],
            content: `### Express Empathy and Belief\n‚ÄúThank you for sharing this with me. I can‚Äôt imagine how hard it was to say that out loud. I want you to know I believe you, and you didn‚Äôt deserve any of this.‚Äù\n\n### Assess Immediate Safety\n‚ÄúAre you safe right now? Is the person who hurt you nearby or likely to return soon?‚Äù\n\n### Provide Control & Options\n‚ÄúYou know your situation best, and I‚Äôm here to support whatever you choose to do. For example, have you heard of the National Domestic Violence Hotline? They have advocates 24/7 at 1-800-799-7233 who can help you make a safety plan or find resources.‚Äù\n\n### Empower & Validate\n‚ÄúYou are not alone and there are people who want to help. You deserve to be safe. None of this is your fault.‚Äù`
        },
        {
            id: 'red-child-abuse',
            title: 'Child Abuse or Neglect Disclosure',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['child abuse', 'neglect', 'mandated reporter', 'cps', 'safety', 'red'],
            content: `### Respond with Care\n‚ÄúThank you for telling me that. I know it‚Äôs not easy to talk about. I am so sorry this happened to you (or to that child). No one, especially no child, should have to go through that.‚Äù\n\n### Explain Mandated Reporting (Transparent and Reassuring)\n‚ÄúI need you to know: because you shared this, I‚Äôm required by law to take steps to report it to the proper authorities... This isn‚Äôt to get anyone in trouble; it‚Äôs to protect you/them and make sure it doesn‚Äôt continue.‚Äù\n\n### Support the Client‚Äôs Emotions\n‚ÄúHow are you feeling now that you‚Äôve shared that? It‚Äôs a lot, I know. Whatever you‚Äôre feeling ‚Äì scared, relieved, angry ‚Äì it‚Äôs completely understandable.‚Äù\n\n### Closing Reassurance\n‚ÄúI know this was a big step to tell me. You were very brave to speak up. Remember: you didn‚Äôt do anything wrong by telling the truth.‚Äù`
        },
        {
            id: 'red-harm-to-others',
            title: 'Threat of Harm to Others (Homicidal Ideation)',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['homicidal', 'harm to others', 'duty to protect', 'safety', 'crisis', 'red'],
            content: `### Immediate Clarification\n‚ÄúI hear you saying you want to hurt someone. I take that very seriously, and I need to ask you a few questions to understand better, because my job is to keep everyone safe.‚Äù\n\n### Duty to Protect Explanation\n‚ÄúOkay, I need you to know: because you‚Äôre talking about harming someone else, I have a responsibility to make sure that person (and everyone) stays safe. That may mean involving other professionals or authorities right away.‚Äù\n\n### De-escalate Anger\n‚ÄúI get that you‚Äôre extremely angry. That anger is telling us something important ‚Äî you feel deeply hurt or wronged. I‚Äôm here to listen to that. Let‚Äôs slow this down and sit with what‚Äôs coming up, instead of letting it boil over.‚Äù`
        },
        {
            id: 'red-under-influence',
            title: 'Under the Influence (Non-Crisis)',
            category: 'Red Zone',
            emoji: 'üö©',
            color: 'red',
            tags: ['substance', 'intoxication', 'policy', 'safety', 'red'],
            content: `### Immediate Safety Check\n"Hi. I'm just checking in with you briefly. It was noticed in group that [specific observation, e.g., 'you seemed a bit sleepy']. How are you doing right now?"\n\n### Stating the Need to Log Off (Clear, Kind, Firm)\n"Because it appears you're under the influence right now, and in line with the group policy for everyone's safety and benefit, I am going to need you to log off from the group session for the rest of today."\n"This isn't a punishment, but it's a necessary step to ensure your well-being and to maintain the group's therapeutic environment."\n\n### Brief Safety Assessment (Essential before log-off)\n"Before you log off for the day, my top priority is to make sure you're going to be safe. Are you in a safe place physically right now? Is there anyone with you, or someone responsible you can contact if you start to feel unwell or need help?"\n\n### Explain Next Steps\n‚ÄúBecause you were under the influence and had to step out of group, I will let your primary therapist know what happened, just so they‚Äôre in the loop and can support you.‚Äù`
        },
        // --- ORANGE ZONE ---
        {
            id: 'orange-relapse-crisis',
            title: 'Relapse Crisis / Intense Cravings',
            category: 'Orange Zone',
            emoji: 'üü†',
            color: 'orange',
            tags: ['relapse', 'addiction', 'cravings', 'substance use', 'crisis', 'orange'],
            content: `### Validate Without Judgment\n"Thank you for reaching out right now. This is exactly when you're supposed to ask for help. The urge is incredibly powerful, and it makes sense that you're struggling. There is no shame in this moment. Let's just focus on getting through the next few minutes together."\n\n### Assess Immediate Safety\n"Have you used any substances already? Are you safe right now? Is there anyone with you?"\n\n### Ride the Wave (Urge Surfing)\n"Remember, an urge is like a wave. It feels like it will last forever, but it won't. It will peak, and it will pass. Our job isn't to fight the wave, but to surf it. Let's try to **Name the Urge, Challenge the Urge** together. Just notice it, without having to act on it."\n\n### Distract and Disrupt\n"Let's throw a wrench in the works. Can you change your environment right now? Go to a different room? Splash cold water on your face using the **TIPP Skill for Rapid Distress Reduction**? Call a sober support? Let's do one, small, different thing."\n\n### Reconnect to 'Why'\n"When the craving is screaming, it's hard to remember why you wanted sobriety in the first place. Can you tell me one thing‚Äîjust one thing‚Äîthat you like about being sober, or one negative consequence of using that you want to avoid?"\n\n### If a Lapse Occurred\n"Okay, a lapse happened. That does not mean you've failed or that all your progress is lost. This is a moment, not a verdict. Let's talk about the **The Abstinence Violation Effect** to make sure this lapse doesn't turn into a full-blown relapse."`
        },
        {
            id: 'orange-agitated',
            title: 'Highly Agitated or Escalating',
            category: 'Orange Zone',
            emoji: 'üü†',
            color: 'orange',
            tags: ['agitation', 'escalation', 'anger', 'distress', 'orange'],
            content: `### Center and Slow the Moment\n‚ÄúI can see (or hear) how agitated you are. Let‚Äôs take a pause for a second. I‚Äôm right here with you. You don‚Äôt have to go through this moment alone.‚Äù\n\n### Acknowledge the Anger/Frustration\n‚ÄúThat energy and anger you‚Äôre feeling right now ‚Äî it makes sense. Something important is going on inside you and it‚Äôs demanding to be heard.‚Äù\n\n### Explore the Underlying Need\n"Anger often acts as a protector for more vulnerable feelings. I wonder, if the anger could speak, what hurt or fear might be underneath it? What is it trying to tell us that you need right now? This is something we can explore using **Acknowledging an Emotional Part**."\n\n### Keep Voice Calm & Assuring\n‚ÄúI‚Äôm not going anywhere. I know you‚Äôre really upset, and it‚Äôs okay. Let‚Äôs stay right here. You‚Äôre safe with me to let it out, as long as we keep each other safe.‚Äù\n\n### After Calming Slightly ‚Äì Reflection\n‚ÄúThat was a lot. You did really well slowing down just now. This is hard stuff, and you‚Äôre handling it. When you‚Äôre ready, maybe we can figure out what you need next or how I can help further.‚Äù`
        },
        {
            id: 'orange-panic-attack',
            title: 'Acute Anxiety or Panic Attack',
            category: 'Orange Zone',
            emoji: 'üü†',
            color: 'orange',
            tags: ['anxiety', 'panic', 'fear', 'grounding', 'tipp', 'orange'],
            content: `### Normalize & Reassure\n‚ÄúWhat you‚Äôre experiencing is a panic attack. It feels really scary, but **I promise it‚Äôs not life-threatening. You are going to be okay. I‚Äôm right here.**‚Äù\n\n### Immediate Physiological Regulation\n* **Temperature:** "Let's try the **TIPP Skill for Rapid Distress Reduction**. Can you splash some cold water on your face, or hold a cold water bottle or ice cube if you have one? This triggers something called the 'dive response' that naturally slows your heart rate."\n* **Paced Breathing:** "Let's breathe together. Breathe in through your nose for 4 counts... hold for 4... now out through your mouth for 6 counts. That longer exhale is key."\n\n### Orient to Safety\n‚ÄúLet‚Äôs ground ourselves in the room. We can use the **Grounding Through Senses (5-4-3-2-1 Technique)** or a technique called **Dropping Anchor (ACT)** to connect with the present moment.‚Äù\n\n### Permission to Pause\n‚ÄúWe don‚Äôt need to unpack everything right now. In fact, we shouldn‚Äôt dive deeper into anything heavy at this moment, because I want to make sure you don‚Äôt leave here feeling even worse.‚Äù`
        },
        {
            id: 'orange-overwhelmed',
            title: 'Overwhelmed & Emotionally Flooded',
            category: 'Orange Zone',
            emoji: 'üü†',
            color: 'orange',
            tags: ['overwhelmed', 'flooded', 'crying', 'shut down', 'orange'],
            content: `### Contain and Validate\n‚ÄúIt‚Äôs all feeling like too much, isn‚Äôt it? I hear you. What you‚Äôre experiencing right now makes so much sense given everything you‚Äôre carrying. Anyone would feel overwhelmed in your shoes.‚Äù\n\n### Permission to Pause\n‚ÄúWe don‚Äôt need to unpack everything right now. In fact, we shouldn‚Äôt dive deeper into anything heavy at this moment, because I want to make sure you don‚Äôt leave here feeling even worse. Let‚Äôs focus on just helping you feel a little steadier.‚Äù\n\n### Grounding in Present\n‚ÄúCan you feel the chair under you, or your feet on the ground? Let‚Äôs start there. Just notice those physical points of contact ‚Äì it might help bring you back just a little from the flood of feelings. We can try some **Simple Somatic Anchors**.‚Äù\n\n### Supportive Reassurance\n‚ÄúI‚Äôm right here, and I‚Äôm not overwhelmed by your overwhelm. You don‚Äôt have to hold it together for my sake. It‚Äôs okay to let it out ‚Äì cry, sit silently, whatever you need. I‚Äôve got you.‚Äù`
        },
        {
            id: 'orange-dissociation',
            title: 'Dissociation / Depersonalization',
            category: 'Orange Zone',
            emoji: 'üü†',
            color: 'orange',
            tags: ['dissociation', 'derealization', 'depersonalization', 'numb', 'unreal', 'grounding', 'orange'],
            content: `### Validate & Normalize\n"It sounds like you're feeling really disconnected, like you're watching yourself from a distance or things don't feel real. That's a very common, though unsettling, way our brains protect us from overwhelming feelings. It's called dissociation."\n\n### Gentle Re-orientation\n"You're not going crazy. This is a survival response. Our main job right now is to gently invite your awareness back into the present moment, without forcing anything."\n\n### Engage the Senses\n"Let's try to connect with one of our senses. Can you find one thing in the room that is a specific color, like blue? Just let your eyes rest on it. No need to do anything else, just notice it."\n\n### Intervention Insight\n* Use **Grounding Through Senses (5-4-3-2-1 Technique)** to re-engage with the environment.\n* Use **Simple Somatic Anchors** like pressing feet into the floor or holding a textured object.\n* Introduce **TIPP Skill for Rapid Distress Reduction**, especially the 'Temperature' component with cold water, to create a strong, grounding sensation.`
        },
        {
            id: 'orange-trauma-reaction',
            title: 'Trauma Reaction / Flashback',
            category: 'Orange Zone',
            emoji: 'üü†',
            color: 'orange',
            tags: ['trauma', 'flashback', 'ptsd', 'grounding', 'safety', 'orange'],
            content: `### Ground in Present Safety\n‚ÄúHey, you‚Äôre here with me. You‚Äôre safe right now. That thing isn‚Äôt happening to you right this second, even though it feels like it is.‚Äù\n\n### Breathe and Orient\n‚ÄúTake a deep breath if you can. You‚Äôre breathing in the current year. You‚Äôre [client‚Äôs name], and you‚Äôre here with me, not back in that situation. That was then, and this is now. Can you say out loud, ‚ÄòI‚Äôm here now‚Äô?‚Äù\n\n### Validate and Contain\n‚ÄúThat memory was really intense. It makes sense that it felt like it was happening all over again. Flashbacks can be that powerful. But it‚Äôs not happening now, and you survived it then. You‚Äôre safe now.‚Äù\n\n### Intervention Insight\n* Use **Dropping Anchor (ACT)** to acknowledge the internal storm while connecting to the physical room.\n* Use **Simple Somatic Anchors** to provide immediate physical grounding.\n* If a younger part feels activated, you can try **Grounding in the 'Here and Now' with a Traumatized Part**.`
        },
        {
            id: 'orange-breakup-distress',
            title: 'Acute Relationship Breakup Distress',
            category: 'Orange Zone',
            emoji: 'üü†',
            color: 'orange',
            tags: ['breakup', 'grief', 'rejection', 'heartbreak', 'crisis', 'orange'],
            content: `### Validate the Pain\n"This is an incredibly painful moment. The end of a relationship can feel like a death, and the shock and hurt you're feeling are completely real and valid. It's okay to not be okay right now. Let's just focus on getting through this immediate wave."\n\n### Ground in the Moment\n"The pain can feel like it's going to last forever, but our job right now is just to get through the next few minutes. Let's try to ground ourselves. Can you feel your feet on the floor? Can you take one slow breath with me? You are here, you are safe in this moment."\n\n### Introduce Emotional First-Aid\n"When you have a physical injury, you apply first aid. We can do the same thing for emotional injuries. It doesn't fix everything, but it helps stop the bleeding and start the healing process. We can walk through some **Relationship Breakup: Emotional First Aid** steps together."\n\n### Normalize the Experience\n"What you're going through is a form of grief. It might be helpful to understand this as an **Ambiguous Loss**‚Äîa loss that's confusing and lacks clear closure, which makes it uniquely painful. You're not crazy for feeling this intensely."`
        },
        {
            id: 'orange-family-conflict',
            title: 'Intense Family Conflict/Argument',
            category: 'Orange Zone',
            emoji: 'üü†',
            color: 'orange',
            tags: ['family', 'conflict', 'argument', 'anger', 'boundaries', 'orange'],
            content: `### Validate the Intensity\n"It sounds like things just exploded. That level of conflict is exhausting and deeply upsetting, especially with family. The anger, the hurt, the frustration you're feeling‚Äîit all makes sense. You're in the middle of an emotional storm."\n\n### Create Space & Safety\n"Right now, the most important thing is to create some safety and space for your nervous system to calm down. You don't have to solve the problem while you're this activated. In fact, it's better not to. Can you physically move to a different room or step outside for a moment?"\n\n### Co-regulate\n"Let's try to bring the temperature down, just a little. We can use the **TIPP Skill for Rapid Distress Reduction** to help your body calm down. Just focus on my voice. You're not in that argument anymore, you're here with me."\n\n### Shift from Reaction to Intention\n"When you're feeling this raw, the urge might be to text them, call them back, or replay the argument in your head. For now, let's put a pause on that. Later, when you're calmer, we can think about what you want to say and how you want to say it, maybe using a framework like **DEAR MAN: For Interpersonal Effectiveness**."`
        },
        // --- YELLOW ZONE ---
        {
            id: 'yellow-burnout',
            title: 'Struggling with Burnout / Compassion Fatigue',
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['burnout', 'stress', 'exhaustion', 'cynicism', 'caregiving', 'yellow'],
            content: `### Validate the Exhaustion\n"It sounds like your battery is completely drained to zero. Burnout isn't just being tired; it's a deep emotional and physical exhaustion from prolonged stress. It's your body and mind telling you that you've been giving more than you have. It makes sense that you feel cynical and detached‚Äîit's a protective mechanism."\n\n### Introduce the Concept\n"What you're describing sounds a lot like burnout. We can explore **What is Burnout?** to put a name to this experience. It often involves three things: exhaustion, cynicism or detachment, and a feeling of ineffectiveness."\n\n### Shift Focus to Replenishment\n"Right now, the goal isn't to 'push through.' The goal is to stop the drain and find small ways to replenish. What is one thing, no matter how small, that feels like it gives back to you, rather than takes away?"\n\n### Explore Emotional Systems\n"It sounds like your 'threat' and 'drive' systems have been in overdrive, and your 'soothing' system is offline. We can use a model from Compassion-Focused Therapy called **The Threat, Drive, & Soothing Systems (CFT)** to understand how to bring more balance back."\n\n### Boundary Setting\n"Burnout is often a signal that our boundaries are being consistently crossed, either by others or by ourselves. This might be a good time to explore **Boundary Setting Exploration & Practice** to see where energy might be leaking."`
        },
        {
            id: 'yellow-insomnia',
            title: 'Insomnia / Difficulty with Sleep',
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['sleep', 'insomnia', 'anxiety', 'cbt-i', 'health', 'yellow'],
            content: `### Validate the Frustration\n"Lying awake at night, desperate for sleep, is a special kind of torture. It's incredibly frustrating and can make everything else in life feel ten times harder. It makes sense that you're feeling anxious about sleep itself‚Äîit's become a battle."\n\n### Externalize the Problem\n"Let's think of this as a 'sleep problem,' not a 'you problem.' Your body's natural sleep system has gotten a bit out of whack, likely due to stress or anxiety. Our job is to gently guide it back on track, not to force it."\n\n### Introduce Sleep Hygiene\n"Sometimes, our daytime and evening habits can unintentionally interfere with sleep. We can go over some strategies from CBT for Insomnia called **Sleep Hygiene & Stimulus Control (CBT-I)**. These are small changes that can make a big difference over time."\n\n### Address the Anxious Mind\n"It sounds like your mind starts racing as soon as your head hits the pillow. This is really common. Instead of fighting the thoughts, we can practice skills like **ACT Defusion: Distancing from Thoughts** or use a guided meditation to give your mind something else to focus on."\n\n### Psychoeducation\n"Understanding a little about **The Basics of Sleep Science** can be empowering. Knowing what's happening in your brain can make the process feel less mysterious and more manageable."`
        },
        {
            id: 'yellow-new-diagnosis',
            title: 'Navigating a New Medical Diagnosis',
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['health', 'illness', 'grief', 'medical', 'diagnosis', 'yellow'],
            content: `### Acknowledge the Shock and Grief\n"Receiving a new diagnosis is a life-altering event. It can feel like your world has been turned upside down. There is a very real grief process that comes with losing the health you once had, or the future you imagined. Whatever you're feeling‚Äîfear, anger, confusion, numbness‚Äîis completely valid."\n\n### Address the Loss of Control\n"A diagnosis can make you feel completely powerless over your own body and life. Let's focus on what you *can* control. We can use the **Circles of Control, Influence, and Concern** to map out where you can effectively put your energy, like learning about your condition, preparing questions for your doctor, or focusing on your self-care."\n\n### Give Permission to Not Be Positive\n"You don't have to be a 'brave warrior' right now. It's okay to be scared and to grieve. Toxic positivity can be very invalidating. Let's make space for all the difficult feelings first. Practicing a **Self-Compassion Break (Kristin Neff)** can be very helpful here."\n\n### Focus on One Day at a Time\n"Thinking about the long-term future can be incredibly overwhelming. Let's bring the focus to just today. What is one thing you need to get through today? What is one small action you can take for your well-being right now?"`
        },
        {
            id: 'yellow-identity-exploration',
            title: 'Exploring Identity (Gender/Sexual/Cultural)',
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['identity', 'gender', 'sexuality', 'lgbtq', 'culture', 'self', 'yellow'],
            content: `### Affirm and Create Safety\n"Thank you for sharing this with me. Exploring questions about who you are is one of the most important and courageous things a person can do. This is a safe space to be curious, to be unsure, and to try on different ideas without any pressure to have it all figured out."\n\n### Validate the Confusion and Fear\n"It can be really confusing and even scary to question parts of your identity that you or others may have taken for granted. There's no right or wrong way to feel about this process. It's okay to feel excited and terrified at the same time."\n\n### Externalize Societal Pressure\n"We get so many messages from society, family, and the media about who we 'should' be. Let's try to set those voices aside for a moment and just listen to your own inner voice. We can use a technique called **Externalizing the Problem (Narrative Therapy)** to separate your own truth from the 'shoulds' that society imposes."\n\n### Focus on Values and Expression\n"Instead of getting stuck on finding the 'right' label, let's focus on what feels authentic to you. What kind of expression feels good? What values are important to you in how you relate to yourself and others? We can use **Values Clarification & Committed Action** as a guide."\n\n### Encourage Exploration\n"This is a journey of discovery. What's one small step you could take to explore this part of yourself? It could be reading an article, watching a video from a creator with a similar identity, or journaling about your feelings."`
        },
        {
            id: 'yellow-parts-conflict',
            title: "Feeling Fragmented / 'Parts' in Conflict",
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['complex trauma', 'cptsd', 'dissociation', 'parts work', 'bpd', 'yellow'],
            content: `### Validate the Internal Chaos\n"It sounds like there's a war going on inside you. One part of you wants [X], while another part feels [Y]. This is incredibly confusing and exhausting. It's not a sign that you're 'crazy'; it's a sign that you've survived some very difficult things by learning to compartmentalize."\n\n### Introduce the 'Parts' Model Gently\n"Let's get curious about these different feelings as 'parts' of you. All these parts belong to you, and none of them are 'bad.' They all developed for a reason, usually to protect you. We can learn more about this by exploring **Understanding Structural Dissociation (The 'Parts' Model)**."\n\n### Speak to the 'Self'\n"I know there are a lot of conflicting voices right now. I'm wondering if we can find the part of you that is just watching all of this happen‚Äîthe calm, curious part. Let's see if we can speak from that place, even for a moment. From that calm place, what do you notice about this internal conflict?"\n\n### Focus on One Part at a Time\n"Instead of trying to solve the whole conflict, let's just get to know one part. Which part feels the loudest right now? Let's use **Acknowledging an Emotional Part** to understand what it needs and what it's afraid of, without judgment."`
        },
        {
            id: 'yellow-gad-worry',
            title: "Persistent Worry & 'What If' Spirals (GAD)",
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['gad', 'anxiety', 'worry', 'catastrophizing', 'rumination', 'yellow'],
            content: `### Normalize Worry as a Flawed Protector\n"It sounds like your mind is constantly scanning for threats, trying to protect you by thinking through every possible negative outcome. That's an exhausting job. This 'what if' thinking is a hallmark of generalized anxiety. It's your brain trying to solve problems that haven't happened yet."\n\n### Differentiate Productive vs. Unproductive Worry\n"Some worry is helpful‚Äîit helps us solve problems. But it sounds like you're stuck in unproductive worry, where you just spin on 'what ifs' without any resolution. The goal isn't to stop worrying, but to learn to let go of the unproductive kind."\n\n### Introduce a Containment Strategy\n"What if you didn't have to carry these worries around all day? We can try an experiment called **Worry Postponement & 'Worry Time'**. This involves setting aside a specific, short period each day to worry, and 'postponing' any worries that pop up outside that time."\n\n### Challenge the Underlying Beliefs\n"Often, we believe that worrying helps us prepare or prevents bad things from happening. Let's challenge that. Has all this worrying actually prevented a catastrophe, or has it just made you feel anxious and tired? We can use **Thought Challenging - cognitive restructuring** to examine the usefulness of worry."`
        },
        {
            id: 'yellow-abandonment-fear',
            title: 'Fear of Abandonment / Frantic Efforts to Connect',
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['abandonment', 'rejection', 'bpd', 'relationships', 'anxious attachment', 'yellow'],
            content: `### Validate the Primal Fear\n"That fear of being left or abandoned is one of the most powerful and painful human emotions. When it gets activated, it can feel like a life-or-death situation. It makes perfect sense that you would do anything to stop that feeling, even things that might push people away in the long run."\n\n### Connect Emotion to Action Urge\n"When that panic of being abandoned hits, what does it make you want to do? Text them 20 times? Pick a fight to get a reaction? Let's get clear on that action urge. We can use **Check the Facts (DBT)** to see if the intensity of the fear matches the current situation."\n\n### Focus on Self-Soothing First\n"Before you act on that urge, the most important first step is to soothe your own nervous system. The goal is to get through the wave of panic without making the situation worse. Let's try **Grounding in the 'Here and Now' with a Traumatized Part**, because often this fear comes from a younger place."\n\n### Build a 'Life Worth Living' Outside the Relationship\n"This fear gets so powerful when one person becomes our entire world. A big part of the work is building a life that feels full and meaningful on its own, so that one relationship doesn't hold all the power. This involves **Values Clarification & Committed Action**."\n\n### Consider Relational Patterns\n"Sometimes this fear leads us into predictable dynamics. The **The Drama Triangle (Karpman)** can be a helpful way to see if we're getting stuck in roles like the Victim or Rescuer in our relationships."`
        },
        {
            id: 'yellow-anhedonia',
            title: 'Feeling Empty / Anhedonia',
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['anhedonia', 'emptiness', 'numbness', 'depression', 'motivation', 'yellow'],
            content: `### Validate the Emptiness\n"It sounds like all the color has been drained from your world. That feeling of emptiness or numbness, where nothing brings you joy, is one of the most painful parts of depression. It's not just sadness; it's the absence of feeling. That's a heavy, lonely place to be."\n\n### Explain the 'Action First' Principle\n"When you're feeling this way, motivation is gone. We can't wait for it to come back. The therapy for this is based on a principle that feels counter-intuitive: action comes *before* motivation. We have to act first to create the possibility of feeling something later."\n\n### Introduce Behavioral Activation\n"We're going to try an experiment called **Behavioral Activation**. The goal is not to feel good; the goal is simply to *do* something, even one tiny thing. We'll pick an activity, schedule it, and do it, no matter how pointless it feels. The only goal is to check it off the list."\n\n### Focus on Mastery or Connection, Not Pleasure\n"Let's forget about 'pleasure' for now. That's too high a bar. Let's brainstorm small actions that could give you even a tiny sense of accomplishment (mastery) or connection. Could you make your bed? Could you text one person 'hello'? We're looking for a 1% change, not a 100% cure."\n\n### Find the 'Opposite' of Empty\n"If emptiness is a void, what's the opposite? It might be connection, purpose, or sensation. Let's use **Values Clarification & Committed Action** to identify one value to move toward, even when you feel nothing."`
        },
        {
            id: 'yellow-sobriety-ambivalence',
            title: 'Ambivalence About Sobriety',
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['addiction', 'sobriety', 'ambivalence', 'motivation', 'substance use', 'yellow'],
            content: `### Normalize the Conflict\n"It makes perfect sense that you're in two minds about this. A part of you wants to stop using because of the negative consequences, and another part of you doesn't want to give it up because it *works* in some way‚Äîit helps you cope, relax, or feel something. Both parts are valid. We don't have to pick a side right now."\n\n### Explore the 'Pros and Cons'\n"Let's honor both sides of this conflict. We can use the **Pros and Cons / Decisional Balance** worksheet to map it out. What are the good things about using? What are the not-so-good things? And then, what are the good things and not-so-good things about the idea of sobriety? Just seeing it all on paper can bring a lot of clarity."\n\n### Personify the 'Using Part'\n"Let's get curious about the part of you that wants to use. What is its job? What is it trying to do for you? What is it afraid would happen if it stopped doing its job? This is an application of **Acknowledging an Emotional Part**."\n\n### Lower the Bar from 'Forever'\n"The idea of being sober 'forever' can be completely overwhelming. Let's forget about forever. What would it be like to think about just for today? Or just for the next hour? We can use **Solution-Focused Brief Therapy (SFBT) Techniques** to focus on small, manageable steps."`
        },
        {
            id: 'yellow-ruminating-ex',
            title: 'Struggling to Move On / Ruminating on Ex',
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['breakup', 'rumination', 'moving on', 'grief', 'obsession', 'yellow'],
            content: `### Normalize the "Stuck" Feeling\n"It makes so much sense that your mind keeps going back to them. Rumination is like a mental habit the brain gets into, trying to solve an unsolvable problem or make sense of a deep hurt. It's frustrating, but it's a very common part of grieving a relationship."\n\n### Externalize the Rumination\n"What if we think of these looping thoughts not as 'you,' but as a 'grief channel' that your brain keeps tuning into? You don't have to believe everything you hear on that channel. We can practice noticing it's on and then gently changing the station. Techniques from **ACT Defusion: Distancing from Thoughts** can be really helpful here."\n\n### Explore the Function\n"What do you think this rumination is trying to do for you? Is it trying to keep you connected to them? Is it trying to find an answer to 'what went wrong?' Sometimes understanding its purpose can help us find a healthier way to meet that need."\n\n### Look for Patterns\n"Sometimes, the relationships we struggle to let go of the most are the ones that fit into a larger pattern in our lives. Would you be open to exploring that? We could use a tool for **Identifying & Challenging Relational Patterns** to see if any themes come up."`
        },
        {
            id: 'yellow-family-dynamics',
            title: 'Navigating Difficult Family Dynamics',
            category: 'Yellow Zone',
            emoji: 'üü®',
            color: 'yellow',
            tags: ['family', 'dynamics', 'boundaries', 'enmeshment', 'communication', 'yellow'],
            content: `### Validate the Challenge\n"Family relationships are complicated. These patterns and roles often go back decades, so it's no wonder they feel so difficult to change. It can feel like you're stuck in a play where everyone already knows their lines."\n\n### Introduce the Concept of Roles\n"In many family systems, people fall into certain roles to keep the system in balance, even if it's an unhealthy balance. Have you ever heard about **Unhelpful Family Roles** like the 'scapegoat' or the 'hero'? Sometimes just having a name for the dynamic can be incredibly validating and empowering. The **The Drama Triangle (Karpman)** is another useful model."\n\n### Focus on What You Can Control\n"We can't change other people, but we can change our own steps in the dance. This often starts with getting clearer on our own boundaries. We can spend some time on **Boundary Setting Exploration & Practice** to figure out what you need and how to start asking for it."\n\n### Shift from 'Why?' to 'What?'\n"Instead of getting stuck on 'Why are they like this?', we can shift to 'What do I need to do to take care of myself in this situation?' This moves us from frustration into empowerment. Using the **Circles of Control, Influence, and Concern** can help clarify where to put your energy."`
        },
        // --- GREEN ZONE ---
        {
            id: 'green-building-resilience',
            title: 'Building Resilience',
            category: 'Green Zone',
            emoji: 'üíö',
            color: 'green',
            tags: ['resilience', 'strengths', 'coping', 'growth', 'post-traumatic growth', 'green'],
            content: `### Define Resilience\n"Resilience isn't about 'bouncing back' to exactly who you were before. It's about adapting and even growing in the face of adversity. It's not about avoiding stress; it's about learning how to navigate through it and come out the other side, maybe even with new strengths and insights."\n\n### Cultivate Supportive Relationships\n"Resilience is rarely a solo act. Strong, supportive relationships are a key ingredient. What's one small step you could take this week to nurture a healthy connection in your life?"\n\n### Focus on Strengths\n"Tough times can make us forget our strengths. Let's take a moment to focus on what's strong in you, not just what's wrong. We can use the **Identifying and Using Character Strengths** intervention to help with this."\n\n### Practice Self-Compassion\n"Beating yourself up when you're already down just makes things harder. Treating yourself with the same kindness you'd offer a friend is a powerful resilience practice. The **Self-Compassion Break (Kristin Neff)** is a great tool for this."\n\n### Find Meaning and Purpose\n"Connecting to your values can be a powerful anchor in stormy seas. When you know what matters to you, it can provide a sense of direction and purpose, even when things are hard. Let's revisit your **Values Clarification & Committed Action** work."\n\n### Look for the Good\n"Resilience also involves training our brains to notice the good, not just the bad. A simple but powerful exercise for this is practicing **Three Good Things** each day."`
        },
        {
            id: 'green-character-strengths',
            title: 'Identifying and Using Character Strengths',
            category: 'Green Zone',
            emoji: 'üíö',
            color: 'green',
            tags: ['strengths', 'positive psychology', 'via', 'self-esteem', 'resilience', 'green'],
            content: `### Shift from Deficits to Strengths\n"So much of therapy can focus on what's not working. For a moment, let's shift our focus to what *is* working. Let's talk about your character strengths‚Äîthe positive parts of your personality that make you who you are."\n\n### Brainstorming Strengths\n"When do you feel most authentic and alive? What do other people compliment you on? Let's think about strengths like creativity, bravery, kindness, curiosity, fairness, humor, gratitude, leadership..."\n\n*(Therapist Note: You can refer to the 24 VIA Character Strengths for a comprehensive list if needed.)*\n\n### Choose a Signature Strength\n"Looking at this list, which one or two feel most like 'you' at your core? This is your signature strength."\n\n### Plan to Use It in a New Way\n"The research shows that we get a significant happiness boost when we use our signature strengths in a new way. If your strength is 'curiosity,' could you visit a new part of town this week? If it's 'kindness,' could you do an anonymous good deed? Let's brainstorm one small, new way to put your strength into action."\n\n### Intervention Insight\n* This is a core exercise from Positive Psychology.\n* It can be a powerful antidote to the shame and self-criticism found in **Shame vs. Guilt**.`
        },
    ];

    const interventionsData = [
        // --- CRISIS & REGULATION ---
        {
            id: 'intervention-verbal-deescalation',
            title: 'Verbal De-escalation Techniques',
            category: 'Intervention',
            subCategory: 'Crisis & Regulation',
            color: 'blue',
            tags: ['de-escalation', 'crisis', 'anger', 'agitation', 'safety'],
            content: `### Core Rationale\nTo lower the emotional temperature of a conversation, ensure safety, and build enough rapport to allow for problem-solving. The goal is not to "win" but to help the person regain control.\n\n### Key Principles\n1.  **Manage Your Own Non-Verbals:** Your calm is contagious. Keep your tone of voice low and slow. Speak calmly. If on video, keep your body language open and non-threatening (no crossed arms).\n2.  **Listen Actively & Reflect:** "Let the person vent. Don't interrupt. Reflect back what you hear to show you're listening: 'So what I'm hearing is you're furious because you feel like nobody is listening to you. Is that right?'"\n3.  **Validate, Validate, Validate:** "Validation doesn't mean you agree; it means you understand their feeling is real *for them*. Use phrases like: 'That makes sense,' 'I can see why you'd be so upset,' or 'That sounds incredibly frustrating.'"\n4.  **Avoid Power Struggles:** "Don't get into arguments about who is right or wrong. Avoid saying 'calm down' or 'but'. Instead of 'but', try using 'and': 'You're feeling angry, *and* we need to figure out a safe plan.'"\n5.  **Give Choices & Control:** "When people feel out of control, giving them choices can help. 'Would you rather we talk about X or Y first?' or 'Would it be more helpful to try a breathing exercise or just sit for a minute?'"\n6.  **Set Clear, Calm Limits:** "If behavior is escalating, set limits calmly and respectfully. 'I want to keep talking with you, and I can't do that if you're screaming. Can we try to continue in a calmer tone?'"`
        },
        {
            id: 'intervention-tipp',
            title: 'TIPP Skill for Rapid Distress Reduction',
            category: 'Intervention',
            subCategory: 'Crisis & Regulation',
            color: 'blue',
            tags: ['dbt', 'distress tolerance', 'regulation', 'panic', 'overwhelm'],
            content: `### Core Rationale\nTIPP skills directly target the body's acute stress response, changing your body chemistry and creating a window to re-engage your thinking brain.\n\n### T - Temperature\n"First, let's try to change your body temperature. The idea is to create a sudden shift. If you can, go splash some cold water on your face - really let it cover your cheeks and the area under your eyes. This can help slow your heart rate down very quickly when you're agitated."\n\n### I - Intense Exercise\n"If you're feeling a lot of restless, built-up energy, a very short burst of exercise can help. Could you do some jumping jacks, run in place as fast as you can, or even just tense and release all your big muscle groups very hard and fast?"\n\n### P - Paced Breathing\n"Now, let's focus on slowing your breath. We're going to make your exhale longer than your inhale. Try breathing in deeply through your nose for 4 seconds, and then breathe out very slowly and gently through your mouth for 6 seconds."\n\n### P - Paired Muscle Relaxation\n"As you continue breathing slowly, when you breathe in, tense a group of muscles. Let's try that with your hands and arms; inhale through your nose, make tight fists. Hold that tension. Now as you exhale, slowly release the squeeze. Notice the difference."\n\n### Clinical Considerations\n* **When to Use:** Best for acute, physiological distress (panic, extreme agitation, intense urges).\n* **When to Avoid:** May not be suitable for individuals with certain medical conditions (e.g., heart problems, breathing issues). Always check for medical contraindications.`
        },
        // --- SOMATIC & GROUNDING ---
        {
            id: 'intervention-somatic-anchors',
            title: 'Simple Somatic Anchors',
            category: 'Intervention',
            subCategory: 'Somatic & Grounding',
            color: 'blue',
            tags: ['somatic', 'grounding', 'body', 'anxiety', 'dissociation'],
            content: `### Core Rationale\nImmediate ways to connect with the present moment using bodily sensations. These anchors signal safety to the nervous system and pull your attention out of overwhelming internal states.\n\n* **Noticing Feet on Floor:** "Just bring your attention down to your feet. Can you feel them on the floor? Notice the sensation of contact."\n* **Butterfly Tapping:** "Cross your arms over your chest, with hands on opposite shoulders. Start gently tapping your hands, one after the other, in a slow, rhythmic way."\n* **Hand on Heart:** "If it feels comfortable, you might try placing a hand gently on your heart. Just notice the warmth and gentle pressure."\n* **Pressing Fingertips Together:** "Try gently pressing the tips of your fingers on one hand against the tips of your fingers on the other. Just notice the sensation."`
        },
        {
            id: 'intervention-54321',
            title: 'Grounding Through Senses (5-4-3-2-1 Technique)',
            category: 'Intervention',
            subCategory: 'Somatic & Grounding',
            color: 'blue',
            tags: ['grounding', 'anxiety', 'panic', 'senses', 'mindfulness'],
            content: `### Core Rationale\nAnchoring in the present by noticing things through all five senses. This pulls your focus out of anxious thoughts and into your immediate, safe environment.\n\n### How to Practice\n"Let‚Äôs walk through your senses to ground you in the here and now."\n\n* **5 THINGS YOU CAN SEE:** Look around and name five things you see. (e.g., "I see a lamp, a blue pen, a window...")\n* **4 THINGS YOU CAN FEEL:** Notice four things you can feel with your body. (e.g., "I feel the chair under me, my feet on the floor...")\n* **3 THINGS YOU CAN HEAR:** Listen carefully and name three sounds. (e.g., "I hear the fan, a car outside...")\n* **2 THINGS YOU CAN SMELL:** Notice two scents. (e.g., "I can smell coffee, the soap on my hands...")\n* **1 THING YOU CAN TASTE:** Name one thing you can taste. (e.g., "I can taste my toothpaste," or just notice the taste in your mouth).`
        },
        {
            id: 'intervention-dropping-anchor',
            title: 'Dropping Anchor (ACT)',
            category: 'Intervention',
            subCategory: 'Somatic & Grounding',
            color: 'blue',
            tags: ['act', 'grounding', 'mindfulness', 'anxiety', 'overwhelm'],
            content: `### Core Rationale\nA comprehensive grounding exercise from ACT to acknowledge internal chaos while deliberately re-engaging with the physical world.\n\n### How to Practice (ACE)\n"Let's try an exercise called Dropping Anchor. The storm of thoughts and feelings can continue, we're just going to drop an anchor into the present moment."\n\n1.  **A - Acknowledge:** "First, silently and kindly acknowledge what's happening inside you. Notice the thoughts, the feelings, the memories. Just notice them without judgment. 'I'm noticing feelings of anxiety,' or 'I'm noticing my mind is racing.'"\n2.  **C - Come back into your body:** "Now, gently bring your attention to your physical body. You can press your feet into the floor, straighten your back, press your fingertips together, or slowly stretch. Feel your body in the chair, right here, right now."\n3.  **E - Engage with the world:** "Finally, notice what's around you. Look around the room and find five things you can see. Notice two things you can hear. Notice one thing you can smell. Re-engage with where you are."\n\n"The storm might still be there, but your anchor is holding you steady in the present."`
        },
        {
            id: 'intervention-grounding-trauma-part',
            title: "Grounding in the 'Here and Now' with a Traumatized Part",
            category: 'Intervention',
            subCategory: 'Somatic & Grounding',
            color: 'blue',
            tags: ['somatic', 'grounding', 'trauma', 'parts work', 'cptsd', 'dissociation'],
            content: `### Core Rationale\nWhen a younger, traumatized part is activated (feeling small, scared, helpless), standard grounding can feel invalidating. This approach first acknowledges the part's reality and then gently orients the adult self to the present, creating a sense of internal safety.\n\n### The Script\n1.  **Acknowledge the Part:** "I know that a part of you feels very young and very scared right now. It feels like [the bad thing] is happening all over again. I see that part, and I'm not going to push it away. It's welcome here."\n\n2.  **Validate its Experience:** "It makes sense that this part is terrified. It's remembering a time when you weren't safe. Thank you to that part for holding onto this memory to try and protect you."\n\n3.  **Engage the Adult Self:** "Now, I want to speak to the adult you. The you that is [current age] years old. Can the adult you look around the room right now? Notice one thing that tells you that you are in the current year, not back then. (e.g., 'I see my college diploma on the wall,' 'I can feel my car keys in my pocket')."\n\n4.  **Internal Co-regulation:** "Can the adult you let that scared, younger part know that you are here now? You can say internally, 'I'm here. I'm grown up now. I will keep us safe.' You might even place a hand on your own heart as a gesture of comfort from your adult self to your younger self."\n\n5.  **External Grounding:** "Now, let's have the adult you feel your feet on the floor. Really press them down. You are here, in this room, in this year. You are safe."`
        },
        // --- COGNITIVE & DBT ---
        {
            id: 'intervention-wise-mind',
            title: "Developing the 'Wise Mind' (DBT)",
            category: 'Intervention',
            subCategory: 'Cognitive & DBT',
            color: 'blue',
            tags: ['dbt', 'wise mind', 'intuition', 'balance', 'emotion regulation'],
            content: `### Core Rationale\nWise Mind is the integration of "Reasonable Mind" (logic, facts, planning) and "Emotion Mind" (feelings, urges, intuition). It's the calm, centered place where we can acknowledge our emotions while also thinking rationally, leading to more effective decisions.\n\n### The Three States of Mind\n1.  **Reasonable Mind:** "This is your 'cool,' logical side. It plans, evaluates facts, and thinks things through. It's very helpful, but without emotion, life can be cold and robotic."\n2.  **Emotion Mind:** "This is your 'hot,' feeling-driven side. It's where passion, love, and fear live. It's vital for a rich life, but when it's in complete control, it can lead to impulsive and unhelpful actions."\n3.  **Wise Mind:** "This is the overlap. It's that deep, intuitive knowing inside you. It acknowledges the logic from Reasonable Mind and the feelings from Emotion Mind, and then finds the centered, effective path forward. It's the feeling of 'just knowing' the right thing to do."\n\n### How to Access Wise Mind\n* **"What would Wise Mind do?":** Simply asking the question can create a pause and a shift in perspective.\n* **Mindful Breathing:** "Let's try focusing on your breath. As you breathe in, say 'Wise' to yourself. As you breathe out, say 'Mind.' Do this for a minute and see what emerges."\n* **Dropping into the Center:** "Imagine your Emotion Mind is in your heart and your Reasonable Mind is in your head. Can you bring your attention to the center of your body, in your belly? That physical center can be an anchor for your Wise Mind."`
        },
        {
            id: 'intervention-check-the-facts',
            title: 'Check the Facts (DBT)',
            category: 'Intervention',
            subCategory: 'Cognitive & DBT',
            color: 'blue',
            tags: ['dbt', 'emotion regulation', 'thoughts', 'reality testing'],
            content: `### Core Rationale\nA skill to determine if an emotional reaction is justified by the facts of a situation. If the emotion doesn't fit the facts, it opens the door to using Opposite Action.\n\n### How to Practice\n1.  **What is the emotion I want to change?** (e.g., Anger, Fear, Sadness)\n2.  **What is the event prompting my emotion?** Describe the facts of what happened, without interpretations. (e.g., "My friend didn't text me back today.")\n3.  **What are my interpretations, thoughts, and assumptions about the event?** (e.g., "They must be mad at me. I did something wrong.")\n4.  **Am I assuming a threat?** What is the threat? How probable is it that the threat is real?\n5.  **What's the catastrophe?** What is the worst-case scenario here?\n6.  **Does my emotion (and its intensity) fit the actual facts?** (e.g., "Is intense anger justified just because a text wasn't returned? Probably not. Maybe they are just busy.")`
        },
        {
            id: 'intervention-thought-challenging',
            title: 'Thought Challenging - cognitive restructuring',
            category: 'Intervention',
            subCategory: 'Cognitive & DBT',
            color: 'blue',
            tags: ['cbt', 'thoughts', 'reframing', 'cognitive distortions'],
            content: `### Core Rationale\nExamining the evidence for and against automatic negative thoughts and considering alternative, more balanced perspectives.\n\n### How to Practice\n1.  **Identify the Hot Thought:** "When you felt that strong emotion, what specific thought was going through your mind?"\n2.  **Examine the Evidence For:** "What evidence or experiences make you believe this thought is true?"\n3.  **Examine the Evidence Against:** "Now, let's play detective. What evidence suggests this thought isn't 100% true?"\n4.  **Consider Alternatives:** "If that thought isn't completely true, what's a more balanced or alternative way to think about this situation?"\n5.  **Assess the Impact:** "How does believing the hot thought affect you? How would believing the balanced thought change things?"`
        },
        {
            id: 'intervention-worry-postponement',
            title: "Worry Postponement & 'Worry Time'",
            category: 'Intervention',
            subCategory: 'Cognitive & DBT',
            color: 'blue',
            tags: ['cbt', 'gad', 'anxiety', 'worry', 'containment'],
            content: `### Core Rationale\nA CBT technique for managing chronic worry (like in GAD). Instead of trying to suppress worries (which doesn't work), you consciously postpone them to a designated, limited time. This helps you regain control over your attention and breaks the cycle of constant rumination.\n\n### The Steps\n1.  **Schedule 'Worry Time':** "Let's schedule a 15-20 minute 'Worry Time' for you each day. It should be the same time and place every day, and not too close to bedtime. This is your official appointment with your worries."\n\n2.  **Postpone Worries:** "When a worry pops into your head outside of this time, acknowledge it and then make a conscious choice to postpone it. You can say to yourself, 'That's a good worry. I'll save that for my 4:00 PM Worry Time.' You can even jot it down on a 'worry list' to look at later."\n\n3.  **Use Your Worry Time:** "When Worry Time arrives, sit down with your list and worry intensely about those things. You have full permission to let your mind spin on them. If you run out of worries, you don't have to find more. When the timer goes off, stop. Get up and do something else."\n\n4.  **Problem-Solve (If Possible):** "During Worry Time, for any worries that are actual, solvable problems, you can switch to **Structured Problem-Solving**. For worries that are hypothetical 'what-ifs,' the goal is just to contain them within that time."\n\n### Why It Works\nThis technique teaches your brain that you are in control of when you worry, not the other way around. It also often reveals that by the time you get to Worry Time, many of the day's worries no longer seem as urgent or important.`
        },
        // --- RELATIONAL & INTERPERSONAL ---
        {
            id: 'intervention-dear-man',
            title: 'DEAR MAN: For Interpersonal Effectiveness',
            category: 'Intervention',
            subCategory: 'Relational & Interpersonal',
            color: 'blue',
            tags: ['dbt', 'communication', 'assertiveness', 'boundaries', 'needs'],
            content: `### Core Rationale\nA structured way to ask for something you want or to say "no" effectively and assertively.\n\n### D - Describe\n"Just the facts. What is the specific, objective situation? (e.g., 'The last three times we planned to meet, you cancelled on the day.')"\n\n### E - Express\n"Clearly state your feelings using 'I-statements'. (e.g., 'I feel frustrated and a bit hurt when this happens.')"\n\n### A - Assert\n"Clearly state what you need or want. Be direct. (e.g., 'I would like us to find a way to make our plans more reliable...')"\n\n### R - Reinforce\n"Explain the positive outcome if your request is met. (e.g., 'It would help me feel more secure in our friendship...')"\n\n### M - (Stay) Mindful\n"Keep your focus on your goal. Avoid getting sidetracked."\n\n### A - Appear Confident\n"Use a confident tone and body language, even if you feel nervous."\n\n### N - Negotiate\n"Be willing to listen and find a workable compromise, but don't give up on your core need."\n\n### Clinical Considerations\n* For situations where maintaining the relationship is the primary goal (vs. getting your objective), consider the **GIVE** skill: be **G**entle, act **I**nterested, **V**alidate, and use an **E**asy manner.`
        },
        {
            id: 'intervention-relational-patterns',
            title: 'Identifying & Challenging Relational Patterns',
            category: 'Intervention',
            subCategory: 'Relational & Interpersonal',
            color: 'blue',
            tags: ['patterns', 'relationships', 'insight', 'repetition compulsion', 'schema'],
            content: `### Core Rationale\nTo help clients move from feeling like a victim of circumstance to an active participant in their relational lives by identifying recurring themes, roles, and outcomes.\n\n### Step 1: Gather the Data (Relationship Inventory)\n"Let's look back, not to dwell, but to learn. Think about your significant past relationships‚Äîromantic, friendships, even family. Let's just list them out."\n\n### Step 2: Look for Recurring Themes\n"As we look at this list, do any patterns jump out? Let's consider a few areas:"\n* **The Beginning:** "How do your relationships typically start? Is there a feeling of intense chemistry, a sense of 'rescuing' or being rescued?"\n* **The Middle (The Role You Play):** "What role do you find yourself playing over and over? The caretaker? The peacemaker? The one who needs fixing? The one who is always understanding?"\n* **The End:** "How do your relationships tend to end? Is there a common feeling you're left with? (e.g., 'abandoned,' 'suffocated,' 'betrayed,' 'misunderstood')."\n\n### Step 3: Connect Patterns to Core Beliefs\n"This pattern of [e.g., choosing unavailable partners] often connects back to a deeper belief about ourselves or relationships. Does this pattern feel linked to a belief like, 'I have to earn love,' or 'I'm not worthy of a secure relationship?'"\n\n### Step 4: Challenge the Pattern with New Behavior\n"Now that we see the pattern, we can consciously choose to take a different step. It doesn't have to be huge. If your pattern is to always be the caretaker, what's one small way you could practice receiving this week? This is about using your **Values Clarification & Committed Action** to guide your choices, not your old patterns."`
        },
        // --- ADDICTION & RECOVERY ---
        {
            id: 'intervention-relapse-prevention',
            title: 'Relapse Prevention Plan',
            category: 'Intervention',
            subCategory: 'Addiction & Recovery',
            color: 'blue',
            tags: ['addiction', 'relapse prevention', 'sobriety', 'coping', 'planning'],
            content: `### Core Rationale\nA structured, proactive plan to identify and manage high-risk situations, urges, and warning signs to maintain sobriety. It's a roadmap for navigating the challenges of recovery.\n\n### Key Components of the Plan\n1.  **My Triggers (High-Risk Situations):** "Let's make a specific list of the people, places, things, and feelings that create cravings or make you want to use."\n    * *External:* People you used with, bars, parties, seeing drug paraphernalia.\n    * *Internal:* Feelings like boredom, loneliness, anger, anxiety; physical pain.\n\n2.  **My Early Warning Signs:** "What are the first signs that you're heading toward a slippery slope? These are often subtle changes in your thinking and behavior."\n    * *Examples:* Romanticizing past use, isolating yourself, stopping recovery meetings, feeling overly stressed or cocky about your sobriety.\n\n3.  **My Coping Strategies for Cravings:** "When a craving hits, what is your step-by-step action plan? Let's make it concrete."\n    * *Examples:* "First, I will call my sponsor. Then, I will use the **TIPP Skill for Rapid Distress Reduction**. After that, I will go for a walk and listen to a recovery podcast."\n\n4.  **My Sober Support Network:** "Let's list at least 3-5 people you can call when you're struggling. Include their names and numbers."\n\n5.  **My Plan for Self-Care:** "Recovery requires physical, mental, and emotional energy. What are some healthy activities that help you recharge?"\n    * *Examples:* Exercise, healthy meals, good sleep, hobbies, meditation.\n\n6.  **In Case of a Lapse:** "If a lapse happens, what is your immediate plan to prevent it from becoming a full-blown relapse? (This is where understanding the **The Abstinence Violation Effect** is key)."\n    * *Example:* "I will call my sponsor or therapist immediately and be 100% honest. I will go to a meeting within 24 hours. I will not keep it a secret."`
        },
        // --- GRIEF & LOSS ---
        {
            id: 'intervention-breakup-first-aid',
            title: 'Relationship Breakup: Emotional First Aid',
            category: 'Intervention',
            subCategory: 'Grief & Loss',
            color: 'blue',
            tags: ['breakup', 'grief', 'first aid', 'coping', 'rejection'],
            content: `### Core Rationale\nTo provide immediate, practical steps to manage the acute pain of a breakup, preventing further emotional injury and beginning the stabilization process. This is about emotional triage, not long-term healing.\n\n### The Steps\n1.  **Acknowledge the Wound (Radical Acceptance):** "The first step is to gently and clearly acknowledge the reality of the situation without fighting it. 'This relationship is over. This hurts terribly.' Fighting reality is like picking at a scab; it prevents healing. This is an application of **Radical Acceptance**."\n\n2.  **Stop the 'Bleeding' (No Contact & Information Detox):** "To heal, you must stop reinjuring yourself. This means committing to a period of no contact. No calls, no texts, and critically, no checking their social media. Every time you check, you are exposing the wound to infection. Mute, block, or delete if you have to. This is an act of self-protection."\n\n3.  **Treat the Symptoms (Self-Soothing & Distraction):** "The pain will come in waves. Your job is to soothe yourself through them. What is one small thing that can bring you comfort? A warm blanket? A favorite movie? A hot shower? Use the **ACCEPTS: For Distress Tolerance (Distraction)** skill to give your mind a break. Use **Mindful Self-Compassion: Soothing Touch** to calm your body."\n\n4.  **Rally Your Support System (Connection):** "Shame will tell you to hide. You must do the opposite. Reach out to one or two trusted friends or family members. You don't need advice; you need presence. Say, 'I'm going through a really hard time and could just use someone to sit with me.'"\n\n5.  **Write It Out (Externalize the Pain):** "Get a journal and write down everything you're feeling‚Äîthe anger, the sadness, the confusion. Don't edit it. This gets the swirling thoughts out of your head and onto the page, which can provide immense relief."`
        },
        // --- NEW INTERVENTIONS ---
        {
            id: 'intervention-sleep-hygiene',
            title: 'Sleep Hygiene & Stimulus Control (CBT-I)',
            category: 'Intervention',
            subCategory: 'Practical Life Skills',
            color: 'blue',
            tags: ['cbt-i', 'sleep', 'insomnia', 'habits', 'health'],
            content: `### Core Rationale\nCBT for Insomnia (CBT-I) techniques are designed to strengthen the connection between your bed and sleep, and to align your body's natural sleep drive with a healthy routine. These are behavioral changes, not quick fixes.\n\n### Sleep Hygiene (The Foundations)\n"These are habits that promote good sleep. Let's see which ones might be helpful to try:"\n* **Consistency:** "Go to bed and wake up at the same time every day, even on weekends. This sets your body's internal clock."\n* **Wind-Down Routine:** "Create a relaxing 30-60 minute routine before bed. No screens. Think reading a book, gentle stretching, listening to calm music."\n* **Cool, Dark, Quiet Environment:** "Optimize your bedroom for sleep. Use blackout curtains, a fan for white noise, and keep the temperature cool."\n* **Avoid Stimulants:** "Avoid caffeine and nicotine for at least 6-8 hours before bed."\n* **Limit Alcohol:** "Alcohol might make you feel sleepy initially, but it disrupts sleep quality later in the night."\n\n### Stimulus Control (Re-training Your Brain)\n"This is about re-associating your bed with sleep, and only sleep."\n* **Bed is for Sleep & Sex Only:** "No working, eating, or watching TV in bed. If your bed is your office and your movie theater, your brain gets confused about what it's supposed to do there."\n* **The 20-Minute Rule:** "If you're in bed and can't fall asleep after about 20 minutes, get up. Go to another room and do something calm and boring (like reading a dull book) in dim light. Only return to bed when you feel sleepy again. Repeat as necessary. This is hard, but it breaks the cycle of frustrated tossing and turning."`
        },
        {
            id: 'intervention-cft-three-circles',
            title: 'Compassion-Focused Therapy (CFT): The Three Circles',
            category: 'Intervention',
            subCategory: 'Other Modalities',
            color: 'blue',
            tags: ['cft', 'compassion', 'emotion regulation', 'burnout', 'anxiety'],
            content: `### Core Rationale\nDeveloped by Dr. Paul Gilbert, this model illustrates our three main emotion regulation systems. Many mental health struggles come from an imbalance, typically an over-developed Threat system and under-developed Soothing system. The goal is to consciously bring them into balance.\n\n### The Three Systems (Circles)\n1.  **Threat System (Red Circle):** "This is your brain's smoke detector. Its job is to protect you. It's fueled by adrenaline and cortisol and generates feelings like anger, anxiety, and disgust. It's essential for survival, but when it's always on, it leads to exhaustion and burnout."\n\n2.  **Drive System (Blue Circle):** "This is your 'go-getter' system. It's about pursuing goals, achieving, and acquiring resources. It's fueled by dopamine and gives you feelings of excitement, motivation, and pleasure. It's important for accomplishment, but living only here can also lead to burnout."\n\n3.  **Soothing System (Green Circle):** "This is your 'rest and digest' system. It's associated with feelings of contentment, safety, and connection. It's fueled by oxytocin and opiates. This system allows you to feel cared for and calm. For many people, this system is under-developed."\n\n### The Practice: Balancing the Circles\n"Let's think about your week. Which circles have you been spending the most time in? It sounds like you've been living in the Red (Threat) and Blue (Drive) circles. What is one small thing you could do today to intentionally activate your Green (Soothing) system? It doesn't have to be big. It could be listening to a favorite song, stroking a pet, or practicing a **Self-Compassion Break (Kristin Neff)**."`
        },
        {
            id: 'intervention-narrative-externalizing',
            title: 'Externalizing the Problem (Narrative Therapy)',
            category: 'Intervention',
            subCategory: 'Other Modalities',
            color: 'blue',
            tags: ['narrative therapy', 'externalizing', 'shame', 'identity', 'problem'],
            content: `### Core Rationale\nA core technique from Narrative Therapy that separates a person from their problem. Instead of "I am a depressed person," it becomes "Depression is affecting my life." This shift reduces shame, opens up space for curiosity, and allows the person to take a stand against the problem.\n\n### How to Practice\n1.  **Name the Problem:** "It sounds like [Anxiety/Depression/Perfectionism] has been a big part of your life. Let's give it a name. What would you call it? 'The Worry Monster'? 'The Grey Fog'?"\n\n2.  **Map its Influence:** "Let's get curious about this 'Worry Monster.' What does it tell you? When is it strongest? What does it make you do? What does it steal from you (e.g., connection, joy, sleep)?"\n\n3.  **Look for 'Unique Outcomes':** "Now, tell me about a time, even a small one, when the 'Worry Monster' tried to take over, but you did something different. A time you didn't listen to it. What did you do instead? What does that say about you and what you value?"\n\n4.  **Thicken the New Story:** "This moment when you resisted the 'Worry Monster' is part of a different story about you‚Äîa story of strength and resilience. How can we build on that? What's another small step you could take to act from this story of strength, rather than the story the 'Worry Monster' tells?"\n\n### The Guiding Principle\n"The person is not the problem; the problem is the problem."`
        },
        {
            id: 'intervention-three-good-things',
            title: 'Three Good Things (Positive Psychology)',
            category: 'Intervention',
            subCategory: 'Positive Psychology',
            color: 'blue',
            tags: ['positive psychology', 'gratitude', 'resilience', 'depression', 'well-being'],
            content: `### Core Rationale\nA simple yet powerful exercise from positive psychology proven to increase well-being and reduce depressive symptoms. Our brains have a 'negativity bias'‚Äîthey are like Velcro for bad experiences and Teflon for good ones. This exercise retrains the brain to scan for and savor positive experiences.\n\n### The Practice\n"I'd like to suggest a simple exercise to try each night before you go to sleep for the next week. It only takes a few minutes."\n\n1.  **Recall Three Good Things:** "At the end of your day, think of three things that went well. They don't have to be monumental. It could be as simple as 'I enjoyed my morning coffee,' 'A stranger smiled at me,' or 'I finished a task at work.'"\n\n2.  **Write Them Down:** "Physically write them down in a notebook or a note on your phone."\n\n3.  **Reflect on Your Role:** "For each good thing, write a brief sentence about *why* it happened or what your role was in making it happen. This is not about taking all the credit, but about recognizing your own agency. For example, 'I enjoyed my coffee because I took the time to make it just how I like it,' or 'I finished the task because I focused for 15 minutes.'"\n\n### Why It Works\n* **It Fights the Negativity Bias:** It forces you to actively look for positives you might otherwise have missed.\n* **It Promotes Savoring:** Taking the time to reflect on the good thing helps you absorb it more fully.\n* **It Fosters Agency:** Recognizing your role, no matter how small, counters feelings of helplessness.`
        },
    ];

    const psychoeducationData = [
        {
            id: 'psychoed-cft-systems',
            title: 'The Threat, Drive, & Soothing Systems (CFT)',
            category: 'Psychoeducation',
            emoji: 'üß†',
            color: 'purple',
            tags: ['cft', 'compassion', 'emotion regulation', 'burnout', 'anxiety', 'psychoed'],
            content: `### What Are the Three Systems?\nCompassion-Focused Therapy (CFT) suggests our brains have three main emotion regulation systems that evolved to help us survive. Problems arise when these systems are out of balance.\n\n1.  **The Threat System:**\n    * **Purpose:** To detect and respond to danger (fight, flight, freeze).\n    * **Feelings:** Anger, anxiety, fear, disgust.\n    * **Role:** Absolutely essential for keeping us safe. But when it's overactive, we feel constantly stressed, anxious, and on edge. It's like the smoke alarm is always going off, even when there's no fire.\n\n2.  **The Drive System:**\n    * **Purpose:** To motivate us to seek out resources, goals, and rewards.\n    * **Feelings:** Excitement, pleasure, ambition, wanting.\n    * **Role:** This system pushes us to achieve things, from finding food to getting a promotion. It's vital for accomplishment, but if we live only in this system, it can lead to burnout, comparison, and never feeling satisfied.\n\n3.  **The Soothing System:**\n    * **Purpose:** To manage distress and promote bonding and contentment. It's our 'rest and digest' and 'tend and befriend' system.\n    * **Feelings:** Calm, contentment, safety, connection, kindness.\n    * **Role:** This system is activated when we feel cared for and safe. It allows us to feel peaceful and connected to others. For many people who have experienced trauma or high levels of criticism, this system is often under-developed.\n\n### The Goal: Balance\nThe goal of CFT is not to get rid of the Threat or Drive systems, but to bring them into balance by intentionally cultivating the Soothing system. By practicing self-compassion, we can learn to calm our own threat system and feel a sense of inner safety and contentment.\n\n### Intervention Insight\n* The **Compassion-Focused Therapy (CFT): The Three Circles** intervention is a direct application of this model.`
        },
        {
            id: 'psychoed-what-is-burnout',
            title: 'What is Burnout?',
            category: 'Psychoeducation',
            emoji: 'üß†',
            color: 'purple',
            tags: ['burnout', 'stress', 'exhaustion', 'work', 'health', 'psychoed'],
            content: `### More Than Just Stress\nBurnout is a specific state of emotional, physical, and mental exhaustion caused by excessive and prolonged stress. It's not the same as just being tired or stressed; it's a feeling of being completely depleted and having nothing left to give.\n\nThe World Health Organization defines burnout by three main components:\n\n1.  **Energy Depletion or Exhaustion:** This is the core of burnout. It's a profound exhaustion that isn't fixed by a good night's sleep or a weekend off. It feels like your internal battery is dead.\n\n2.  **Increased Mental Distance, Negativism, or Cynicism:** This is an emotional detachment from your job, your relationships, or your life. You might feel cynical, critical, and irritable. It's a protective shield your mind puts up when you're overwhelmed.\n\n3.  **Reduced Professional Efficacy:** You start to feel like you're not effective at what you do. You might doubt your abilities and feel a lack of accomplishment, even if you're still performing your tasks. You feel like you're just going through the motions.\n\n### What Causes It?\nBurnout isn't a personal failing. It's often a response to a dysfunctional environment. Common causes include an overwhelming workload, feeling a lack of control, unclear expectations, a lack of social support, and a mismatch in values.\n\n### Intervention Insight\n* Understanding the **The Threat, Drive, & Soothing Systems (CFT)** can help explain why burnout happens‚Äîliving too long in the 'threat' and 'drive' systems.\n* **Boundary Setting Exploration & Practice** is a key skill for preventing or recovering from burnout.`
        },
        {
            id: 'psychoed-sleep-science',
            title: 'The Basics of Sleep Science',
            category: 'Psychoeducation',
            emoji: 'üß†',
            color: 'purple',
            tags: ['sleep', 'insomnia', 'cbt-i', 'health', 'neuroscience', 'psychoed'],
            content: `### The Two-Process Model of Sleep\nThink of your sleep as being regulated by two main systems working together:\n\n1.  **Sleep Drive (Process S):** This is like a hunger for sleep. The longer you're awake, the more your sleep drive builds up. It's caused by a chemical called adenosine accumulating in your brain. When you sleep, your brain clears out the adenosine, and the drive goes down. Napping can reduce this drive, which can make it harder to fall asleep at night.\n\n2.  **Circadian Rhythm (Process C):** This is your body's internal 24-hour clock. It's primarily regulated by light exposure. It tells your body when to be alert and when to be sleepy. A strong circadian rhythm makes you feel alert during the day and sleepy at night. Inconsistent wake-up times and lack of morning light can weaken this rhythm.\n\n### How Insomnia Develops\nInsomnia often starts when stress or anxiety disrupts sleep for a few nights. In response, you might start doing things that make sense in the short term but hurt sleep in the long term:\n* Going to bed earlier or staying in bed later to 'try' and get more sleep. This weakens your sleep drive.\n* Napping during the day. This also weakens your sleep drive.\n* Worrying about sleep and watching the clock. This creates anxiety and teaches your brain that the bed is a stressful place.\n\n### The Goal of CBT-I\nThe goal of techniques like **Sleep Hygiene & Stimulus Control (CBT-I)** is to get these two systems working together again. By keeping a consistent wake-up time, you strengthen your circadian rhythm. By getting out of bed when you're not sleeping, you build a stronger sleep drive and re-train your brain to associate the bed with sleep.`
        },
        {
            id: 'psychoed-structural-dissociation',
            title: "Understanding Structural Dissociation (The 'Parts' Model)",
            category: 'Psychoeducation',
            emoji: 'üß†',
            color: 'purple',
            tags: ['dissociation', 'parts work', 'trauma', 'cptsd', 'bpd', 'psychoed'],
            content: `### A Normal Brain's Response to Abnormal Events\nStructural dissociation is not a disease or a sign of being broken. It's a brilliant, creative adaptation of the human mind to survive overwhelming, inescapable experiences, especially in childhood. When things are too much to bear, the personality organizes itself into different 'parts' to handle the impossible task of both living daily life and holding the trauma.\n\n### The Two Main Types of Parts\n1.  **The Apparently Normal Part (ANP):** This is the part of you that goes to work or school, pays the bills, socializes, and tries to live a 'normal' life. The ANP's main job is to *avoid* thinking about the trauma so that you can function. It often carries beliefs like "I'm fine" or "It wasn't that bad."\n\n2.  **The Emotional Part (EP):** This part (or parts) holds the raw emotions, sensations, and memories of the traumatic experience. EPs are 'stuck in the time of the trauma.' They hold the fight, flight, or freeze responses that couldn't be completed back then. When an EP is triggered, you might feel overwhelmed with emotion, have a flashback, or feel like you're a helpless child again.\n\n### Why This Model is Helpful\n* **It Ends the 'Why do I do that?' Confusion:** It explains why you can feel competent one moment and like a terrified child the next. It's not you being inconsistent; it's different parts taking over.\n* **It Fosters Self-Compassion:** Instead of hating the part of you that gets angry or shuts down, you can understand it's an EP trying to protect you in an old, outdated way.\n* **It Creates a Path to Healing:** The goal of therapy is to foster communication and cooperation between the ANP and EPs, so the trauma can be processed and integrated. This allows the whole system to live in the present, rather than being hijacked by the past.\n\n### Intervention Insight\n* **Acknowledging an Emotional Part** is the first step in working with this model.\n* **Grounding in the 'Here and Now' with a Traumatized Part** is a key skill for when an EP is triggered.`
        },
        {
            id: 'psychoed-drama-triangle',
            title: 'The Drama Triangle (Karpman)',
            category: 'Psychoeducation',
            emoji: 'üß†',
            color: 'purple',
            tags: ['relationships', 'conflict', 'roles', 'victim', 'rescuer', 'persecutor', 'psychoed'],
            content: `### What is the Drama Triangle?\nDeveloped by Stephen Karpman, the Drama Triangle describes a common, dysfunctional pattern of interaction in relationships. People unconsciously take on one of three roles. The roles are not static; people often switch between them rapidly during a conflict.\n\n### The Three Roles\n1.  **The Victim:** The Victim feels powerless, helpless, and oppressed. Their stance is "Poor me." They don't take responsibility for their situation and often seek a Rescuer to solve their problems. While they may be genuinely hurting, staying in the Victim role prevents them from accessing their own power.\n\n2.  **The Rescuer:** The Rescuer feels compelled to help the Victim. They are the classic enabler. They get their self-worth from being needed and solving others' problems, often neglecting their own needs in the process. Their help is often short-term and can keep the Victim dependent.\n\n3.  **The Persecutor:** The Persecutor is critical, blaming, and controlling. They point fingers at the Victim ("It's all your fault") and the Rescuer ("You're not helping correctly"). They often feel justified in their anger and criticism, which masks their own underlying vulnerability.\n\n### Why It's a 'Drama' Triangle\n* **It's a Trap:** Once you're in the triangle, it's hard to get out. The roles feed each other. The Victim needs a Rescuer, the Rescuer needs a Victim, and the Persecutor gives them both someone to blame.\n* **It Prevents Real Solutions:** The triangle is all about drama and distraction. It prevents anyone from taking true responsibility and solving the underlying problems.\n* **The Switch:** The most dramatic part is the switch. A Victim who doesn't feel rescued properly will turn on their Rescuer, becoming a Persecutor. A Rescuer who feels unappreciated will become a resentful Victim.\n\n### How to Get Out\nThe only way out is to refuse to play any of the roles. This involves using skills like **Boundary Setting Exploration & Practice** and **DEAR MAN: For Interpersonal Effectiveness** to communicate directly and take responsibility for your own feelings and needs.`
        },
        {
            id: 'psychoed-abstinence-violation',
            title: 'The Abstinence Violation Effect',
            category: 'Psychoeducation',
            emoji: 'üß†',
            color: 'purple',
            tags: ['addiction', 'relapse', 'shame', 'cbt', 'sobriety', 'psychoed'],
            content: `### What is the Abstinence Violation Effect (AVE)?\nThe AVE describes what happens after a person, who has committed to abstinence from a substance, has a lapse (a single instance of use). It's the intense guilt and shame that follows, which often leads to a full-blown relapse.\n\n### The Dangerous Thought Process\n1.  **The Lapse:** The person uses the substance once.\n2.  **Cognitive Dissonance & Guilt:** This creates a conflict: "I am a sober person" vs. "I just used." This conflict feels terrible and creates intense guilt.\n3.  **Personalization & All-or-Nothing Thinking:** The person makes a critical thinking error. Instead of seeing the lapse as a *mistake* (behavior), they see it as proof that they are a *failure* (identity). They think, "I've blown it. All my hard work is gone. I'm a hopeless addict." This is a form of **Shame vs. Guilt** confusion.\n4.  **The "Might as Well" Effect:** Because they now believe they have failed completely, they think, "Well, I might as well keep using." The single lapse turns into a full-blown relapse.\n\n### How to Counteract the AVE\n* **Reframe the Lapse:** A lapse is a mistake, not a moral failing or a verdict on your entire recovery. It's a sign that a coping skill failed or a trigger was stronger than expected. It is a learning opportunity.\n* **Challenge All-or-Nothing Thinking:** Recovery is not a straight line. A lapse does not erase all the sober time you have accumulated. You can use **Thought Challenging - cognitive restructuring** on the belief "I've ruined everything."\n* **Reach Out Immediately:** Shame thrives in secrecy. The antidote is to tell a sponsor, therapist, or sober support what happened immediately. This breaks the power of the AVE.\n* **Get Curious, Not Critical:** Instead of beating yourself up, ask: "What led to this? What was the trigger? What can I do differently next time?" This is the foundation of a good **Relapse Prevention Plan**.`
        },
        {
            id: 'psychoed-ambiguous-loss',
            title: 'Ambiguous Loss',
            category: 'Psychoeducation',
            emoji: 'üß†',
            color: 'purple',
            tags: ['grief', 'loss', 'closure', 'breakup', 'estrangement', 'psychoed'],
            content: `### What is Ambiguous Loss?\nCoined by Dr. Pauline Boss, ambiguous loss is a loss that occurs without closure or clear understanding. It freezes the grieving process because the loss is confusing and uncertain.\n\nThere are two main types:\n1.  **Physical Absence, Psychological Presence:** This is when a person is physically gone, but they are still very much alive in your mind and heart. This is the classic experience of a **breakup** or **family estrangement**. They are out there in the world, but they are lost to you. You see things that remind you of them; you wonder what they're doing. There's no funeral, no formal ritual to mark the end.\n2.  **Psychological Absence, Physical Presence:** This is when a person is physically present, but psychologically gone. This can happen with dementia, severe mental illness, or addiction.\n\n### Why is it So Hard?\n* **It Defies Resolution:** You can't "get over it" because you don't know exactly what "it" is. Is there hope for reconciliation? Should you move on? The uncertainty is exhausting.\n* **It's Not Socially Recognized:** People don't send sympathy cards for a breakup or an estrangement. You may be told to "just move on," which invalidates the very real grief you are feeling.\n* **It Leads to Rumination:** The mind gets stuck trying to solve the puzzle of the loss, leading to endless "what ifs" and analysis.\n\n### What Helps?\n* **Name It:** Simply having a term‚Äîambiguous loss‚Äîcan be incredibly validating. It confirms that your pain is real and has a reason.\n* **Increase Your Tolerance for Ambiguity:** Learning to live with the questions, rather than needing an immediate answer. This involves **Radical Acceptance** of the uncertainty.\n* **Find Meaning:** Focus not on what was lost, but on what the relationship meant and what you've learned from it.`
        },
        {
            id: 'psychoed-family-roles',
            title: 'Unhelpful Family Roles',
            category: 'Psychoeducation',
            emoji: 'üß†',
            color: 'purple',
            tags: ['family systems', 'roles', 'scapegoat', 'hero', 'lost child', 'mascot', 'psychoed'],
            content: `### What are Unhelpful Family Roles?\nIn families struggling with dysfunction (like addiction, mental illness, or chronic conflict), members often unconsciously take on specific roles. These roles help reduce anxiety and maintain the family's balance (homeostasis), but they prevent real problems from being addressed and stifle individual growth.\n\n### Common Roles:\n* **The Hero (or The Good Child):** This person is a high achiever and appears to have it all together. They make the family look good from the outside. **The Cost:** They often feel like a fraud, suffer from immense pressure and perfectionism, and have difficulty identifying their own needs.\n\n* **The Scapegoat (or The Problem Child):** This person is blamed for all the family's problems. Their behavior (acting out, substance use, etc.) distracts from the core issues in the family. **The Cost:** They internalize a deep sense of shame and believe they are "bad," struggling with self-worth and often continuing a pattern of self-sabotage.\n\n* **The Lost Child (or The Quiet One):** This person tries to be invisible. They are quiet, independent, and avoid causing any trouble. They cope by withdrawing into their own world. **The Cost:** They often struggle with loneliness, have difficulty forming close relationships, and feel disconnected from their own feelings and needs.\n\n* **The Mascot (or The Clown):** This person uses humor and charm to defuse tension and distract from the family's pain. They are often the center of attention in a "fun" way. **The Cost:** They hide their own fear and sadness behind a mask of comedy, and others may not take their problems seriously.\n\n### Why It Matters\nIdentifying your role is not about blaming your family. It's about understanding the system you grew up in and how it shaped you. It gives you the power to choose whether you want to keep playing that role or write a new script for yourself. This is a key part of **Identifying & Challenging Relational Patterns**.`
        },
    ];

    const scriptsData = [
        {
            id: 'script-boundary-setting',
            title: 'Foundational Boundary Setting',
            category: 'Script',
            color: 'indigo',
            tags: ['boundaries', 'role setting', 'containment', 'scripts'],
            content: `### Standard Framing\n‚ÄúBefore we get started‚Äîmy role isn‚Äôt for processing, but to make sure you‚Äôre safe and help get you grounded so you can rejoin group. We‚Äôve got about 20 minutes, can you tell me what‚Äôs going on that brought you to reach out for support?‚Äù\n\n### For Clients Expecting Therapy\n‚ÄúMy role‚Äôs a bit different than a therapist‚Äôs‚ÄîI‚Äôm not here to fully process, but I am here to check in on your safety and help you feel a little more steady before heading back to group. Want to tell me what‚Äôs weighing on you today?‚Äù\n\n### Quick Boundary Phrases\n* "I can‚Äôt go deep with you here, but I can help you feel safer and more grounded right now."\n* "Let‚Äôs slow it down together. I‚Äôm here to help steady things‚Äînot unpack everything."`
        },
        {
            id: 'script-stabilize',
            title: 'Stabilization Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['stabilize', 'grounding', 'containment', 'validation', 'scripts'],
            content: `### Validate & Contain\n‚ÄúYou‚Äôve been dealing with a lot, and your mind and body are hitting a limit. That‚Äôs okay. There‚Äôs no rush to fix anything right now. We‚Äôre not trying to erase that heaviness ‚Äî but to hold it in a way that feels manageable enough for this moment."\n\n### Slow Nervous System\n‚ÄúLet‚Äôs take a moment to slow things down together. There‚Äôs no rush here and no pressure to fix anything. Let's try one slow breath together. Inhale and notice your lungs filling... hold it for a second... now exhale nice and slow."\n\n### Empower & Redirect\n‚ÄúYour courage in acknowledging how intense this feels is really powerful. Remember, our goal isn‚Äôt to solve everything right now ‚Äî it‚Äôs just to get you steady enough that you can leave here feeling a bit more centered.‚Äù`
        },
        {
            id: 'script-end-of-session',
            title: 'End-of-Session Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['end of session', 'survey', 'closure', 'scripts'],
            content: `### Survey\n‚ÄúBefore you go back to group, I do have a brief survey that I‚Äôm required to provide. It's very short, just a thumbs up or thumbs down. Do you see the link in the chat?‚Äù\n‚ÄúGreat! Let me know when you are done and then I will get you back into group.‚Äù\n\n### If Still Heavy\n"You‚Äôre still carrying a lot ‚Äî I see that. We haven‚Äôt solved everything, and we‚Äôre not supposed to in these few minutes. I just want to make sure that what you‚Äôre feeling now is something you can handle for now. Does it feel safe enough for you to wrap up, even if it‚Äôs still heavy?"\n\n### If Still in Distress\n"I don‚Äôt want to send you back in this state. Why don‚Äôt we take another minute here? We can try another grounding technique or even get additional support if you need it. My priority is that you leave feeling safe enough. How are you feeling about continuing a bit longer until this eases?"`
        },
        {
            id: 'script-trauma-dumping-containment',
            title: 'Trauma-Dumping Containment Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['trauma', 'containment', 'boundaries', 'safety', 'scripts'],
            content: `### Mid-Session Redirect\n‚ÄúI really hear that this is painful, and it makes sense that you‚Äôd want to process it. But because we only have a few minutes and I‚Äôm not in the role of a therapist, I want to be careful we don‚Äôt go too deep here and leave you feeling more overwhelmed.‚Äù\n\n### Gentle Wall for Immediate Flooding\n‚ÄúI know it can feel urgent to get it all out, but my role is to support you in feeling safe‚Äînot to unpack everything. If we open something deep in this short space, there‚Äôs a chance you‚Äôll end up carrying it alone after we disconnect‚Äîand I want to avoid that.‚Äù\n\n### Emergency Stop ‚Äì Already Flooded\n‚ÄúYou‚Äôve shared something really heavy, and I can tell this matters. But we‚Äôre in a short space right now, and going deeper might actually make things harder for you when I have to end the session. Let‚Äôs focus on helping you stabilize.‚Äù`
        },
    ];
    
    const scratchpadTemplates = {
        safetyPlan: `### Safety Plan\n\n**Warning Signs (Thoughts, feelings, behaviors that things are getting worse):**\n- \n\n**Internal Coping Strategies (Things I can do on my own):**\n- \n\n**Social Distractions (People or places that can distract me):**\n- \n\n**People I Can Ask for Help:**\n- \n\n**Professional Resources (Therapist, crisis lines):**\n- \n\n**Making My Environment Safe:**\n- `,
        sessionNotes: () => {
            const now = new Date();
            const timestamp = now.toLocaleString('en-US', {
                dateStyle: 'short',
                timeStyle: 'short'
            });
            return `(${timestamp})\n\n[Concern] CC request for Ct ___.\n[Intervention] CSSRS: ___. Ct ___.\n[Outcome] Ct returned to group.`;
        }
    };

    // ---- STATE AND DATA ----
    const state = {
        favorites: [],
        recentlyViewed: [],
        usedThisSession: [],
        contentMap: new Map(),
        interventionMap: new Map(),
        annotations: {},
        currentView: 'dashboard',
        currentOpenScenario: null,
        scratchpadContent: '',
        scratchpadMode: 'write', 
        timer: {
            intervalId: null,
            elapsedSeconds: 0,
            isPaused: true,
        },
        isEditingQuickAccess: false,
        quickAccessIds: [],
    };

    const colorMap = {
        red: { border: "border-red-500", bg: "bg-red-50 dark:bg-red-900/20", text: "text-red-600 dark:text-red-400" },
        orange: { border: "border-orange-500", bg: "bg-orange-50 dark:bg-orange-900/20", text: "text-orange-600 dark:text-orange-400" },
        yellow: { border: "border-yellow-500", bg: "bg-yellow-50 dark:bg-yellow-900/20", text: "text-yellow-600 dark:text-yellow-400" },
        green: { border: "border-green-500", bg: "bg-green-50 dark:bg-green-900/20", text: "text-green-600 dark:text-green-400" },
        blue: { border: "border-blue-500", bg: "bg-blue-50 dark:bg-blue-900/20", text: "text-blue-600 dark:text-blue-400" },
        indigo: { border: "border-indigo-500", bg: "bg-indigo-50 dark:bg-indigo-900/20", text: "text-indigo-600 dark:text-indigo-400" },
        purple: { border: "border-purple-500", bg: "bg-purple-50 dark:bg-purple-900/20", text: "text-purple-600 dark:text-purple-400" },
    };

    // ---- DOM REFERENCES ----
    const dom = {
        contentArea: document.getElementById('content-area'),
        searchBox: document.getElementById('search-box'),
        toast: document.getElementById('toast'),
        scenarioModal: document.getElementById('scenario-modal'),
        modalContentWrapper: document.getElementById('modal-content-wrapper'),
        modalTitle: document.getElementById('modal-title'),
        modalBody: document.getElementById('modal-body'),
        modalContext: document.getElementById('modal-context'),
        closeModal: document.getElementById('close-modal'),
        modalPrev: document.getElementById('modal-prev'),
        modalNext: document.getElementById('modal-next'),
        usedThisSessionContainer: document.getElementById('used-this-session-container'),
        themeToggle: document.getElementById('theme-toggle'),
        copyModalContentBtn: document.getElementById('copy-modal-content-to-scratchpad'),
        addAnnotationBtn: document.getElementById('add-annotation-btn'),
        confirmationModal: document.getElementById('confirmation-modal'),
        confirmationTitle: document.getElementById('confirmation-title'),
        confirmationMessage: document.getElementById('confirmation-message'),
        confirmationConfirm: document.getElementById('confirmation-confirm'),
        confirmationCancel: document.getElementById('confirmation-cancel'),
        sessionTimer: document.getElementById('session-timer'),
        sessionTimerContainer: document.getElementById('session-timer-container'),
        timerToggleBtn: document.getElementById('timer-toggle-btn'),
        timerResetBtn: document.getElementById('timer-reset-btn'),
        quickAccessModal: document.getElementById('quick-access-modal'),
        quickAccessList: document.getElementById('quick-access-list'),
        quickAccessSearch: document.getElementById('quick-access-search'),
        closeQuickAccessModal: document.getElementById('close-quick-access-modal'),
        annotationModal: document.getElementById('annotation-modal'),
        annotationModalTitle: document.getElementById('annotation-modal-title'),
        annotationTextarea: document.getElementById('annotation-textarea'),
        annotationSave: document.getElementById('annotation-save'),
        annotationCancel: document.getElementById('annotation-cancel'),
        floatingScratchpadModal: document.getElementById('floating-scratchpad-modal'),
        floatingScratchpadBody: document.getElementById('floating-scratchpad-body'),
        closeScratchpadBtn: document.getElementById('close-scratchpad-btn'),
        scratchpadToggleBtn: document.getElementById('scratchpad-toggle-btn'),
    };

    // ---- STATE PERSISTENCE ----
    function saveState() {
        localStorage.setItem('clinicalFavorites', JSON.stringify(state.favorites));
        localStorage.setItem('clinicalRecents', JSON.stringify(state.recentlyViewed));
        localStorage.setItem('clinicalScratchpad', state.scratchpadContent);
        localStorage.setItem('clinicalQuickAccess', JSON.stringify(state.quickAccessIds));
        localStorage.setItem('clinicalAnnotations', JSON.stringify(state.annotations));
    }

    function loadState() {
        state.favorites = JSON.parse(localStorage.getItem('clinicalFavorites') || '[]');
        state.recentlyViewed = JSON.parse(localStorage.getItem('clinicalRecents') || '[]');
        state.scratchpadContent = localStorage.getItem('clinicalScratchpad') || '';
        const savedQuickAccess = localStorage.getItem('clinicalQuickAccess');
        state.quickAccessIds = savedQuickAccess ? JSON.parse(savedQuickAccess) : ['script-boundary-setting', 'intervention-tipp', 'intervention-self-compassion-break', 'script-end-of-session'];
        state.annotations = JSON.parse(localStorage.getItem('clinicalAnnotations') || '{}');
    }

    // ---- INITIALIZATION ----
    function initializeDataMap() {
        // Clear existing maps to prevent stale data on re-init
        state.contentMap.clear();
        state.interventionMap.clear();

        const allContent = [...clinicalData, ...interventionsData, ...scriptsData, ...psychoeducationData];
        const uniqueContent = Array.from(new Set(allContent.map(a => a.id))).map(id => allContent.find(a => a.id === id));

        uniqueContent.forEach(item => state.contentMap.set(item.id, item));
        
        interventionsData.forEach(item => {
            state.interventionMap.set(item.title, item.id);
            if (!item.referencedIn) {
                 item.referencedIn = []; // Initialize for bi-directional linking
            }
        });

        buildInterventionLinks();
    }


    function buildInterventionLinks() {
        // Reset references to avoid duplication on re-build
        state.contentMap.forEach(item => {
            if (item.category === 'Intervention') {
                item.referencedIn = [];
            }
        });

        const contentToScan = Array.from(state.contentMap.values());
        
        contentToScan.forEach(sourceItem => {
            if (!sourceItem.content) return;

            state.interventionMap.forEach((interventionId, interventionTitle) => {
                const regex = new RegExp(`\\*\\*(${interventionTitle})\\*\\*`, 'g');
                if (sourceItem.content.match(regex)) {
                    const targetIntervention = state.contentMap.get(interventionId);
                    if (targetIntervention && !targetIntervention.referencedIn.includes(sourceItem.id)) {
                        targetIntervention.referencedIn.push(sourceItem.id);
                    }
                }
            });
        });
    }

    // ---- RENDERING ----
    function createScenarioCard(scenario) {
        const isFavorite = state.favorites.includes(scenario.id);
        const colors = colorMap[scenario.color] || colorMap.indigo;
        const tagsHtml = (scenario.tags || []).slice(0, 3).map(tag => 
            `<button class="tag-btn text-xs font-medium mr-1.5 mb-1.5 px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-tag="${tag}">${tag}</button>`
        ).join('');

        return `
        <div class="scenario-card bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 flex flex-col border-l-4 ${colors.border}">
            <div class="p-4 flex-1 flex flex-col">
                <h3 class="font-bold text-gray-800 dark:text-gray-100 flex items-center">
                    <span class="mr-2">${scenario.emoji || ''}</span>
                    <span class="flex-1">${scenario.title}</span>
                </h3>
                <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 flex-1 flex flex-wrap items-start">
                    ${tagsHtml}
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <button class="view-btn text-sm font-semibold text-indigo-600 dark:text-indigo-400 hover:underline" data-id="${scenario.id}">View Details</button>
                    <button class="favorite-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${scenario.id}" title="Add to favorites">
                        <i data-lucide="star" class="w-5 h-5 ${isFavorite ? 'text-yellow-500 fill-current' : 'text-gray-400'}"></i>
                    </button>
                </div>
            </div>
        </div>
        `;
    }

    function renderCardList(container, items, message, search_query = '') {
        container.style.opacity = '0';
        setTimeout(() => {
            let headerHtml = '';
            if(search_query){
                headerHtml = `<div class="col-span-full mb-4 flex items-center gap-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Showing ${items.length} results for "${search_query}"</h2>
                    <button id="clear-search-btn" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">Clear</button>
                </div>`;
            }
            
            container.innerHTML = headerHtml + '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>';
            const grid = container.querySelector('.grid');

            if (items.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-12">${message}</div>`;
            } else {
                grid.innerHTML = items.map(createScenarioCard).join('');
            }
            lucide.createIcons();
            container.style.opacity = '1';
        }, 300);
    }

    function renderDashboard() {
        dom.contentArea.style.opacity = '0';
        setTimeout(() => {
            const zones = ['Red Zone', 'Orange Zone', 'Yellow Zone', 'Green Zone'];
            const zoneEmojis = {'Red Zone': 'üî¥', 'Orange Zone': 'üü†', 'Yellow Zone': 'üü®', 'Green Zone': 'üíö'};
            
            const quickAccessItems = state.quickAccessIds.map(id => state.contentMap.get(id)).filter(Boolean);

            let editControls = '';
            if (state.isEditingQuickAccess) {
                editControls = `
                    <button id="done-quick-access-btn" class="text-sm font-semibold text-green-600 dark:text-green-400 hover:underline">Done</button>
                `;
            } else {
                editControls = `<button id="edit-quick-access-btn" class="text-sm font-semibold text-indigo-600 dark:text-indigo-400 hover:underline">Edit</button>`;
            }

            let quickAccessHtml = `
                <div class="mb-10">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-300 dark:border-gray-600">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i data-lucide="zap" class="w-6 h-6 text-gray-500"></i> Quick Access
                        </h2>
                        ${editControls}
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        ${quickAccessItems.map(item => `
                            <div class="relative">
                                <button class="view-btn p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all text-left flex flex-col justify-between h-full w-full border-l-4 ${colorMap[item.color]?.border || ''}" data-id="${item.id}">
                                    <span class="font-semibold text-gray-800 dark:text-gray-200">${item.title}</span>
                                    <span class="text-xs mt-2 ${colorMap[item.color]?.text || ''}">${item.category}</span>
                                </button>
                                ${state.isEditingQuickAccess ? `<button class="remove-quick-access-btn absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600" data-id="${item.id}"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''}
                            </div>
                        `).join('')}
                        ${state.isEditingQuickAccess ? `
                            <button id="add-quick-access-card" class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center border-2 border-dashed border-gray-400 dark:border-gray-600 text-gray-500 hover:text-indigo-500 hover:border-indigo-500">
                                <i data-lucide="plus" class="w-8 h-8"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            let zonesHtml = zones.map(zone => {
                const itemsInZone = Array.from(state.contentMap.values()).filter(item => item.category === zone);
                if (itemsInZone.length === 0) return '';
                const zoneColor = itemsInZone[0].color;
                return `
                    <div class="mb-10">
                        <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-${zoneColor}-500 text-${zoneColor}-600 dark:text-${zoneColor}-400">${zoneEmojis[zone]} ${zone}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${itemsInZone.map(createScenarioCard).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            dom.contentArea.innerHTML = quickAccessHtml + zonesHtml;
            lucide.createIcons();
            dom.contentArea.style.opacity = '1';
        }, 300);
    }
    
    function renderQuickAccessAddModal(searchTerm = '') {
        const allItems = Array.from(state.contentMap.values()).sort((a, b) => a.title.localeCompare(b.title));
        const filteredItems = allItems.filter(item => 
            !state.quickAccessIds.includes(item.id) &&
            item.title.toLowerCase().includes(searchTerm.toLowerCase())
        );

        if (filteredItems.length === 0) {
            dom.quickAccessList.innerHTML = `<p class="text-center text-gray-500">No items found or all are added.</p>`;
            return;
        }

        dom.quickAccessList.innerHTML = filteredItems.map(item => {
            const colors = colorMap[item.color] || colorMap.indigo;
            return `
                <div class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800 dark:text-gray-100">${item.title}</p>
                        <p class="text-xs ${colors.text}">${item.category}</p>
                    </div>
                    <button class="add-quick-access-item-btn p-2 bg-green-500 text-white rounded-full hover:bg-green-600" data-id="${item.id}">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }).join('');
        lucide.createIcons();
    }

    function openQuickAccessModal() {
        renderQuickAccessAddModal();
        dom.quickAccessModal.classList.remove('modal-hidden');
        dom.quickAccessModal.classList.add('modal-visible');
        setTimeout(() => {
            dom.quickAccessModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
        }, 10);
    }

    function closeQuickAccessModal() {
        dom.quickAccessModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            dom.quickAccessModal.classList.add('modal-hidden');
            dom.quickAccessModal.classList.remove('modal-visible');
        }, 300);
    }

    function renderCategorizedList(container, items, categoryTitle, message) {
        container.style.opacity = '0';
        setTimeout(() => {
            const grouped = items.reduce((acc, item) => {
                const group = item.subCategory || 'General';
                if (!acc[group]) {
                    acc[group] = [];
                }
                acc[group].push(item);
                return acc;
            }, {});

            let html = `<h1 class="text-3xl font-bold mb-8">${categoryTitle}</h1>`;
            
            if (Object.keys(grouped).length === 0) {
                html += `<div class="text-center text-gray-500 py-12">${message}</div>`;
            } else {
                const sortedGroupNames = Object.keys(grouped).sort();
                for (const groupName of sortedGroupNames) {
                    html += `
                        <div class="mb-10">
                            <h2 class="text-xl font-bold mb-4 pb-2 border-b-2 border-gray-300 dark:border-gray-600">${groupName}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                ${grouped[groupName].map(createScenarioCard).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            container.innerHTML = html;
            lucide.createIcons();
            container.style.opacity = '1';
        }, 300);
    }

    function renderUsedThisSession() {
        if (state.usedThisSession.length === 0) {
            dom.usedThisSessionContainer.innerHTML = '';
            return;
        }
        const itemsHtml = state.usedThisSession.map(id => {
            const item = state.contentMap.get(id);
            if (!item) return '';
            return `
                <button class="view-btn inline-flex items-center gap-x-1.5 py-1.5 px-3 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-800/30 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-700" data-id="${id}">
                    <span>${item.title}</span>
                    <button class="remove-used-btn group -mr-1.5" data-id="${id}">
                        <i data-lucide="x" class="w-3 h-3 text-blue-500 group-hover:text-blue-700 dark:group-hover:text-blue-200"></i>
                    </button>
                </button>
            `;
        }).join('');

        dom.usedThisSessionContainer.innerHTML = `
            <div class="p-4 rounded-lg bg-gray-100 dark:bg-gray-800">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400">Used This Session:</h3>
                    <button id="copy-used-log-btn" class="flex items-center text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="copy" class="w-3 h-3 mr-1"></i>Copy Log
                    </button>
                </div>
                <div class="flex flex-wrap gap-2">${itemsHtml}</div>
            </div>
        `;
        lucide.createIcons();
    }
    
    function renderFloatingScratchpad() {
        dom.floatingScratchpadBody.innerHTML = `
            <div class="flex items-center gap-2 mb-4">
                <button id="toggle-scratchpad-mode" class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                    ${state.scratchpadMode === 'write' ? 'Preview' : 'Edit'}
                </button>
                <button class="template-item text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600" data-template="sessionNotes">Note</button>
                <button class="template-item text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600" data-template="safetyPlan">Safety Plan</button>
                <button id="clear-scratchpad" class="ml-auto text-sm text-red-500 hover:underline">Clear</button>
            </div>
            <div id="scratchpad-write-area" class="${state.scratchpadMode === 'write' ? '' : 'hidden'}">
                <textarea id="scratchpad-textarea"
                    class="w-full p-4 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 rounded-lg scratchpad-resize text-sm font-mono focus:ring-2 focus:ring-teal-500 focus:outline-none"
                    rows="12"
                    placeholder="Type notes, scripts, or plans here... (Markdown supported)">${state.scratchpadContent || ''}</textarea>
                <div class="flex mt-3 gap-2">
                    <button id="copy-scratchpad" class="flex items-center text-xs px-3 py-1 bg-indigo-100 dark:bg-indigo-900 rounded-md text-indigo-700 dark:text-indigo-200 hover:bg-indigo-200 dark:hover:bg-indigo-800"><i data-lucide="copy" class="w-4 h-4 mr-1"></i>Copy</button>
                    <button id="download-scratchpad" class="flex items-center text-xs px-3 py-1 bg-green-100 dark:bg-green-900 rounded-md text-green-700 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800"><i data-lucide="download" class="w-4 h-4 mr-1"></i>Download</button>
                </div>
            </div>
            <div id="scratchpad-preview-area" class="prose dark:prose-invert max-w-none ${state.scratchpadMode === 'preview' ? '' : 'hidden'} p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg min-h-[12rem] bg-gray-50 dark:bg-gray-900/50">
                ${marked.parse(state.scratchpadContent || '_Nothing here yet. Type in Edit mode!_')}
            </div>
        `;
        lucide.createIcons();
        attachScratchpadEvents();
    }

    function openModal(scenarioId, searchQuery = '') {
        const scenario = state.contentMap.get(scenarioId);
        if (!scenario) return;

        state.currentOpenScenario = scenario;
        
        const categoryColor = colorMap[scenario.color] || colorMap.indigo;
        const contextTags = (scenario.tags || []).map(tag => `<button class="tag-btn text-xs font-medium px-2 py-0.5 rounded-full bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-tag="${tag}">${tag}</button>`).join('');
        dom.modalContext.innerHTML = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${categoryColor.bg} ${categoryColor.text}">${scenario.category}</span>` + contextTags;

        dom.modalTitle.innerHTML = `<span class="mr-3">${scenario.emoji || ''}</span> ${scenario.title}`;
        
        let processedContent = scenario.content;
        state.interventionMap.forEach((id, title) => {
            const regex = new RegExp(`\\*\\*(${title})\\*\\*`, 'g');
            processedContent = processedContent.replace(regex, `<button class="insight-link" data-id="${id}">$1</button>`);
        });

        if (scenario.referencedIn?.length > 0) {
            const referencesHtml = scenario.referencedIn.map(id => {
                const refScenario = state.contentMap.get(id);
                if (!refScenario) return '';
                return `<li><button class="insight-link" data-id="${id}">${refScenario.title}</button></li>`;
            }).join('');
            processedContent += `\n\n### Commonly Used For / Related To:\n<ul>${referencesHtml}</ul>`;
        }
        
        const annotation = state.annotations[scenario.id];
        if (annotation) {
            processedContent += `\n\n<div class="p-4 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg not-prose"><h4 class="text-sm font-bold text-yellow-800 dark:text-yellow-200 !mt-0">My Note:</h4><div class="prose prose-sm dark:prose-invert max-w-none">${marked.parse(annotation)}</div></div>`;
        }

        dom.modalBody.innerHTML = marked.parse(processedContent);
        
        if (searchQuery) {
            highlightText(dom.modalBody, searchQuery);
        }
        
        makeChecklistsInteractive(dom.modalBody);
        makeSectionsCollapsible(dom.modalBody);
        
        dom.scenarioModal.classList.remove('modal-hidden');
        dom.scenarioModal.classList.add('modal-visible');
        setTimeout(() => {
            dom.modalContentWrapper.classList.remove('opacity-0', 'scale-95');
        }, 10);

        if (!state.usedThisSession.includes(scenarioId)) {
            state.usedThisSession.push(scenarioId);
            renderUsedThisSession();
        }
        if (!state.recentlyViewed.includes(scenarioId)) {
            state.recentlyViewed = [scenarioId, ...state.recentlyViewed.filter(id => id !== scenarioId)].slice(0, 20);
            saveState();
        }
        
        updateModalNav();
        lucide.createIcons();
    }
    
    function makeChecklistsInteractive(container) {
        const lists = container.querySelectorAll('ol');
        lists.forEach(list => {
            list.classList.add('interactive-checklist');
            const items = list.querySelectorAll('li');
            items.forEach((item, index) => {
                const originalText = item.innerHTML;
                const checkboxId = `checklist-${state.currentOpenScenario.id}-${index}`;
                item.innerHTML = `
                    <label for="${checkboxId}">
                        <input type="checkbox" id="${checkboxId}">
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-text">${originalText}</span>
                    </label>
                `;
            });
        });
    }

    function makeSectionsCollapsible(container) {
        const headers = container.querySelectorAll('h3');
        headers.forEach(header => {
            header.classList.add('collapsible-header');
            header.innerHTML += `<i data-lucide="chevron-down" class="w-5 h-5"></i>`;

            let content = [];
            let nextElem = header.nextElementSibling;
            while (nextElem && nextElem.tagName !== 'H3') {
                content.push(nextElem);
                nextElem = nextElem.nextElementSibling;
            }

            const contentWrapper = document.createElement('div');
            contentWrapper.classList.add('collapsible-content');
            content.forEach(el => contentWrapper.appendChild(el));
            header.parentNode.insertBefore(contentWrapper, header.nextElementSibling);

            header.addEventListener('click', () => {
                header.classList.toggle('collapsed');
                contentWrapper.classList.toggle('collapsed');
            });
        });
    }
    
    function highlightText(container, text) {
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const regex = new RegExp(`(${text})`, 'gi');
        while (node = walker.nextNode()) {
            if (node.parentElement.tagName !== 'MARK') {
                const newHtml = node.textContent.replace(regex, `<mark>$1</mark>`);
                if (newHtml !== node.textContent) {
                    const newNode = document.createElement('span');
                    newNode.innerHTML = newHtml;
                    node.parentNode.replaceChild(newNode, node);
                }
            }
        }
    }

    function closeModal() {
        if (dom.scenarioModal.classList.contains('modal-hidden')) {
            return;
        }
        dom.modalContentWrapper.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            dom.scenarioModal.classList.add('modal-hidden');
            dom.scenarioModal.classList.remove('modal-visible');
        }, 300);
    }
    
    function updateModalNav() {
        const currentList = getCurrentList();
        const currentIndex = currentList.findIndex(item => item.id === state.currentOpenScenario.id);
        
        dom.modalPrev.disabled = currentIndex <= 0;
        dom.modalNext.disabled = currentIndex >= currentList.length - 1;

        dom.modalPrev.onclick = () => {
            if (currentIndex > 0) openModal(currentList[currentIndex - 1].id, dom.searchBox.value);
        };
        dom.modalNext.onclick = () => {
            if (currentIndex < currentList.length - 1) openModal(currentList[currentIndex + 1].id, dom.searchBox.value);
        };
    }

    // ---- TIMER LOGIC ----
    function toggleTimer() {
        state.timer.isPaused = !state.timer.isPaused;
        if (state.timer.isPaused) {
            clearInterval(state.timer.intervalId);
            state.timer.intervalId = null;
            dom.timerToggleBtn.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i>`;
        } else {
            if (!state.timer.intervalId) {
                state.timer.intervalId = setInterval(updateTimer, 1000);
            }
            dom.timerToggleBtn.innerHTML = `<i data-lucide="pause" class="w-4 h-4"></i>`;
        }
        lucide.createIcons();
    }

    function resetTimer() {
        clearInterval(state.timer.intervalId);
        state.timer.intervalId = null;
        state.timer.elapsedSeconds = 0;
        state.timer.isPaused = true;
        dom.sessionTimer.textContent = '00:00';
        dom.timerToggleBtn.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i>`;
        lucide.createIcons();
        
        dom.sessionTimerContainer.classList.remove('bg-yellow-100', 'dark:bg-yellow-900', 'bg-red-100', 'dark:bg-red-900');
        dom.sessionTimerContainer.classList.add('bg-green-100', 'dark:bg-green-900');
    }

    function updateTimer() {
        if (state.timer.isPaused) return;
        state.timer.elapsedSeconds++;
        const minutes = Math.floor(state.timer.elapsedSeconds / 60);
        const seconds = state.timer.elapsedSeconds % 60;
        dom.sessionTimer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        dom.sessionTimerContainer.classList.remove('bg-green-100', 'dark:bg-green-900', 'bg-yellow-100', 'dark:bg-yellow-900', 'bg-red-100', 'dark:bg-red-900');
        if (minutes < 10) {
            dom.sessionTimerContainer.classList.add('bg-green-100', 'dark:bg-green-900');
        } else if (minutes < 15) {
            dom.sessionTimerContainer.classList.add('bg-yellow-100', 'dark:bg-yellow-900');
        } else {
            dom.sessionTimerContainer.classList.add('bg-red-100', 'dark:bg-red-900');
        }
    }

    // ---- EVENT HANDLERS & LOGIC ----
    function handleContentInteraction(e) {
        const viewBtn = e.target.closest('.view-btn');
        if (viewBtn) {
            if (e.target.closest('.remove-used-btn') || e.target.closest('.remove-quick-access-btn')) return;
            openModal(viewBtn.dataset.id, dom.searchBox.value);
            return;
        }

        const favoriteBtn = e.target.closest('.favorite-btn');
        if (favoriteBtn) {
            const id = favoriteBtn.dataset.id;
            const isFavorite = state.favorites.includes(id);
            if (isFavorite) {
                state.favorites = state.favorites.filter(favId => favId !== id);
                showToast('Removed from favorites', 'info');
            } else {
                state.favorites.push(id);
                showToast('Added to favorites!', 'success');
            }
            saveState();
            if (state.currentView === 'favorites' || dom.searchBox.value) {
                switchView(state.currentView);
            } else {
                const icon = favoriteBtn.querySelector('i');
                icon.classList.toggle('text-yellow-500', !isFavorite);
                icon.classList.toggle('fill-current', !isFavorite);
                icon.classList.toggle('text-gray-400', isFavorite);
            }
            return;
        }
        
        const removeUsedBtn = e.target.closest('.remove-used-btn');
        if(removeUsedBtn) {
            e.stopPropagation();
            const id = removeUsedBtn.dataset.id;
            state.usedThisSession = state.usedThisSession.filter(usedId => usedId !== id);
            renderUsedThisSession();
            return;
        }

        const tagBtn = e.target.closest('.tag-btn');
        if (tagBtn) {
            const tag = tagBtn.dataset.tag;
            closeModal();
            dom.searchBox.value = tag;
            dom.searchBox.dispatchEvent(new Event('input'));
            return;
        }

        const insightLink = e.target.closest('.insight-link');
        if(insightLink) {
            const id = insightLink.dataset.id;
            dom.modalContentWrapper.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                openModal(id);
            }, 150);
            return;
        }
        
        if (e.target.closest('#clear-search-btn')) {
            dom.searchBox.value = '';
            switchView(state.currentView);
            return;
        }
        
        if (e.target.closest('#copy-used-log-btn')) {
            copyUsedLogToScratchpad();
            return;
        }

        // Quick Access Edit Logic
        if (e.target.closest('#edit-quick-access-btn')) {
            state.isEditingQuickAccess = true;
            renderDashboard();
            return;
        }
        if (e.target.closest('#done-quick-access-btn')) {
            state.isEditingQuickAccess = false;
            saveState();
            renderDashboard();
            return;
        }
        if (e.target.closest('.remove-quick-access-btn')) {
            const id = e.target.closest('.remove-quick-access-btn').dataset.id;
            state.quickAccessIds = state.quickAccessIds.filter(qaId => qaId !== id);
            renderDashboard();
            return;
        }
        if (e.target.closest('#add-quick-access-card')) {
            openQuickAccessModal();
            return;
        }
        if (e.target.closest('.add-quick-access-item-btn')) {
            const id = e.target.closest('.add-quick-access-item-btn').dataset.id;
            state.quickAccessIds.push(id);
            renderQuickAccessAddModal(dom.quickAccessSearch.value);
            renderDashboard();
            return;
        }
    }

    function attachScratchpadEvents() {
        const scratchpadBody = dom.floatingScratchpadModal.querySelector('#floating-scratchpad-body');
        if (!scratchpadBody) return;

        scratchpadBody.querySelector('#toggle-scratchpad-mode')?.addEventListener('click', () => {
            state.scratchpadMode = (state.scratchpadMode === 'write') ? 'preview' : 'write';
            renderFloatingScratchpad();
        });
        scratchpadBody.querySelector('#clear-scratchpad')?.addEventListener('click', () => {
            showConfirmationModal('Clear all notes in your scratchpad?', 'This action cannot be undone.', () => {
                state.scratchpadContent = '';
                saveState();
                renderFloatingScratchpad();
                showToast('Scratchpad cleared.', 'success');
            });
        });
        const textarea = scratchpadBody.querySelector('#scratchpad-textarea');
        const previewArea = scratchpadBody.querySelector('#scratchpad-preview-area');
        textarea?.addEventListener('input', (e) => {
            state.scratchpadContent = e.target.value;
            saveState();
            if(previewArea) {
               previewArea.innerHTML = marked.parse(state.scratchpadContent || '_Nothing here yet._');
            }
        });
        scratchpadBody.querySelector('#copy-scratchpad')?.addEventListener('click', () => copyToClipboard(state.scratchpadContent));
        scratchpadBody.querySelector('#download-scratchpad')?.addEventListener('click', downloadScratchpad);
        
        scratchpadBody.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const templateKey = e.target.dataset.template;
                let templateContent = scratchpadTemplates[templateKey];
                
                if (typeof templateContent === 'function') {
                    templateContent = templateContent();
                }

                if (templateContent) {
                    const currentText = textarea.value;
                    textarea.value = (currentText ? currentText + '\n\n---\n\n' : '') + templateContent;
                    textarea.dispatchEvent(new Event('input'));
                    textarea.scrollTop = textarea.scrollHeight;
                }
            });
        });
    }
    
    // ---- UTILITIES ----
    function showToast(message, type = 'info') {
        const colors = {
            success: 'bg-green-500',
            info: 'bg-gray-600 dark:bg-gray-700',
            error: 'bg-red-500'
        };
        dom.toast.textContent = message;
        dom.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[100] transition-all duration-300 ${colors[type]}`;
        dom.toast.classList.remove('hidden');
        dom.toast.classList.add('opacity-100');
        setTimeout(() => { dom.toast.classList.remove('opacity-100'); }, 2700);
        setTimeout(() => { dom.toast.classList.add('hidden'); }, 3000);
    }

    function copyToClipboard(text) {
        if (!text) return;
        const plainText = text.replace(/###\s/g, '').replace(/##\s/g, '').replace(/#\s/g, '').replace(/\*\*/g, '').replace(/\*/g, '').replace(/>\s/g, '');
        const textArea = document.createElement('textarea');
        textArea.value = plainText;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast("Copied to clipboard!", 'success');
        } catch (err) {
            showToast("Failed to copy.", 'error');
        }
        document.body.removeChild(textArea);
    }
    
    function copyUsedLogToScratchpad() {
        if (state.usedThisSession.length === 0) {
            showToast("Session log is empty.", "info");
            return;
        }
        const logTitle = `### Log from Session (${new Date().toLocaleDateString()})\n\n`;
        const logItems = state.usedThisSession
            .map(id => state.contentMap.get(id)?.title)
            .filter(Boolean)
            .map(title => `- Used: ${title}`)
            .join('\n');
        
        const fullLog = logTitle + logItems;
        state.scratchpadContent += (state.scratchpadContent ? '\n\n---\n\n' : '') + fullLog;
        saveState();
        showToast("Session log copied to scratchpad!", 'success');

        if (!dom.floatingScratchpadModal.classList.contains('modal-hidden')) {
            renderFloatingScratchpad();
        }
    }

    function downloadScratchpad() {
        const blob = new Blob([state.scratchpadContent], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'scratchpad.md';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        dom.confirmationTitle.textContent = title;
        dom.confirmationMessage.textContent = message;
        dom.confirmationModal.classList.remove('modal-hidden');
        dom.confirmationModal.classList.add('modal-visible');
         setTimeout(() => {
            dom.confirmationModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
        }, 10);
        
        const confirmHandler = () => {
            onConfirm();
            hideConfirmationModal();
        };
        const cancelHandler = () => hideConfirmationModal();

        const hideConfirmationModal = () => {
            dom.confirmationModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dom.confirmationModal.classList.add('modal-hidden');
                dom.confirmationModal.classList.remove('modal-visible');
                dom.confirmationConfirm.removeEventListener('click', confirmHandler);
                dom.confirmationCancel.removeEventListener('click', cancelHandler);
            }, 300);
        };
        
        dom.confirmationConfirm.addEventListener('click', confirmHandler);
        dom.confirmationCancel.addEventListener('click', cancelHandler);
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    const debouncedSearch = debounce((e) => {
        const q = e.target.value.toLowerCase().trim();
        if (state.currentView === 'scratchpad') return;

        if (!q) {
            switchView(state.currentView);
            return;
        }
        
        const filtered = Array.from(state.contentMap.values()).filter(item =>
            item.title.toLowerCase().includes(q) ||
            (item.content && item.content.toLowerCase().includes(q)) ||
            (item.tags && item.tags.some(tag => tag.toLowerCase().includes(q)))
        );
        renderCardList(dom.contentArea, filtered, 'No matches found for your search.', q);
    }, 300);
    
    // ---- TABS & VIEWS ----
    function getCurrentList() {
        const q = dom.searchBox.value.toLowerCase().trim();
        if (q) {
            return Array.from(state.contentMap.values()).filter(item =>
                item.title.toLowerCase().includes(q) ||
                (item.content && item.content.toLowerCase().includes(q)) ||
                (item.tags && item.tags.some(tag => tag.toLowerCase().includes(q)))
            );
        }

        switch (state.currentView) {
            case 'favorites': return state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
            case 'recents': return state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
            case 'interventions': return interventionsData;
            case 'scripts': return scriptsData;
            case 'psychoeducation': return psychoeducationData;
            case 'dashboard': return Array.from(state.contentMap.values()).filter(item => item.category.includes('Zone'));
            default: return Array.from(state.contentMap.values());
        }
    }

    function switchView(viewId) {
        state.currentView = viewId;
        // Update sidebar link styles
        document.querySelectorAll('.sidebar-link').forEach(link => {
            const isSelected = link.dataset.tab === viewId;
            link.classList.toggle('bg-indigo-100', isSelected);
            link.classList.toggle('dark:bg-indigo-800', isSelected);
            link.classList.toggle('text-indigo-700', isSelected);
            link.classList.toggle('dark:text-indigo-200', isSelected);
            link.classList.toggle('font-semibold', isSelected);
        });
        dom.scratchpadToggleBtn.classList.remove('bg-indigo-100', 'dark:bg-indigo-800', 'text-indigo-700', 'dark:text-indigo-200', 'font-semibold');
        dom.scratchpadToggleBtn.classList.remove('bg-teal-100', 'dark:bg-teal-900', 'text-teal-700', 'dark:text-teal-200');

        if (dom.searchBox.value) {
            dom.searchBox.value = '';
        }

        if (viewId === 'dashboard') {
            renderDashboard();
        } else if (viewId === 'interventions') {
            renderCategorizedList(dom.contentArea, interventionsData, 'Interventions', 'No interventions found.');
        } else if (viewId === 'psychoeducation') {
            renderCardList(dom.contentArea, psychoeducationData, 'No psychoeducation topics found.');
        } else {
            let items = [];
            let message = 'No items found.';
            if (viewId === 'favorites') {
                items = state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
                message = 'No favorites yet. Click the star on a card to add one.';
            } else if (viewId === 'recents') {
                items = state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
                message = 'No recently viewed items.';
            } else if (viewId === 'scripts') {
                items = scriptsData;
                message = 'No scripts found.';
            }
            renderCardList(dom.contentArea, items, message);
        }
    }

    // ---- THEME ----
    function applyTheme(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        dom.themeToggle.innerHTML = isDark ? '<i data-lucide="sun" class="w-5 h-5"></i>' : '<i data-lucide="moon" class="w-5 h-5"></i>';
        lucide.createIcons();
    }

    // ---- DRAGGABLE MODAL ----
    function makeDraggable(element, handle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // ---- MAIN INITIALIZATION ----
    function main() {
        loadState();
        initializeDataMap();

        // Event listeners
        document.querySelectorAll('.sidebar-link').forEach(link => {
            if (link.id !== 'scratchpad-toggle-btn') {
                link.addEventListener('click', () => switchView(link.dataset.tab));
            }
        });
        document.body.addEventListener('click', handleContentInteraction);
        
        dom.searchBox?.addEventListener('input', debouncedSearch);
        dom.timerToggleBtn?.addEventListener('click', toggleTimer);
        dom.timerResetBtn?.addEventListener('click', resetTimer);
        
        dom.closeModal.addEventListener('click', closeModal);
        dom.closeQuickAccessModal.addEventListener('click', closeQuickAccessModal);
        dom.quickAccessSearch.addEventListener('input', (e) => renderQuickAccessAddModal(e.target.value));
        
        // Click-out listeners
        dom.scenarioModal.addEventListener('click', (e) => { if (e.target === dom.scenarioModal) closeModal(); });
        dom.quickAccessModal.addEventListener('click', (e) => { if (e.target === dom.quickAccessModal) closeQuickAccessModal(); });
        dom.annotationModal.addEventListener('click', (e) => { if (e.target === dom.annotationModal) dom.annotationCancel.click(); });
        dom.confirmationModal.addEventListener('click', (e) => { if (e.target === dom.confirmationModal) dom.confirmationCancel.click(); });

        dom.addAnnotationBtn.addEventListener('click', () => {
            if (state.currentOpenScenario) {
                dom.annotationModalTitle.textContent = `Note for: ${state.currentOpenScenario.title}`;
                dom.annotationTextarea.value = state.annotations[state.currentOpenScenario.id] || '';
                dom.annotationModal.classList.remove('modal-hidden');
                dom.annotationModal.classList.add('modal-visible');
                setTimeout(() => {
                    dom.annotationModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                }, 10);
            }
        });

        dom.annotationCancel.addEventListener('click', () => {
            dom.annotationModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dom.annotationModal.classList.add('modal-hidden');
                dom.annotationModal.classList.remove('modal-visible');
            }, 300);
        });

        dom.annotationSave.addEventListener('click', () => {
            const note = dom.annotationTextarea.value;
            const id = state.currentOpenScenario.id;
            if (note.trim()) {
                state.annotations[id] = note;
            } else {
                delete state.annotations[id];
            }
            saveState();
            showToast("Note saved!", "success");
            dom.annotationCancel.click(); // Close modal
            openModal(id, dom.searchBox.value); // Re-open main modal to show updated note
        });


        dom.themeToggle?.addEventListener('click', () => {
            const isCurrentlyDark = document.documentElement.classList.contains('dark');
            const newIsDark = !isCurrentlyDark;
            localStorage.setItem('theme', newIsDark ? 'dark' : 'light');
            applyTheme(newIsDark);
        });
        dom.copyModalContentBtn.addEventListener('click', () => {
            if (state.currentOpenScenario) {
                const contentToCopy = `### ${state.currentOpenScenario.title}\n\n${state.currentOpenScenario.content}`;
                state.scratchpadContent += (state.scratchpadContent ? '\n\n---\n\n' : '') + contentToCopy;
                saveState();
                showToast('Copied to scratchpad!', 'success');
                if (!dom.floatingScratchpadModal.classList.contains('modal-hidden')) {
                    renderFloatingScratchpad();
                }
            }
        });
        
        // Floating Scratchpad Logic
        dom.scratchpadToggleBtn.addEventListener('click', () => {
            const modal = dom.floatingScratchpadModal;
            const isHidden = modal.classList.contains('modal-hidden');
            if (isHidden) {
                renderFloatingScratchpad();
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
                setTimeout(() => {
                    modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                }, 10);
            } else {
                modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modal.classList.add('modal-hidden');
                    modal.classList.remove('modal-visible');
                }, 300);
            }
        });
        dom.closeScratchpadBtn.addEventListener('click', () => dom.scratchpadToggleBtn.click());
        makeDraggable(dom.floatingScratchpadModal, dom.floatingScratchpadModal.querySelector('.drag-handle'));

        // Initial theme setup
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme === 'dark' || (savedTheme === null && prefersDark));

        // Initial view
        switchView(state.currentView || 'dashboard');
        renderUsedThisSession();
        lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
