// ---- CARD RENDERING ----
function createScenarioCard(scenario) {
    const isFavorited = state.favorites.includes(scenario.id);
    const isUsed = state.checkedScenarios.includes(scenario.id);
    const colors = colorMap[scenario.color] || colorMap.indigo;
    // Only show first non-empty paragraph as the summary
    const firstParagraph = scenario.content.split('\n').find(p => p.trim());
    // Tag badges
    const tagBadges = scenario.tags && scenario.tags.length
        ? scenario.tags.map(tag => `<span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-xs rounded mr-1">${tag}</span>`).join('')
        : '';
    const usedBadge = isUsed ? `<span class="used-badge">Used</span>` : '';
    const favBadge = isFavorited ? `<i data-lucide="star" class="inline h-4 w-4 text-yellow-400 mr-1"></i>` : '';
    const card = document.createElement('div');
    card.className = `scenario-card bg-white dark:bg-gray-800 p-4 rounded-lg cursor-pointer flex flex-col justify-between relative ${colors.border} mb-4`;
    card.dataset.id = scenario.id;
    card.innerHTML = `
        <div>
            <div class="flex items-center">
                <h3 class="font-semibold pr-2 text-gray-800 dark:text-gray-200">${favBadge}${scenario.title}${usedBadge}</h3>
            </div>
            <div class="scenario-summary mt-2 text-gray-600 dark:text-gray-400">${marked.parseInline(firstParagraph)}</div>
            <div class="mt-2">${tagBadges}</div>
            <button class="show-more text-xs text-indigo-600 mt-2 underline">Show more</button>
            <div class="scenario-full-content hidden mt-3">${marked.parse(scenario.content)}</div>
        </div>
        <div class="flex mt-2 space-x-2">
            <button class="favorite-star text-gray-400 dark:text-gray-600 ${isFavorited ? 'favorited' : ''}" title="Toggle Favorite">
                <i data-lucide="star" class="h-5 w-5"></i>
            </button>
            <button class="copy-btn text-gray-400 dark:text-gray-600" title="Copy Script"><i data-lucide="copy" class="h-5 w-5"></i></button>
            <button class="mark-used-btn text-gray-400 dark:text-gray-600" title="Mark as Used"><i data-lucide="check" class="h-5 w-5"></i></button>
        </div>
    `;
    card.querySelector('.show-more').addEventListener('click', (e) => {
        e.stopPropagation();
        const full = card.querySelector('.scenario-full-content');
        if (full.classList.contains('hidden')) {
            document.querySelectorAll('.scenario-full-content').forEach(el => el.classList.add('hidden'));
            card.querySelector('.show-more').textContent = "Show less";
            full.classList.remove('hidden');
        } else {
            full.classList.add('hidden');
            card.querySelector('.show-more').textContent = "Show more";
        }
    });
    card.querySelector('.favorite-star').addEventListener('click', (e) => {
        e.stopPropagation();
        toggleFavorite(scenario.id);
    });
    card.querySelector('.copy-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        navigator.clipboard.writeText(scenario.content);
        showToast("Script copied to clipboard!", false);
    });
    card.querySelector('.mark-used-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        if (!state.checkedScenarios.includes(scenario.id)) state.checkedScenarios.push(scenario.id);
        renderUsedThisSession();
        showToast("Marked as used.", true);
        switchView(state.currentView);
    });
    card.addEventListener('click', () => openModal(scenario));
    return card;
}

// ---- MODAL LOGIC ----
function openModal(scenario) {
    if (!scenario) return;
    state.currentOpenScenario = scenario;
    const tagBadges = scenario.tags && scenario.tags.length
        ? scenario.tags.map(tag => `<span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 text-xs rounded mr-1">${tag}</span>`).join('')
        : '';
    dom.modalTitle.innerHTML = `${scenario.title} ${tagBadges}`;
    dom.modalBody.innerHTML = `
        <div class="flex flex-wrap gap-2 mb-2">
            <button id="copyScript" class="bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded text-xs text-gray-700 dark:text-gray-200">Copy Script</button>
            <button id="markUsed" class="bg-green-100 dark:bg-green-800 px-3 py-1 rounded text-xs text-green-700 dark:text-green-200">Mark as Used</button>
        </div>
        <div>${marked.parse(scenario.content)}</div>
    `;
    dom.scenarioModal.classList.remove('hidden');
    addToRecentlyViewed(scenario.id);
    lucide.createIcons();
    document.getElementById('copyScript')?.addEventListener('click', () => {
        navigator.clipboard.writeText(scenario.content);
        showToast("Script copied to clipboard!", false);
    });
    document.getElementById('markUsed')?.addEventListener('click', () => {
        if (!state.checkedScenarios.includes(scenario.id)) state.checkedScenarios.push(scenario.id);
        renderUsedThisSession();
        showToast("Marked as used.", true);
        dom.scenarioModal.classList.add('hidden');
        switchView(state.currentView);
    });
}
dom.closeModal?.addEventListener('click', () => {
    dom.scenarioModal.classList.add('hidden');
});

// ---- FAVORITES & RECENTS ----
function toggleFavorite(scenarioId) {
    const idx = state.favorites.indexOf(scenarioId);
    if (idx === -1) {
        state.favorites.unshift(scenarioId);
    } else {
        state.favorites.splice(idx, 1);
    }
    switchView(state.currentView);
}
function addToRecentlyViewed(scenarioId) {
    const idx = state.recentlyViewed.indexOf(scenarioId);
    if (idx !== -1) state.recentlyViewed.splice(idx, 1);
    state.recentlyViewed.unshift(scenarioId);
    if (state.recentlyViewed.length > 10) state.recentlyViewed.pop();
}

// ---- CARD LIST ----
function renderCardList(container, items, emptyMessage) {
    if (!container) return;
    container.innerHTML = '';
    if (items.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 p-8 col-span-full">${emptyMessage}</p>`;
        return;
    }
    items.forEach(item => {
        if (item) container.appendChild(createScenarioCard(item));
    });
    lucide.createIcons();
}

// ---- TABS ----
function switchView(viewId) {
    state.currentView = viewId;
    document.querySelectorAll('.sidebar-link').forEach(link => {
        link.classList.toggle('active', link.dataset.tab === viewId);
    });
    dom.contentArea.innerHTML = '';
    renderUsedThisSession();

    if (viewId === 'dashboard') {
        const dashboardItems = Array.from(state.contentMap.values()).filter(item => item.category && item.category.includes('Zone'));
        renderCardList(dom.contentArea, dashboardItems, 'No scenarios found.');
    } else if (viewId === 'favorites') {
        const items = state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
        renderCardList(dom.contentArea, items, 'No favorites yet.');
    } else if (viewId === 'recents') {
        const items = state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
        renderCardList(dom.contentArea, items, 'No recently viewed scenarios.');
    } else if (viewId === 'interventions') {
        const items = [];
        Object.entries(interventionsData).forEach(([cat, arr]) => items.push(...arr));
        renderCardList(dom.contentArea, items, 'No interventions found.');
    }
}

// ---- SEARCH ----
dom.searchBox?.addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    let filtered = [];
    if (!q) {
        switchView(state.currentView);
        return;
    }
    filtered = Array.from(state.contentMap.values()).filter(
        item =>
            item.title.toLowerCase().includes(q) ||
            (item.content && item.content.toLowerCase().includes(q)) ||
            (item.tags && item.tags.some(tag => tag.includes(q)))
    );
    dom.contentArea.innerHTML = '';
    renderUsedThisSession();
    renderCardList(dom.contentArea, filtered, 'No matches found.');
});

// ---- TOAST ----
function showToast(message, isSubtle = false) {
    dom.toast.textContent = message;
    dom.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${isSubtle ? 'bg-gray-600 dark:bg-gray-700' : 'bg-green-500'}`;
    dom.toast.classList.remove('hidden');
    setTimeout(() => { dom.toast.classList.add('hidden'); }, 3000);
}

// ---- THEME ----
document.getElementById('theme-toggle')?.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
});

// ---- MAIN ----
function main() {
    populateDomObject();
    renderSidebarTabs();
    initializeDataMap();
    switchView(state.currentView || 'dashboard');
    renderUsedThisSession();
}
document.addEventListener('DOMContentLoaded', main);
</script>
</body>
</html>
