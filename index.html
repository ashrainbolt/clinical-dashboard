<!DOCTYPE html>
<html lang="en" class="bg-gray-50 dark:bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Marked.js (Markdown parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom styles for prose, layout, and new features */
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
            font-weight: 600;
            margin-top: 1.25em;
            margin-bottom: 0.5em;
        }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.25em; }
        .prose h3 { font-size: 1.1em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; }
        .prose strong { font-weight: 600; }
        .prose blockquote {
            border-left: 0.25rem solid var(--theme-color-500);
            padding-left: 1em;
            font-style: italic;
            color: #4b5563;
        }
        .dark .prose blockquote {
            border-left-color: var(--theme-color-400);
            color: #d1d5db;
        }
        .prose .insight-link {
            color: var(--theme-color-600);
            font-weight: 600;
            text-decoration: underline;
            cursor: pointer;
        }
        .dark .prose .insight-link {
            color: var(--theme-color-400);
        }

        .scratchpad-resize {
            resize: vertical;
            min-height: 10rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        .sidebar-nav {
            flex: 1 1 auto;
            overflow-y: auto;
        }
        
        /* Modal Animation */
        .modal-hidden {
            display: none;
        }
        .modal-visible {
            display: flex;
        }
        .modal-content {
            transition: all 0.3s ease-out;
        }

        /* Card Animation */
        .card-container {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Interactive Checklist Styles */
        .interactive-checklist li {
            list-style-type: none;
            margin-left: -1.5em;
            display: flex;
            align-items: flex-start;
        }
        .interactive-checklist li label {
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            width: 100%;
        }
        .interactive-checklist li .checkbox-custom {
            flex-shrink: 0;
            margin-top: 0.25em;
            margin-right: 0.75em;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #6b7280;
            border-radius: 0.25rem;
            cursor: pointer;
            display: inline-block;
            position: relative;
        }
        .dark .interactive-checklist li .checkbox-custom {
            border-color: #9ca3af;
        }
        .interactive-checklist li input[type="checkbox"]:checked + .checkbox-custom {
            background-color: var(--theme-color-500);
            border-color: var(--theme-color-500);
        }
        .interactive-checklist li input[type="checkbox"]:checked + .checkbox-custom::after {
            content: '✓';
            font-size: 1rem;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .interactive-checklist li input[type="checkbox"] {
            display: none;
        }
        .interactive-checklist li .checkbox-text {
            flex: 1;
        }
        
        /* Collapsible Section Styles */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .collapsible-header .lucide {
            transition: transform 0.3s ease;
        }
        .collapsible-header.collapsed .lucide {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            max-height: 1000px; /* Or a large enough value */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, visibility 0s linear 0s, opacity 0.3s ease;
            visibility: visible;
            opacity: 1;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            visibility: hidden;
            opacity: 0;
            transition: max-height 0.3s ease-in-out, visibility 0s linear 0.3s, opacity 0.3s ease;
        }
        mark {
            background-color: #fef08a; /* yellow-200 */
            padding: 0.1em 0.2em;
            border-radius: 0.2em;
        }
        .dark mark {
            background-color: #facc15; /* yellow-400 */
            color: #1f2937; /* gray-800 */
        }
        
        /* Floating Scratchpad Styles */
        #floating-scratchpad-modal .drag-handle {
            cursor: move;
        }

        /* Drag and Drop Styles */
        .draggable.dragging {
            opacity: 0.5;
            background: #e0e7ff;
        }
        .dark .draggable.dragging {
            background: #3730a3;
        }
        .drag-over {
            border-top: 2px dashed var(--theme-color-500);
        }

        /* Edit Mode Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--theme-color-500);
        }
        input:checked + .slider:before {
            transform: translateX(16px);
        }

    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans">

    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-full w-60 bg-white dark:bg-gray-800 shadow-lg flex flex-col z-40">
        <div class="flex items-center h-16 px-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
            <i data-lucide="activity" class="w-6 h-6 mr-2 text-[var(--theme-color-500)]"></i>
            <span class="font-bold text-lg">Clinical OS</span>
            <button id="theme-toggle" class="ml-auto p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Theme">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
        <nav class="sidebar-nav py-4 px-2 space-y-1">
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center" data-tab="dashboard"><i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i>Dashboard</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center" data-tab="interventions"><i data-lucide="zap" class="w-4 h-4 mr-3"></i>Interventions</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center" data-tab="scripts"><i data-lucide="file-text" class="w-4 h-4 mr-3"></i>Scripts</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center" data-tab="psychoeducation"><i data-lucide="book-open" class="w-4 h-4 mr-3"></i>Psychoed</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center" data-tab="favorites"><i data-lucide="star" class="w-4 h-4 mr-3"></i>Favorites</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center" data-tab="recents"><i data-lucide="history" class="w-4 h-4 mr-3"></i>Recently Viewed</button>
            <button id="scratchpad-toggle-btn" class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center" data-tab="scratchpad"><i data-lucide="edit-3" class="w-4 h-4 mr-3"></i>Scratchpad</button>
        </nav>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0 space-y-4">
            <div class="flex items-center justify-between">
                <label for="theme-selector" class="text-sm font-medium text-gray-700 dark:text-gray-300">Theme</label>
                <select id="theme-selector" class="text-sm rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:ring-[var(--theme-color-500)] focus:border-[var(--theme-color-500)]">
                    <option value="indigo">Clinical Indigo</option>
                    <option value="green">Forest Green</option>
                    <option value="orange">Sunset Orange</option>
                    <option value="gray">Monochrome</option>
                </select>
            </div>
             <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Edit Mode</span>
                <label class="switch">
                    <input type="checkbox" id="edit-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <input id="search-box" type="text" placeholder="Search scenarios..." class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-[var(--theme-color-500)]" />
        </div>
    </aside>

    <!-- Main content -->
    <main class="ml-60 min-h-screen p-6 md:p-8 transition-colors duration-300">
        <div class="flex justify-between items-center mb-4">
            <!-- Used this session -->
            <div id="used-this-session-container" class="flex-1"></div>
            <!-- In-Session Timer -->
            <div id="session-timer-container" class="flex items-center gap-2 p-2 rounded-lg bg-green-100 dark:bg-green-900 transition-colors duration-500">
                <i data-lucide="timer" class="w-5 h-5"></i>
                <span id="session-timer" class="font-mono font-semibold text-lg">00:00</span>
                <button id="timer-toggle-btn" title="Start/Pause Timer" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="play" class="w-4 h-4"></i>
                </button>
                <button id="timer-reset-btn" title="Reset Timer" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <!-- Dynamic content area -->
        <div id="content-area" class="card-container"></div>
    </main>

    <!-- Content Modal -->
    <div id="scenario-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-50 p-4 modal-hidden">
        <div id="modal-content-wrapper" class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full relative p-6 max-h-[90vh] flex flex-col modal-content opacity-0 scale-95">
            <div id="modal-context" class="flex flex-wrap gap-2 mb-3"></div>
            <div class="flex items-start mb-4">
                <h2 id="modal-title" class="text-2xl font-bold flex-1"></h2>
                <button id="close-modal" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="modal-body" class="prose dark:prose-invert max-w-none overflow-y-auto pr-4 -mr-4 flex-1"></div>
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex items-center gap-2">
                 <button id="copy-modal-content-to-scratchpad" class="flex items-center text-xs px-3 py-1 bg-teal-100 dark:bg-teal-900 rounded-md text-teal-700 dark:text-teal-200 hover:bg-teal-200 dark:hover:bg-teal-800"><i data-lucide="plus-square" class="w-4 h-4 mr-1"></i>Copy to Scratchpad</button>
                 <button id="add-annotation-btn" class="flex items-center text-xs px-3 py-1 bg-yellow-100 dark:bg-yellow-900 rounded-md text-yellow-700 dark:text-yellow-200 hover:bg-yellow-200 dark:hover:bg-yellow-800"><i data-lucide="sticky-note" class="w-4 h-4 mr-1"></i>Add Note</button>
                 <button id="edit-content-btn" class="hidden edit-mode-item flex items-center text-xs px-3 py-1 bg-blue-100 dark:bg-blue-900 rounded-md text-blue-700 dark:text-blue-200 hover:bg-blue-200 dark:hover:bg-blue-800"><i data-lucide="edit" class="w-4 h-4 mr-1"></i>Edit</button>
                 <div class="ml-auto flex gap-2">
                    <button id="modal-prev" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <button id="modal-next" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-right" class="w-5 h-5"></i></button>
                 </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Access Add Modal -->
    <div id="quick-access-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-50 p-4 modal-hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full relative p-6 max-h-[90vh] flex flex-col modal-content opacity-0 scale-95">
            <div class="flex items-center mb-4">
                <h2 id="quick-access-modal-title" class="text-2xl font-bold flex-1">Add to Quick Access</h2>
                <button id="close-quick-access-modal" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <input id="quick-access-search" type="text" placeholder="Search all items..." class="w-full px-3 py-2 mb-4 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-[var(--theme-color-500)]" />
            <div id="quick-access-list" class="flex-1 overflow-y-auto -mr-4 pr-4 space-y-2"></div>
        </div>
    </div>

    <!-- Annotation Modal -->
    <div id="annotation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-[60] p-4 modal-hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-lg modal-content opacity-0 scale-95">
            <h3 id="annotation-modal-title" class="text-lg font-semibold mb-4">Add/Edit Note</h3>
            <textarea id="annotation-textarea" class="w-full p-2 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 rounded-lg text-sm" rows="6" placeholder="Your private notes for this item..."></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button id="annotation-cancel" class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                <button id="annotation-save" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-[var(--theme-color-600)] hover:bg-[var(--theme-color-700)]">Save</button>
            </div>
        </div>
    </div>

    <!-- Edit Content Modal -->
    <div id="edit-content-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-[60] p-4 modal-hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-3xl modal-content opacity-0 scale-95 max-h-[95vh] flex flex-col">
            <h3 id="edit-modal-title" class="text-xl font-semibold mb-4">Edit Content</h3>
            <div class="flex-1 overflow-y-auto pr-2 -mr-4 space-y-4">
                <div>
                    <label for="edit-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                    <input type="text" id="edit-title" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-[var(--theme-color-500)] focus:border-[var(--theme-color-500)] sm:text-sm">
                </div>
                <div>
                    <label for="edit-emoji" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Emoji</label>
                    <input type="text" id="edit-emoji" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-[var(--theme-color-500)] focus:border-[var(--theme-color-500)] sm:text-sm">
                </div>
                <div>
                    <label for="edit-tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tags (comma-separated)</label>
                    <input type="text" id="edit-tags" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-[var(--theme-color-500)] focus:border-[var(--theme-color-500)] sm:text-sm">
                </div>
                <div>
                    <label for="edit-content-textarea" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Content (Markdown)</label>
                    <textarea id="edit-content-textarea" class="mt-1 block w-full p-2 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 rounded-lg text-sm font-mono" rows="15" placeholder="Enter content here..."></textarea>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6">
                <button id="edit-revert" class="px-4 py-2 rounded-md text-sm font-medium text-red-600 hover:bg-red-100 dark:hover:bg-red-900/50">Revert to Default</button>
                <div class="flex gap-3">
                    <button id="edit-cancel" class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                    <button id="edit-save" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-[var(--theme-color-600)] hover:bg-[var(--theme-color-700)]">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-[70] p-4 modal-hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm modal-content opacity-0 scale-95">
            <h3 id="confirmation-title" class="text-lg font-semibold mb-4">Are you sure?</h3>
            <div id="confirmation-message" class="text-sm text-gray-600 dark:text-gray-300 mb-6"></div>
            <div class="flex justify-end gap-3">
                <button id="confirmation-cancel" class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                <button id="confirmation-confirm" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Floating Scratchpad -->
    <div id="floating-scratchpad-modal" class="fixed top-20 left-[20%] w-full max-w-xl z-[70] modal-hidden">
        <div id="floating-scratchpad-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl flex flex-col modal-content opacity-0 scale-95">
            <div class="drag-handle flex items-center p-4 border-b border-gray-200 dark:border-gray-700 cursor-move">
                <i data-lucide="edit-3" class="w-5 h-5 text-teal-500 mr-2"></i>
                <h2 class="text-xl font-bold flex-1">Scratchpad</h2>
                <button id="close-scratchpad-btn" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="floating-scratchpad-body" class="p-6">
                <!-- Content will be injected here by renderFloatingScratchpad -->
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="hidden"></div>

    <script>
    // ---- DATA ----
    const clinicalData = [
        // --- RED ZONE ---
        {
            id: 'red-suicidal-ideation',
            title: 'Suicidal Ideation – Safety Assessment',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['suicide', 'safety', 'crisis', 'cssrs', 'assessment', 'red'],
            content: `### ASSESS\n"Before we go any deeper, **our priority is always your safety**. I’d like to ask a few questions that help us understand how you’re doing and what kind of support might help keep you safe right now.\n\n1.  **Have you wished you were dead or that you could go to sleep and not wake up?**\n2.  **Have you actually had any thoughts of killing yourself?** (If yes, ask 3, 4, 5, 6. If no, go to 6).\n3.  **In the past 48 hours, have you been thinking about how you might do this?**\n4.  **In the past 48 hours, have you had these thoughts and had some intention of acting on them?**\n5.  **In the past 48 hours, have you started to work out any details for how to kill yourself? Do you intend to carry out this plan?**\n6.  **In the past 48 hours have you done anything to prepare to end your life?**\n\n*If Yes to 4, 5, or 6, ask scaling questions:*\n\n> \"On a scale of 1-5, one meaning you feel you can stay safe today, and five meaning that you're going to make an attempt today, where would you place yourself right now?\"\n\n*Reflect back answer:*\n* \"So a **four** means to me you have a plan and some intentions on acting on the plan, you just don't know when. Is that accurate?\"\n* \"A **three** means to me you have strong thoughts of wanting to die and have thought about ways you might act on it, but you don't have a specific plan. Did I get that right?\"\n* \"A **two** means to me that you have fleeting thoughts of wanting to end your life, but no plan or intention of acting on it.\"\n\n“I’m really glad you told me this. It takes a lot of strength to be this honest, and I’m here to help you figure it out.”\n\n### SAFETY PLAN\n**Need to escalate:** \"Thank you for telling me that. If it sounds like things are starting to feel more intense or harder to manage on your own, I’d like to connect you with a Crisis Manager — who can better support you and help figure out the next steps to keep you safe.\"\n\n* **Warning Signs:** “What are some early signs you notice when things start to spiral?”\n* **Internal Coping:** “What can you try on your own that sometimes helps, even a little?”\n* **Social Distractions:** “Who or what helps you shift your focus — even briefly?”\n* **People to Reach Out To:** “If things feel too big to hold alone, who could you reach out to?”\n* **Professional Resources:** “Do you have Charlie Health’s 24/7 crisis line saved in your phone?”\n* **Safety at Home:** “Is there anything nearby that might feel unsafe to have around right now?”\n* **Reasons to Stay:** “When things get dark, what’s something — or someone — that reminds you there’s still a reason to hang on?”`
        },
        {
            id: 'red-self-harm',
            title: 'Self-Harm Urges (Non-Suicidal Self-Injury)',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['nssi', 'self-harm', 'urges', 'coping', 'safety', 'red'],
            content: `### Direct Check-In\n“Thank you for telling me. I need to ask: Are you having urges to hurt yourself right now?”\n* **If yes (urge is present):** “On a scale from 1 to 10, how strong is the urge right now, 10 being the strongest?”\n* **If yes (recent self-harm action):** “What did you do, and how severe was it? Do you need any medical attention for that?”\n\n### Clarify Intent\n“When you self-harmed, was it because you wanted to die, or was it more about coping with pain or numbness?”\n\n### Validate & Normalize\n“That urge makes sense given what you’re carrying. A part of you is trying to survive and find relief, even if it’s doing it in a way that ends up hurting you. Let’s see if we can work with that part in a safer way.”\n\n### Offer Alternatives & Coping Strategies\n* **Intense Physical Sensations:** “Sometimes our body needs a very strong sensation to release that tension. We could try the **TIPP Skill for Rapid Distress Reduction**.”\n* **“Urge Surfing” Technique:** “Remember, urges are like waves — they build, peak, and eventually fall. Let’s try to ride this wave out together using the **Name the Urge, Challenge the Urge** technique.”\n* **Safe Physical Release:** “Would it help to rip up some paper, squeeze a stress ball, stomp your feet, or even scream into a pillow?”\n\n### Harm Reduction (If urge is overwhelming)\n"I hear that the urge feels too strong to resist completely right now. The priority is to keep you as safe as possible. Is there a way to get through this moment with less harm? For example, instead of [more severe method], could you try holding ice very tightly, or drawing on your skin with a red marker?"\n\n### Commitment to Safety\n“I know the urge is strong, but do you feel like you can stay safe tonight? Even if the urge comes back, can you promise me you’ll try these coping steps or reach out for help before doing anything to hurt yourself?”`
        },
        {
            id: 'red-imminent-risk',
            title: 'Imminent Risk of Harm (Active Crisis)',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['imminent risk', 'active crisis', 'de-escalation', 'emergency', 'safety', 'red'],
            content: `### Goal: Keep them engaged, slow the process, get help.\n"I am so glad you told me what's happening. I am here with you. Please stay on the line with me. We are going to figure this out together, one step at a time. My number one priority is your safety."\n\n### Step 1: Slow Things Down\n"I hear how much pain you're in. There is no rush to do anything right now. Can we just pause for a second? Just for one breath. Can you do that with me? Just one slow breath in... and out. Thank you. You're doing a great job."\n\n### Step 2: Express Empathy & Concern\n"It sounds like things have become completely unbearable. I can't imagine how much you must be hurting to get to this point. I am very, very concerned about you right now."\n\n### Step 3: Introduce the Idea of Help\n"You don't have to carry this all by yourself. Because I'm so concerned, I need to get you more support right now. I am going to contact emergency services to get someone to you. I will stay on the line with you the entire time. We will get through this together."\n\n### Step 4: If possible, create distance from means\n"While we wait for help to arrive, would you be willing to do something for me? It would help me feel a little less worried. Would you be willing to put the [pills/object] down, maybe just on the other side of the room? You don't have to get rid of them, just create a little space for a moment."\n\n### Intervention Insight\n* This entire process is an application of **The Seven-Stage Crisis Intervention Model** in real-time.\n* Use **Verbal De-escalation Techniques** throughout the conversation.`
        },
        {
            id: 'red-hallucinations',
            title: 'Hallucinations or Disturbing Perceptual Experiences',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['psychosis', 'hallucinations', 'voices', 'paranoia', 'safety', 'red'],
            content: `### Acknowledge Experience (Don’t Dismiss)\n“Thank you for telling me. I can imagine this feels really intense and scary. I want you to know I’m here with you, and I believe that you’re experiencing this.”\n\n### Safety Check (Calm & Direct)\n“Are the things you’re hearing or seeing telling you to hurt yourself or anyone else?”\n\n### Orient to Present (Ground in Shared Reality)\n“Let’s try something together to bring you into the here and now with me, okay? Put your feet flat on the floor for me. Press them down a little and notice that sensation. You’re right here, in this moment, with me. We’re safe right now. We can try a **Simple Somatic Anchors** technique.”\n\n### Calm Reassurance\n“You’re doing really well. I’m going to stay right here with you. The things you’re perceiving can feel real, but I want you to keep noticing the ground under your feet, the sound of my voice. We’re in the present moment.”`
        },
        {
            id: 'red-medical-crisis',
            title: 'Acute Medical Crisis',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['medical', 'emergency', '911', 'crisis', 'safety', 'red'],
            content: `### Immediate Action – Take Charge\n“Okay, I see/hear that something serious might be happening physically. The most important thing right now is getting you medical help immediately.”\n\n### Instruct to Call Emergency\n“Are you able to call 911 (or your local emergency number) right now? Is there someone with you who can call for you?”\n\n### Offer to Call\n“It sounds like you can’t call on your own. I’m going to get you help. Do I have your permission to call 911 for you right now to get an ambulance?”\n\n### Keep Them Engaged While Help Comes\n“Help is on the way. I’m right here with you. Try to stay as calm as you can – focus on taking slow breaths with me if possible. In… and out… nice and easy.”`
        },
        {
            id: 'red-overdose',
            title: 'Substance Overdose or Severe Intoxication',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['overdose', 'substance', 'intoxication', 'emergency', '911', 'red'],
            content: `### Recognize Seriousness\n“I can tell this is serious. I’m very concerned that you might be experiencing a medical emergency from substances.”\n\n### Instruct to Call Emergency\n“This is urgent. Are you able to call 911 right now for medical attention? Or is there someone with you who can call?”\n\n### Naloxone (If Opioid Overdose suspected)\n“If this might be an opioid overdose and if you or anyone there has Naloxone (Narcan) and knows how to use it, please use it now while we wait for the ambulance.”\n\n### Keep Them Awake & Oriented\n“Stay with me, okay? Help is coming. Try to stay awake and keep talking to me. I know you’re very drowsy, but focus on my voice.”`
        },
        {
            id: 'red-unsafe-home',
            title: 'Unsafe Home Environment / Domestic Violence',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['dv', 'domestic violence', 'abuse', 'safety', 'home', 'red'],
            content: `### Express Empathy and Belief\n“Thank you for sharing this with me. I can’t imagine how hard it was to say that out loud. I want you to know I believe you, and you didn’t deserve any of this.”\n\n### Assess Immediate Safety\n“Are you safe right now? Is the person who hurt you nearby or likely to return soon?”\n\n### Provide Control & Options\n“You know your situation best, and I’m here to support whatever you choose to do. For example, have you heard of the National Domestic Violence Hotline? They have advocates 24/7 at 1-800-799-7233 who can help you make a safety plan or find resources.”\n\n### Empower & Validate\n“You are not alone and there are people who want to help. You deserve to be safe. None of this is your fault.”`
        },
        {
            id: 'red-child-abuse',
            title: 'Child Abuse or Neglect Disclosure',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['child abuse', 'neglect', 'mandated reporter', 'cps', 'safety', 'red'],
            content: `### Respond with Care\n“Thank you for telling me that. I know it’s not easy to talk about. I am so sorry this happened to you (or to that child). No one, especially no child, should have to go through that.”\n\n### Explain Mandated Reporting (Transparent and Reassuring)\n“I need you to know: because you shared this, I’m required by law to take steps to report it to the proper authorities... This isn’t to get anyone in trouble; it’s to protect you/them and make sure it doesn’t continue.”\n\n### Support the Client’s Emotions\n“How are you feeling now that you’ve shared that? It’s a lot, I know. Whatever you’re feeling – scared, relieved, angry – it’s completely understandable.”\n\n### Closing Reassurance\n“I know this was a big step to tell me. You were very brave to speak up. Remember: you didn’t do anything wrong by telling the truth.”`
        },
        {
            id: 'red-harm-to-others',
            title: 'Threat of Harm to Others (Homicidal Ideation)',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['homicidal', 'harm to others', 'duty to protect', 'safety', 'crisis', 'red'],
            content: `### Immediate Clarification\n“I hear you saying you want to hurt someone. I take that very seriously, and I need to ask you a few questions to understand better, because my job is to keep everyone safe.”\n\n### Duty to Protect Explanation\n“Okay, I need you to know: because you’re talking about harming someone else, I have a responsibility to make sure that person (and everyone) stays safe. That may mean involving other professionals or authorities right away.”\n\n### De-escalate Anger\n“I get that you’re extremely angry. That anger is telling us something important — you feel deeply hurt or wronged. I’m here to listen to that. Let’s slow this down and sit with what’s coming up, instead of letting it boil over.”`
        },
        {
            id: 'red-under-influence',
            title: 'Under the Influence (Non-Crisis)',
            category: 'Red Zone',
            emoji: '🚩',
            color: 'red',
            tags: ['substance', 'intoxication', 'policy', 'safety', 'red'],
            content: `### Immediate Safety Check\n"Hi. I'm just checking in with you briefly. It was noticed in group that [specific observation, e.g., 'you seemed a bit sleepy']. How are you doing right now?"\n\n### Stating the Need to Log Off (Clear, Kind, Firm)\n"Because it appears you're under the influence right now, and in line with the group policy for everyone's safety and benefit, I am going to need you to log off from the group session for the rest of today."\n"This isn't a punishment, but it's a necessary step to ensure your well-being and to maintain the group's therapeutic environment."\n\n### Brief Safety Assessment (Essential before log-off)\n"Before you log off for the day, my top priority is to make sure you're going to be safe. Are you in a safe place physically right now? Is there anyone with you, or someone responsible you can contact if you start to feel unwell or need help?"\n\n### Explain Next Steps\n“Because you were under the influence and had to step out of group, I will let your primary therapist know what happened, just so they’re in the loop and can support you.”`
        },
        // --- ORANGE ZONE ---
        {
            id: 'orange-agitated',
            title: 'Highly Agitated or Escalating',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['agitation', 'escalation', 'anger', 'distress', 'orange'],
            content: `### Center and Slow the Moment\n“I can see (or hear) how agitated you are. Let’s take a pause for a second. I’m right here with you. You don’t have to go through this moment alone.”\n\n### Acknowledge the Anger/Frustration\n“That energy and anger you’re feeling right now — it makes sense. Something important is going on inside you and it’s demanding to be heard.”\n\n### Explore the Underlying Need\n"Anger often acts as a protector for more vulnerable feelings. I wonder, if the anger could speak, what hurt or fear might be underneath it? What is it trying to tell us that you need right now? This is something we can explore using **Acknowledging an Emotional Part**."\n\n### Keep Voice Calm & Assuring\n“I’m not going anywhere. I know you’re really upset, and it’s okay. Let’s stay right here. You’re safe with me to let it out, as long as we keep each other safe.”\n\n### After Calming Slightly – Reflection\n“That was a lot. You did really well slowing down just now. This is hard stuff, and you’re handling it. When you’re ready, maybe we can figure out what you need next or how I can help further.”`
        },
        {
            id: 'orange-panic-attack',
            title: 'Acute Anxiety or Panic Attack',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['anxiety', 'panic', 'fear', 'grounding', 'tipp', 'orange'],
            content: `### Normalize & Reassure\n“What you’re experiencing is a panic attack. It feels really scary, but **I promise it’s not life-threatening. You are going to be okay. I’m right here.**”\n\n### Immediate Physiological Regulation\n* **Temperature:** "Let's try the **TIPP Skill for Rapid Distress Reduction**. Can you splash some cold water on your face, or hold a cold water bottle or ice cube if you have one? This triggers something called the 'dive response' that naturally slows your heart rate."\n* **Paced Breathing:** "Let's breathe together. Breathe in through your nose for 4 counts... hold for 4... now out through your mouth for 6 counts. That longer exhale is key."\n\n### Orient to Safety\n“Let’s ground ourselves in the room. We can use the **Grounding Through Senses (5-4-3-2-1 Technique)** or a technique called **Dropping Anchor (ACT)** to connect with the present moment.”\n\n### Permission to Pause\n“We don’t need to unpack everything right now. In fact, we shouldn’t dive deeper into anything heavy at this moment, because I want to make sure you don’t leave here feeling even worse.”`
        },
        {
            id: 'orange-overwhelmed',
            title: 'Overwhelmed & Emotionally Flooded',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['overwhelmed', 'flooded', 'crying', 'shut down', 'orange'],
            content: `### Contain and Validate\n“It’s all feeling like too much, isn’t it? I hear you. What you’re experiencing right now makes so much sense given everything you’re carrying. Anyone would feel overwhelmed in your shoes.”\n\n### Permission to Pause\n“We don’t need to unpack everything right now. In fact, we shouldn’t dive deeper into anything heavy at this moment, because I want to make sure you don’t leave here feeling even worse. Let’s focus on just helping you feel a little more steady.”\n\n### Grounding in Present\n“Can you feel the chair under you, or your feet on the ground? Let’s start there. Just notice those physical points of contact – it might help bring you back just a little from the flood of feelings. We can try some **Simple Somatic Anchors**.”\n\n### Supportive Reassurance\n“I’m right here, and I’m not overwhelmed by your overwhelm. You don’t have to hold it together for my sake. It’s okay to let it out – cry, sit silently, whatever you need. I’ve got you.”`
        },
        {
            id: 'orange-dissociation',
            title: 'Dissociation / Depersonalization',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['dissociation', 'derealization', 'depersonalization', 'numb', 'unreal', 'grounding', 'orange'],
            content: `### Validate & Normalize\n"It sounds like you're feeling really disconnected, like you're watching yourself from a distance or things don't feel real. That's a very common, though unsettling, way our brains protect us from overwhelming feelings. It's called dissociation."\n\n### Gentle Re-orientation\n"You're not going crazy. This is a survival response. Our main job right now is to gently invite your awareness back into the present moment, without forcing anything."\n\n### Engage the Senses\n"Let's try to connect with one of our senses. Can you find one thing in the room that is a specific color, like blue? Just let your eyes rest on it. No need to do anything else, just notice it."\n\n### Intervention Insight\n* Use **Grounding Through Senses (5-4-3-2-1 Technique)** to re-engage with the environment.\n* Use **Simple Somatic Anchors** like pressing feet into the floor or holding a textured object.\n* Introduce **TIPP Skill for Rapid Distress Reduction**, especially the 'Temperature' component with cold water, to create a strong, grounding sensation.`
        },
        {
            id: 'orange-unusual-thoughts',
            title: 'Unusual Thoughts (Mild Paranoia or Cognitive Distortions)',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['paranoia', 'distortions', 'thoughts', 'reality testing', 'orange'],
            content: `### Do Not Dismiss\n“That sounds really troubling. It must feel scary (or confusing) thinking that might be true. Thank you for telling me what’s going through your mind.”\n\n### Gently Reality-Check\n“Let’s look at that together. You feel like everyone in group hates you. I know it can really feel that way. May I share what I’ve observed? I’ve seen group members show you care... I’m not seeing evidence of hate.”\n\n### Affirm\n“You’re not ‘crazy’ or bad for having these thoughts. Our minds do all kinds of weird things under stress. The fact that you can question it and talk about it means you have insight and courage.”\n\n### Intervention Insight\n* Use **Check the Facts (DBT)** to systematically evaluate if the emotion fits the situation.\n* Introduce **Thought Challenging - cognitive restructuring** to examine the evidence.`
        },
        {
            id: 'orange-trauma-reaction',
            title: 'Trauma Reaction / Flashback',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['trauma', 'flashback', 'ptsd', 'grounding', 'safety', 'orange'],
            content: `### Ground in Present Safety\n“Hey, you’re here with me. You’re safe right now. That thing isn’t happening to you right this second, even though it feels like it is.”\n\n### Breathe and Orient\n“Take a deep breath if you can. You’re breathing in the current year. You’re [client’s name], and you’re here with me, not back in that situation. That was then, and this is now. Can you say out loud, ‘I’m here now’?”\n\n### Validate and Contain\n“That memory was really intense. It makes sense that it felt like it was happening all over again. Flashbacks can be that powerful. But it’s not happening now, and you survived it then. You’re safe now.”\n\n### Intervention Insight\n* Use **Dropping Anchor (ACT)** to acknowledge the internal storm while connecting to the physical room.\n* Use **Simple Somatic Anchors** to provide immediate physical grounding.`
        },
        {
            id: 'orange-sexual-assault',
            title: 'Sexual Assault Disclosure',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['sexual assault', 'trauma', 'disclosure', 'safety', 'support', 'orange'],
            content: `### Listen and Honor Courage\n“I’m so sorry that happened to you. Thank you for trusting me enough to tell me. I can’t imagine how terrible that was for you, and how heavy it must be to carry that.”\n\n### Validate the Response\n“What happened is not your fault. You did not deserve that. The blame is 100% on the person who hurt you.”\n\n### Empower Choices\n“I want you to have control over what happens next. If you want help reporting it or getting medical care, I can help facilitate that. If you just wanted to tell someone and not take further action right now, that’s okay too.”`
        },
        {
            id: 'orange-relational-rupture',
            title: 'Relational Rupture / Intense Interpersonal Conflict',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['conflict', 'relationship', 'anger', 'betrayal', 'communication', 'orange'],
            content: `### Validate the Hurt/Anger\n“It sounds like you’re really hurt and angry about what happened. That’s completely understandable – when someone we care about [does X], it can feel awful and infuriating.”\n\n### Prevent Overwhelm or Shutdown\n“Let’s try to slow it just a bit so I can understand everything. I want to make sure I’m catching what’s most important to you in all of this.”\n\n### Brainstorm or Contain\n“Given how raw this is, it might be best not to confront them while you’re feeling this angry. We can work out what you want to say when you’re calmer. For now, maybe focus on what you need to feel a bit better.”\n\n### Intervention Insight\n* Prepare for a future conversation using **DEAR MAN: For Interpersonal Effectiveness**.\n* Use the **Nonviolent Communication (NVC) Framework** to clarify feelings and needs before communicating.`
        },
        {
            id: 'orange-triggered-by-group',
            title: 'Triggered by Group Content',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['trigger', 'group', 'trauma', 'overwhelmed', 'orange'],
            content: `### Normalize Triggers\n“It makes a lot of sense that you felt triggered by what came up in group. Sometimes other people’s stories can stir up feelings or memories we didn’t expect. That doesn’t mean anything is wrong with you – it means you’re human.”\n\n### Re-ground and Stabilize\n“Let’s come back to the here and now first. You’re with me, you’re safe. The group conversation is over (or on pause) and we’re just sitting here talking. Let's try to use the **Grounding Through Senses (5-4-3-2-1 Technique)** to help.”\n\n### Affirmation\n“I’m glad you took a break and talked to me about it. That’s a healthy response to feeling overwhelmed. You honored your limits, and that’s good.”`
        },
        {
            id: 'orange-conflict-in-group',
            title: 'Conflict in Group or with Staff',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['conflict', 'group', 'staff', 'anger', 'communication', 'orange'],
            content: `### Initial Response\n"It makes sense that you’d feel activated after what happened in group. I want to hold space for that with you."\n\n### Plan a Constructive Follow-Up\n“If you feel up to it, we can talk about how to address this. Would you want to speak with [the person] one-on-one with a mediator, maybe me or your therapist, present? Or would you prefer writing down what you feel and sharing it? We could use the **DEAR MAN: For Interpersonal Effectiveness** script to prepare.”\n\n### Affirm Self-Advocacy\n“I’m really glad you told me how you feel. You have every right to speak up when something isn’t okay for you.”`
        },
        {
            id: 'orange-anger-irritability',
            title: 'Anger and Irritability',
            category: 'Orange Zone',
            emoji: '🟠',
            color: 'orange',
            tags: ['anger', 'irritability', 'frustration', 'coping', 'orange'],
            content: `### Acknowledge the Emotion\n“You’ve been feeling a lot of anger lately – like a constant simmering. That’s exhausting, isn’t it? It’s okay to feel angry. Anger is a normal emotion. It often comes when we feel hurt, or trapped, or disrespected.”\n\n### Invite Insight\n“Do you have a sense of what’s underneath the anger? Often there’s pain or fear hiding under anger’s umbrella.”\n\n### Intervention Insight\n* Use **Circles of Control, Influence, and Concern** to help focus energy effectively.\n* Apply **Assertiveness Skills Training & Practice** for assertive expression.\n* Use **Check the Facts (DBT)** to see if the anger's intensity fits the situation.`
        },
        // --- YELLOW ZONE ---
        {
            id: 'yellow-resistant',
            title: 'Resistant / Ambivalent About Therapy',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['resistance', 'ambivalence', 'motivation', 'therapy', 'yellow'],
            content: `### Acknowledge Autonomy\n“It’s okay if you’re not sure about this or even if you don’t want help right now. You’re in control here – I’m not going to force anything on you.”\n\n### Gently Explore Resistance\n“Can I ask, what’s your biggest concern about accepting help? If you’d rather not say, that’s fine, but if we talk about it, maybe we can address it together.”\n\n### Affirm Their Pace\n“We can go as slow as you want. Maybe we don’t dive into anything deep today. We could just chat about surface stuff or even sit in silence if that feels safer.”\n\n### Intervention Insight\n* Use **Pros and Cons / Decisional Balance** to explore the costs and benefits of change versus staying the same.\n* Use **Solution-Focused Brief Therapy (SFBT) Techniques** like coping questions ("How have you managed so far?") to highlight existing strengths.`
        },
        {
            id: 'yellow-group-resistant',
            title: 'Group Resistant',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['group', 'resistance', 'ambivalence', 'therapy', 'yellow'],
            content: `### Validate Concerns\n"It sounds like you're not really feeling the group setting right now. That's fair. Group therapy isn't for everyone, and it can definitely feel awkward or unproductive at times."\n\n### Explore Specifics\n"Can you tell me a bit more about what's not working for you in group? Is it the topics, the other people, the format? Understanding the specific issue can help us see if it's something we can adjust."\n\n### Reframe Group's Purpose\n"Let's reframe this: What if group isn't about 'fixing' everything, but about practicing new ways of relating to yourself and others, even when it's imperfect?”\n\n### Empower Agency\n"This program asks a lot. And the reason it asks a lot is because the things you're working towards are significant. How can the group support you in meeting those demands today?”`
        },
        {
            id: 'yellow-manipulative-behaviors',
            title: '“Manipulative” or Testing Behaviors',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['manipulation', 'testing', 'boundaries', 'needs', 'yellow'],
            content: `### Look Under the Behavior\n“It seems like you really need something right now – maybe reassurance, or to feel in control? I want to understand what you need, because I don’t think you’re doing these things for no reason.”\n\n### Call Out Needs, Not Character\n“I don’t see you as ‘manipulative.’ I see someone who’s trying hard to get their needs met. How about we skip the part where you have to escalate things to get me to care – because I already care.”\n\n### Encourage Direct Communication\n“You shouldn’t have to test me to see if I’ll support you. I want you to know: if you need something, you can ask me as plainly as possible.”\n\n### Intervention Insight\n* Use the **DEAR MAN: For Interpersonal Effectiveness** framework for clear, assertive communication.\n* Explore the **Nonviolent Communication (NVC) Framework** to connect behaviors to unmet needs.`
        },
        {
            id: 'yellow-shut-down',
            title: 'Shut Down, Withdrawn, or Minimizing',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['withdrawn', 'shut down', 'minimizing', 'dissociation', 'yellow'],
            content: `### Gently Call It Out\n“I notice you’re getting really quiet (or you keep saying you’re fine). Sometimes when people get really quiet, it’s because the feelings are too much or too hard to put into words. Does that feel true for you right now?”\n\n### Permission to Be Silent\n“We can sit here together without talking for a bit if that’s what you need. I’m not uncomfortable with the silence if you aren’t. Sometimes just having someone nearby is enough.”\n\n### Explore Connection\n“Let’s think of one small way to feel a bit more connected. Is there anyone – even an acquaintance or a family member – you could send a text to later today, just to say hi?”\n\n### Affirmation\n“It took courage to admit how lonely you feel. That’s a step toward change. You deserve to feel connected and valued – because you are.”\n\n### Intervention Insight\n* Gently introduce **Simple Somatic Anchors** to help the client reconnect with their body in a non-threatening way.\n* Consider introducing **Acknowledging an Emotional Part** to give voice to the part that needs to withdraw.`
        },
        {
            id: 'yellow-loneliness',
            title: 'Loneliness and Isolation',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['loneliness', 'isolation', 'connection', 'depression', 'yellow'],
            content: `### Validate the Pain of Loneliness\n“Feeling lonely can be incredibly painful. I hear you – it’s like you’re aching for connection and it’s nowhere to be found. That’s a really heavy thing to carry.”\n\n### Assure Them They’re Not Alone Right Now\n“Well, you’re not alone at this exact moment. I’m here with you, and I care about what you’re feeling. I know I’m just one person and not a long-term fix, but I want you to know, right now in this space, you are seen and heard.”\n\n### Explore Opportunities for Connection (Gently)\n“Let’s think of one small way to feel a bit more connected. Is there anyone – even an acquaintance or a family member – you could send a text to later today, just to say hi? You don’t have to spill your guts to them, just a simple connection.”\n\n### Intervention Insight\n* Use **Behavioral Activation** to schedule small, connection-oriented activities.\n* Practice **Assertiveness Skills Training & Practice** to build confidence in initiating contact.`
        },
        {
            id: 'yellow-shame-guilt',
            title: 'Shame, Self-Hatred, or Guilt',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['shame', 'guilt', 'self-compassion', 'worthlessness', 'yellow'],
            content: `### Validate\n“It sounds like you’re holding yourself to an impossible standard. Whatever you did (or think you did), it doesn’t make you worthless or evil. It makes you human.”\n\n### Get Specific\n“Can we talk about what’smaking you feel so ashamed? What do you believe you did that’s so unforgivable?”\n\n### Self-Compassion\n“Think about what you would say to a close friend if they were feeling exactly what you’re feeling. You deserve that same kindness. What if you tried talking to yourself in that gentle way, maybe saying something like ‘It’s okay to feel this. I’m here for you.’?”\n\n### Intervention Insight\n* Use **ACT Defusion: Distancing from Thoughts** ("I'm having the thought that...") to create distance from shaming thoughts.\n* Apply **Cognitive Reframing: Behavior vs. Identity** to separate actions from self-worth.\n* Practice the **Self-Compassion Break (Kristin Neff)**.`
        },
        {
            id: 'yellow-body-image',
            title: 'Body Image Issues',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['body image', 'self-esteem', 'eating disorders', 'yellow'],
            content: `### Validate Feelings (Don’t Dismiss)\n“It’s really hard to feel uncomfortable in your own body. That’s a very real kind of pain. In a world that bombards us with certain images, it’s no wonder you feel this way.”\n\n### Gently Challenge Harsh Statements\n“When you say, ‘I hate my body’ – that’s a strong, blanket statement. I wonder, are there any parts of your body or things it does that you don’t hate? Even something small, like ‘I like my eyes’ or ‘my body gets me from place to place each day’?”\n\n### Promote Body Neutrality over Negativity\n“You don’t have to love your body right now – that can feel impossible. Maybe we aim for neutrality first. For example, instead of ‘I hate my legs,’ maybe ‘My legs allow me to walk, even if I don’t like how they look.’ It’s acknowledging their function without focusing on appearance.”\n\n### Intervention Insight\n* Practice **Mindful Self-Compassion: Soothing Touch** to offer kindness to the body.\n* Use **Thought Challenging - cognitive restructuring** on the negative self-talk.`
        },
        {
            id: 'yellow-hopelessness',
            title: 'Hopelessness or Despair (without active suicidal intent)',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['hopelessness', 'despair', 'depression', 'motivation', 'yellow'],
            content: `### Borrow Hope\n“Sometimes we have to borrow hope from others. Is it okay if I believe that things can change, even if you don’t believe it today? I’ve seen people come out of pits like this, and I truly believe you can too.”\n\n### Focus on Immediate Next Step\n“When the future looks blank or bleak, don’t even worry about the future right now. Let’s just focus on getting through today, or even just the next hour.”\n\n### Compassion\n“Even if you can’t feel hope right now, I have enough for both of us. I know you’re tired. But you’ve made it to this day, even carrying all that despair – that’s not small thing.”\n\n### Intervention Insight\n* Use **Behavioral Activation** to schedule one very small, simple, and achievable action.\n* Use **Solution-Focused Brief Therapy (SFBT) Techniques**, especially coping questions, to highlight resilience.`
        },
        {
            id: 'yellow-grief-loss',
            title: 'Grief and Loss',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['grief', 'bereavement', 'loss', 'sadness', 'yellow'],
            content: `### Validate the Pain\n"Grief is such a profound and painful experience. There's no timeline for it, and no 'right' way to do it. Whatever you're feeling right now—sadness, anger, numbness, confusion—it's all a valid part of the process. It's the price of love, in a way."\n\n### Permission to Grieve\n"You have permission to feel exactly what you're feeling. You don't need to put on a brave face or rush through this for anyone's sake, including your own. It's okay to not be okay. All parts of you are welcome here."\n\n### Focus on Self-Care and Gentleness\n"When you're grieving, your whole system is under immense stress. What's one small, gentle thing you could do for yourself today? It doesn't have to be big. Maybe it's just drinking a glass of water, or stretching for 30 seconds."\n\n### Intervention Insight\n* You can learn more about different ways to view the grieving process in **Models of Grief (Beyond the 5 Stages)**.\n* Practice the **Self-Compassion Break (Kristin Neff)** to offer kindness to the part that is hurting.\n* Explore ways to honor your loved one with **Continuing Bonds & Memorializing**.`
        },
        {
            id: 'yellow-social-anxiety',
            title: 'Social or Performance Anxiety',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['social anxiety', 'performance anxiety', 'fear', 'avoidance', 'yellow'],
            content: `### Normalize the Fear\n"It makes perfect sense to feel anxious in social situations, especially when you feel like you're being judged. That's a very common fear. Your brain is just trying to protect you from potential rejection, which is a deep, primal fear for humans."\n\n### Externalize the Anxiety\n"Let's think of that anxiety as a character—like a worried bodyguard that's a little too overprotective. It means well, but its advice isn't always helpful. We can say, 'Thanks for trying to protect me, Anxiety, but I've got this.'" \n\n### Focus on Small, Value-Based Steps\n"Instead of focusing on conquering the fear, what if we focused on a value, like 'connection' or 'courage'? What is one tiny step you could take that aligns with that value, even if the anxiety is still there? Maybe it's just making eye contact with the cashier for one second."\n\n### Intervention Insight\n* Use **ACT Defusion: Distancing from Thoughts** to unhook from anxious predictions.\n* Practice **Thought Challenging - cognitive restructuring** on specific fears like "Everyone will think I'm stupid."`
        },
        {
            id: 'yellow-terminal-illness',
            title: 'Terminal Illness',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['illness', 'grief', 'mortality', 'existential', 'yellow'],
            content: `### Initial Response & Presence\n"Thank you for reaching out today. I can only imagine how overwhelming this must be for you right now. Having a terminal diagnosis brings up so many intense feelings and fears. I'm here with you in this moment, and I want you to know that whatever you're feeling right now is completely valid and understandable."\n\n### Validating the Enormity of Their Experience\n"What you're going through - facing your own mortality - this is one of the most profound and difficult human experiences. There's no right way to feel about this. Whether you're feeling scared, angry, sad, numb, or all of these at once, it all makes sense."\n\n### Self-Compassion in the Face of Mortality\n"Facing terminal illness can bring up so much self-judgment. You deserve infinite compassion right now, especially from yourself. Let's try a **Self-Compassion Break (Kristin Neff)**."\n\n### Meaning-Making and Values Clarification\n"When we're facing limited time, it can help to get clear about what matters most. If you think about the time you have, what do you most want that time to include? How do you want to spend your energy? What relationships matter most? We can use **Values Clarification & Committed Action** to explore this."`
        },
        {
            id: 'yellow-ocd-thoughts',
            title: 'Obsessive-Compulsive Thoughts',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['ocd', 'obsessions', 'compulsions', 'intrusive thoughts', 'yellow'],
            content: `### Normalize\n“It sounds like your brain is stuck on a loop right now. Those kinds of intrusive thoughts can be really exhausting and frightening. You’re not crazy – OCD-type thoughts happen to a lot of people, and they don’t reflect your character or true intentions.”\n\n### Plan for Therapy Work\n“It might help to tell your therapist or psychiatrist about this if you haven’t – OCD is something that can really improve with the right techniques (like Exposure and Response Prevention therapy or sometimes medication).”\n\n### Intervention Insight\n* Practice **ACT Defusion: Distancing from Thoughts** or **Name the Urge, Challenge the Urge** to create distance.\n* Explain **Radical Acceptance** of the presence of the thought, without accepting its content as true.`
        },
        {
            id: 'yellow-negative-loops',
            title: 'Negative Thought Loops / Rumination',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['rumination', 'negative thinking', 'worry', 'anxiety', 'yellow'],
            content: `### Gently Interrupt\n“I notice your mind keeps circling around this. It’s like you’re stuck in a thought loop, huh? That can be really draining. Let’s hit the pause button on those thoughts for just a moment, if we can.”\n\n### Intervention Insight\n* Use **ACT Defusion: Distancing from Thoughts** techniques to help distance from thoughts.\n* Try **Grounding Through Senses (5-4-3-2-1 Technique)** to pull attention out of the head and into the environment.`
        },
        {
            id: 'yellow-eating-disorder',
            title: 'Eating Disorder (Moderate)',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['eating disorder', 'body image', 'food', 'anorexia', 'bulimia', 'yellow'],
            content: `### Address Gently\n“You mentioned some concerns around eating and body image. I know that can be really sensitive to talk about. I just want to say: I’m here to support you, not judge you. A lot of people struggle with food and eating; you’re definitely not alone in that.”\n\n### Assurance\n“I know this is scary. But you’re not alone in it. We care about you – I care about you – and we want you healthy and happy. You deserve to nourish yourself and to live without this burden.”\n\n### Intervention Insight\n* Explore the function of the behavior using **Acknowledging an Emotional Part** (e.g., "What is the part of you that restricts/purges trying to achieve for you?").\n* Practice **Opposite Action in Micro** when urges arise.`
        },
        {
            id: 'yellow-neurodivergent',
            title: 'Neurodivergent Challenges (ADHD/Autism Spectrum)',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['adhd', 'autism', 'neurodivergent', 'focus', 'sensory', 'yellow'],
            content: `### Immediate Coping for Sensory Overload\n“Are the lights or sounds bothering you right now? We can dim the lights, or if you want, you can wear headphones or a hoodie to feel more comfortable. No judgment – do what you need to regulate.”\n\n### Encourage Self-Acceptance\n“I know you sometimes feel like you’re ‘too weird’ or ‘broken’ because of how your brain works. You’re not. You’re different, yes, and different can be hard, but it can also be powerful.”\n\n### Intervention Insight\n* Use **Structured Goal-Setting (e.g., SMART Goals)** to break down overwhelming tasks.\n* Practice **Self-Compassion Break (Kristin Neff)** to counter negative self-talk.`
        },
        {
            id: 'yellow-off-topic',
            title: 'Off-Topic / Distractible',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['focus', 'distraction', 'adhd', 'avoidance', 'yellow'],
            content: `### Kindly Refocus\n“I notice we jumped to a different topic just now. That’s okay – sometimes our brains steer us away when we hit something uncomfortable or just because something else pops up. Let’s gently steer back to what we were talking about earlier, because I think that was important.”\n\n### Positive Reinforcement\n“You’re doing great. We covered the tough bit about your mom’s comment after all, and I really appreciate you sticking with that. I know it’s tempting to veer away, but you stayed with it. That’s progress!”`
        },
        {
            id: 'yellow-infidelity',
            title: 'Infidelity',
            category: 'Yellow Zone',
            emoji: '🟨',
            color: 'yellow',
            tags: ['infidelity', 'betrayal', 'relationships', 'trust', 'yellow'],
            content: `### Immediate Stabilization & Grounding\n"What you've discovered is a major shock to your system. Your body and mind are probably feeling like they're in crisis mode right now. That's completely normal when our world gets turned upside down like this."\n\n### Validating the Crisis Response\n"What you're feeling right now - the shock, the anger, the hurt - all of that makes complete sense. Discovering infidelity is a form of trauma. Your reaction is normal and valid."\n\n### Self-Compassion in Crisis\n"Right now, there might be a voice in your head blaming you. That self-blame is common, but it's not helpful and it's not accurate. Let's try a **Self-Compassion Break (Kristin Neff)**."\n\n### Immediate vs. Long-term Decisions\n"You might be feeling pressure to make big decisions right now. But you're in crisis mode, and that isn't the best time for life-changing decisions. Your only job right now is to take care of yourself through this crisis."`
        },
        // --- GREEN ZONE ---
        {
            id: 'green-imposter-syndrome',
            title: 'Imposter Syndrome',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['imposter syndrome', 'self-doubt', 'perfectionism', 'anxiety', 'green'],
            content: `### Normalize the Feeling\n"That feeling of being a 'fraud' or that you're going to be 'found out' is incredibly common, especially among high-achieving people. It's called Imposter Syndrome, and it doesn't mean you're actually an imposter. It means you have a pattern of thinking that discounts your own success."\n\n### Separate Feelings from Facts\n"Let's try an experiment. We have the *feeling* that you don't belong or aren't good enough. Now let's look for the *facts*. What are some objective accomplishments you've had? What positive feedback have you received? The feeling is real, but it might not be telling the whole truth."\n\n### Reframe the Narrative\n"What if this feeling of self-doubt isn't proof of your inadequacy, but a sign that you're pushing yourself, learning, and growing? People who are truly incompetent rarely worry about being incompetent. This feeling often shows up when you're challenging yourself, which is a good thing."\n\n### Intervention Insight\n* Use **Thought Challenging - cognitive restructuring** to directly confront the "imposter" thoughts.\n* Practice **Cognitive Reframing: Behavior vs. Identity** to see successes as part of your story, not just flukes.`
        },
        {
            id: 'green-global-anxiety',
            title: 'Political/Global Events Anxiety',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['anxiety', 'global events', 'politics', 'eco-anxiety', 'control', 'green'],
            content: `### Validate\n“It makes complete sense that you’re feeling [anxious/angry/overwhelmed] given what’s happening in the world. These are heavy and uncertain times, and your feelings are a very understandable response.”\n\n### Focus on Control vs. Concern\n“One thing that can help is to separate what you can control from what you can’t. We can’t single-handedly solve [the big issue] overnight, but we can control some actions in our own lives or communities.”\n\n### Intervention Insight\n* Use **Circles of Control, Influence, and Concern** to focus energy effectively.\n* Practice **Radical Acceptance** of the things outside of your control.`
        },
        {
            id: 'green-existential',
            title: 'Existential Concerns',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['existential', 'meaning', 'purpose', 'mortality', 'green'],
            content: `### Admire Depth and Acknowledge Pain\n“These are some of the biggest, most profound questions we face as human beings – meaning, purpose, our place in the world. It makes sense that they feel heavy and even overwhelming. Not everyone has the courage to even voice these thoughts.”\n\n### Explore Values and Sources of Meaning\n“When you think about ‘meaning’ or ‘purpose,’ are there any moments or activities in your life that even briefly give you a sense of meaning? It could be as simple as moments in nature, helping a friend, creating something, learning something new.”\n\n### Intervention Insight\n* Use **Values Clarification & Committed Action** to build a life aligned with what matters to the client, regardless of cosmic purpose.\n* Use **ACT Defusion: Distancing from Thoughts** to unhook from thoughts of meaninglessness.`
        },
        {
            id: 'green-chronic-pain',
            title: 'Chronic Pain or Health Challenges',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['chronic pain', 'illness', 'health', 'coping', 'green'],
            content: `### Acknowledge Difficulty\n“Dealing with chronic pain (or a chronic illness) is really tough. Not only are you physically hurting, but it wears on you emotionally too. It’s completely valid to feel frustrated, exhausted, or down about it.”\n\n### Discuss Coping Strategies\n“What helps on the days when the pain or symptoms are a bit more manageable? Is there anything – maybe a heating pad, a short walk, a certain stretch, a distraction like a good TV show – that gives you even a small relief or comfort?”\n\n### Intervention Insight\n* Practice **Radical Acceptance** of the current reality of the pain, which is different from approving of it.\n* Use **Mindful Self-Compassion: Soothing Touch** to offer comfort to the body.`
        },
        {
            id: 'green-expressing-needs',
            title: 'Struggling to Identify or Express Needs',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['needs', 'communication', 'assertiveness', 'boundaries', 'green'],
            content: `### Highlight the Pattern\n“It sounds like you often find yourself feeling unsatisfied or hurt because your needs aren’t met – but at the same time, you have a hard time even knowing or saying what those needs are. That’s more common than you might think... your needs matter.”\n\n### Practice in the Moment\n“Let’s practice right now in a small way: How are you feeling in this moment with me? Do you need anything? This is a low-stakes environment to practice identifying a need and voicing it.”\n\n### Intervention Insight\n* Use the **Nonviolent Communication (NVC) Framework** (Observations, Feelings, Needs, Requests).\n* Use **DEAR MAN: For Interpersonal Effectiveness** to structure a request.`
        },
        {
            id: 'green-enmeshed-relationships',
            title: 'Enmeshed or Dependent Relationships',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['enmeshment', 'dependency', 'boundaries', 'identity', 'relationships', 'green'],
            content: `### Validate Difficulty\n“It sounds like you feel really tangled up in this relationship – like your feelings and decisions are almost merged with theirs. That can be comforting at times, but also suffocating or confusing.”\n\n### Identify Personal Values and Interests\n“Let’s talk about you – just you. What are some things you enjoy or value that are independent of this other person? It could be hobbies, goals, even opinions on things like favorite movies or foods.”\n\n### Intervention Insight\n* Explore **Boundary Setting Exploration & Practice**.\n* Use **Values Clarification & Committed Action** to strengthen sense of self.`
        },
        {
            id: 'green-feeling-stuck',
            title: 'Feeling Directionless or “Stuck” in Life',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['stuck', 'directionless', 'purpose', 'motivation', 'values', 'green'],
            content: `### Normalize\n“A lot of people go through periods of life where they feel lost or directionless. It can be really unsettling, like you’re drifting without a map. First off, it’s okay to not have everything figured out.”\n\n### Explore Values\n“Sometimes direction becomes clearer when we focus on what we truly value in life.”\n\n### Intervention Insight\n* Use **Solution-Focused Brief Therapy (SFBT) Techniques** like the "Miracle Question" to identify desired future states.\n* Use **Values Clarification & Committed Action** to find a meaningful direction.`
        },
        {
            id: 'green-time-management',
            title: 'Time Management and Organization',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['time management', 'organization', 'procrastination', 'productivity', 'green'],
            content: `### Positive Frame\n“You’re looking to get more organized and manage your time better – that’s a great goal. These skills can make life so much less stressful once they click, and I’m excited to help you with it.”\n\n### Task Chunking\n“Another approach is breaking the task into teeny tiny chunks. Instead of ‘Write essay,’ chunk it to: ‘1) Open a Word doc, 2) write a rough title, 3) jot three bullet points of ideas.’ Then do one chunk at a time.”\n\n### Time Management Techniques (Pomodoro)\n“Have you heard of the Pomodoro Technique? It’s where you work for 25 minutes, then take a 5-minute break, then repeat.”\n\n### Intervention Insight\n* Encourage **Structured Goal-Setting (e.g., SMART Goals)**.\n* Use **Behavioral Activation** to schedule and commit to tasks.`
        },
        {
            id: 'green-decision-making',
            title: 'Decision-Making',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['decisions', 'indecisive', 'anxiety', 'choices', 'green'],
            content: `### Frame the Issue\n“Decision-making can be really stressful, especially if you’re afraid of making the wrong choice or if you’ve got a lot of options. It’s actually great that you want to work on this; being more confident in your decisions can reduce a lot of anxiety.”\n\n### Listen to Gut and Head\n“It’s good to analyze, but also consider your gut feeling. Our instincts are basically our subconscious pulling from past experiences and values.”\n\n### Intervention Insight\n* Use **Structured Problem-Solving** or the **Pros and Cons / Decisional Balance** to examine consequences.\n* Connect the decision to **Values Clarification & Committed Action**.`
        },
        {
            id: 'green-perfectionism',
            title: 'Perfectionism',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['perfectionism', 'procrastination', 'self-criticism', 'anxiety', 'green'],
            content: `### Acknowledge Upside/Downside\n“It sounds like you have some perfectionistic tendencies... On one hand, that drive can push you to achieve great things. On the other hand, it’s really exhausting and can make you avoid things.”\n\n### Address Procrastination\n“Try the motto, ‘Done is better than perfect.’ Starting something, even if you know it’s rough, gives you material to refine.”\n\n### Self-Compassion Practice\n“You likely speak to yourself very harshly when you’re not perfect. Try to cultivate a more compassionate inner voice. A good trick is to talk to yourself as if you were your best friend.”\n\n### Intervention Insight\n* Use **Thought Challenging - cognitive restructuring** to examine "shoulds".\n* Practice **Opposite Action in Micro** by intentionally submitting "good enough" work.`
        },
        {
            id: 'green-life-transitions',
            title: 'Life Transitions',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['transition', 'change', 'graduation', 'new job', 'anxiety', 'green'],
            content: `### Normalize Anxiety\n“Big changes – even positive ones – can be really unsettling. It’s totally normal to feel anxious or unsure when you’re entering a new phase of life. You’re basically stepping into the unknown.”\n\n### Use Old Skills in New Ways\n“Remember that even though the context is changing, you’re bringing all your accumulated skills and wisdom with you. Think about other transitions you’ve navigated in the past... What helped you then?”\n\n### Build a Support System\n“In times of change, leaning on support is key. Stay connected with your old friends/colleagues even as you make new ones. Talk to people who’ve been through similar transitions.”`
        },
        {
            id: 'green-healthy-habits',
            title: 'Building Healthy Habits & Routines',
            category: 'Green Zone',
            emoji: '💚',
            color: 'green',
            tags: ['habits', 'routines', 'goals', 'motivation', 'green'],
            content: `### Praise Initiative\n“It’s fantastic that you want to build healthy habits. That’s a big step toward improving your day-to-day life. Habits and routines can really give you a sense of stability and make those positive actions almost automatic.”\n\n### Start Small\n“Instead of aiming for 30 minutes of meditation, what if you started with just one deep breath after you sit down at your desk? The goal is to make it so easy you can’t say no.”\n\n### Accountability\n“It can really help to track your habits – like a habit journal or an app where you tick off each day you did the behavior. Seeing a streak can be motivating (you won’t want to break the chain!).”\n\n### Intervention Insight\n* Use **Behavioral Activation** to link activities to improved mood.\n* Use **Structured Goal-Setting (e.g., SMART Goals)** to create clear and achievable habits.`
        },
    ];

    const interventionsData = [
        // --- CRISIS & REGULATION ---
        {
            id: 'intervention-verbal-deescalation',
            title: 'Verbal De-escalation Techniques',
            category: 'Intervention',
            subCategory: 'Crisis & Regulation',
            color: 'blue',
            tags: ['de-escalation', 'crisis', 'anger', 'agitation', 'safety'],
            content: `### Core Rationale\nTo lower the emotional temperature of a conversation, ensure safety, and build enough rapport to allow for problem-solving. The goal is not to "win" but to help the person regain control.\n\n### Key Principles\n1.  **Manage Your Own Non-Verbals:** Your calm is contagious. Keep your tone of voice low and slow. Speak calmly. If on video, keep your body language open and non-threatening (no crossed arms).\n2.  **Listen Actively & Reflect:** "Let the person vent. Don't interrupt. Reflect back what you hear to show you're listening: 'So what I'm hearing is you're furious because you feel like nobody is listening to you. Is that right?'"\n3.  **Validate, Validate, Validate:** "Validation doesn't mean you agree; it means you understand their feeling is real *for them*. Use phrases like: 'That makes sense,' 'I can see why you'd be so upset,' or 'That sounds incredibly frustrating.'"\n4.  **Avoid Power Struggles:** "Don't get into arguments about who is right or wrong. Avoid saying 'calm down' or 'but'. Instead of 'but', try using 'and': 'You're feeling angry, *and* we need to figure out a safe plan.'"\n5.  **Give Choices & Control:** "When people feel out of control, giving them choices can help. 'Would you rather we talk about X or Y first?' or 'Would it be more helpful to try a breathing exercise or just sit for a minute?'"\n6.  **Set Clear, Calm Limits:** "If behavior is escalating, set limits calmly and respectfully. 'I want to keep talking with you, and I can't do that if you're screaming. Can we try to continue in a calmer tone?'"`
        },
        {
            id: 'intervention-tipp',
            title: 'TIPP Skill for Rapid Distress Reduction',
            category: 'Intervention',
            subCategory: 'Crisis & Regulation',
            color: 'blue',
            tags: ['dbt', 'distress tolerance', 'regulation', 'panic', 'overwhelm'],
            content: `### Core Rationale\nTIPP skills directly target the body's acute stress response, changing your body chemistry and creating a window to re-engage your thinking brain.\n\n### T - Temperature\n"First, let's try to change your body temperature. The idea is to create a sudden shift. If you can, go splash some cold water on your face - really let it cover your cheeks and the area under your eyes. This can help slow your heart rate down very quickly when you're agitated."\n\n### I - Intense Exercise\n"If you're feeling a lot of restless, built-up energy, a very short burst of exercise can help. Could you do some jumping jacks, run in place as fast as you can, or even just tense and release all your big muscle groups very hard and fast?"\n\n### P - Paced Breathing\n"Now, let's focus on slowing your breath. We're going to make your exhale longer than your inhale. Try breathing in deeply through your nose for 4 seconds, and then breathe out very slowly and gently through your mouth for 6 seconds."\n\n### P - Paired Muscle Relaxation\n"As you continue breathing slowly, when you breathe in, tense a group of muscles. Let's try that with your hands and arms; inhale through your nose, make tight fists. Hold that tension. Now as you exhale, slowly release the squeeze. Notice the difference."\n\n### Clinical Considerations\n* **When to Use:** Best for acute, physiological distress (panic, extreme agitation, intense urges).\n* **When to Avoid:** May not be suitable for individuals with certain medical conditions (e.g., heart problems, breathing issues). Always check for medical contraindications.`
        },
        // --- SOMATIC & GROUNDING ---
        {
            id: 'intervention-somatic-anchors',
            title: 'Simple Somatic Anchors',
            category: 'Intervention',
            subCategory: 'Somatic & Grounding',
            color: 'blue',
            tags: ['somatic', 'grounding', 'body', 'anxiety', 'dissociation'],
            content: `### Core Rationale\nImmediate ways to connect with the present moment using bodily sensations. These anchors signal safety to the nervous system and pull your attention out of overwhelming internal states.\n\n* **Noticing Feet on Floor:** "Just bring your attention down to your feet. Can you feel them on the floor? Notice the sensation of contact."\n* **Butterfly Tapping:** "Cross your arms over your chest, with hands on opposite shoulders. Start gently tapping your hands, one after the other, in a slow, rhythmic way."\n* **Hand on Heart:** "If it feels comfortable, you might try placing a hand gently on your heart. Just notice the warmth and gentle pressure."\n* **Pressing Fingertips Together:** "Try gently pressing the tips of your fingers on one hand against the tips of your fingers on the other. Just notice the sensation."`
        },
        {
            id: 'intervention-54321',
            title: 'Grounding Through Senses (5-4-3-2-1 Technique)',
            category: 'Intervention',
            subCategory: 'Somatic & Grounding',
            color: 'blue',
            tags: ['grounding', 'anxiety', 'panic', 'senses', 'mindfulness'],
            content: `### Core Rationale\nAnchoring in the present by noticing things through all five senses. This pulls your focus out of anxious thoughts and into your immediate, safe environment.\n\n### How to Practice\n"Let’s walk through your senses to ground you in the here and now."\n\n* **5 THINGS YOU CAN SEE:** Look around and name five things you see. (e.g., "I see a lamp, a blue pen, a window...")\n* **4 THINGS YOU CAN FEEL:** Notice four things you can feel with your body. (e.g., "I feel the chair under me, my feet on the floor...")\n* **3 THINGS YOU CAN HEAR:** Listen carefully and name three sounds. (e.g., "I hear the fan, a car outside...")\n* **2 THINGS YOU CAN SMELL:** Notice two scents. (e.g., "I can smell coffee, the soap on my hands...")\n* **1 THING YOU CAN TASTE:** Name one thing you can taste. (e.g., "I can taste my toothpaste," or just notice the taste in your mouth).`
        },
        {
            id: 'intervention-dropping-anchor',
            title: 'Dropping Anchor (ACT)',
            category: 'Intervention',
            subCategory: 'Somatic & Grounding',
            color: 'blue',
            tags: ['act', 'grounding', 'mindfulness', 'anxiety', 'overwhelm'],
            content: `### Core Rationale\nA comprehensive grounding exercise from ACT to acknowledge internal chaos while deliberately re-engaging with the physical world.\n\n### How to Practice (ACE)\n"Let's try an exercise called Dropping Anchor. The storm of thoughts and feelings can continue, we're just going to drop an anchor into the present moment."\n\n1.  **A - Acknowledge:** "First, silently and kindly acknowledge what's happening inside you. Notice the thoughts, the feelings, the memories. Just notice them without judgment. 'I'm noticing feelings of anxiety,' or 'I'm noticing my mind is racing.'"\n2.  **C - Come back into your body:** "Now, gently bring your attention to your physical body. You can press your feet into the floor, straighten your back, press your fingertips together, or slowly stretch. Feel your body in the chair, right here, right now."\n3.  **E - Engage with the world:** "Finally, notice what's around you. Look around the room and find five things you can see. Notice two things you can hear. Notice one thing you can smell. Re-engage with where you are."\n\n"The storm might still be there, but your anchor is holding you steady in the present."`
        },
        {
            id: 'intervention-grounding-trauma-part',
            title: "Grounding in the 'Here and Now' with a Traumatized Part",
            category: 'Intervention',
            subCategory: 'Somatic & Grounding',
            color: 'blue',
            tags: ['somatic', 'grounding', 'trauma', 'parts work', 'cptsd', 'dissociation'],
            content: `### Core Rationale\nWhen a younger, traumatized part is activated (feeling small, scared, helpless), standard grounding can feel invalidating. This approach first acknowledges the part's reality and then gently orients the adult self to the present, creating a sense of internal safety.\n\n### The Script\n1.  **Acknowledge the Part:** "I know that a part of you feels very young and very scared right now. It feels like [the bad thing] is happening all over again. I see that part, and I'm not going to push it away. It's welcome here."\n\n2.  **Validate its Experience:** "It makes sense that this part is terrified. It's remembering a time when you weren't safe. Thank you to that part for holding onto this memory to try and protect you."\n\n3.  **Engage the Adult Self:** "Now, I want to speak to the adult you. The you that is [current age] years old. Can the adult you look around the room right now? Notice one thing that tells you that you are in the current year, not back then. (e.g., 'I see my college diploma on the wall,' 'I can feel my car keys in my pocket')."\n\n4.  **Internal Co-regulation:** "Can the adult you let that scared, younger part know that you are here now? You can say internally, 'I'm here. I'm grown up now. I will keep us safe.' You might even place a hand on your own heart as a gesture of comfort from your adult self to your younger self."\n\n5.  **External Grounding:** "Now, let's have the adult you feel your feet on the floor. Really press them down. You are here, in this room, in this year. You are safe."`
        },
        // --- COGNITIVE & DBT ---
        {
            id: 'intervention-wise-mind',
            title: "Developing the 'Wise Mind' (DBT)",
            category: 'Intervention',
            subCategory: 'Cognitive & DBT',
            color: 'blue',
            tags: ['dbt', 'wise mind', 'intuition', 'balance', 'emotion regulation'],
            content: `### Core Rationale\nWise Mind is the integration of "Reasonable Mind" (logic, facts, planning) and "Emotion Mind" (feelings, urges, intuition). It's the calm, centered place where we can acknowledge our emotions while also thinking rationally, leading to more effective decisions.\n\n### The Three States of Mind\n1.  **Reasonable Mind:** "This is your 'cool,' logical side. It plans, evaluates facts, and thinks things through. It's very helpful, but without emotion, life can be cold and robotic."\n2.  **Emotion Mind:** "This is your 'hot,' feeling-driven side. It's where passion, love, and fear live. It's vital for a rich life, but when it's in complete control, it can lead to impulsive and unhelpful actions."\n3.  **Wise Mind:** "This is the overlap. It's that deep, intuitive knowing inside you. It acknowledges the logic from Reasonable Mind and the feelings from Emotion Mind, and then finds the centered, effective path forward. It's the feeling of 'just knowing' the right thing to do."\n\n### How to Access Wise Mind\n* **"What would Wise Mind do?":** Simply asking the question can create a pause and a shift in perspective.\n* **Mindful Breathing:** "Let's try focusing on your breath. As you breathe in, say 'Wise' to yourself. As you breathe out, say 'Mind.' Do this for a minute and see what emerges."\n* **Dropping into the Center:** "Imagine your Emotion Mind is in your heart and your Reasonable Mind is in your head. Can you bring your attention to the center of your body, in your belly? That physical center can be an anchor for your Wise Mind."`
        },
        {
            id: 'intervention-erp-intro',
            title: 'Exposure and Response Prevention (ERP) for OCD (Intro)',
            category: 'Intervention',
            subCategory: 'Cognitive & DBT',
            color: 'blue',
            tags: ['erp', 'ocd', 'exposure', 'anxiety', 'cbt'],
            content: `### Core Rationale\nTo introduce the gold-standard treatment for OCD in a way that is collaborative and demystifies the process. The goal is to build buy-in by explaining *why* facing fears without compulsions is the path to freedom.\n\n### The Conversation\n1.  **Validate the Current Strategy:** "Right now, when you feel that intense anxiety from an obsession, doing the compulsion brings relief. It makes perfect sense why you do it. It works, for a little while."\n\n2.  **Explain the OCD Trap:** "The problem is, each time you do the compulsion, you're teaching your brain that the obsession was a real threat that you *had* to neutralize. It strengthens the OCD cycle for next time. It's a short-term solution with long-term costs."\n\n3.  **Introduce ERP:** "The way out of this trap is called Exposure and Response Prevention, or ERP. 'Exposure' means we'll work together to gradually face the things you're afraid of. 'Response Prevention' means we'll work on resisting the urge to do the compulsion."\n\n4.  **Explain Habituation:** "When you do this, your anxiety will go up. That's a sign it's working. But if you can stay with that feeling without doing the compulsion, your brain will learn something new. It will learn that the feared outcome doesn't happen, and that the anxiety goes down *on its own*. This is called habituation. It's like getting into a cold pool—it's shocking at first, but eventually, you get used to it."\n\n5.  **Emphasize Collaboration:** "This is not something I would ever force on you. We would do this together, at your pace. We'll create a list of your fears, from least scary to most scary, and we'll start with something that feels challenging but manageable. You are in the driver's seat."`
        },
        // --- RELATIONAL & INTERPERSONAL ---
        {
            id: 'intervention-perfect-apology',
            title: "The 'Perfect Apology' - A Repair Script",
            category: 'Intervention',
            subCategory: 'Relational & Interpersonal',
            color: 'blue',
            tags: ['apology', 'repair', 'relationships', 'conflict', 'communication'],
            content: `### Core Rationale\nMany apologies fail because they are defensive or don't truly acknowledge the other person's pain. This structured approach, based on the work of Dr. Harriet Lerner, provides a framework for an apology that is more likely to be heard and to lead to genuine repair.\n\n### The Key Ingredients (No 'Buts' Allowed)\n1.  **State Your Specific Action (Without Excuses):** "Start by clearly and specifically stating what you did wrong. Avoid vague language."\n    * *Instead of:* "I'm sorry for what happened last night."\n    * *Try:* "I'm sorry that I was dismissive of your feelings when you tried to talk to me last night."\n\n2.  **Acknowledge Their Pain:** "Show them you understand how your actions impacted them. This is the most important part."\n    * *Example:* "I can imagine that felt really hurtful and like I didn't care. That must have been lonely."\n\n3.  **State Your Intention to Change (and what that will look like):** "An apology without a commitment to change is empty. Be specific about what you will do differently."\n    * *Example:* "It was not okay for me to do that. In the future, I will put my phone down and give you my full attention when you need to talk."\n\n4.  **Ask How You Can Help Make It Right:** "This shows you are willing to take responsibility and be part of the solution."\n    * *Example:* "Is there anything I can do now to help make things right?"\n\n### What to Avoid\n* **The word 'but':** Anything after 'but' negates the apology (e.g., "I'm sorry I yelled, but I was really stressed.")\n* **Explaining your intentions:** Don't say "I didn't mean to..." The focus should be on the *impact* of your actions, not your intent.\n* **Expecting immediate forgiveness:** The other person is entitled to their feelings. Your job is to deliver a clean apology, not to demand forgiveness.`
        },
        // --- ADDICTION & RECOVERY ---
        {
            id: 'intervention-functional-analysis-ed',
            title: 'Functional Analysis of Binge/Purge Behavior',
            category: 'Intervention',
            subCategory: 'Addiction & Recovery',
            color: 'blue',
            tags: ['cbt', 'eating disorder', 'bulimia', 'binge', 'analysis', 'cycle'],
            content: `### Core Rationale\nA core CBT tool to help clients understand the context and function of their eating disorder behaviors. By mapping out the chain of events, clients can identify high-risk situations and find specific points where they can intervene differently.\n\n### The Chain Analysis\n"Let's break down the most recent episode like a detective. By understanding all the links in the chain, we can figure out where to break it next time."\n\n1.  **Trigger/Antecedent:** "What was happening right before the urge to binge started? Where were you? Who were you with? What were you feeling? (e.g., 'I was home alone after a stressful day at work, feeling lonely and bored')."\n\n2.  **Thoughts & Feelings:** "What thoughts were going through your mind? What feelings were most prominent? (e.g., 'I feel like a failure,' 'I deserve a treat,' 'I can't handle this feeling')."\n\n3.  **The Behavior (The Binge):** "Describe the binge itself. What did you eat? How fast? Where were you?"\n\n4.  **Immediate Consequences (Short-Term):** "What happened right after? What was the immediate relief or change in feeling? (e.g., 'For a few minutes, I felt numb and didn't have to think about my stressful day')."\n\n5.  **The Urge to Purge:** "What thoughts and feelings led to the decision to purge? (e.g., 'I'm disgusting,' 'I have to get rid of this,' intense shame and panic)."\n\n6.  **Delayed Consequences (Long-Term):** "Looking back now, what were the longer-term consequences of the whole cycle? (e.g., 'I felt even more ashamed,' 'I isolated myself,' 'I spent money I didn't have')."\n\n### The Goal\n"Looking at this whole chain, where is the first place you could have done something differently? What's one skill you could have tried at the trigger stage, or with the initial thoughts and feelings?"`
        },
        // --- MOTIVATIONAL ---
        {
            id: 'intervention-mi-oars',
            title: "Motivational Interviewing: OARS & The 'Change Talk' Dance",
            category: 'Intervention',
            subCategory: 'Motivational',
            color: 'blue',
            tags: ['mi', 'motivational interviewing', 'oars', 'change talk', 'ambivalence'],
            content: `### Core Rationale\nMotivational Interviewing (MI) is a collaborative conversation style for strengthening a person's own motivation and commitment to change. It's about dancing, not wrestling. You don't convince them to change; you help them convince themselves.\n\n### The Core Skills: OARS\n* **O - Open-Ended Questions:** "Ask questions that invite more than a 'yes' or 'no' answer. They open the door for the client to explore their experience."\n    * *Example:* "What are some of the not-so-good things about how things are now?" instead of "Is this a problem for you?"\n\n* **A - Affirmations:** "Genuinely affirm the client's strengths, efforts, and positive qualities. This builds rapport and self-efficacy."\n    * *Example:* "It took a lot of courage to even talk about this today."\n\n* **R - Reflective Listening:** "This is the most important skill. Reflect back what the client is saying, often guessing at the underlying meaning or feeling. This shows you're listening and helps the client hear themselves."\n    * *Client:* "I know I should quit, but I don't know if I can."\n    * *Reflection:* "So on one hand, you see the reasons to change, but on the other, you're not confident in your ability to do it."\n\n* **S - Summaries:** "Periodically pull together what the client has said. This shows you've been tracking with them and allows them to hear their own change talk bundled together."\n    * *Example:* "So let me see if I have this right... You said that your drinking is starting to affect your job, and you're worried about your health, but you're also concerned about how you'll relax without it. Is that about right?"\n\n### The Goal: Elicit 'Change Talk'\n'Change Talk' is any statement the client makes in favor of change. The goal of OARS is to listen for and strategically reflect and summarize Change Talk, helping the client build their own argument for change.`
        },
    ];

    const psychoeducationData = [
        {
            id: 'psychoed-erp-what-is',
            title: 'What is Exposure and Response Prevention (ERP)?',
            category: 'Psychoeducation',
            emoji: '🧠',
            color: 'purple',
            tags: ['erp', 'ocd', 'cbt', 'treatment', 'anxiety', 'psychoed'],
            content: `### The Gold Standard for OCD\nExposure and Response Prevention (ERP) is not just one type of therapy; it is considered the gold-standard, most effective treatment for Obsessive-Compulsive Disorder (OCD). It's a specific type of Cognitive Behavioral Therapy (CBT).\n\n### The Two Parts\n1.  **Exposure:** This means voluntarily and gradually facing the thoughts, images, objects, and situations that trigger your obsessions and anxiety. We do this together, starting with things that are only mildly anxiety-provoking and working our way up.\n\n2.  **Response Prevention:** This is the crucial second half. It means making a conscious choice *not* to do the compulsive behavior or ritual once the anxiety has been triggered. This is the part that breaks the OCD cycle.\n\n### How Does It Work?\nERP works through a process called **habituation**. When you expose yourself to a trigger and prevent the response, your anxiety will naturally spike. This is uncomfortable, but it's supposed to happen. If you can stay in the situation without 'fixing' it with a compulsion, your brain learns two very important things:\n\n1.  **The feared outcome usually doesn't happen.** Your brain's catastrophic prediction was wrong.\n2.  **The anxiety goes away on its own.** You learn that you can tolerate the feeling of anxiety and that it is not permanent. It peaks and then subsides naturally.\n\n### Why It's Hard but Worth It\nERP is not easy. It requires courage and a willingness to feel uncomfortable. However, by repeatedly showing your brain that its alarms are false, you weaken the power of the obsessions and compulsions. You get your life back from OCD, instead of having your life run by rituals and avoidance.\n\n### Intervention Insight\n* The **Exposure and Response Prevention (ERP) for OCD (Intro)** intervention is the first step in explaining this process to a client.`
        },
        {
            id: 'psychoed-ed-function',
            title: 'The Function of an Eating Disorder',
            category: 'Psychoeducation',
            emoji: '🧠',
            color: 'purple',
            tags: ['eating disorder', 'function', 'coping', 'control', 'alexithymia', 'psychoed'],
            content: `### Not About Food\nWhile they revolve around food and weight, eating disorders are rarely about food itself. They are serious mental illnesses that serve a purpose, or a function, in a person's life. Understanding this function is a key step toward recovery, as it allows us to find healthier ways to meet those same needs.\n\n### Common Functions of an ED\n* **A Sense of Control:** When life feels chaotic and overwhelming, controlling food intake, weight, or exercise can provide a powerful (though illusory) sense of control and predictability.\n\n* **Emotional Numbing or Distraction:** ED behaviors can be a way to numb or distract from painful emotions like sadness, anger, or loneliness. The intense focus on calories, rules, or the physical sensations of binging/purging can drown out everything else.\n\n* **A Sense of Identity:** For some, the eating disorder can become a core part of their identity. Being 'the thin one' or 'the disciplined one' can provide a sense of specialness or accomplishment, especially if other areas of life feel unfulfilling.\n\n* **Communication:** Sometimes, an eating disorder is a non-verbal way of communicating distress. It can be a way of saying "I'm not okay" when words feel impossible.\n\n* **Coping with Trauma:** EDs often develop as a way to cope with the aftermath of trauma, providing a way to manage overwhelming feelings or a sense of being unsafe in one's own body.\n\n### The Path to Recovery\nRecovery involves grieving the loss of this coping mechanism and building new, healthier ones. It's about learning to tolerate difficult emotions, finding a sense of self-worth outside of appearance, and developing a sense of agency in the world. This is why interventions like **Functional Analysis of Binge/Purge Behavior** and **Values Clarification & Committed Action** are so important.`
        },
        {
            id: 'psychoed-disenfranchised-grief',
            title: "Disenfranchised Grief: The Grief You're Not 'Allowed' to Have",
            category: 'Psychoeducation',
            emoji: '🧠',
            color: 'purple',
            tags: ['grief', 'loss', 'disenfranchised', 'shame', 'validation', 'psychoed'],
            content: `### What is Disenfranchised Grief?\nCoined by Dr. Kenneth Doka, disenfranchised grief is grief that is not openly acknowledged, socially sanctioned, or publicly mourned. It's a loss that society doesn't deem 'legitimate,' which can make the grieving process incredibly lonely and complicated.\n\n### When Does It Happen?\nDisenfranchised grief can occur when:\n\n1.  **The Relationship is Not Recognized:** This includes the loss of a partner in an extramarital affair, a same-sex partner when the relationship was not 'out,' an ex-spouse, or even a close online friend.\n\n2.  **The Loss is Not Seen as Significant:** Society often minimizes certain losses. This can include the death of a pet, a miscarriage, an abortion, or losing a job.\n\n3.  **The Griever is Not Seen as Capable of Grief:** This often happens to young children or individuals with developmental disabilities or mental illness, whose capacity to grieve is underestimated by those around them.\n\n4.  **The Cause of Death is Stigmatized:** Deaths by suicide, drug overdose, or AIDS can carry a stigma that prevents people from openly grieving or receiving support.\n\n### Why It's So Difficult\n* **Invalidation:** You are told, directly or indirectly, that your pain is not valid. This can lead to intense shame and self-doubt.\n* **Isolation:** You cannot share your pain openly, so you are forced to grieve alone.\n* **Lack of Rituals:** There are no funerals, sympathy cards, or social rituals to help you process the loss.\n\n### What Helps\n* **Name and Validate It:** Simply recognizing that you are experiencing disenfranchised grief can be a powerful first step. Your pain is real, even if others don't see it.\n* **Find a Witness:** Find at least one person—a friend, a therapist, a support group—who can listen to your story without judgment and validate your loss.\n* **Create Your Own Ritual:** You can create your own private ritual to honor your loss, such as writing a letter, planting a tree, or making a donation in their memory.`
        },
        {
            id: 'psychoed-good-enough-parenting',
            title: "'Good Enough' Parenting",
            category: 'Psychoeducation',
            emoji: '🧠',
            color: 'purple',
            tags: ['parenting', 'winnicott', 'perfectionism', 'guilt', 'family', 'psychoed'],
            content: `### The Impossible Goal of 'Perfect' Parenting\nModern culture puts immense pressure on parents to be perfect—to be endlessly patient, always engaging, and never make a mistake. This is an impossible standard that leads to guilt, shame, and burnout.\n\n### The 'Good Enough' Parent\nDonald Winnicott, a renowned pediatrician and psychoanalyst, introduced the concept of the 'good enough' mother (now adapted to 'good enough' parent). He observed that children do not need perfect parents. In fact, perfection can be harmful.\n\nWhat children need is a parent who is **attuned and responsive most of the time**, but who also makes mistakes and then **repairs** them.\n\n### Why 'Good Enough' is Better Than 'Perfect'\n1.  **It Models Reality:** The world is not perfect. A parent who makes mistakes and handles them with grace teaches their child that it's okay to be imperfect. It prepares them for the real world.\n\n2.  **It Fosters Resilience:** When a parent inevitably fails a child in a small way (e.g., is late picking them up, loses their temper) and then apologizes and reconnects, the child learns that relationships can withstand conflict and that ruptures can be repaired. This is a crucial life skill.\n\n3.  **It Allows for Healthy Separation:** A parent who meets a child's every need instantly doesn't allow the child to develop their own sense of self and their own ability to tolerate frustration and solve problems.\n\n### The Key is Repair\nThe magic of 'good enough' parenting is not in avoiding mistakes, but in the **repair**. It's in saying, "I'm sorry I yelled. I was feeling really frustrated. I love you." This teaches children accountability, forgiveness, and the resilience of human connection.\n\n### Intervention Insight\n* This concept is a powerful antidote to the struggles described in **Struggling with Parenting Challenges**.\n* The **The 'Perfect Apology' - A Repair Script** is a practical tool for making these essential repairs.`
        },
    ];

    const scriptsData = [
        {
            id: 'script-boundary-setting',
            title: 'Foundational Boundary Setting',
            category: 'Script',
            color: 'indigo',
            tags: ['boundaries', 'role setting', 'containment', 'scripts'],
            content: `### Standard Framing\n“Before we get started—my role isn’t for processing, but to make sure you’re safe and help get you grounded so you can rejoin group. We’ve got about 20 minutes, can you tell me what’s going on that brought you to reach out for support?”\n\n### For Clients Expecting Therapy\n“My role’s a bit different than a therapist’s—I’m not here to fully process, but I am here to check in on your safety and help you feel a little more steady before heading back to group. Want to tell me what’s weighing on you today?”\n\n### Quick Boundary Phrases\n* "I can’t go deep with you here, but I can help you feel safer and more grounded right now."\n* "Let’s slow it down together. I’m here to help steady things—not unpack everything."`
        },
        {
            id: 'script-stabilize',
            title: 'Stabilization Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['stabilize', 'grounding', 'containment', 'validation', 'scripts'],
            content: `### Validate & Contain\n“You’ve been dealing with a lot, and your mind and body are hitting a limit. That’s okay. There’s no rush to fix anything right now. We’re not trying to erase that heaviness — but to hold it in a way that feels manageable enough for this moment."\n\n### Slow Nervous System\n“Let’s take a moment to slow things down together. There’s no rush here and no pressure to fix anything. Let's try one slow breath together. Inhale and notice your lungs filling... hold it for a second... now exhale nice and slow."\n\n### Empower & Redirect\n“Your courage in acknowledging how intense this feels is really powerful. Remember, our goal isn’t to solve everything right now — it’s just to get you steady enough that you can leave here feeling a bit more centered.”`
        },
        {
            id: 'script-end-of-session',
            title: 'End-of-Session Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['end of session', 'survey', 'closure', 'scripts'],
            content: `### Survey\n“Before you go back to group, I do have a brief survey that I’m required to provide. It's very short, just a thumbs up or thumbs down. Do you see the link in the chat?”\n“Great! Let me know when you are done and then I will get you back into group.”\n\n### If Still Heavy\n"You’re still carrying a lot — I see that. We haven’t solved everything, and we’re not supposed to in these few minutes. I just want to make sure that what you’re feeling now is something you can handle for now. Does it feel safe enough for you to wrap up, even if it’s still heavy?"\n\n### If Still in Distress\n"I don’t want to send you back in this state. Why don’t we take another minute here? We can try another grounding technique or even get additional support if you need it. My priority is that you leave feeling safe enough. How are you feeling about continuing a bit longer until this eases?"`
        },
        {
            id: 'script-trauma-dumping-containment',
            title: 'Trauma-Dumping Containment Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['trauma', 'containment', 'boundaries', 'safety', 'scripts'],
            content: `### Mid-Session Redirect\n“I really hear that this is painful, and it makes sense that you’d want to process it. But because we only have a few minutes and I’m not in the role of a therapist, I want to be careful we don’t go too deep here and leave you feeling more overwhelmed.”\n\n### Gentle Wall for Immediate Flooding\n“I know it can feel urgent to get it all out, but my role is to support you in feeling safe—not to unpack everything. If we open something deep in this short space, there’s a chance you’ll end up carrying it alone after we disconnect—and I want to avoid that.”\n\n### Emergency Stop – Already Flooded\n“You’ve shared something really heavy, and I can tell this matters. But we’re in a short space right now, and going deeper might actually make things harder for you when I have to end the session. Let’s focus on helping you stabilize.”`
        },
    ];
    
    const scratchpadTemplates = {
        safetyPlan: `### Safety Plan\n\n**Warning Signs (Thoughts, feelings, behaviors that things are getting worse):**\n- \n\n**Internal Coping Strategies (Things I can do on my own):**\n- \n\n**Social Distractions (People or places that can distract me):**\n- \n\n**People I Can Ask for Help:**\n- \n\n**Professional Resources (Therapist, crisis lines):**\n- \n\n**Making My Environment Safe:**\n- `,
        sessionNotes: () => {
            const now = new Date();
            const timestamp = now.toLocaleString('en-US', {
                dateStyle: 'short',
                timeStyle: 'short'
            });
            return `(${timestamp})\n\n[Concern] CC request for Ct ___.\n[Intervention] CSSRS: ___. Ct ___.\n[Outcome] Ct returned to group.`;
        }
    };

    // ---- STATE AND DATA ----
    const state = {
        favorites: [],
        recentlyViewed: [],
        usedThisSession: [],
        contentMap: new Map(),
        interventionMap: new Map(),
        annotations: {},
        customContent: {},
        editMode: false,
        currentView: 'dashboard',
        currentOpenScenario: null,
        scratchpadContent: '',
        scratchpadMode: 'write', 
        timer: {
            intervalId: null,
            elapsedSeconds: 0,
            isPaused: true,
        },
        isEditingQuickAccess: false,
        quickAccessIds: [],
        sessionPlans: [],
        currentPlanForAdding: null,
        theme: 'indigo',
        dashboardLayout: {
            zones: ['Red Zone', 'Orange Zone', 'Yellow Zone', 'Green Zone'],
            cards: {}
        }
    };

    const themes = {
        indigo: { 500: '#4f46e5', 600: '#4338ca', 700: '#3730a3', 400: '#818cf8', 100: '#e0e7ff', 900: '#312e81' },
        green: { 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 400: '#4ade80', 100: '#dcfce7', 900: '#14532d' },
        orange: { 500: '#f97316', 600: '#ea580c', 700: '#c2410c', 400: '#fb923c', 100: '#ffedd5', 900: '#7c2d12' },
        gray: { 500: '#6b7280', 600: '#4b5563', 700: '#374151', 400: '#9ca3af', 100: '#f3f4f6', 900: '#111827' },
    };

    const colorMap = {
        red: { border: "border-red-500", bg: "bg-red-50 dark:bg-red-900/20", text: "text-red-600 dark:text-red-400" },
        orange: { border: "border-orange-500", bg: "bg-orange-50 dark:bg-orange-900/20", text: "text-orange-600 dark:text-orange-400" },
        yellow: { border: "border-yellow-500", bg: "bg-yellow-50 dark:bg-yellow-900/20", text: "text-yellow-600 dark:text-yellow-400" },
        green: { border: "border-green-500", bg: "bg-green-50 dark:bg-green-900/20", text: "text-green-600 dark:text-green-400" },
        blue: { border: "border-blue-500", bg: "bg-blue-50 dark:bg-blue-900/20", text: "text-blue-600 dark:text-blue-400" },
        indigo: { border: "border-indigo-500", bg: "bg-indigo-50 dark:bg-indigo-900/20", text: "text-indigo-600 dark:text-indigo-400" },
        purple: { border: "border-purple-500", bg: "bg-purple-50 dark:bg-purple-900/20", text: "text-purple-600 dark:text-purple-400" },
    };

    // ---- DOM REFERENCES ----
    const dom = {
        contentArea: document.getElementById('content-area'),
        searchBox: document.getElementById('search-box'),
        toast: document.getElementById('toast'),
        scenarioModal: document.getElementById('scenario-modal'),
        modalContentWrapper: document.getElementById('modal-content-wrapper'),
        modalTitle: document.getElementById('modal-title'),
        modalBody: document.getElementById('modal-body'),
        modalContext: document.getElementById('modal-context'),
        closeModal: document.getElementById('close-modal'),
        modalPrev: document.getElementById('modal-prev'),
        modalNext: document.getElementById('modal-next'),
        usedThisSessionContainer: document.getElementById('used-this-session-container'),
        themeToggle: document.getElementById('theme-toggle'),
        themeSelector: document.getElementById('theme-selector'),
        copyModalContentBtn: document.getElementById('copy-modal-content-to-scratchpad'),
        addAnnotationBtn: document.getElementById('add-annotation-btn'),
        editContentBtn: document.getElementById('edit-content-btn'),
        confirmationModal: document.getElementById('confirmation-modal'),
        confirmationTitle: document.getElementById('confirmation-title'),
        confirmationMessage: document.getElementById('confirmation-message'),
        confirmationConfirm: document.getElementById('confirmation-confirm'),
        confirmationCancel: document.getElementById('confirmation-cancel'),
        sessionTimer: document.getElementById('session-timer'),
        sessionTimerContainer: document.getElementById('session-timer-container'),
        timerToggleBtn: document.getElementById('timer-toggle-btn'),
        timerResetBtn: document.getElementById('timer-reset-btn'),
        quickAccessModal: document.getElementById('quick-access-modal'),
        quickAccessModalTitle: document.getElementById('quick-access-modal-title'),
        quickAccessList: document.getElementById('quick-access-list'),
        quickAccessSearch: document.getElementById('quick-access-search'),
        closeQuickAccessModal: document.getElementById('close-quick-access-modal'),
        annotationModal: document.getElementById('annotation-modal'),
        annotationModalTitle: document.getElementById('annotation-modal-title'),
        annotationTextarea: document.getElementById('annotation-textarea'),
        annotationSave: document.getElementById('annotation-save'),
        annotationCancel: document.getElementById('annotation-cancel'),
        editContentModal: document.getElementById('edit-content-modal'),
        editModalTitle: document.getElementById('edit-modal-title'),
        editTitleInput: document.getElementById('edit-title'),
        editEmojiInput: document.getElementById('edit-emoji'),
        editTagsInput: document.getElementById('edit-tags'),
        editContentTextarea: document.getElementById('edit-content-textarea'),
        editSaveBtn: document.getElementById('edit-save'),
        editCancelBtn: document.getElementById('edit-cancel'),
        editRevertBtn: document.getElementById('edit-revert'),
        editModeToggle: document.getElementById('edit-mode-toggle'),
        floatingScratchpadModal: document.getElementById('floating-scratchpad-modal'),
        floatingScratchpadBody: document.getElementById('floating-scratchpad-body'),
        closeScratchpadBtn: document.getElementById('close-scratchpad-btn'),
        scratchpadToggleBtn: document.getElementById('scratchpad-toggle-btn'),
    };

    // ---- STATE PERSISTENCE ----
    function saveState() {
        localStorage.setItem('clinicalFavorites', JSON.stringify(state.favorites));
        localStorage.setItem('clinicalRecents', JSON.stringify(state.recentlyViewed));
        localStorage.setItem('clinicalScratchpad', state.scratchpadContent);
        localStorage.setItem('clinicalQuickAccess', JSON.stringify(state.quickAccessIds));
        localStorage.setItem('clinicalAnnotations', JSON.stringify(state.annotations));
        localStorage.setItem('clinicalSessionPlans', JSON.stringify(state.sessionPlans));
        localStorage.setItem('clinicalCustomContent', JSON.stringify(state.customContent));
        localStorage.setItem('clinicalTheme', state.theme);
        localStorage.setItem('clinicalDashboardLayout', JSON.stringify(state.dashboardLayout));
    }

    function loadState() {
        state.favorites = JSON.parse(localStorage.getItem('clinicalFavorites') || '[]');
        state.recentlyViewed = JSON.parse(localStorage.getItem('clinicalRecents') || '[]');
        state.scratchpadContent = localStorage.getItem('clinicalScratchpad') || '';
        const savedQuickAccess = localStorage.getItem('clinicalQuickAccess');
        state.quickAccessIds = savedQuickAccess ? JSON.parse(savedQuickAccess) : ['script-boundary-setting', 'intervention-tipp', 'intervention-self-compassion-break', 'script-end-of-session'];
        state.annotations = JSON.parse(localStorage.getItem('clinicalAnnotations') || '{}');
        state.sessionPlans = JSON.parse(localStorage.getItem('clinicalSessionPlans') || '[]');
        state.customContent = JSON.parse(localStorage.getItem('clinicalCustomContent') || '{}');
        state.theme = localStorage.getItem('clinicalTheme') || 'indigo';
        const savedLayout = localStorage.getItem('clinicalDashboardLayout');
        if (savedLayout) {
            state.dashboardLayout = JSON.parse(savedLayout);
        }
    }

    // ---- INITIALIZATION ----
    function initializeDataMap() {
        // Clear existing maps to prevent stale data on re-init
        state.contentMap.clear();
        state.interventionMap.clear();

        const allDefaultContent = [...clinicalData, ...interventionsData, ...scriptsData, ...psychoeducationData];
        
        allDefaultContent.forEach(defaultItem => {
            const customItem = state.customContent[defaultItem.id];
            const finalItem = customItem ? { ...defaultItem, ...customItem } : defaultItem;
            state.contentMap.set(finalItem.id, finalItem);
        });
        
        // Add any purely custom cards
        Object.keys(state.customContent).forEach(id => {
            if (!allDefaultContent.some(item => item.id === id)) {
                state.contentMap.set(id, state.customContent[id]);
            }
        });

        interventionsData.forEach(item => {
            state.interventionMap.set(item.title, item.id);
            if (!item.referencedIn) {
                 item.referencedIn = []; // Initialize for bi-directional linking
            }
        });

        buildInterventionLinks();
    }


    function buildInterventionLinks() {
        // Reset references to avoid duplication on re-build
        state.contentMap.forEach(item => {
            if (item.category === 'Intervention') {
                item.referencedIn = [];
            }
        });

        const contentToScan = Array.from(state.contentMap.values());
        
        contentToScan.forEach(sourceItem => {
            if (!sourceItem.content) return;

            state.interventionMap.forEach((interventionId, interventionTitle) => {
                const regex = new RegExp(`\\*\\*(${interventionTitle})\\*\\*`, 'g');
                if (sourceItem.content.match(regex)) {
                    const targetIntervention = state.contentMap.get(interventionId);
                    if (targetIntervention && !targetIntervention.referencedIn.includes(sourceItem.id)) {
                        targetIntervention.referencedIn.push(sourceItem.id);
                    }
                }
            });
        });
    }

    // ---- RENDERING ----
    function createScenarioCard(scenario) {
        const isFavorite = state.favorites.includes(scenario.id);
        const colors = colorMap[scenario.color] || colorMap.indigo;
        const tagsHtml = (scenario.tags || []).slice(0, 3).map(tag => 
            `<button class="tag-btn text-xs font-medium mr-1.5 mb-1.5 px-2.5 py-0.5 rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-tag="${tag}">${tag}</button>`
        ).join('');

        return `
        <div class="scenario-card draggable bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 flex flex-col border-l-4 ${colors.border}" draggable="true" data-id="${scenario.id}">
            <div class="p-4 flex-1 flex flex-col">
                <h3 class="font-bold text-gray-800 dark:text-gray-100 flex items-center">
                    <i data-lucide="grip-vertical" class="w-5 h-5 text-gray-400 mr-2 flex-shrink-0 edit-mode-item hidden cursor-grab"></i>
                    <span class="mr-2">${scenario.emoji || ''}</span>
                    <span class="flex-1">${scenario.title}</span>
                </h3>
                <div class="mt-3 text-xs text-gray-500 dark:text-gray-400 flex-1 flex flex-wrap items-start">
                    ${tagsHtml}
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <button class="view-btn text-sm font-semibold text-[var(--theme-color-600)] dark:text-[var(--theme-color-400)] hover:underline" data-id="${scenario.id}">View Details</button>
                    <div class="flex items-center">
                        <button class="edit-mode-item hidden edit-card-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${scenario.id}" title="Edit Content">
                            <i data-lucide="file-pen-line" class="w-5 h-5 text-gray-400"></i>
                        </button>
                        <button class="favorite-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${scenario.id}" title="Add to favorites">
                            <i data-lucide="star" class="w-5 h-5 ${isFavorite ? 'text-yellow-500 fill-current' : 'text-gray-400'}"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    function renderCardList(container, items, message, search_query = '') {
        container.style.opacity = '0';
        setTimeout(() => {
            let headerHtml = '';
            if(search_query){
                headerHtml = `<div class="col-span-full mb-4 flex items-center gap-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Showing ${items.length} results for "${search_query}"</h2>
                    <button id="clear-search-btn" class="text-sm font-semibold text-[var(--theme-color-600)] dark:text-[var(--theme-color-400)] hover:underline">Clear</button>
                </div>`;
            }
            
            container.innerHTML = headerHtml + '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>';
            const grid = container.querySelector('.grid');

            if (items.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-12">${message}</div>`;
            } else {
                grid.innerHTML = items.map(createScenarioCard).join('');
            }
            lucide.createIcons();
            container.style.opacity = '1';
            toggleEditMode(state.editMode);
        }, 300);
    }

    function renderDashboard() {
        dom.contentArea.style.opacity = '0';
        setTimeout(() => {
            const sessionPlannerHtml = renderSessionPlanner();
            const quickAccessHtml = renderQuickAccess();
            
            const zoneOrder = state.dashboardLayout.zones;
            const zoneEmojis = {'Red Zone': '🔴', 'Orange Zone': '🟠', 'Yellow Zone': '🟨', 'Green Zone': '💚'};

            let zonesHtml = zoneOrder.map(zone => {
                const cardOrder = state.dashboardLayout.cards[zone] || Array.from(state.contentMap.values()).filter(item => item.category === zone).map(item => item.id);
                const itemsInZone = cardOrder.map(id => state.contentMap.get(id)).filter(Boolean);
                
                const zoneColor = colorMap[zone.split(' ')[0].toLowerCase()] || colorMap.indigo;
                
                return `
                    <div class="zone-container draggable mb-10" draggable="true" data-zone="${zone}">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b-2" style="border-color: ${themes[state.theme][500]}">
                            <h2 class="text-2xl font-bold flex items-center" style="color: ${themes[state.theme][600]}">
                               <i data-lucide="grip-vertical" class="w-6 h-6 text-gray-400 mr-2 flex-shrink-0 edit-mode-item hidden cursor-grab"></i>
                               ${zoneEmojis[zone]} ${zone}
                            </h2>
                            <button class="add-card-btn edit-mode-item hidden p-1.5 bg-green-500 text-white rounded-full hover:bg-green-600" data-category="${zone}" title="Add New Card">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="card-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" data-zone="${zone}">
                            ${itemsInZone.map(createScenarioCard).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            dom.contentArea.innerHTML = sessionPlannerHtml + quickAccessHtml + `<div id="dashboard-zones">${zonesHtml}</div>`;
            lucide.createIcons();
            dom.contentArea.style.opacity = '1';
            attachPlannerEventListeners();
            attachDashboardDragDropListeners();
            toggleEditMode(state.editMode);
        }, 300);
    }

    function renderQuickAccess() {
        const quickAccessItems = state.quickAccessIds.map(id => state.contentMap.get(id)).filter(Boolean);
        let editControls = '';
        if (state.isEditingQuickAccess) {
            editControls = `<button id="done-quick-access-btn" class="text-sm font-semibold text-green-600 dark:text-green-400 hover:underline">Done</button>`;
        } else {
            editControls = `<button id="edit-quick-access-btn" class="text-sm font-semibold text-[var(--theme-color-600)] dark:text-[var(--theme-color-400)] hover:underline">Edit</button>`;
        }

        return `
            <div class="mb-10">
                <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-300 dark:border-gray-600">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i data-lucide="zap" class="w-6 h-6 text-gray-500"></i> Quick Access
                    </h2>
                    ${editControls}
                </div>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    ${quickAccessItems.map(item => `
                        <div class="relative">
                            <button class="view-btn p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all text-left flex flex-col justify-between h-full w-full border-l-4 ${colorMap[item.color]?.border || ''}" data-id="${item.id}">
                                <span class="font-semibold text-gray-800 dark:text-gray-200">${item.title}</span>
                                <span class="text-xs mt-2 ${colorMap[item.color]?.text || ''}">${item.category}</span>
                            </button>
                            ${state.isEditingQuickAccess ? `<button class="remove-quick-access-btn absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600" data-id="${item.id}"><i data-lucide="x" class="w-3 h-3"></i></button>` : ''}
                        </div>
                    `).join('')}
                    ${state.isEditingQuickAccess ? `
                        <button id="add-quick-access-card" class="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center border-2 border-dashed border-gray-400 dark:border-gray-600 text-gray-500 hover:text-[var(--theme-color-500)] hover:border-[var(--theme-color-500)]">
                            <i data-lucide="plus" class="w-8 h-8"></i>
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }

    function renderSessionPlanner() {
        const plansHtml = state.sessionPlans.map(plan => {
            const planItemsHtml = plan.items.map(itemId => {
                const item = state.contentMap.get(itemId);
                if (!item) return '';
                const colors = colorMap[item.color] || colorMap.indigo;
                return `
                    <div class="plan-item draggable flex items-center justify-between p-3 bg-white dark:bg-gray-700 rounded-md shadow-sm" draggable="true" data-item-id="${item.id}" data-plan-id="${plan.id}">
                        <div class="flex items-center flex-1 min-w-0">
                             <i data-lucide="grip-vertical" class="w-5 h-5 text-gray-400 mr-2 flex-shrink-0 cursor-grab"></i>
                             <span class="font-semibold truncate view-btn" data-id="${item.id}" data-context="plan" data-plan-id="${plan.id}">${item.title}</span>
                        </div>
                        <button class="remove-plan-item-btn p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-800" data-item-id="${item.id}" data-plan-id="${plan.id}">
                             <i data-lucide="x" class="w-4 h-4 text-red-500"></i>
                        </button>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">${plan.title}</h3>
                        <div class="flex items-center gap-2">
                            <button class="add-to-plan-btn p-1.5 bg-green-500 text-white rounded-full hover:bg-green-600" data-plan-id="${plan.id}" title="Add Item">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-plan-btn p-1.5 bg-red-500 text-white rounded-full hover:bg-red-600" data-plan-id="${plan.id}" title="Delete Plan">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="plan-items-container space-y-2" data-plan-id="${plan.id}">
                        ${planItemsHtml || '<p class="text-sm text-gray-500 dark:text-gray-400 p-2">This plan is empty. Click the plus icon to add items.</p>'}
                    </div>
                </div>
            `;
        }).join('');

        return `
            <div class="mb-10">
                <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-300 dark:border-gray-600">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-gray-500"></i> Session Plans
                    </h2>
                    <button id="add-new-plan-btn" class="text-sm font-semibold text-[var(--theme-color-600)] dark:text-[var(--theme-color-400)] hover:underline">New Plan</button>
                </div>
                <div id="session-plans-container" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    ${plansHtml}
                </div>
            </div>
        `;
    }
    
    function renderQuickAccessAddModal(searchTerm = '', forPlan = false) {
        dom.quickAccessModalTitle.textContent = forPlan ? 'Add to Session Plan' : 'Add to Quick Access';
        const currentListIds = forPlan ? state.sessionPlans.find(p => p.id === state.currentPlanForAdding)?.items || [] : state.quickAccessIds;

        const allItems = Array.from(state.contentMap.values()).sort((a, b) => a.title.localeCompare(b.title));
        const filteredItems = allItems.filter(item => 
            !currentListIds.includes(item.id) &&
            item.title.toLowerCase().includes(searchTerm.toLowerCase())
        );

        if (filteredItems.length === 0) {
            dom.quickAccessList.innerHTML = `<p class="text-center text-gray-500">No items found or all are added.</p>`;
            return;
        }

        dom.quickAccessList.innerHTML = filteredItems.map(item => {
            const colors = colorMap[item.color] || colorMap.indigo;
            return `
                <div class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800 dark:text-gray-100">${item.title}</p>
                        <p class="text-xs ${colors.text}">${item.category}</p>
                    </div>
                    <button class="add-item-btn p-2 bg-green-500 text-white rounded-full hover:bg-green-600" data-id="${item.id}">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
        }).join('');
        lucide.createIcons();
    }

    function openQuickAccessModal(forPlan = false) {
        renderQuickAccessAddModal('', forPlan);
        dom.quickAccessModal.classList.remove('modal-hidden');
        dom.quickAccessModal.classList.add('modal-visible');
        setTimeout(() => {
            dom.quickAccessModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
        }, 10);
    }

    function closeQuickAccessModal() {
        dom.quickAccessModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            dom.quickAccessModal.classList.add('modal-hidden');
            dom.quickAccessModal.classList.remove('modal-visible');
            state.currentPlanForAdding = null; // Reset context
        }, 300);
    }

    function renderCategorizedList(container, items, categoryTitle, message) {
        container.style.opacity = '0';
        setTimeout(() => {
            const grouped = items.reduce((acc, item) => {
                const group = item.subCategory || 'General';
                if (!acc[group]) {
                    acc[group] = [];
                }
                acc[group].push(item);
                return acc;
            }, {});

            let html = `
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-3xl font-bold">${categoryTitle}</h1>
                    <button class="add-card-btn edit-mode-item hidden p-2 bg-green-500 text-white rounded-full hover:bg-green-600" data-category="${categoryTitle}" title="Add New Card">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </div>`;
            
            if (Object.keys(grouped).length === 0) {
                html += `<div class="text-center text-gray-500 py-12">${message}</div>`;
            } else {
                const sortedGroupNames = Object.keys(grouped).sort();
                for (const groupName of sortedGroupNames) {
                    html += `
                        <div class="mb-10">
                            <h2 class="text-xl font-bold mb-4 pb-2 border-b-2 border-gray-300 dark:border-gray-600">${groupName}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                ${grouped[groupName].map(createScenarioCard).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            container.innerHTML = html;
            lucide.createIcons();
            container.style.opacity = '1';
            toggleEditMode(state.editMode);
        }, 300);
    }

    function renderUsedThisSession() {
        if (state.usedThisSession.length === 0) {
            dom.usedThisSessionContainer.innerHTML = '';
            return;
        }
        const itemsHtml = state.usedThisSession.map(id => {
            const item = state.contentMap.get(id);
            if (!item) return '';
            return `
                <button class="view-btn inline-flex items-center gap-x-1.5 py-1.5 px-3 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-800/30 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-700" data-id="${id}">
                    <span>${item.title}</span>
                    <button class="remove-used-btn group -mr-1.5" data-id="${id}">
                        <i data-lucide="x" class="w-3 h-3 text-blue-500 group-hover:text-blue-700 dark:group-hover:text-blue-200"></i>
                    </button>
                </button>
            `;
        }).join('');

        dom.usedThisSessionContainer.innerHTML = `
            <div class="p-4 rounded-lg bg-gray-100 dark:bg-gray-800">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400">Used This Session:</h3>
                    <button id="copy-used-log-btn" class="flex items-center text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="copy" class="w-3 h-3 mr-1"></i>Copy Log
                    </button>
                </div>
                <div class="flex flex-wrap gap-2">${itemsHtml}</div>
            </div>
        `;
        lucide.createIcons();
    }
    
    function renderFloatingScratchpad() {
        dom.floatingScratchpadBody.innerHTML = `
            <div class="flex items-center gap-2 mb-4">
                <button id="toggle-scratchpad-mode" class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                    ${state.scratchpadMode === 'write' ? 'Preview' : 'Edit'}
                </button>
                <button class="template-item text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600" data-template="sessionNotes">Note</button>
                <button class="template-item text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600" data-template="safetyPlan">Safety Plan</button>
                <button id="clear-scratchpad" class="ml-auto text-sm text-red-500 hover:underline">Clear</button>
            </div>
            <div id="scratchpad-write-area" class="${state.scratchpadMode === 'write' ? '' : 'hidden'}">
                <textarea id="scratchpad-textarea"
                    class="w-full p-4 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 rounded-lg scratchpad-resize text-sm font-mono focus:ring-2 focus:ring-teal-500 focus:outline-none"
                    rows="12"
                    placeholder="Type notes, scripts, or plans here... (Markdown supported)">${state.scratchpadContent || ''}</textarea>
                <div class="flex mt-3 gap-2">
                    <button id="copy-scratchpad" class="flex items-center text-xs px-3 py-1 bg-indigo-100 dark:bg-indigo-900 rounded-md text-indigo-700 dark:text-indigo-200 hover:bg-indigo-200 dark:hover:bg-indigo-800"><i data-lucide="copy" class="w-4 h-4 mr-1"></i>Copy</button>
                    <button id="download-scratchpad" class="flex items-center text-xs px-3 py-1 bg-green-100 dark:bg-green-900 rounded-md text-green-700 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800"><i data-lucide="download" class="w-4 h-4 mr-1"></i>Download</button>
                </div>
            </div>
            <div id="scratchpad-preview-area" class="prose dark:prose-invert max-w-none ${state.scratchpadMode === 'preview' ? '' : 'hidden'} p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg min-h-[12rem] bg-gray-50 dark:bg-gray-900/50">
                ${marked.parse(state.scratchpadContent || '_Nothing here yet. Type in Edit mode!_')}
            </div>
        `;
        lucide.createIcons();
        attachScratchpadEvents();
    }

    function openModal(scenarioId, searchQuery = '', context = null, planId = null) {
        const scenario = state.contentMap.get(scenarioId);
        if (!scenario) return;

        state.currentOpenScenario = { ...scenario, context, planId };
        
        const categoryColor = colorMap[scenario.color] || colorMap.indigo;
        const contextTags = (scenario.tags || []).map(tag => `<button class="tag-btn text-xs font-medium px-2 py-0.5 rounded-full bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-tag="${tag}">${tag}</button>`).join('');
        dom.modalContext.innerHTML = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${categoryColor.bg} ${categoryColor.text}">${scenario.category}</span>` + contextTags;

        dom.modalTitle.innerHTML = `<span class="mr-3">${scenario.emoji || ''}</span> ${scenario.title}`;
        
        let processedContent = scenario.content;
        state.interventionMap.forEach((id, title) => {
            const regex = new RegExp(`\\*\\*(${title})\\*\\*`, 'g');
            processedContent = processedContent.replace(regex, `<button class="insight-link" data-id="${id}">$1</button>`);
        });

        if (scenario.referencedIn?.length > 0) {
            const referencesHtml = scenario.referencedIn.map(id => {
                const refScenario = state.contentMap.get(id);
                if (!refScenario) return '';
                return `<li><button class="insight-link" data-id="${id}">${refScenario.title}</button></li>`;
            }).join('');
            processedContent += `\n\n### Commonly Used For / Related To:\n<ul>${referencesHtml}</ul>`;
        }
        
        const annotation = state.annotations[scenario.id];
        if (annotation) {
            processedContent += `\n\n<div class="p-4 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg not-prose"><h4 class="text-sm font-bold text-yellow-800 dark:text-yellow-200 !mt-0">My Note:</h4><div class="prose prose-sm dark:prose-invert max-w-none">${marked.parse(annotation)}</div></div>`;
        }

        dom.modalBody.innerHTML = marked.parse(processedContent);
        
        if (searchQuery) {
            highlightText(dom.modalBody, searchQuery);
        }
        
        makeChecklistsInteractive(dom.modalBody);
        makeSectionsCollapsible(dom.modalBody);
        
        dom.scenarioModal.classList.remove('modal-hidden');
        dom.scenarioModal.classList.add('modal-visible');
        setTimeout(() => {
            dom.modalContentWrapper.classList.remove('opacity-0', 'scale-95');
        }, 10);

        if (!state.usedThisSession.includes(scenarioId)) {
            state.usedThisSession.push(scenarioId);
            renderUsedThisSession();
        }
        if (!state.recentlyViewed.includes(scenarioId)) {
            state.recentlyViewed = [scenarioId, ...state.recentlyViewed.filter(id => id !== scenarioId)].slice(0, 20);
            saveState();
        }
        
        updateModalNav();
        lucide.createIcons();
        toggleEditMode(state.editMode);
    }
    
    function makeChecklistsInteractive(container) {
        const lists = container.querySelectorAll('ol');
        lists.forEach(list => {
            list.classList.add('interactive-checklist');
            const items = list.querySelectorAll('li');
            items.forEach((item, index) => {
                const originalText = item.innerHTML;
                const checkboxId = `checklist-${state.currentOpenScenario.id}-${index}`;
                item.innerHTML = `
                    <label for="${checkboxId}">
                        <input type="checkbox" id="${checkboxId}">
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-text">${originalText}</span>
                    </label>
                `;
            });
        });
    }

    function makeSectionsCollapsible(container) {
        const headers = container.querySelectorAll('h3');
        headers.forEach(header => {
            header.classList.add('collapsible-header');
            header.innerHTML += `<i data-lucide="chevron-down" class="w-5 h-5"></i>`;

            let content = [];
            let nextElem = header.nextElementSibling;
            while (nextElem && nextElem.tagName !== 'H3') {
                content.push(nextElem);
                nextElem = nextElem.nextElementSibling;
            }

            const contentWrapper = document.createElement('div');
            contentWrapper.classList.add('collapsible-content');
            content.forEach(el => contentWrapper.appendChild(el));
            header.parentNode.insertBefore(contentWrapper, header.nextElementSibling);

            header.addEventListener('click', () => {
                header.classList.toggle('collapsed');
                contentWrapper.classList.toggle('collapsed');
            });
        });
    }
    
    function highlightText(container, text) {
        const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
        let node;
        const regex = new RegExp(`(${text})`, 'gi');
        while (node = walker.nextNode()) {
            if (node.parentElement.tagName !== 'MARK') {
                const newHtml = node.textContent.replace(regex, `<mark>$1</mark>`);
                if (newHtml !== node.textContent) {
                    const newNode = document.createElement('span');
                    newNode.innerHTML = newHtml;
                    node.parentNode.replaceChild(newNode, node);
                }
            }
        }
    }

    function closeModal() {
        if (dom.scenarioModal.classList.contains('modal-hidden')) {
            return;
        }
        dom.modalContentWrapper.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            dom.scenarioModal.classList.add('modal-hidden');
            dom.scenarioModal.classList.remove('modal-visible');
        }, 300);
    }
    
    function updateModalNav() {
        const currentList = getCurrentList();
        const currentIndex = currentList.findIndex(item => item.id === state.currentOpenScenario.id);
        
        dom.modalPrev.disabled = currentIndex <= 0;
        dom.modalNext.disabled = currentIndex >= currentList.length - 1;

        dom.modalPrev.onclick = () => {
            if (currentIndex > 0) openModal(currentList[currentIndex - 1].id, dom.searchBox.value, state.currentOpenScenario.context, state.currentOpenScenario.planId);
        };
        dom.modalNext.onclick = () => {
            if (currentIndex < currentList.length - 1) openModal(currentList[currentIndex + 1].id, dom.searchBox.value, state.currentOpenScenario.context, state.currentOpenScenario.planId);
        };
    }

    // ---- TIMER LOGIC ----
    function toggleTimer() {
        state.timer.isPaused = !state.timer.isPaused;
        if (state.timer.isPaused) {
            clearInterval(state.timer.intervalId);
            state.timer.intervalId = null;
            dom.timerToggleBtn.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i>`;
        } else {
            if (!state.timer.intervalId) {
                state.timer.intervalId = setInterval(updateTimer, 1000);
            }
            dom.timerToggleBtn.innerHTML = `<i data-lucide="pause" class="w-4 h-4"></i>`;
        }
        lucide.createIcons();
    }

    function resetTimer() {
        clearInterval(state.timer.intervalId);
        state.timer.intervalId = null;
        state.timer.elapsedSeconds = 0;
        state.timer.isPaused = true;
        dom.sessionTimer.textContent = '00:00';
        dom.timerToggleBtn.innerHTML = `<i data-lucide="play" class="w-4 h-4"></i>`;
        lucide.createIcons();
        
        dom.sessionTimerContainer.classList.remove('bg-yellow-100', 'dark:bg-yellow-900', 'bg-red-100', 'dark:bg-red-900');
        dom.sessionTimerContainer.classList.add('bg-green-100', 'dark:bg-green-900');
    }

    function updateTimer() {
        if (state.timer.isPaused) return;
        state.timer.elapsedSeconds++;
        const minutes = Math.floor(state.timer.elapsedSeconds / 60);
        const seconds = state.timer.elapsedSeconds % 60;
        dom.sessionTimer.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        dom.sessionTimerContainer.classList.remove('bg-green-100', 'dark:bg-green-900', 'bg-yellow-100', 'dark:bg-yellow-900', 'bg-red-100', 'dark:bg-red-900');
        if (minutes < 10) {
            dom.sessionTimerContainer.classList.add('bg-green-100', 'dark:bg-green-900');
        } else if (minutes < 15) {
            dom.sessionTimerContainer.classList.add('bg-yellow-100', 'dark:bg-yellow-900');
        } else {
            dom.sessionTimerContainer.classList.add('bg-red-100', 'dark:bg-red-900');
        }
    }

    // ---- EVENT HANDLERS & LOGIC ----
    function handleContentInteraction(e) {
        const viewBtn = e.target.closest('.view-btn');
        if (viewBtn) {
            if (e.target.closest('.remove-used-btn') || e.target.closest('.remove-quick-access-btn')) return;
            const context = viewBtn.dataset.context || null;
            const planId = viewBtn.dataset.planId || null;
            openModal(viewBtn.dataset.id, dom.searchBox.value, context, planId);
            return;
        }

        const favoriteBtn = e.target.closest('.favorite-btn');
        if (favoriteBtn) {
            const id = favoriteBtn.dataset.id;
            const isFavorite = state.favorites.includes(id);
            if (isFavorite) {
                state.favorites = state.favorites.filter(favId => favId !== id);
                showToast('Removed from favorites', 'info');
            } else {
                state.favorites.push(id);
                showToast('Added to favorites!', 'success');
            }
            saveState();
            if (state.currentView === 'favorites' || dom.searchBox.value) {
                switchView(state.currentView);
            } else {
                const icon = favoriteBtn.querySelector('i');
                icon.classList.toggle('text-yellow-500', !isFavorite);
                icon.classList.toggle('fill-current', !isFavorite);
                icon.classList.toggle('text-gray-400', isFavorite);
            }
            return;
        }
        
        const removeUsedBtn = e.target.closest('.remove-used-btn');
        if(removeUsedBtn) {
            e.stopPropagation();
            const id = removeUsedBtn.dataset.id;
            state.usedThisSession = state.usedThisSession.filter(usedId => usedId !== id);
            renderUsedThisSession();
            return;
        }

        const tagBtn = e.target.closest('.tag-btn');
        if (tagBtn) {
            const tag = tagBtn.dataset.tag;
            closeModal();
            dom.searchBox.value = tag;
            dom.searchBox.dispatchEvent(new Event('input'));
            return;
        }

        const insightLink = e.target.closest('.insight-link');
        if(insightLink) {
            const id = insightLink.dataset.id;
            dom.modalContentWrapper.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                openModal(id);
            }, 150);
            return;
        }
        
        if (e.target.closest('#clear-search-btn')) {
            dom.searchBox.value = '';
            switchView(state.currentView);
            return;
        }
        
        if (e.target.closest('#copy-used-log-btn')) {
            copyUsedLogToScratchpad();
            return;
        }

        // Quick Access Edit Logic
        if (e.target.closest('#edit-quick-access-btn')) {
            state.isEditingQuickAccess = true;
            renderDashboard();
            return;
        }
        if (e.target.closest('#done-quick-access-btn')) {
            state.isEditingQuickAccess = false;
            saveState();
            renderDashboard();
            return;
        }
        if (e.target.closest('.remove-quick-access-btn')) {
            const id = e.target.closest('.remove-quick-access-btn').dataset.id;
            state.quickAccessIds = state.quickAccessIds.filter(qaId => qaId !== id);
            renderDashboard();
            return;
        }
        if (e.target.closest('#add-quick-access-card')) {
            openQuickAccessModal(false);
            return;
        }
        if (e.target.closest('.add-item-btn')) {
            const id = e.target.closest('.add-item-btn').dataset.id;
            if (state.currentPlanForAdding) {
                const plan = state.sessionPlans.find(p => p.id === state.currentPlanForAdding);
                if (plan) {
                    plan.items.push(id);
                    saveState();
                    renderQuickAccessAddModal(dom.quickAccessSearch.value, true);
                    renderDashboard();
                }
            } else {
                 state.quickAccessIds.push(id);
                 saveState();
                 renderQuickAccessAddModal(dom.quickAccessSearch.value, false);
                 renderDashboard();
            }
            return;
        }

        const editCardBtn = e.target.closest('.edit-card-btn');
        if (editCardBtn) {
            const id = editCardBtn.dataset.id;
            openEditModal(id);
            return;
        }

        const addCardBtn = e.target.closest('.add-card-btn');
        if(addCardBtn) {
            const category = addCardBtn.dataset.category;
            openEditModal(null, category);
        }
    }

    function attachScratchpadEvents() {
        const scratchpadBody = dom.floatingScratchpadModal.querySelector('#floating-scratchpad-body');
        if (!scratchpadBody) return;

        scratchpadBody.querySelector('#toggle-scratchpad-mode')?.addEventListener('click', () => {
            state.scratchpadMode = (state.scratchpadMode === 'write') ? 'preview' : 'write';
            renderFloatingScratchpad();
        });
        scratchpadBody.querySelector('#clear-scratchpad')?.addEventListener('click', () => {
            showConfirmationModal('Clear all notes in your scratchpad?', 'This action cannot be undone.', () => {
                state.scratchpadContent = '';
                saveState();
                renderFloatingScratchpad();
                showToast('Scratchpad cleared.', 'success');
            });
        });
        const textarea = scratchpadBody.querySelector('#scratchpad-textarea');
        const previewArea = scratchpadBody.querySelector('#scratchpad-preview-area');
        textarea?.addEventListener('input', (e) => {
            state.scratchpadContent = e.target.value;
            saveState();
            if(previewArea) {
               previewArea.innerHTML = marked.parse(state.scratchpadContent || '_Nothing here yet._');
            }
        });
        scratchpadBody.querySelector('#copy-scratchpad')?.addEventListener('click', () => copyToClipboard(state.scratchpadContent));
        scratchpadBody.querySelector('#download-scratchpad')?.addEventListener('click', downloadScratchpad);
        
        scratchpadBody.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const templateKey = e.target.dataset.template;
                let templateContent = scratchpadTemplates[templateKey];
                
                if (typeof templateContent === 'function') {
                    templateContent = templateContent();
                }

                if (templateContent) {
                    const currentText = textarea.value;
                    textarea.value = (currentText ? currentText + '\n\n---\n\n' : '') + templateContent;
                    textarea.dispatchEvent(new Event('input'));
                    textarea.scrollTop = textarea.scrollHeight;
                }
            });
        });
    }
    
    // ---- UTILITIES ----
    function showToast(message, type = 'info') {
        const colors = {
            success: 'bg-green-500',
            info: 'bg-gray-600 dark:bg-gray-700',
            error: 'bg-red-500'
        };
        dom.toast.textContent = message;
        dom.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-[100] transition-all duration-300 ${colors[type]}`;
        dom.toast.classList.remove('hidden');
        dom.toast.classList.add('opacity-100');
        setTimeout(() => { dom.toast.classList.remove('opacity-100'); }, 2700);
        setTimeout(() => { dom.toast.classList.add('hidden'); }, 3000);
    }

    function copyToClipboard(text) {
        if (!text) return;
        const plainText = text.replace(/###\s/g, '').replace(/##\s/g, '').replace(/#\s/g, '').replace(/\*\*/g, '').replace(/\*/g, '').replace(/>\s/g, '');
        const textArea = document.createElement('textarea');
        textArea.value = plainText;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast("Copied to clipboard!", 'success');
        } catch (err) {
            showToast("Failed to copy.", 'error');
        }
        document.body.removeChild(textArea);
    }
    
    function copyUsedLogToScratchpad() {
        if (state.usedThisSession.length === 0) {
            showToast("Session log is empty.", "info");
            return;
        }
        const logTitle = `### Log from Session (${new Date().toLocaleDateString()})\n\n`;
        const logItems = state.usedThisSession
            .map(id => state.contentMap.get(id)?.title)
            .filter(Boolean)
            .map(title => `- Used: ${title}`)
            .join('\n');
        
        const fullLog = logTitle + logItems;
        state.scratchpadContent += (state.scratchpadContent ? '\n\n---\n\n' : '') + fullLog;
        saveState();
        showToast("Session log copied to scratchpad!", 'success');

        if (!dom.floatingScratchpadModal.classList.contains('modal-hidden')) {
            renderFloatingScratchpad();
        }
    }

    function downloadScratchpad() {
        const blob = new Blob([state.scratchpadContent], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'scratchpad.md';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        dom.confirmationTitle.textContent = title;
        dom.confirmationMessage.textContent = message;
        dom.confirmationModal.classList.remove('modal-hidden');
        dom.confirmationModal.classList.add('modal-visible');
         setTimeout(() => {
            dom.confirmationModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
        }, 10);
        
        const confirmHandler = () => {
            onConfirm();
            hideConfirmationModal();
        };
        const cancelHandler = () => hideConfirmationModal();

        const hideConfirmationModal = () => {
            dom.confirmationModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dom.confirmationModal.classList.add('modal-hidden');
                dom.confirmationModal.classList.remove('modal-visible');
                dom.confirmationConfirm.removeEventListener('click', confirmHandler);
                dom.confirmationCancel.removeEventListener('click', cancelHandler);
            }, 300);
        };
        
        dom.confirmationConfirm.addEventListener('click', confirmHandler);
        dom.confirmationCancel.addEventListener('click', cancelHandler);
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    const debouncedSearch = debounce((e) => {
        const q = e.target.value.toLowerCase().trim();
        if (state.currentView === 'scratchpad') return;

        if (!q) {
            switchView(state.currentView);
            return;
        }
        
        const filtered = Array.from(state.contentMap.values()).filter(item =>
            item.title.toLowerCase().includes(q) ||
            (item.content && item.content.toLowerCase().includes(q)) ||
            (item.tags && item.tags.some(tag => tag.toLowerCase().includes(q)))
        );
        renderCardList(dom.contentArea, filtered, 'No matches found for your search.', q);
    }, 300);
    
    // ---- TABS & VIEWS ----
    function getCurrentList() {
        const q = dom.searchBox.value.toLowerCase().trim();
        if (q) {
            return Array.from(state.contentMap.values()).filter(item =>
                item.title.toLowerCase().includes(q) ||
                (item.content && item.content.toLowerCase().includes(q)) ||
                (item.tags && item.tags.some(tag => tag.toLowerCase().includes(q)))
            );
        }

        if (state.currentOpenScenario?.context === 'plan') {
            const plan = state.sessionPlans.find(p => p.id === state.currentOpenScenario.planId);
            return plan ? plan.items.map(id => state.contentMap.get(id)).filter(Boolean) : [];
        }

        switch (state.currentView) {
            case 'favorites': return state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
            case 'recents': return state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
            case 'interventions': return interventionsData;
            case 'scripts': return scriptsData;
            case 'psychoeducation': return psychoeducationData;
            case 'dashboard': return clinicalData;
            default: return Array.from(state.contentMap.values());
        }
    }

    function switchView(viewId) {
        state.currentView = viewId;
        // Update sidebar link styles
        document.querySelectorAll('.sidebar-link').forEach(link => {
            const isSelected = link.dataset.tab === viewId;
            link.classList.toggle('bg-[var(--theme-color-100)]', isSelected);
            link.classList.toggle('dark:bg-[var(--theme-color-900)]', isSelected);
            link.classList.toggle('text-[var(--theme-color-700)]', isSelected);
            link.classList.toggle('dark:text-[var(--theme-color-200)]', isSelected);
            link.classList.toggle('font-semibold', isSelected);
        });
        dom.scratchpadToggleBtn.classList.remove('bg-[var(--theme-color-100)]', 'dark:bg-[var(--theme-color-900)]', 'text-[var(--theme-color-700)]', 'dark:text-[var(--theme-color-200)]', 'font-semibold');
        
        if (dom.searchBox.value) {
            dom.searchBox.value = '';
        }

        if (viewId === 'dashboard') {
            renderDashboard();
        } else if (viewId === 'interventions') {
            renderCategorizedList(dom.contentArea, interventionsData, 'Interventions', 'No interventions found.');
        } else if (viewId === 'psychoeducation') {
            renderCardList(dom.contentArea, psychoeducationData, 'No psychoeducation topics found.');
        } else {
            let items = [];
            let message = 'No items found.';
            if (viewId === 'favorites') {
                items = state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
                message = 'No favorites yet. Click the star on a card to add one.';
            } else if (viewId === 'recents') {
                items = state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
                message = 'No recently viewed items.';
            } else if (viewId === 'scripts') {
                items = scriptsData;
                message = 'No scripts found.';
            }
            renderCardList(dom.contentArea, items, message);
        }
    }

    // ---- THEME ----
    function applyTheme(themeName) {
        state.theme = themeName;
        const theme = themes[themeName] || themes.indigo; // Fallback to indigo
        const root = document.documentElement;
        Object.keys(theme).forEach(key => {
            root.style.setProperty(`--theme-color-${key}`, theme[key]);
        });
        
        // Update sidebar link styles for the new theme
        switchView(state.currentView);
        saveState();
    }

    function applyDarkMode(isDark) {
        localStorage.setItem('darkMode', isDark ? 'true' : 'false');
        document.documentElement.classList.toggle('dark', isDark);
        dom.themeToggle.innerHTML = isDark ? '<i data-lucide="sun" class="w-5 h-5"></i>' : '<i data-lucide="moon" class="w-5 h-5"></i>';
        lucide.createIcons();
    }

    // ---- DRAGGABLE MODAL ----
    function makeDraggable(element, handle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // ---- SESSION PLANNER LOGIC ----
    function attachPlannerEventListeners() {
        document.getElementById('add-new-plan-btn')?.addEventListener('click', () => {
            const title = prompt("Enter a title for your new session plan:");
            if (title) {
                const newPlan = {
                    id: `plan-${Date.now()}`,
                    title: title,
                    items: []
                };
                state.sessionPlans.push(newPlan);
                saveState();
                renderDashboard();
            }
        });

        document.querySelectorAll('.delete-plan-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const planId = e.currentTarget.dataset.planId;
                showConfirmationModal('Delete this plan?', 'This action cannot be undone.', () => {
                    state.sessionPlans = state.sessionPlans.filter(p => p.id !== planId);
                    saveState();
                    renderDashboard();
                    showToast('Plan deleted.', 'success');
                });
            });
        });
        
        document.querySelectorAll('.add-to-plan-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                state.currentPlanForAdding = e.currentTarget.dataset.planId;
                openQuickAccessModal(true);
            });
        });

        document.querySelectorAll('.remove-plan-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const { planId, itemId } = e.currentTarget.dataset;
                const plan = state.sessionPlans.find(p => p.id === planId);
                if (plan) {
                    plan.items = plan.items.filter(id => id !== itemId);
                    saveState();
                    renderDashboard();
                }
            });
        });

        // Drag and Drop
        const containers = document.querySelectorAll('.plan-items-container');
        containers.forEach(container => {
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            });
        });

        const draggables = document.querySelectorAll('.plan-item');
        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => {
                draggable.classList.add('dragging');
            });

            draggable.addEventListener('dragend', () => {
                draggable.classList.remove('dragging');
                updatePlanOrder();
            });
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updatePlanOrder() {
        const newPlansState = [];
        document.querySelectorAll('.plan-items-container').forEach(container => {
            const planId = container.dataset.planId;
            const originalPlan = state.sessionPlans.find(p => p.id === planId);
            const newItemIds = [];
            container.querySelectorAll('.plan-item').forEach(itemEl => {
                newItemIds.push(itemEl.dataset.itemId);
            });
            newPlansState.push({
                id: planId,
                title: originalPlan.title,
                items: newItemIds
            });
        });
        state.sessionPlans = newPlansState;
        saveState();
    }

    function attachDashboardDragDropListeners() {
        if (!state.editMode) return;

        const zoneContainer = document.getElementById('dashboard-zones');
        const zones = zoneContainer.querySelectorAll('.zone-container');
        
        zones.forEach(zone => {
            zone.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('zone-container')) {
                    e.target.classList.add('dragging');
                }
            });
            zone.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('zone-container')) {
                    e.target.classList.remove('dragging');
                    updateZoneOrder();
                }
            });
        });

        zoneContainer.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(zoneContainer, e.clientY);
            const draggable = document.querySelector('.zone-container.dragging');
            if (draggable) {
                if (afterElement == null) {
                    zoneContainer.appendChild(draggable);
                } else {
                    zoneContainer.insertBefore(draggable, afterElement);
                }
            }
        });
        
        const cardGrids = document.querySelectorAll('.card-grid');
        cardGrids.forEach(grid => {
            grid.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(grid, e.clientY);
                const draggable = document.querySelector('.scenario-card.dragging');
                if (draggable) {
                    if (afterElement == null) {
                        grid.appendChild(draggable);
                    } else {
                        grid.insertBefore(draggable, afterElement);
                    }
                }
            });
        });

        document.querySelectorAll('.scenario-card').forEach(card => {
            card.addEventListener('dragstart', (e) => {
                if(state.editMode) {
                    e.target.classList.add('dragging');
                } else {
                    e.preventDefault();
                }
            });
            card.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
                updateCardOrder();
            });
        });
    }

    function updateZoneOrder() {
        const newZoneOrder = [];
        document.querySelectorAll('#dashboard-zones .zone-container').forEach(zoneEl => {
            newZoneOrder.push(zoneEl.dataset.zone);
        });
        state.dashboardLayout.zones = newZoneOrder;
        saveState();
    }

    function updateCardOrder() {
        document.querySelectorAll('.card-grid').forEach(grid => {
            const zone = grid.dataset.zone;
            const newCardOrder = [];
            grid.querySelectorAll('.scenario-card').forEach(cardEl => {
                newCardOrder.push(cardEl.dataset.id);
            });
            state.dashboardLayout.cards[zone] = newCardOrder;
        });
        saveState();
    }


    // ---- EDIT MODE LOGIC ----
    function toggleEditMode(isOn) {
        state.editMode = isOn;
        document.body.classList.toggle('edit-mode-active', isOn);
        document.querySelectorAll('.edit-mode-item').forEach(el => {
            el.classList.toggle('hidden', !isOn);
        });
        document.querySelectorAll('.draggable').forEach(el => {
            el.setAttribute('draggable', isOn);
        });
    }

    function openEditModal(itemId, category = null) {
        const isCreating = !itemId;
        const item = isCreating ? {} : state.contentMap.get(itemId);
        if (!item) return;

        dom.editContentModal.dataset.editingId = itemId;
        dom.editModalTitle.textContent = isCreating ? `Create New Card` : `Editing: ${item.title}`;
        dom.editTitleInput.value = item.title || '';
        dom.editEmojiInput.value = item.emoji || '';
        dom.editTagsInput.value = (item.tags || []).join(', ');
        dom.editContentTextarea.value = item.content || '';
        dom.editContentModal.dataset.category = isCreating ? category : '';
        dom.editRevertBtn.style.display = isCreating ? 'none' : 'block';
        
        dom.editContentModal.classList.remove('modal-hidden');
        dom.editContentModal.classList.add('modal-visible');
        setTimeout(() => {
            dom.editContentModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
        }, 10);
    }

    function closeEditModal() {
        dom.editContentModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            dom.editContentModal.classList.add('modal-hidden');
            dom.editContentModal.classList.remove('modal-visible');
            dom.editContentModal.dataset.editingId = '';
            dom.editContentModal.dataset.category = '';
        }, 300);
    }

    function saveEditedContent() {
        const itemId = dom.editContentModal.dataset.editingId;
        const isCreating = !itemId;
        const newId = isCreating ? `custom-${Date.now()}` : itemId;

        const newContent = {
            id: newId,
            title: dom.editTitleInput.value,
            emoji: dom.editEmojiInput.value,
            tags: dom.editTagsInput.value.split(',').map(tag => tag.trim()).filter(Boolean),
            content: dom.editContentTextarea.value,
            category: isCreating ? dom.editContentModal.dataset.category : state.contentMap.get(itemId).category,
            color: isCreating ? 'purple' : state.contentMap.get(itemId).color, // Default color for custom cards
            isCustom: true
        };

        state.customContent[newId] = newContent;
        saveState();
        initializeDataMap(); 
        switchView(state.currentView); 
        closeEditModal();
        showToast(isCreating ? 'Card created!' : 'Content updated!', 'success');
    }

    function revertContentToDefault() {
        const itemId = dom.editContentModal.dataset.editingId;
        if (!itemId) return;

        showConfirmationModal('Revert to Default?', 'This will discard all your custom changes for this item. This cannot be undone.', () => {
            delete state.customContent[itemId];
            saveState();
            initializeDataMap();
            switchView(state.currentView);
            closeEditModal();
            showToast('Content reverted to default.', 'info');
        });
    }


    // ---- MAIN INITIALIZATION ----
    function main() {
        loadState();
        initializeDataMap();
        
        // Initial theme setup
        applyTheme(state.theme);
        dom.themeSelector.value = state.theme;

        const savedDarkMode = localStorage.getItem('darkMode');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyDarkMode(savedDarkMode === 'true' || (savedDarkMode === null && prefersDark));

        // Event listeners
        document.querySelectorAll('.sidebar-link').forEach(link => {
            if (link.id !== 'scratchpad-toggle-btn') {
                link.addEventListener('click', () => switchView(link.dataset.tab));
            }
        });
        document.body.addEventListener('click', handleContentInteraction);
        
        dom.searchBox?.addEventListener('input', debouncedSearch);
        dom.timerToggleBtn?.addEventListener('click', toggleTimer);
        dom.timerResetBtn?.addEventListener('click', resetTimer);
        
        dom.closeModal.addEventListener('click', closeModal);
        dom.closeQuickAccessModal.addEventListener('click', closeQuickAccessModal);
        dom.quickAccessSearch.addEventListener('input', (e) => {
             renderQuickAccessAddModal(e.target.value, state.currentPlanForAdding !== null)
        });
        
        // Click-out listeners
        dom.scenarioModal.addEventListener('click', (e) => { if (e.target === dom.scenarioModal) closeModal(); });
        dom.quickAccessModal.addEventListener('click', (e) => { if (e.target === dom.quickAccessModal) closeQuickAccessModal(); });
        dom.annotationModal.addEventListener('click', (e) => { if (e.target === dom.annotationModal) dom.annotationCancel.click(); });
        dom.confirmationModal.addEventListener('click', (e) => { if (e.target === dom.confirmationModal) dom.confirmationCancel.click(); });
        dom.editContentModal.addEventListener('click', (e) => { if (e.target === dom.editContentModal) closeEditModal(); });

        dom.addAnnotationBtn.addEventListener('click', () => {
            if (state.currentOpenScenario) {
                dom.annotationModalTitle.textContent = `Note for: ${state.currentOpenScenario.title}`;
                dom.annotationTextarea.value = state.annotations[state.currentOpenScenario.id] || '';
                dom.annotationModal.classList.remove('modal-hidden');
                dom.annotationModal.classList.add('modal-visible');
                setTimeout(() => {
                    dom.annotationModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                }, 10);
            }
        });

        dom.annotationCancel.addEventListener('click', () => {
            dom.annotationModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dom.annotationModal.classList.add('modal-hidden');
                dom.annotationModal.classList.remove('modal-visible');
            }, 300);
        });

        dom.annotationSave.addEventListener('click', () => {
            const note = dom.annotationTextarea.value;
            const id = state.currentOpenScenario.id;
            if (note.trim()) {
                state.annotations[id] = note;
            } else {
                delete state.annotations[id];
            }
            saveState();
            showToast("Note saved!", "success");
            dom.annotationCancel.click(); // Close modal
            openModal(id, dom.searchBox.value); // Re-open main modal to show updated note
        });


        dom.themeToggle?.addEventListener('click', () => {
            const isCurrentlyDark = document.documentElement.classList.contains('dark');
            applyDarkMode(!isCurrentlyDark);
        });
        dom.themeSelector.addEventListener('change', (e) => applyTheme(e.target.value));

        dom.copyModalContentBtn.addEventListener('click', () => {
            if (state.currentOpenScenario) {
                const contentToCopy = `### ${state.currentOpenScenario.title}\n\n${state.currentOpenScenario.content}`;
                state.scratchpadContent += (state.scratchpadContent ? '\n\n---\n\n' : '') + contentToCopy;
                saveState();
                showToast('Copied to scratchpad!', 'success');
                if (!dom.floatingScratchpadModal.classList.contains('modal-hidden')) {
                    renderFloatingScratchpad();
                }
            }
        });
        
        // Floating Scratchpad Logic
        dom.scratchpadToggleBtn.addEventListener('click', () => {
            const modal = dom.floatingScratchpadModal;
            const isHidden = modal.classList.contains('modal-hidden');
            if (isHidden) {
                renderFloatingScratchpad();
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
                setTimeout(() => {
                    modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                }, 10);
            } else {
                modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modal.classList.add('modal-hidden');
                    modal.classList.remove('modal-visible');
                }, 300);
            }
        });
        dom.closeScratchpadBtn.addEventListener('click', () => dom.scratchpadToggleBtn.click());
        makeDraggable(dom.floatingScratchpadModal, dom.floatingScratchpadModal.querySelector('.drag-handle'));

        // Edit Mode Logic
        dom.editModeToggle.addEventListener('change', (e) => toggleEditMode(e.target.checked));
        dom.editContentBtn.addEventListener('click', () => {
            if(state.currentOpenScenario) openEditModal(state.currentOpenScenario.id);
        });
        dom.editSaveBtn.addEventListener('click', saveEditedContent);
        dom.editCancelBtn.addEventListener('click', closeEditModal);
        dom.editRevertBtn.addEventListener('click', revertContentToDefault);

        // Initial view
        switchView(state.currentView || 'dashboard');
        renderUsedThisSession();
        lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
