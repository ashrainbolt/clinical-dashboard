<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicalX: Interactive Dashboard v4.4 (Full Functionality)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .modal-content, .toast-notification { animation: slide-up 0.3s ease-out; }
        @keyframes slide-up { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .scenario-card { transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s; }
        .scenario-card:hover { transform: translateY(-5px); }
        .modal-body::-webkit-scrollbar, #notes-view::-webkit-scrollbar { width: 8px; }
        
        body { background-color: #f3f4f6; color: #1f2937; }
        .scenario-card, .modal-content, #timer-section, #notes-view, .content-section { background-color: white; border: 1px solid #e5e7eb; }
        .scenario-card:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .tab-button-container { background-color: #e5e7eb; }
        .tab-button.active { background-color: white; color: #4f46e5; }
        .tab-button { color: #4b5563; }
        .sticky-header { background-color: rgba(243, 244, 246, 0.8); backdrop-filter: blur(8px); }
        input, textarea { background-color: #f9fafb; border-color: #d1d5db; color: #111827; }
        input::placeholder, textarea::placeholder { color: #6b7280; }
        .modal-body::-webkit-scrollbar-track, #notes-view::-webkit-scrollbar-track { background: #e5e7eb; }
        .modal-body::-webkit-scrollbar-thumb, #notes-view::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #e5e7eb; }
        .modal-header, .modal-footer { border-color: #e5e7eb; }

        .dark body { background-color: #111827; color: #d1d5db; }
        .dark .scenario-card, .dark .modal-content, .dark #timer-section, .dark #notes-view, .dark .content-section { background-color: #1f2937; border: 1px solid #374151; }
        .dark .scenario-card:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2), 0 2px 4px -1px rgba(0,0,0,0.15); }
        .dark .tab-button-container { background-color: #374151; }
        .dark .tab-button.active { background-color: #4f46e5; color: white; }
        .dark .tab-button { color: #d1d5db; }
        .dark .sticky-header { background-color: rgba(17, 24, 39, 0.8); }
        .dark input, .dark textarea { background-color: #374151; border-color: #4b5563; color: #f9fafb; }
        .dark input::placeholder, .dark textarea::placeholder { color: #9ca3af; }
        .dark .modal-body::-webkit-scrollbar-track, .dark #notes-view::-webkit-scrollbar-track { background: #2d3748; }
        .dark .modal-body::-webkit-scrollbar-thumb, .dark #notes-view::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px; border: 2px solid #2d3748; }
        .dark .modal-header, .dark .modal-footer { border-color: #374151; }
        
        #modalBody h3, #notes-view h3, .content-section h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .dark #modalBody h3, .dark #notes-view h3, .dark .content-section h3 { color: #9ca3af; }
        #modalBody h4, #notes-view h4, .content-section h4 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .dark #modalBody h4, .dark #notes-view h4, .dark .content-section h4 { color: #8b94a3; }
        #modalBody p, #modalBody li, #notes-view p, .content-section p { margin-bottom: 0.75rem; line-height: 1.6; }
        #modalBody ol, #modalBody ul, .content-section ul { padding-left: 1.5rem; }
        .favorite-star.favorited i { fill: #facc15; color: #facc15; }
        .intervention-link { color: #60a5fa; text-decoration: underline; cursor: pointer; }

        .author-control { display: none !important; }
        .author-mode-active .author-control { display: flex !important; }
        #author-mode-toggle.active svg { color: #4f46e5; }
        
        .gemini-suggestions { border-top: 1px solid #e5e7eb; margin-top: 1.5rem; padding-top: 1.5rem; }
        .dark .gemini-suggestions { border-top-color: #374151; }
        .gemini-suggestions h4 { color: #4f46e5; }
        .dark .gemini-suggestions h4 { color: #a5b4fc; }
        .suggestion-item { border-left: 3px solid #d1d5db; padding-left: 1rem; margin-bottom: 1rem; }
        .dark .suggestion-item { border-left-color: #4b5563; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <V<div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-6 relative">
            <h1 class="text-4xl md:text-5xl font-bold">ClinicalX Dashboard</h1>
            <p class="text-lg md:text-xl text-gray-500 dark:text-gray-400 mt-2">Your Real-Time Guide for Care Coaching</p>
            <div id="user-id-display" class="text-xs text-gray-400 dark:text-gray-600 mt-1 font-mono">Connecting...</div>
            <div class="absolute top-0 right-0 flex items-center space-x-2">
                <button id="author-mode-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Author Mode">
                    <i data-lucide="pencil" class="h-6 w-6"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Theme">
                    <i data-lucide="sun" id="theme-icon-light" class="h-6 w-6 hidden"></i>
                    <i data-lucide="moon" id="theme-icon-dark" class="h-6 w-6"></i>
                </button>
            </div>
        </header>

        <div id="timer-section" class="max-w-md mx-auto p-4 rounded-2xl mb-8">
            <div id="timer-display" class="text-5xl font-mono text-center mb-3">20:00</div>
            <div class="flex justify-center items-center space-x-2">
                <button id="start-pause-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-full transition-colors">Start</button>
                <button id="reset-btn" class="bg-gray-500 hover:bg-gray-400 text-white font-bold py-2 px-4 rounded-full transition-colors">Reset</button>
                <div class="border-l border-gray-300 dark:border-gray-500 h-8 mx-2"></div>
                <button class="timer-preset-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm py-1 px-3 rounded-full" data-time="900">15 min</button>
                <button class="timer-preset-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm py-1 px-3 rounded-full" data-time="1200">20 min</button>
            </div>
        </div>

        <div class="sticky-header sticky top-0 backdrop-blur-sm py-4 z-10">
            <div class="max-w-5xl mx-auto">
                <div class="relative mb-4">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="h-5 w-5 text-gray-500 dark:text-gray-400"></i>
                    </div>
                    <input type="text" id="searchInput" class="focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 pr-3 py-3 rounded-full" placeholder="Search all content...">
                </div>
                <div class="tab-button-container flex justify-center space-x-1 p-1 rounded-full overflow-x-auto">
                    <button id="tab-zones" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors active">Zones</button>
                    <button id="tab-toolkit" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Toolkit</button>
                    <button id="tab-scripts" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Session Scripts</button>
                    <button id="tab-mi" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">MI</button>
                    <button id="tab-coping" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Coping Skills</button>
                    <button id="tab-favorites" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Favorites</button>
                    <button id="tab-recent" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">Recent</button>
                    <button id="tab-notes" class="tab-button flex-shrink-0 py-2 px-4 rounded-full text-sm font-semibold transition-colors">My Notes</button>
                </div>
            </div>
        </div>

        <div id="content-area" class="mt-8">
            <div id="zones-view" class="view-content">
                <div id="zone-selection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                <div id="scenarios-display" class="hidden mt-8">
                    <button id="backButton" class="mb-6 bg-gray-500 hover:bg-gray-400 text-white font-bold py-2 px-4 rounded-full transition-colors flex items-center space-x-2"><i data-lucide="arrow-left" class="h-5 w-5"></i><span>Back to Zones</span></button>
                    <div class="flex justify-between items-center">
                        <h2 id="zoneTitle" class="text-4xl font-bold mb-6"></h2>
                        <button id="add-scenario-to-zone-btn" class="author-control bg-indigo-600 hover:bg-indigo-500 text-white font-bold p-2 rounded-full transition-colors -mt-6" title="Add New Scenario to this Zone">
                            <i data-lucide="plus" class="h-6 w-6"></i>
                        </button>
                    </div>
                    <div id="scenarios-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                </div>
            </div>
            <div id="toolkit-view" class="view-content hidden"></div>
            <div id="scripts-view" class="view-content hidden"></div>
            <div id="mi-view" class="view-content hidden"></div>
            <div id="coping-view" class="view-content hidden"></div>
            <div id="favorites-view" class="view-content hidden"></div>
            <div id="recent-view" class="view-content hidden"></div>
            <div id="notes-view" class="view-content hidden max-w-4xl mx-auto p-6 rounded-2xl overflow-y-auto" style="max-height: 70vh;"></div>
        </div>
    </div>

    <div id="scenarioModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content rounded-2xl shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="modal-header flex justify-between items-center p-5 border-b">
                <h3 id="modalTitle" class="text-2xl font-bold flex-1 pr-4"></h3>
                <div class="flex items-center">
                    <button id="modal-edit-btn" class="author-control text-gray-500 hover:text-indigo-500 transition-colors p-2" title="Edit Scenario">
                        <i data-lucide="file-pen-line" class="h-6 w-6"></i>
                    </button>
                    <button id="modal-favorite-btn" class="favorite-star text-gray-500 hover:text-yellow-400 transition-colors p-2" title="Favorite">
                        <i data-lucide="star" class="h-7 w-7"></i>
                    </button>
                    <button id="closeModal" class="text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white transition-colors p-2 ml-2" title="Close">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
            </div>
            <div id="modalBody" class="modal-body p-6 overflow-y-auto"></div>
            <div class="modal-footer p-4 border-t space-y-4">
                <div class="flex justify-center">
                    <button id="suggest-phrasing-btn" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-full transition-colors flex items-center space-x-2">
                        <i data-lucide="sparkles" class="h-5 w-5"></i>
                        <span>Suggest Phrasing</span>
                    </button>
                </div>
                <div>
                    <label for="notes-phrasing" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">My Phrasing:</label>
                    <textarea id="notes-phrasing" rows="2" class="notes-field w-full rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Alternative ways I like to say this..."></textarea>
                </div>
                <div>
                    <label for="notes-reminders" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Key Reminders:</label>
                    <textarea id="notes-reminders" rows="2" class="notes-field w-full Rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 'Works well for client X', 'Don't forget to validate first'"></textarea>
                </div>
                <div>
                    <label for="notes-followup" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Follow-up Actions:</label>
                    <div class="flex items-center space-x-2">
                        <textarea id="notes-followup" rows="2" class="notes-field w-full rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 'Flag for therapist', 'Check in next session'"></textarea>
                        <button id="generate-followup-btn" class="p-2 bg-purple-600 hover:bg-purple-500 text-white rounded-full" title="✨ Generate Follow-up Plan">
                            <i data-lucide="sparkles" class="h-5 w-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content rounded-2xl shadow-xl w-full max-w-2xl flex flex-col">
            <div class="modal-header flex justify-between items-center p-5 border-b">
                <h3 id="editModalTitle" class="text-2xl font-bold">Create Scenario</h3>
                <button id="closeEditModal" class="text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white transition-colors p-2 ml-2" title="Close">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label for="editScenarioTitle" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="editScenarioTitle" class="w-full rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter scenario title...">
                </div>
                <div>
                    <label for="editScenarioContent" class="block text-sm font-medium mb-1">Content (Markdown supported)</label>
                    <textarea id="editScenarioContent" rows="10" class="w-full rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter content. Use ### for headers, * for bullet points..."></textarea>
                </div>
            </div>
            <div class="modal-footer p-4 border-t flex justify-end space-x-2">
                <button id="cancelEdit" class="bg-gray-500 hover:bg-gray-400 text-white font-bold py-2 px-4 rounded-full transition-colors">Cancel</button>
                <button id="saveEdit" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-full transition-colors">Save</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="modal-content rounded-2xl shadow-xl w-full max-w-sm flex flex-col">
            <div class="p-6 text-center">
                <i data-lucide="alert-triangle" class="h-12 w-12 text-red-500 mx-auto mb-4"></i>
                <h3 id="confirmModalTitle" class="text-lg font-bold mb-2">Are you sure?</h3>
                <p id="confirmModalText" class="text-sm text-gray-500 dark:text-gray-400">This action cannot be undone.</p>
            </div>
            <div class="modal-footer p-4 flex justify-center space-x-4">
                <button id="confirmCancel" class="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 font-bold py-2 px-6 rounded-full transition-colors">Cancel</button>
                <button id="confirmAction" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-full transition-colors">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const clinicalData = {
            "Red": {title: "🔴 Red Zone – Immediate Risk & Crisis", color: "red", scenarios: [
                {title: "Suicidal Ideation – Safety Assessment", content: "<h3>ASSESS</h3><p>...</p>", id: "suicidal-ideation"},
                // Additional Red Zone scenarios...
            ]},
            "Orange": {title: "🟠 Orange Zone – High Distress", color: "orange", scenarios: [
                {title: "Highly Agitated or Escalating", content: "<h3>Center and Slow...</h3><p>...</p>", id: "highly-agitated"},
                // Additional Orange Zone scenarios...
            ]},
            "Yellow": {title: "🟨 Yellow Zone – Moderate Challenges", color: "yellow", scenarios: [
                {title: "Resistant / Ambivalent About Therapy", content: "<h3>Acknowledge Autonomy...</h3><p>...</p>", id: "resistant-therapy"},
                // Additional Yellow Zone scenarios...
            ]},
            "Green": {title: "💚 Green Zone – Growth & Skill-Building", color: "green", scenarios: [
                {title: "Political/Global Events Anxiety", content: "<h3>Validate...</h3><p>...</p>", id: "political-anxiety"},
                // Additional Green Zone scenarios...
            ]},
        };

        const interventionsData = {
            "Distress Tolerance": [
                {title: "TIPP Skill", content: "<h4>Temperature...</h4><p>...</p>", id: "tipp-skill"},
                // Additional Distress Tolerance interventions...
            ],
            "Grounding & Somatic": [
                {title: "5-4-3-2-1 Technique", content: "<h4>Anchoring...</h4><p>...</p>", id: "5-4-3-2-1"},
                // Additional Grounding interventions...
            ],
            "Cognitive & ACT": [
                {title: "Defusion (from ACT)", content: "<h4>Creating distance...</h4><p>...</p>", id: "defusion-act"},
                // Additional Cognitive interventions...
            ],
            "Interpersonal Skills": [
                {title: "DEAR MAN", content: "<h4>A structured way...</h4><p>...</p>", id: "dear-man"},
                // Additional Interpersonal interventions...
            ],
            "Session Scripts": [
                {title: "Opening Session Script", content: "<h3>Introduction</h3><p>Welcome to our session. Let's start by checking in on how you're feeling today.</p>", id: "opening-session-script"},
                {title: "Closing Session Script", content: "<h3>Wrap-Up</h3><p>Thank you for sharing today. Let's review our key takeaways and plan for next time.</p>", id: "closing-session-script"}
            ],
            "MI": [
                {title: "Motivational Interviewing Basics", content: "<h3>OARS</h3><p>Use Open Questions, Affirmations, Reflective Listening, and Summaries to engage clients.</p>", id: "mi-basics"},
                {title: "Change Talk", content: "<h3>Eliciting Change Talk</h3><p>Ask: 'What would be different if you made this change?' to encourage motivation.</p>", id: "change-talk"}
            ],
            "Coping Skills": [
                {title: "Deep Breathing", content: "<h3>Technique</h3><p>Inhale for 4 counts, hold for 4, exhale for 6 to calm your nervous system.</p>", id: "deep-breathing"},
                {title: "Progressive Muscle Relaxation", content: "<h3>Technique</h3><p>Tense and release each muscle group to reduce physical tension.</p>", id: "progressive-muscle-relaxation"}
            ]
        };

        const dom = {
            body: document.body,
            html: document.documentElement,
            zonesView: document.getElementById('zones-view'),
            toolkitView: document.getElementById('toolkit-view'),
            scriptsView: document.getElementById('scripts-view'),
            miView: document.getElementById('mi-view'),
            copingView: document.getElementById('coping-view'),
            favoritesView: document.getElementById('favorites-view'),
            recentView: document.getElementById('recent-view'),
            notesView: document.getElementById('notes-view'),
            tabZones: document.getElementById('tab-zones'),
            tabToolkit: document.getElementById('tab-toolkit'),
            tabScripts: document.getElementById('tab-scripts'),
            tabMi: document.getElementById('tab-mi'),
            tabCoping: document.getElementById('tab-coping'),
            tabFavorites: document.getElementById('tab-favorites'),
            tabRecent: document.getElementById('tab-recent'),
            tabNotes: document.getElementById('tab-notes'),
            zoneSelection: document.getElementById('zone-selection'),
            scenariosDisplay: document.getElementById('scenarios-display'),
            backButton: document.getElementById('backButton'),
            zoneTitle: document.getElementById('zoneTitle'),
            scenariosGrid: document.getElementById('scenarios-grid'),
            addScenarioToZoneBtn: document.getElementById('add-scenario-to-zone-btn'),
            searchInput: document.getElementById('searchInput'),
            modal: document.getElementById('scenarioModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalBody: document.getElementById('modalBody'),
            closeModal: document.getElementById('closeModal'),
            modalFavoriteBtn: document.getElementById('modal-favorite-btn'),
            modalEditBtn: document.getElementById('modal-edit-btn'),
            notesFields: document.querySelectorAll('.notes-field'),
            timerDisplay: document.getElementById('timer-display'),
            startPauseBtn: document.getElementById('start-pause-btn'),
            resetBtn: document.getElementById('reset-btn'),
            timerPresetBtns: document.querySelectorAll('.timer-preset-btn'),
            themeToggle: document.getElementById('theme-toggle'),
            themeIconLight: document.getElementById('theme-icon-light'),
            themeIconDark: document.getElementById('theme-icon-dark'),
            toast: document.getElementById('toast'),
            authorModeToggle: document.getElementById('author-mode-toggle'),
            editModal: document.getElementById('editModal'),
            editModalTitle: document.getElementById('editModalTitle'),
            closeEditModal: document.getElementById('closeEditModal'),
            editScenarioTitle: document.getElementById('editScenarioTitle'),
            editScenarioContent: document.getElementById('editScenarioContent'),
            cancelEdit: document.getElementById('cancelEdit'),
            saveEdit: document.getElementById('saveEdit'),
            confirmModal: document.getElementById('confirmModal'),
            confirmModalTitle: document.getElementById('confirmModalTitle'),
            confirmModalText: document.getElementById('confirmModalText'),
            confirmCancel: document.getElementById('confirmCancel'),
            confirmAction: document.getElementById('confirmAction'),
        };

        const state = {
            currentView: 'zones',
            currentZone: null,
            favorites: [],
            notes: {},
            recentlyViewed: [],
            customContent: {},
            isAuthorMode: false,
            timer: { id: null, timeRemaining: 1200, isPaused: true, initialTime: 1200 },
            currentOpenScenario: null,
            confirmCallback: null,
        };

        let userDocRef;

        async function initFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyBr3hTkM_2PlRreFvgK9kk4s4bQvx5y8xw",
                authDomain: "my-dashboard-app-e1d1f.firebaseapp.com",
                projectId: "my-dashboard-app-e1d1f",
                storageBucket: "my-dashboard-app-e1d1f.appspot.com",
                messagingSenderId: "969081281658",
                appId: "1:969081281658:web:d479a7b003805625f02fc3"
            };
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userId = user.uid;
                    userDocRef = doc(db, `users/${userId}`);
                    initApp(db, userDocRef);
                    const userIdDisplay = document.getElementById('user-id-display');
                    if (userIdDisplay) userIdDisplay.textContent = `UserID: ${userId.substring(0, 8)}...`;
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error during anonymous sign-in:", error);
                        document.body.innerHTML = '<div class="text-center p-8 text-red-500">Could not sign in. Please refresh.</div>';
                    }
                }
            });
        }

        function initApp(db, docRef) {
            userDocRef = docRef;
            onSnapshot(docRef, (doc) => {
                const data = doc.data() || {};
                state.favorites = data.favorites || [];
                state.notes = data.notes || {};
                state.recentlyViewed = data.recentlyViewed || [];
                state.theme = data.theme || 'dark';
                state.customContent = data.customContent || {};

                applyTheme();
                renderAll();
            }, (error) => {
                console.error("Error listening to user data:", error);
            });

            updateTimerDisplay();
            setupEventListeners();
            lucide.createIcons();
        }

        function getAllContent() {
            const allContent = {};
            for (const zoneKey in clinicalData) {
                allContent[zoneKey] = [...clinicalData[zoneKey].scenarios.map(s => ({...s, category: zoneKey, color: clinicalData[zoneKey].color, id: s.id}))];
            }
            for (const categoryKey in interventionsData) {
                if (!allContent[categoryKey]) allContent[categoryKey] = [];
                allContent[categoryKey].push(...interventionsData[categoryKey].map(i => ({...i, category: categoryKey, color: 'indigo', id: i.id})));
            }
            for (const customId in state.customContent) {
                const item = state.customContent[customId];
                if (!allContent[item.category]) allContent[item.category] = [];
                allContent[item.category].push({...item, color: 'purple'});
            }
            return allContent;
        }

        function findScenarioById(id) {
            const allContent = getAllContent();
            for (const category in allContent) {
                const found = allContent[category].find(item => item.id === id);
                if (found) return found;
            }
            return null;
        }

        async function saveStateToFirestore() {
            if (!userDocRef) return;
            try {
                await setDoc(userDocRef, {
                    favorites: state.favorites,
                    notes: state.notes,
                    recentlyViewed: state.recentlyViewed,
                    theme: state.theme,
                    customContent: state.customContent
                }, { merge: true });
            } catch (error) {
                console.error("Error saving state to Firestore: ", error);
                showToast("Error: Could not save changes.");
            }
        }

        function renderAll() {
            renderAllInView(state.currentView);
            lucide.createIcons();
        }

        function createAddButton(category) {
            const btn = document.createElement('button');
            btn.className = 'author-control bg-indigo-600 hover:bg-indigo-500 text-white font-bold p-2 rounded-full transition-colors absolute top-0 right-0 -mt-4 mr-4';
            btn.innerHTML = `<i data-lucide="plus" class="h-6 w-6"></i>`;
            btn.title = "Add New Scenario";
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditModal(null, category);
            });
            return btn;
        }

        function renderZones() {
            dom.zoneSelection.innerHTML = '';
            Object.keys(clinicalData).forEach(zoneKey => {
                const zone = clinicalData[zoneKey];
                const card = document.createElement('div');
                card.className = `zone-card bg-${zone.color}-500/10 dark:bg-${zone.color}-800/20 border border-${zone.color}-200 dark:border-${zone.color}-600 p-6 rounded-2xl cursor-pointer hover:bg-${zone.color}-500/20 dark:hover:bg-${zone.color}-700/30`;
                card.innerHTML = `<h2 class="text-3xl font-bold text-${zone.color}-600 dark:text-${zone.color}-400">${zone.title}</h2><p class="text-gray-500 dark:text-${zone.color}-300 mt-2">${zoneKey} Zone</p>`;
                card.dataset.zone = zoneKey;
                card.addEventListener('click', () => showScenarios(zoneKey));
                dom.zoneSelection.appendChild(card);
            });
        }

        function renderToolkit() {
            dom.toolkitView.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'relative';
            container.appendChild(createAddButton('Toolkit'));

            const allContent = getAllContent();
            const toolkitCategories = Object.keys(interventionsData).filter(cat => !['Session Scripts', 'MI', 'Coping Skills'].includes(cat));

            toolkitCategories.forEach(category => {
                const categoryEl = document.createElement('div');
                categoryEl.className = 'mb-8';
                categoryEl.innerHTML = `<h2 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 border-b border-gray-300 dark:border-gray-700 pb-2 mb-4">${category}</h2>`;
                const gridEl = document.createElement('div');
                gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
                const items = allContent[category] || [];
                items.forEach(item => {
                    gridEl.appendChild(createScenarioCard(item));
                });
                categoryEl.appendChild(gridEl);
                container.appendChild(categoryEl);
            });
            dom.toolkitView.appendChild(container);
        }

        function renderScripts() {
            dom.scriptsView.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'relative';
            container.appendChild(createAddButton('Session Scripts'));

            const allContent = getAllContent();
            const items = allContent['Session Scripts'] || [];
            const gridEl = document.createElement('div');
            gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            items.forEach(item => {
                gridEl.appendChild(createScenarioCard(item));
            });
            container.appendChild(gridEl);
            dom.scriptsView.appendChild(container);
        }

        function renderMi() {
            dom.miView.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'relative';
            container.appendChild(createAddButton('MI'));

            const allContent = getAllContent();
            const items = allContent['MI'] || [];
            const gridEl = document.createElement('div');
            gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            items.forEach(item => {
                gridEl.appendChild(createScenarioCard(item));
            });
            container.appendChild(gridEl);
            dom.miView.appendChild(container);
        }

        function renderCoping() {
            dom.copingView.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'relative';
            container.appendChild(createAddButton('Coping Skills'));

            const allContent = getAllContent();
            const items = allContent['Coping Skills'] || [];
            const gridEl = document.createElement('div');
            gridEl.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            items.forEach(item => {
                gridEl.appendChild(createScenarioCard(item));
            });
            container.appendChild(gridEl);
            dom.copingView.appendChild(container);
        }

        function renderFavorites() { renderCardList(dom.favoritesView, state.favorites.map(findScenarioById).filter(Boolean), "You haven't favorited any scenarios yet."); }
        function renderRecent() { renderCardList(dom.recentView, state.recentlyViewed.map(findScenarioById).filter(Boolean), "You haven't viewed any scenarios recently."); }

        function renderNotesView() {
            dom.notesView.innerHTML = '';
            const notes = state.notes;
            const noteKeys = Object.keys(notes).filter(key => notes[key].phrasing || notes[key].reminders || notes[key].followup);

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-6';
            header.innerHTML = `<h2 class="text-3xl font-bold">All My Notes</h2>`;
            if (noteKeys.length > 0) {
                const clearBtn = document.createElement('button');
                clearBtn.className = 'bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-full transition-colors flex items-center space-x-2';
                clearBtn.innerHTML = `<i data-lucide="trash-2" class="h-5 w-5"></i><span>Clear All Notes</span>`;
                clearBtn.addEventListener('click', () => {
                    showConfirmModal("Clear All Notes?", "This will permanently delete all of your notes.", () => {
                        state.notes = {};
                        saveStateToFirestore();
                        showToast("All notes cleared.");
                    });
                });
                header.appendChild(clearBtn);
            }
            dom.notesView.appendChild(header);

            if (noteKeys.length === 0) {
                dom.notesView.innerHTML += `<p class="text-center text-gray-500 dark:text-gray-400 mt-8">You haven't written any notes yet.</p>`;
                return;
            }

            const copyBtn = document.createElement('button');
            copyBtn.className = 'bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-full transition-colors flex items-center space-x-2 mb-6';
            copyBtn.innerHTML = `<i data-lucide="clipboard" class="h-5 w-5"></i><span>Copy All Notes</span>`;
            copyBtn.addEventListener('click', copyAllNotesToClipboard);
            dom.notesView.appendChild(copyBtn);

            noteKeys.forEach(title => {
                const noteData = notes[title];
                const noteEl = document.createElement('div');
                noteEl.className = 'mb-6 pb-4 border-b border-gray-200 dark:border-gray-700';
                let content = `<h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">${title}</h3>`;
                if (noteData.phrasing) content += `<h4 class="font-semibold mt-3 mb-1 text-gray-600 dark:text-gray-400">My Phrasing:</h4><p class="whitespace-pre-wrap">${noteData.phrasing}</p>`;
                if (noteData.reminders) content += `<h4 class="font-semibold mt-3 mb-1 text-gray-600 dark:text-gray-400">Key Reminders:</h4><p class="whitespace-pre-wrap">${noteData.reminders}</p>`;
                if (noteData.followup) content += `<h4 class="font-semibold mt-3 mb-1 text-gray-600 dark:text-gray-400">Follow-up Actions:</h4><p class="whitespace-pre-wrap">${noteData.followup}</p>`;
                noteEl.innerHTML = content;
                dom.notesView.appendChild(noteEl);
            });
        }

        function copyAllNotesToClipboard() {
            let textToCopy = `ClinicalX Notes Export - ${new Date().toLocaleString()}\n\n`;
            const notes = state.notes;
            Object.keys(notes).forEach(title => {
                const noteData = notes[title];
                if (noteData.phrasing || noteData.reminders || noteData.followup) {
                    textToCopy += `----------------------------------------\n`;
                    textToCopy += `SCENARIO: ${title}\n`;
                    textToCopy += `----------------------------------------\n`;
                    if (noteData.phrasing) textToCopy += `My Phrasing:\n${noteData.phrasing}\n\n`;
                    if (noteData.reminders) textToCopy += `Key Reminders:\n${noteData.reminders}\n\n`;
                    if (noteData.followup) textToCopy += `Follow-up Actions:\n${noteData.followup}\n\n`;
                }
            });

            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("All notes copied to clipboard!");
            } catch (err) {
                showToast("Failed to copy notes.");
            }
            document.body.removeChild(textArea);
        }

        function renderCardList(container, items, emptyMessage) {
            container.innerHTML = '';
            container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
            if (items.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">${emptyMessage}</p>`;
                return;
            }
            items.forEach(item => {
                if (item) container.appendChild(createScenarioCard(item));
            });
        }

        function showScenarios(zoneKey) {
            state.currentZone = zoneKey;
            const allContent = getAllContent();
            const zoneData = clinicalData[zoneKey];
            const items = allContent[zoneKey] || [];

            dom.zoneSelection.classList.add('hidden');
            dom.scenariosDisplay.classList.remove('hidden');
            dom.zoneTitle.textContent = zoneData.title;
            dom.zoneTitle.className = `text-4xl font-bold mb-6 text-${zoneData.color}-600 dark:text-${zoneData.color}-400`;
            dom.scenariosGrid.innerHTML = '';
            items.forEach(item => {
                dom.scenariosGrid.appendChild(createScenarioCard(item));
            });
        }

        function createScenarioCard(scenario) {
            const isFavorited = state.favorites.includes(scenario.id);
            const card = document.createElement('div');
            card.className = `scenario-card p-4 rounded-lg cursor-pointer flex flex-col justify-between relative`;
            let cardColorClass = `border-${scenario.color}-500/30`;
            if (scenario.isCustom) cardColorClass = `border-purple-500/50`;

            card.innerHTML = `
                <div class="absolute top-1 right-1 flex space-x-1">
                    <button class="author-control edit-custom-btn text-gray-400 hover:text-indigo-500 p-1" title="Edit"><i data-lucide="file-pen-line" class="h-4 w-4"></i></button>
                    <button class="author-control delete-custom-btn text-gray-400 hover:text-red-500 p-1" title="Delete"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                </div>
                <h3 class="font-semibold pr-12">${scenario.title}</h3>
                <div class="favorite-star self-end mt-2 text-gray-400 dark:text-gray-600 ${isFavorited ? 'favorited' : ''}">
                    <i data-lucide="star" class="h-5 w-5"></i>
                </div>`;

            card.querySelector('.favorite-star').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(scenario.id);
            });
            card.addEventListener('click', () => openModal(scenario));

            if (scenario.isCustom) {
                card.querySelector('.edit-custom-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(scenario);
                });
                card.querySelector('.delete-custom-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirmModal("Delete Scenario?", `Are you sure you want to delete "${scenario.title}"?`, () => {
                        delete state.customContent[scenario.id];
                        saveStateToFirestore();
                        showToast("Scenario deleted.");
                    });
                });
            } else {
                card.querySelector('.edit-custom-btn').remove();
                card.querySelector('.delete-custom-btn').remove();
            }
            return card;
        }

        function openModal(scenario) {
            state.currentOpenScenario = scenario;
            dom.modalTitle.textContent = scenario.title;
            dom.modalBody.innerHTML = scenario.isCustom ? marked.parse(scenario.content) : linkInterventions(scenario.content);
            dom.modal.classList.remove('hidden');
            dom.modalEditBtn.style.display = scenario.isCustom ? 'flex' : 'none';
            updateModalFavoriteButton();
            loadNotes();
            addToRecentlyViewed(scenario.id);
            lucide.createIcons();
        }

        function hideModal() { dom.modal.classList.add('hidden'); state.currentOpenScenario = null; }

        function linkInterventions(content) {
            let newContent = content;
            const allInterventions = Object.values(interventionsData).flat();
            allInterventions.forEach(intervention => {
                const regex = new RegExp(`\\b(${intervention.title})\\b`, 'gi');
                if (content.match(regex)) {
                    newContent = newContent.replace(regex, `<a class="intervention-link" data-id="${intervention.id}">$1</a>`);
                }
            });
            return newContent;
        }

        function toggleFavorite(id) {
            const favIndex = state.favorites.indexOf(id);
            if (favIndex > -1) state.favorites.splice(favIndex, 1);
            else state.favorites.push(id);
            saveStateToFirestore();
        }

        function updateModalFavoriteButton() {
            if (!state.currentOpenScenario) return;
            dom.modalFavoriteBtn.classList.toggle('favorited', state.favorites.includes(state.currentOpenScenario.id));
        }

        function loadNotes() {
            if (!state.currentOpenScenario) return;
            const notes = state.notes[state.currentOpenScenario.title] || {};
            dom.notesFields.forEach(f => f.value = '');
            document.getElementById('notes-phrasing').value = notes.phrasing || '';
            document.getElementById('notes-reminders').value = notes.reminders || '';
            document.getElementById('notes-followup').value = notes.followup || '';
        }

        function saveNote() {
            if (!state.currentOpenScenario) return;
            const title = state.currentOpenScenario.title;
            const phrasing = document.getElementById('notes-phrasing').value.trim();
            const reminders = document.getElementById('notes-reminders').value.trim();
            const followup = document.getElementById('notes-followup').value.trim();
            if (phrasing || reminders || followup) {
                state.notes[title] = { phrasing, reminders, followup };
            } else {
                delete state.notes[title];
            }
            saveStateToFirestore();
            showToast('Note saved!');
        }

        function addToRecentlyViewed(id) {
            state.recentlyViewed = [id, ...state.recentlyViewed.filter(t => t !== id)].slice(0, 8);
            saveStateToFirestore();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(state.timer.timeRemaining / 60);
            const seconds = state.timer.timeRemaining % 60;
            dom.timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            dom.startPauseBtn.textContent = state.timer.isPaused ? 'Start' : 'Pause';
        }

        function timerTick() {
            if (!state.timer.isPaused && state.timer.timeRemaining > 0) {
                state.timer.timeRemaining--;
                updateTimerDisplay();
            } else if (state.timer.timeRemaining <= 0) {
                clearInterval(state.timer.id);
                state.timer.id = null;
                new Tone.Synth().toDestination().triggerAttackRelease("C4", "8n");
                showToast("Timer finished!");
            }
        }

        function startPauseTimer() {
            if (state.timer.isPaused) {
                if (!state.timer.id) state.timer.id = setInterval(timerTick, 1000);
                state.timer.isPaused = false;
            } else {
                clearInterval(state.timer.id);
                state.timer.id = null;
                state.timer.isPaused = true;
            }
            updateTimerDisplay();
        }

        function resetTimer() {
            clearInterval(state.timer.id);
            state.timer.id = null;
            state.timer.timeRemaining = state.timer.initialTime;
            state.timer.isPaused = true;
            updateTimerDisplay();
        }

        function setTimer(seconds) {
            clearInterval(state.timer.id);
            state.timer.id = null;
            state.timer.timeRemaining = seconds;
            state.timer.initialTime = seconds;
            state.timer.isPaused = true;
            updateTimerDisplay();
        }

        function filterContent(query) {
            const normalizedQuery = query.toLowerCase().trim();
            const allContent = getAllContent();
            let searchResults = [];

            for (const category in allContent) {
                searchResults.push(...allContent[category].filter(item => 
                    item.title.toLowerCase().includes(normalizedQuery) || 
                    item.content.toLowerCase().includes(normalizedQuery)
                ));
            }
            const currentViewEl = document.querySelector('.view-content:not(.hidden)');
            renderCardList(currentViewEl, searchResults, `No results found for "${query}".`);
            lucide.createIcons();
        }

        function showToast(message) {
            dom.toast.textContent = message;
            dom.toast.classList.remove('hidden');
            setTimeout(() => dom.toast.classList.add('hidden'), 3000);
        }

        function switchView(viewName) {
            state.currentView = viewName;
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.remove('hidden');
            document.getElementById(`tab-${viewName}`).classList.add('active');
            dom.searchInput.value = '';
            renderAllInView(viewName);
        }

        function renderAllInView(viewName) {
            switch(viewName) {
                case 'zones': renderZones(); dom.scenariosDisplay.classList.add('hidden'); dom.zoneSelection.classList.remove('hidden'); break;
                case 'toolkit': renderToolkit(); break;
                case 'scripts': renderScripts(); break;
                case 'mi': renderMi(); break;
                case 'coping': renderCoping(); break;
                case 'favorites': renderFavorites(); break;
                case 'recent': renderRecent(); break;
                case 'notes': renderNotesView(); break;
            }
            lucide.createIcons();
        }

        function applyTheme() {
            if (state.theme === 'dark') {
                dom.body.classList.add('dark');
                dom.themeIconLight.classList.add('hidden');
                dom.themeIconDark.classList.remove('hidden');
            } else {
                dom.body.classList.remove('dark');
                dom.themeIconLight.classList.remove('hidden');
                dom.themeIconDark.classList.add('hidden');
            }
        }

        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            applyTheme();
            saveStateToFirestore();
        }

        function toggleAuthorMode() {
            state.isAuthorMode = !state.isAuthorMode;
            dom.body.classList.toggle('author-mode-active', state.isAuthorMode);
            dom.authorModeToggle.classList.toggle('active', state.isAuthorMode);
            showToast(`Author Mode ${state.isAuthorMode ? 'Enabled' : 'Disabled'}`);
            renderAll();
        }

        function openEditModal(scenario = null, category = null) {
            dom.editModalTitle.textContent = scenario ? 'Edit Scenario' : 'Create Scenario';
            dom.editScenarioTitle.value = scenario ? scenario.title : '';
            dom.editScenarioContent.value = scenario ? scenario.content : '';
            dom.editModal.dataset.editingId = scenario ? scenario.id : '';
            dom.editModal.dataset.category = category || (scenario ? scenario.category : 'Toolkit');
            dom.editModal.classList.remove('hidden');
        }

        function closeEditModal() { dom.editModal.classList.add('hidden'); }

        function saveCustomScenario() {
            const title = dom.editScenarioTitle.value.trim();
            const content = dom.editScenarioContent.value.trim();
            const category = dom.editModal.dataset.category;
            const editingId = dom.editModal.dataset.editingId;

            if (!title || !content) {
                showToast("Title and content cannot be empty.");
                return;
            }

            const id = editingId || `custom_${Date.now()}`;
            state.customContent[id] = { id, title, content, category, isCustom: true };
            saveStateToFirestore();
            closeEditModal();
            showToast(`Scenario ${editingId ? 'updated' : 'created'}!`);
        }

        function showConfirmModal(title, text, onConfirm) {
            dom.confirmModalTitle.textContent = title;
            dom.confirmModalText.textContent = text;
            state.confirmCallback = onConfirm;
            dom.confirmModal.classList.remove('hidden');
            lucide.createIcons();
        }

        function hideConfirmModal() {
            dom.confirmModal.classList.add('hidden');
            state.confirmCallback = null;
        }

        function setupEventListeners() {
            dom.tabZones.addEventListener('click', () => switchView('zones'));
            dom.tabToolkit.addEventListener('click', () => switchView('toolkit'));
            dom.tabScripts.addEventListener('click', () => switchView('scripts'));
            dom.tabMi.addEventListener('click', () => switchView('mi'));
            dom.tabCoping.addEventListener('click', () => switchView('coping'));
            dom.tabFavorites.addEventListener('click', () => switchView('favorites'));
            dom.tabRecent.addEventListener('click', () => switchView('recent'));
            dom.tabNotes.addEventListener('click', () => switchView('notes'));
            dom.backButton.addEventListener('click', () => { dom.scenariosDisplay.classList.add('hidden'); dom.zoneSelection.classList.remove('hidden'); });
            dom.closeModal.addEventListener('click', hideModal);
            dom.modal.addEventListener('click', (e) => { if (e.target === dom.modal) hideModal(); });
            dom.closeEditModal.addEventListener('click', closeEditModal);
            dom.cancelEdit.addEventListener('click', closeEditModal);
            dom.saveEdit.addEventListener('click', saveCustomScenario);
            dom.confirmCancel.addEventListener('click', hideConfirmModal);
            dom.confirmAction.addEventListener('click', () => {
                if (state.confirmCallback) state.confirmCallback();
                hideConfirmModal();
            });
            document.addEventListener('keydown', (e) => { 
                if (e.key === 'Escape') {
                    if (!dom.modal.classList.contains('hidden')) hideModal();
                    if (!dom.editModal.classList.contains('hidden')) closeEditModal();
                    if (!dom.confirmModal.classList.contains('hidden')) hideConfirmModal();
                }
            });
            dom.modalFavoriteBtn.addEventListener('click', () => toggleFavorite(state.currentOpenScenario.id));
            dom.modalEditBtn.addEventListener('click', () => openEditModal(state.currentOpenScenario));
            dom.addScenarioToZoneBtn.addEventListener('click', () => openEditModal(null, state.currentZone));
            dom.notesFields.forEach(field => field.addEventListener('blur', saveNote));
            dom.startPauseBtn.addEventListener('click', startPauseTimer);
            dom.resetBtn.addEventListener('click', resetTimer);
            dom.timerPresetBtns.forEach(btn => btn.addEventListener('click', () => setTimer(parseInt(btn.dataset.time))));
            dom.searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                if (!query) renderAllInView(state.currentView);
                else filterContent(query);
            });
            dom.themeToggle.addEventListener('click', toggleTheme);
            dom.authorModeToggle.addEventListener('click', toggleAuthorMode);
            document.body.addEventListener('click', (e) => {
                const link = e.target.closest('.intervention-link');
                if (link) {
                    e.preventDefault();
                    const scenario = findScenarioById(link.dataset.id);
                    if (scenario) openModal(scenario);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>
