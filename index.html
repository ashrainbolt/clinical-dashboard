<!DOCTYPE html>
<html lang="en" class="bg-gray-50 dark:bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Marked.js (Markdown parser) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom styles for prose and layout */
        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
            font-weight: 600;
            margin-top: 1.25em;
            margin-bottom: 0.5em;
        }
        .prose h1 { font-size: 1.5em; }
        .prose h2 { font-size: 1.25em; }
        .prose h3 { font-size: 1.1em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; }
        .prose strong { font-weight: 600; }
        .prose blockquote {
            border-left: 0.25rem solid #4f46e5;
            padding-left: 1em;
            font-style: italic;
            color: #4b5563;
        }
        .dark .prose blockquote {
            border-left-color: #818cf8;
            color: #d1d5db;
        }

        .scratchpad-resize {
            resize: vertical;
            min-height: 6rem;
            max-height: 50vh;
            overflow-y: auto;
        }
        /* Ensure sidebar content can scroll if it overflows */
        .sidebar-nav {
            flex: 1 1 auto;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans">

    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-full w-60 bg-white dark:bg-gray-800 shadow-lg flex flex-col z-40">
        <div class="flex items-center h-16 px-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
            <i data-lucide="activity" class="w-6 h-6 mr-2 text-indigo-500"></i>
            <span class="font-bold text-lg">Clinical OS</span>
            <button id="theme-toggle" class="ml-auto p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle Theme">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
        <nav class="sidebar-nav py-4 px-2 space-y-1">
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="dashboard"><i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i>Dashboard</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="interventions"><i data-lucide="zap" class="w-4 h-4 mr-3"></i>Interventions</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="scripts"><i data-lucide="file-text" class="w-4 h-4 mr-3"></i>Scripts</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="favorites"><i data-lucide="star" class="w-4 h-4 mr-3"></i>Favorites</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-indigo-100 dark:hover:bg-indigo-900" data-tab="recents"><i data-lucide="history" class="w-4 h-4 mr-3"></i>Recently Viewed</button>
            <button class="sidebar-link w-full text-left px-4 py-2 rounded flex items-center hover:bg-teal-100 dark:hover:bg-teal-900" data-tab="scratchpad"><i data-lucide="edit-3" class="w-4 h-4 mr-3"></i>Scratchpad</button>
        </nav>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
            <input id="search-box" type="text" placeholder="Search scenarios..." class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
    </aside>

    <!-- Main content -->
    <main class="ml-60 min-h-screen p-6 md:p-8 transition-colors duration-300">
        <!-- Used this session -->
        <div id="used-this-session" class="mb-4"></div>
        <!-- Dynamic content area -->
        <div id="content-area"></div>
    </main>

    <!-- Content Modal -->
    <div id="scenario-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full relative p-6 max-h-[90vh] flex flex-col">
            <div class="flex items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold flex-1"></h2>
                <button id="close-modal" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-body" class="prose dark:prose-invert max-w-none overflow-y-auto pr-4 -mr-4"></div>
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex gap-2">
                 <button id="copy-modal-content-to-scratchpad" class="flex items-center text-xs px-3 py-1 bg-teal-100 dark:bg-teal-900 rounded-md text-teal-700 dark:text-teal-200 hover:bg-teal-200 dark:hover:bg-teal-800">
                    <i data-lucide="plus-square" class="w-4 h-4 mr-1"></i>Copy to Scratchpad
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h3 id="confirmation-title" class="text-lg font-semibold mb-4">Are you sure?</h3>
            <div id="confirmation-message" class="text-sm text-gray-600 dark:text-gray-300 mb-6"></div>
            <div class="flex justify-end gap-3">
                <button id="confirmation-cancel" class="px-4 py-2 rounded-md text-sm font-medium bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Cancel</button>
                <button id="confirmation-confirm" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="hidden"></div>

    <script>
    // ---- DATA ----
    // This section contains all the clinical scenarios and interventions
    // converted from the user's document into a structured format.

    const clinicalData = [
        // --- RED ZONE ---
        {
            id: 'red-suicidal-ideation',
            title: 'Suicidal Ideation – Safety Assessment',
            category: 'Red Zone',
            color: 'red',
            tags: ['suicide', 'safety', 'crisis', 'cssrs', 'assessment', 'red'],
            content: `### ASSESS\n"Before we go any deeper, **our priority is always your safety**. I’d like to ask a few questions that help us understand how you’re doing and what kind of support might help keep you safe right now.\n\n1.  **Have you wished you were dead or that you could go to sleep and not wake up?**\n2.  **Have you actually had any thoughts of killing yourself?** (If yes, ask 3, 4, 5, 6. If no, go to 6).\n3.  **In the past 48 hours, have you been thinking about how you might do this?**\n4.  **In the past 48 hours, have you had these thoughts and had some intention of acting on them?**\n5.  **In the past 48 hours, have you started to work out any details for how to kill yourself? Do you intend to carry out this plan?**\n6.  **In the past 48 hours have you done anything to prepare to end your life?**\n\n*If Yes to 4, 5, or 6, ask scaling questions:*\n\n> \"On a scale of 1-5, one meaning you feel you can stay safe today, and five meaning that you're going to make an attempt today, where would you place yourself right now?\"\n\n*Reflect back answer:*\n* \"So a **four** means to me you have a plan and some intentions on acting on the plan, you just don't know when. Is that accurate?\"\n* \"A **three** means to me you have strong thoughts of wanting to die and have thought about ways you might act on it, but you don't have a specific plan. Did I get that right?\"\n* \"A **two** means to me that you have fleeting thoughts of wanting to end your life, but no plan or intention of acting on it.\"\n\n“I’m really glad you told me this. It takes a lot of strength to be this honest, and I’m here to help you figure it out.”\n\n### SAFETY PLAN\n**Need to escalate:** \"Thank you for telling me that. If it sounds like things are starting to feel more intense or harder to manage on your own, I’d like to connect you with a Crisis Manager — who can better support you and help figure out the next steps to keep you safe.\"\n\n* **Warning Signs:** “What are some early signs you notice when things start to spiral?”\n* **Internal Coping:** “What can you try on your own that sometimes helps, even a little?”\n* **Social Distractions:** “Who or what helps you shift your focus — even briefly?”\n* **People to Reach Out To:** “If things feel too big to hold alone, who could you reach out to?”\n* **Professional Resources:** “Do you have Charlie Health’s 24/7 crisis line saved in your phone?”\n* **Safety at Home:** “Is there anything nearby that might feel unsafe to have around right now?”\n* **Reasons to Stay:** “When things get dark, what’s something — or someone — that reminds you there’s still a reason to hang on?”`
        },
        {
            id: 'red-self-harm',
            title: 'Self-Harm Urges (Non-Suicidal Self-Injury)',
            category: 'Red Zone',
            color: 'red',
            tags: ['nssi', 'self-harm', 'urges', 'coping', 'safety', 'red'],
            content: `### Direct Check-In\n“Thank you for telling me. I need to ask: Are you having urges to hurt yourself right now?”\n* **If yes (urge is present):** “On a scale from 1 to 10, how strong is the urge right now, 10 being the strongest?”\n* **If yes (recent self-harm action):** “What did you do, and how severe was it? Do you need any medical attention for that?”\n\n### Clarify Intent\n“When you self-harmed, was it because you wanted to die, or was it more about coping with pain or numbness?”\n\n### Validate & Normalize\n“That urge makes sense given what you’re carrying. A part of you is trying to survive and find relief, even if it’s doing it in a way that ends up hurting you. Let’s see if we can work with that part in a safer way.”\n\n### Offer Alternatives & Coping Strategies\n* **Intense Physical Sensations (TIPP skills):** “Sometimes our body needs a very strong sensation to release that tension. We could try holding something frozen (like ice), doing a wall-sit or some push-ups, or splashing really cold water on your face.”\n* **“Urge Surfing” Technique:** “Remember, urges are like waves — they build, peak, and eventually fall. Let’s try to ride this wave out together.”\n* **Safe Physical Release:** “Would it help to rip up some paper, squeeze a stress ball, stomp your feet, or even scream into a pillow?”\n\n### Commitment to Safety\n“I know the urge is strong, but do you feel like you can stay safe tonight? Even if the urge comes back, can you promise me you’ll try these coping steps or reach out for help before doing anything to hurt yourself?”`
        },
        {
            id: 'red-hallucinations',
            title: 'Hallucinations or Disturbing Perceptual Experiences',
            category: 'Red Zone',
            color: 'red',
            tags: ['psychosis', 'hallucinations', 'voices', 'paranoia', 'safety', 'red'],
            content: `### Acknowledge Experience (Don’t Dismiss)\n“Thank you for telling me. I can imagine this feels really intense and scary. I want you to know I’m here with you, and I believe that you’re experiencing this.”\n\n### Safety Check (Calm & Direct)\n“Are the things you’re hearing or seeing telling you to hurt yourself or anyone else?”\n\n### Orient to Present (Ground in Shared Reality)\n“Let’s try something together to bring you into the here and now with me, okay? Put your feet flat on the floor for me. Press them down a little and notice that sensation. You’re right here, in this moment, with me. We’re safe right now.”\n\n### Calm Reassurance\n“You’re doing really well. I’m going to stay right here with you. The things you’re perceiving can feel real, but I want you to keep noticing the ground under your feet, the sound of my voice. We’re in the present moment.”`
        },
        {
            id: 'red-medical-crisis',
            title: 'Acute Medical Crisis',
            category: 'Red Zone',
            color: 'red',
            tags: ['medical', 'emergency', '911', 'crisis', 'safety', 'red'],
            content: `### Immediate Action – Take Charge\n“Okay, I see/hear that something serious might be happening physically. The most important thing right now is getting you medical help immediately.”\n\n### Instruct to Call Emergency\n“Are you able to call 911 (or your local emergency number) right now? Is there someone with you who can call for you?”\n\n### Offer to Call\n“It sounds like you can’t call on your own. I’m going to get you help. Do I have your permission to call 911 for you right now to get an ambulance?”\n\n### Keep Them Engaged While Help Comes\n“Help is on the way. I’m right here with you. Try to stay as calm as you can – focus on taking slow breaths with me if possible. In… and out… nice and easy.”`
        },
        {
            id: 'red-overdose',
            title: 'Substance Overdose or Severe Intoxication',
            category: 'Red Zone',
            color: 'red',
            tags: ['overdose', 'substance', 'intoxication', 'emergency', '911', 'red'],
            content: `### Recognize Seriousness\n“I can tell this is serious. I’m very concerned that you might be experiencing a medical emergency from substances.”\n\n### Instruct to Call Emergency\n“This is urgent. Are you able to call 911 right now for medical attention? Or is there someone with you who can call?”\n\n### Naloxone (If Opioid Overdose suspected)\n“If this might be an opioid overdose and if you or anyone there has Naloxone (Narcan) and knows how to use it, please use it now while we wait for the ambulance.”\n\n### Keep Them Awake & Oriented\n“Stay with me, okay? Help is coming. Try to stay awake and keep talking to me. I know you’re very drowsy, but focus on my voice.”`
        },
        {
            id: 'red-unsafe-home',
            title: 'Unsafe Home Environment / Domestic Violence',
            category: 'Red Zone',
            color: 'red',
            tags: ['dv', 'domestic violence', 'abuse', 'safety', 'home', 'red'],
            content: `### Express Empathy and Belief\n“Thank you for sharing this with me. I can’t imagine how hard it was to say that out loud. I want you to know I believe you, and you didn’t deserve any of this.”\n\n### Assess Immediate Safety\n“Are you safe right now? Is the person who hurt you nearby or likely to return soon?”\n\n### Provide Control & Options\n“You know your situation best, and I’m here to support whatever you choose to do. For example, have you heard of the National Domestic Violence Hotline? They have advocates 24/7 at 1-800-799-7233 who can help you make a safety plan or find resources.”\n\n### Empower & Validate\n“You are not alone and there are people who want to help. You deserve to be safe. None of this is your fault.”`
        },
        {
            id: 'red-child-abuse',
            title: 'Child Abuse or Neglect Disclosure',
            category: 'Red Zone',
            color: 'red',
            tags: ['child abuse', 'neglect', 'mandated reporter', 'cps', 'safety', 'red'],
            content: `### Respond with Care\n“Thank you for telling me that. I know it’s not easy to talk about. I am so sorry this happened to you (or to that child). No one, especially no child, should have to go through that.”\n\n### Explain Mandated Reporting (Transparent and Reassuring)\n“I need you to know: because you shared this, I’m required by law to take steps to report it to the proper authorities... This isn’t to get anyone in trouble; it’s to protect you/them and make sure it doesn’t continue.”\n\n### Support the Client’s Emotions\n“How are you feeling now that you’ve shared that? It’s a lot, I know. Whatever you’re feeling – scared, relieved, angry – it’s completely understandable.”\n\n### Closing Reassurance\n“I know this was a big step to tell me. You were very brave to speak up. Remember: you didn’t do anything wrong by telling the truth.”`
        },
        {
            id: 'red-harm-to-others',
            title: 'Threat of Harm to Others (Homicidal Ideation)',
            category: 'Red Zone',
            color: 'red',
            tags: ['homicidal', 'harm to others', 'duty to protect', 'safety', 'crisis', 'red'],
            content: `### Immediate Clarification\n“I hear you saying you want to hurt someone. I take that very seriously, and I need to ask you a few questions to understand better, because my job is to keep everyone safe.”\n\n### Duty to Protect Explanation\n“Okay, I need you to know: because you’re talking about harming someone else, I have a responsibility to make sure that person (and everyone) stays safe. That may mean involving other professionals or authorities right away.”\n\n### De-escalate Anger\n“I get that you’re extremely angry. That anger is telling us something important — you feel deeply hurt or wronged. I’m here to listen to that. Let’s slow this down and sit with what’s coming up, instead of letting it boil over.”`
        },
        {
            id: 'red-under-influence',
            title: 'Under the Influence (Non-Crisis)',
            category: 'Red Zone',
            color: 'red',
            tags: ['substance', 'intoxication', 'policy', 'safety', 'red'],
            content: `### Immediate Safety Check\n"Hi. I'm just checking in with you briefly. It was noticed in group that [specific observation, e.g., 'you seemed a bit sleepy']. How are you doing right now?"\n\n### Stating the Need to Log Off (Clear, Kind, Firm)\n"Because it appears you're under the influence right now, and in line with the group policy for everyone's safety and benefit, I am going to need you to log off from the group session for the rest of today."\n"This isn't a punishment, but it's a necessary step to ensure your well-being and to maintain the group's therapeutic environment."\n\n### Brief Safety Assessment (Essential before log-off)\n"Before you log off for the day, my top priority is to make sure you're going to be safe. Are you in a safe place physically right now? Is there anyone with you, or someone responsible you can contact if you start to feel unwell or need help?"\n\n### Explain Next Steps\n“Because you were under the influence and had to step out of group, I will let your primary therapist know what happened, just so they’re in the loop and can support you.”`
        },
        // --- ORANGE ZONE ---
        {
            id: 'orange-agitated',
            title: 'Highly Agitated or Escalating',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['agitation', 'escalation', 'anger', 'distress', 'orange'],
            content: `### Center and Slow the Moment\n“I can see (or hear) how agitated you are. Let’s take a pause for a second. I’m right here with you. You don’t have to go through this moment alone.”\n\n### Acknowledge the Anger/Frustration\n“That energy and anger you’re feeling right now — it makes sense. Something important is going on inside you and it’s demanding to be heard.”\n\n### Keep Voice Calm & Assuring\n“I’m not going anywhere. I know you’re really upset, and it’s okay. Let’s stay right here. You’re safe with me to let it out, as long as we keep each other safe.”\n\n### After Calming Slightly – Reflection\n“That was a lot. You did really well slowing down just now. This is hard stuff, and you’re handling it. When you’re ready, maybe we can figure out what you need next or how I can help further.”`
        },
        {
            id: 'orange-panic-attack',
            title: 'Acute Anxiety or Panic Attack',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['anxiety', 'panic', 'fear', 'grounding', 'tipp', 'orange'],
            content: `### Normalize & Reassure\n“What you’re experiencing is a panic attack. It feels really scary, but **I promise it’s not life-threatening. You are going to be okay. I’m right here.**”\n\n### Immediate Physiological Regulation (TIPP Skills)\n* **Temperature:** "Can you splash some cold water on your face, or hold a cold water bottle or ice cube if you have one? This triggers something called the 'dive response' that naturally slows your heart rate."\n* **Paced Breathing:** "Let's breathe together. Breathe in through your nose for 4 counts... hold for 4... now out through your mouth for 6 counts. That longer exhale is key."\n\n### Orient to Safety (5-4-3-2-1 technique)\n“Let’s name five things you see in the room. Good. Now four things you can feel... three things you can hear... two things you can smell... and one thing you can taste.”\n\n### Permission to Pause\n“We don’t need to unpack everything right now. In fact, we shouldn’t dive deeper into anything heavy at this moment, because I want to make sure you don’t leave here feeling even worse.”`
        },
        {
            id: 'orange-unusual-thoughts',
            title: 'Unusual Thoughts (Mild Paranoia or Cognitive Distortions)',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['paranoia', 'distortions', 'thoughts', 'reality testing', 'orange'],
            content: `### Do Not Dismiss\n“That sounds really troubling. It must feel scary (or confusing) thinking that might be true. Thank you for telling me what’s going through your mind.”\n\n### Gently Reality-Check\n“Let’s look at that together. You feel like everyone in group hates you. I know it can really feel that way. May I share what I’ve observed? I’ve seen group members show you care... I’m not seeing evidence of hate.”\n\n### Affirm\n“You’re not ‘crazy’ or bad for having these thoughts. Our minds do all kinds of weird things under stress. The fact that you can question it and talk about it means you have insight and courage.”`
        },
        {
            id: 'orange-trauma-reaction',
            title: 'Trauma Reaction / Flashback',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['trauma', 'flashback', 'ptsd', 'grounding', 'safety', 'orange'],
            content: `### Ground in Present Safety\n“Hey, you’re here with me. You’re safe right now. That thing isn’t happening to you right this second, even though it feels like it is.”\n\n### Breathe and Orient\n“Take a deep breath if you can. You’re breathing in the current year. You’re [client’s name], and you’re here with me, not back in that situation. That was then, and this is now. Can you say out loud, ‘I’m here now’?”\n\n### Validate and Contain\n“That memory was really intense. It makes sense that it felt like it was happening all over again. Flashbacks can be that powerful. But it’s not happening now, and you survived it then. You’re safe now.”`
        },
        {
            id: 'orange-sexual-assault',
            title: 'Sexual Assault Disclosure (Trauma Processing in the Moment)',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['sexual assault', 'trauma', 'disclosure', 'safety', 'support', 'orange'],
            content: `### Listen and Honor Courage\n“I’m so sorry that happened to you. Thank you for trusting me enough to tell me. I can’t imagine how terrible that was for you, and how heavy it must be to carry that.”\n\n### Validate the Response\n“What happened is not your fault. You did not deserve that. The blame is 100% on the person who hurt you.”\n\n### Empower Choices\n“I want you to have control over what happens next. If you want help reporting it or getting medical care, I can help facilitate that. If you just wanted to tell someone and not take further action right now, that’s okay too.”`
        },
        {
            id: 'orange-relational-rupture',
            title: 'Relational Rupture / Intense Interpersonal Conflict',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['conflict', 'relationship', 'anger', 'betrayal', 'communication', 'orange'],
            content: `### Validate the Hurt/Anger\n“It sounds like you’re really hurt and angry about what happened. That’s completely understandable – when someone we care about [does X], it can feel awful and infuriating.”\n\n### Prevent Overwhelm or Shutdown\n“Let’s try to slow it just a bit so I can understand everything. I want to make sure I’m catching what’s most important to you in all of this.”\n\n### Brainstorm or Contain\n“Given how raw this is, it might be best not to confront them while you’re feeling this angry. We can work out what you want to say when you’re calmer. For now, maybe focus on what you need to feel a bit better.”`
        },
        {
            id: 'orange-triggered-by-group',
            title: 'Triggered by Group Content',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['trigger', 'group', 'trauma', 'overwhelmed', 'orange'],
            content: `### Normalize Triggers\n“It makes a lot of sense that you felt triggered by what came up in group. Sometimes other people’s stories can stir up feelings or memories we didn’t expect. That doesn’t mean anything is wrong with you – it means you’re human.”\n\n### Re-ground and Stabilize\n“Let’s come back to the here and now first. You’re with me, you’re safe. The group conversation is over (or on pause) and we’re just sitting here talking.”\n\n### Affirmation\n“I’m glad you took a break and talked to me about it. That’s a healthy response to feeling overwhelmed. You honored your limits, and that’s good.”`
        },
        {
            id: 'orange-conflict-in-group',
            title: 'Conflict in Group or with Staff',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['conflict', 'group', 'staff', 'anger', 'communication', 'orange'],
            content: `### Initial Response\n"It makes sense that you’d feel activated after what happened in group. I want to hold space for that with you."\n\n### Plan a Constructive Follow-Up\n“If you feel up to it, we can talk about how to address this. Would you want to speak with [the person] one-on-one with a mediator, maybe me or your therapist, present? Or would you prefer writing down what you feel and sharing it?”\n\n### Affirm Self-Advocacy\n“I’m really glad you told me how you feel. You have every right to speak up when something isn’t okay for you.”`
        },
        {
            id: 'orange-anger-irritability',
            title: 'Anger and Irritability (beyond mild agitation)',
            category: 'Orange Zone',
            color: 'orange',
            tags: ['anger', 'irritability', 'frustration', 'coping', 'orange'],
            content: `### Acknowledge the Emotion\n“You’ve been feeling a lot of anger lately – like a constant simmering. That’s exhausting, isn’t it? It’s okay to feel angry. Anger is a normal emotion. It often comes when we feel hurt, or trapped, or disrespected.”\n\n### Invite Insight\n“Do you have a sense of what’s underneath the anger? Often there’s pain or fear hiding under anger’s umbrella.”\n\n### Intervention Insight\nUse **Circles of Control, Influence, and Concern** to help focus energy effectively. Apply **"I-Statements"** for assertive expression.`
        },
        // --- YELLOW ZONE ---
        {
            id: 'yellow-manipulative-behaviors',
            title: '“Manipulative” or Testing Behaviors',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['manipulation', 'testing', 'boundaries', 'needs', 'yellow'],
            content: `### Look Under the Behavior\n“It seems like you really need something right now – maybe reassurance, or to feel in control? I want to understand what you need, because I don’t think you’re doing these things for no reason.”\n\n### Call Out Needs, Not Character\n“I don’t see you as ‘manipulative.’ I see someone who’s trying hard to get their needs met. How about we skip the part where you have to escalate things to get me to care – because I already care.”\n\n### Encourage Direct Communication\n“You shouldn’t have to test me to see if I’ll support you. I want you to know: if you need something, you can ask me as plainly as possible.”\n\n### Intervention Insight\nUse the **DEAR MAN** framework for clear, assertive communication.`
        },
        {
            id: 'yellow-shut-down',
            title: 'Shut Down, Withdrawn, or Minimizing',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['withdrawn', 'shut down', 'minimizing', 'dissociation', 'yellow'],
            content: `### Gently Call It Out\n“I notice you’re getting really quiet (or you keep saying you’re fine). Sometimes when people get really quiet, it’s because the feelings are too much or too hard to put into words. Does that feel true for you right now?”\n\n### Permission to Be Silent\n“We can sit here together without talking for a bit if that’s what you need. I’m not uncomfortable with the silence if you aren’t. Sometimes just having someone nearby is enough.”\n\n### Affirmation\n“It took courage to admit how lonely you feel. That’s a step toward change. You deserve to feel connected and valued – because you are.”`
        },
        {
            id: 'yellow-shame-guilt',
            title: 'Shame, Self-Hatred, or Guilt',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['shame', 'guilt', 'self-compassion', 'worthlessness', 'yellow'],
            content: `### Validate\n“It sounds like you’re holding yourself to an impossible standard. Whatever you did (or think you did), it doesn’t make you worthless or evil. It makes you human.”\n\n### Get Specific\n“Can we talk about what’s making you feel so ashamed? What do you believe you did that’s so unforgivable?”\n\n### Self-Compassion\n“Think about what you would say to a close friend if they were feeling exactly what you’re feeling. You deserve that same kindness. What if you tried talking to yourself in that gentle way, maybe saying something like ‘It’s okay to feel this. I’m here for you.’?”\n\n### Intervention Insight\n* Use **ACT Defusion** ("I'm having the thought that...") to create distance from thoughts.\n* Apply **Cognitive Reframing: Behavior vs. Identity** to separate actions from self-worth.`
        },
        {
            id: 'yellow-hopelessness',
            title: 'Hopelessness or Despair (without active suicidal intent)',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['hopelessness', 'despair', 'depression', 'motivation', 'yellow'],
            content: `### Borrow Hope\n“Sometimes we have to borrow hope from others. Is it okay if I believe that things can change, even if you don’t believe it today? I’ve seen people come out of pits like this, and I truly believe you can too.”\n\n### Focus on Immediate Next Step\n“When the future looks blank or bleak, don’t even worry about the future right now. Let’s just focus on getting through today, or even just the next hour.”\n\n### Compassion\n“Even if you can’t feel hope right now, I have enough for both of us. I know you’re tired. But you’ve made it to this day, even carrying all that despair – that’s not small thing.”`
        },
        {
            id: 'yellow-ocd-thoughts',
            title: 'Obsessive-Compulsive Thoughts',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['ocd', 'obsessions', 'compulsions', 'intrusive thoughts', 'yellow'],
            content: `### Normalize\n“It sounds like your brain is stuck on a loop right now. Those kinds of intrusive thoughts can be really exhausting and frightening. You’re not crazy – OCD-type thoughts happen to a lot of people, and they don’t reflect your character or true intentions.”\n\n### Plan for Therapy Work\n“It might help to tell your therapist or psychiatrist about this if you haven’t – OCD is something that can really improve with the right techniques (like Exposure and Response Prevention therapy or sometimes medication).”\n\n### Intervention Insight\nPractice **Thought Labeling** ("That's an OCD thought") or **Urge Surfing** to create distance.`
        },
        {
            id: 'yellow-negative-loops',
            title: 'Negative Thought Loops / Rumination',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['rumination', 'negative thinking', 'worry', 'anxiety', 'yellow'],
            content: `### Gently Interrupt\n“I notice your mind keeps circling around this. It’s like you’re stuck in a thought loop, huh? That can be really draining. Let’s hit the pause button on those thoughts for just a moment, if we can.”\n\n### Intervention Insight\nUse **ACT Defusion** techniques to help distance from thoughts.`
        },
        {
            id: 'yellow-eating-disorder',
            title: 'Eating Disorder (Moderate)',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['eating disorder', 'body image', 'food', 'anorexia', 'bulimia', 'yellow'],
            content: `### Address Gently\n“You mentioned some concerns around eating and body image. I know that can be really sensitive to talk about. I just want to say: I’m here to support you, not judge you. A lot of people struggle with food and eating; you’re definitely not alone in that.”\n\n### Assurance\n“I know this is scary. But you’re not alone in it. We care about you – I care about you – and we want you healthy and happy. You deserve to nourish yourself and to live without this burden.”`
        },
        {
            id: 'yellow-neurodivergent',
            title: 'Neurodivergent Challenges (ADHD/Autism Spectrum)',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['adhd', 'autism', 'neurodivergent', 'focus', 'sensory', 'yellow'],
            content: `### Immediate Coping for Sensory Overload\n“Are the lights or sounds bothering you right now? We can dim the lights, or if you want, you can wear headphones or a hoodie to feel more comfortable. No judgment – do what you need to regulate.”\n\n### Encourage Self-Acceptance\n“I know you sometimes feel like you’re ‘too weird’ or ‘broken’ because of how your brain works. You’re not. You’re different, yes, and different can be hard, but it can also be powerful.”`
        },
        {
            id: 'yellow-off-topic',
            title: 'Off-Topic / Distractible (Difficulty Staying Focused)',
            category: 'Yellow Zone',
            color: 'yellow',
            tags: ['focus', 'distraction', 'adhd', 'avoidance', 'yellow'],
            content: `### Kindly Refocus\n“I notice we jumped to a different topic just now. That’s okay – sometimes our brains steer us away when we hit something uncomfortable or just because something else pops up. Let’s gently steer back to what we were talking about earlier, because I think that was important.”\n\n### Positive Reinforcement\n“You’re doing great. We covered the tough bit about your mom’s comment after all, and I really appreciate you sticking with that. I know it’s tempting to veer away, but you stayed with it. That’s progress!”`
        },
        // --- GREEN ZONE ---
        {
            id: 'green-global-anxiety',
            title: 'Political/Global Events Anxiety',
            category: 'Green Zone',
            color: 'green',
            tags: ['anxiety', 'global events', 'politics', 'eco-anxiety', 'control', 'green'],
            content: `### Validate\n“It makes complete sense that you’re feeling [anxious/angry/overwhelmed] given what’s happening in the world. These are heavy and uncertain times, and your feelings are a very understandable response.”\n\n### Address Fears of Death/Cosmic Insignificance\n“A lot of existential dread comes from realizing our own mortality or how small we are in the vast universe. That can be scary, but it can also be seen another way: If nothing ultimately matters on a cosmic scale, then maybe we’re free to create our own meaning here and now.”\n\n### Intervention Insight\nUse **Circles of Control, Influence, and Concern** to focus energy effectively.`
        },
        {
            id: 'green-chronic-pain',
            title: 'Chronic Pain or Health Challenges',
            category: 'Green Zone',
            color: 'green',
            tags: ['chronic pain', 'illness', 'health', 'coping', 'green'],
            content: `### Acknowledge Difficulty\n“Dealing with chronic pain (or a chronic illness) is really tough. Not only are you physically hurting, but it wears on you emotionally too. It’s completely valid to feel frustrated, exhausted, or down about it.”\n\n### Discuss Coping Strategies\n“What helps on the days when the pain or symptoms are a bit more manageable? Is there anything – maybe a heating pad, a short walk, a certain stretch, a distraction like a good TV show – that gives you even a small relief or comfort?”\n\n### Intervention Insight\nPractice **Radical Acceptance** of the current reality.`
        },
        {
            id: 'green-expressing-needs',
            title: 'Struggling to Identify or Express Needs',
            category: 'Green Zone',
            color: 'green',
            tags: ['needs', 'communication', 'assertiveness', 'boundaries', 'green'],
            content: `### Highlight the Pattern\n“It sounds like you often find yourself feeling unsatisfied or hurt because your needs aren’t met – but at the same time, you have a hard time even knowing or saying what those needs are. That’s more common than you might think... your needs matter.”\n\n### Practice in the Moment\n“Let’s practice right now in a small way: How are you feeling in this moment with me? Do you need anything? This is a low-stakes environment to practice identifying a need and voicing it.”\n\n### Intervention Insight\nUse the **Nonviolent Communication (NVC) Framework** (Observations, Feelings, Needs, Requests).`
        },
        {
            id: 'green-enmeshed-relationships',
            title: 'Enmeshed or Dependent Relationships',
            category: 'Green Zone',
            color: 'green',
            tags: ['enmeshment', 'dependency', 'boundaries', 'identity', 'relationships', 'green'],
            content: `### Validate Difficulty\n“It sounds like you feel really tangled up in this relationship – like your feelings and decisions are almost merged with theirs. That can be comforting at times, but also suffocating or confusing.”\n\n### Intervention Insight\nExplore **Boundary Setting**.`
        },
        {
            id: 'green-feeling-stuck',
            title: 'Feeling Directionless or “Stuck” in Life',
            category: 'Green Zone',
            color: 'green',
            tags: ['stuck', 'directionless', 'purpose', 'motivation', 'values', 'green'],
            content: `### Normalize\n“A lot of people go through periods of life where they feel lost or directionless. It can be really unsettling, like you’re drifting without a map. First off, it’s okay to not have everything figured out.”\n\n### Explore Values\n“Sometimes direction becomes clearer when we focus on what we truly value in life.”\n\n### Intervention Insight\nUse **Solution-Focused Brief Therapy (SFBT) techniques** like the "Miracle Question" to identify desired future states.`
        },
        {
            id: 'green-time-management',
            title: 'Time Management and Organization',
            category: 'Green Zone',
            color: 'green',
            tags: ['time management', 'organization', 'procrastination', 'productivity', 'green'],
            content: `### Positive Frame\n“You’re looking to get more organized and manage your time better – that’s a great goal. These skills can make life so much less stressful once they click, and I’m excited to help you with it.”\n\n### Task Chunking\n“Another approach is breaking the task into teeny tiny chunks. Instead of ‘Write essay,’ chunk it to: ‘1) Open a Word doc, 2) write a rough title, 3) jot three bullet points of ideas.’ Then do one chunk at a time.”\n\n### Time Management Techniques (Pomodoro)\n“Have you heard of the Pomodoro Technique? It’s where you work for 25 minutes, then take a 5-minute break, then repeat.”\n\n### Intervention Insight\nEncourage **Habit Stacking** (attaching new habits to existing ones).`
        },
        {
            id: 'green-decision-making',
            title: 'Decision-Making',
            category: 'Green Zone',
            color: 'green',
            tags: ['decisions', 'indecisive', 'anxiety', 'choices', 'green'],
            content: `### Frame the Issue\n“Decision-making can be really stressful, especially if you’re afraid of making the wrong choice or if you’ve got a lot of options. It’s actually great that you want to work on this; being more confident in your decisions can reduce a lot of anxiety.”\n\n### Listen to Gut and Head\n“It’s good to analyze, but also consider your gut feeling. Our instincts are basically our subconscious pulling from past experiences and values.”\n\n### Intervention Insight\nUse **Cost-Benefit Analysis** or the **"10-10-10 Perspective"** to examine consequences.`
        },
        {
            id: 'green-perfectionism',
            title: 'Perfectionism',
            category: 'Green Zone',
            color: 'green',
            tags: ['perfectionism', 'procrastination', 'self-criticism', 'anxiety', 'green'],
            content: `### Acknowledge Upside/Downside\n“It sounds like you have some perfectionistic tendencies... On one hand, that drive can push you to achieve great things. On the other hand, it’s really exhausting and can make you avoid things.”\n\n### Address Procrastination\n“Try the motto, ‘Done is better than perfect.’ Starting something, even if you know it’s rough, gives you material to refine.”\n\n### Self-Compassion Practice\n“You likely speak to yourself very harshly when you’re not perfect. Try to cultivate a more compassionate inner voice. A good trick is to talk to yourself as if you were your best friend.”\n\n### Intervention Insight\nUse **Thought Challenging** to examine "shoulds".`
        },
        {
            id: 'green-life-transitions',
            title: 'Life Transitions',
            category: 'Green Zone',
            color: 'green',
            tags: ['transition', 'change', 'graduation', 'new job', 'anxiety', 'green'],
            content: `### Normalize Anxiety\n“Big changes – even positive ones – can be really unsettling. It’s totally normal to feel anxious or unsure when you’re entering a new phase of life. You’re basically stepping into the unknown.”\n\n### Use Old Skills in New Ways\n“Remember that even though the context is changing, you’re bringing all your accumulated skills and wisdom with you. Think about other transitions you’ve navigated in the past... What helped you then?”\n\n### Build a Support System\n“In times of change, leaning on support is key. Stay connected with your old friends/colleagues even as you make new ones. Talk to people who’ve been through similar transitions.”`
        },
        {
            id: 'green-healthy-habits',
            title: 'Building Healthy Habits & Routines',
            category: 'Green Zone',
            color: 'green',
            tags: ['habits', 'routines', 'goals', 'motivation', 'green'],
            content: `### Praise Initiative\n“It’s fantastic that you want to build healthy habits. That’s a big step toward improving your day-to-day life. Habits and routines can really give you a sense of stability and make those positive actions almost automatic.”\n\n### Start Small\n“Instead of aiming for 30 minutes of meditation, what if you started with just one deep breath after you sit down at your desk? The goal is to make it so easy you can’t say no.”\n\n### Accountability\n“It can really help to track your habits – like a habit journal or an app where you tick off each day you did the behavior. Seeing a streak can be motivating (you won’t want to break the chain!).”`
        },
    ];

    const interventionsData = [
        {
            id: 'intervention-tipp',
            title: 'TIPP Skill for Rapid Distress Reduction',
            category: 'Intervention',
            color: 'blue',
            tags: ['dbt', 'distress tolerance', 'regulation', 'panic', 'overwhelm'],
            content: `### Core Rationale\nTIPP skills directly target the body's acute stress response, changing your body chemistry and creating a window to re-engage your thinking brain.\n\n### T - Temperature\n"First, let's try to change your body temperature. The idea is to create a sudden shift. If you can, go splash some cold water on your face - really let it cover your cheeks and the area under your eyes. This can help slow your heart rate down very quickly when you're agitated."\n\n### I - Intense Exercise\n"If you're feeling a lot of restless, built-up energy, a very short burst of exercise can help. Could you do some jumping jacks, run in place as fast as you can, or even just tense and release all your big muscle groups very hard and fast?"\n\n### P - Paced Breathing\n"Now, let's focus on slowing your breath. We're going to make your exhale longer than your inhale. Try breathing in deeply through your nose for 4 seconds, and then breathe out very slowly and gently through your mouth for 6 seconds."\n\n### P - Paired Muscle Relaxation\n"As you continue breathing slowly, when you breathe in, tense a group of muscles. Let's try that with your hands and arms; inhale through your nose, make tight fists. Hold that tension. Now as you exhale, slowly release the squeeze. Notice the difference."`
        },
        {
            id: 'intervention-accepts',
            title: 'ACCEPTS: For Distress Tolerance (Distraction)',
            category: 'Intervention',
            color: 'blue',
            tags: ['dbt', 'distress tolerance', 'distraction', 'coping'],
            content: `### Core Rationale\nAn acronym for skills used to tolerate and survive moments of high distress without making things worse, especially when you can't solve the problem right now.\n\n* **A**ctivities: Do something that is healthy and absorbing.\n* **C**ontributing: Do something helpful or kind for someone else.\n* **C**omparisons: Compare yourself to a time you felt worse, or to others struggling.\n* **E**motions: Generate different emotions by watching a comedy, etc.\n* **P**ushing Away: Temporarily push away painful thoughts.\n* **T**houghts: Occupy your mind with other thoughts (counting, etc.).\n* **S**ensations: Use intense, non-harmful sensations to shift focus (cold shower, etc.).`
        },
        {
            id: 'intervention-radical-acceptance',
            title: 'Radical Acceptance',
            category: 'Intervention',
            color: 'blue',
            tags: ['dbt', 'acceptance', 'suffering', 'reality'],
            content: `### Core Rationale\nAccepting reality as it is, without judgment, approval, or bitterness. It is about letting go of the fight against what you cannot change to reduce suffering.\n\n### How to Practice\n1.  **Acknowledge Reality:** Notice when you are fighting reality ("This shouldn't be happening!").\n2.  **State the Facts:** Remind yourself, "This is what happened. I cannot change it."\n3.  **Accept with Body & Mind:** Allow yourself to feel the disappointment or sadness, without letting it turn into bitterness or anger at reality itself.\n4.  **Focus on What's Next:** Ask, "Given that this is the reality, what is the wise thing for me to do now?"`
        },
        {
            id: 'intervention-opposite-action',
            title: 'Opposite Action',
            category: 'Intervention',
            color: 'blue',
            tags: ['dbt', 'emotions', 'action urge', 'behavior change'],
            content: `### Core Rationale\nActing opposite to what an unhelpful emotion is urging you to do, especially when the emotion doesn't fit the facts or isn't helpful. This stops feeding the unhelpful emotion.\n\n### How to Practice\n1.  **Identify the Emotion:** What are you feeling? (e.g., Fear, Sadness, Anger).\n2.  **Identify the Action Urge:** What does this emotion make you want to do? (e.g., Avoid, Withdraw, Attack).\n3.  **Ask: Is this Emotion Justified/Helpful?** Does the intensity fit the facts? Will acting on this urge help you in the long run?\n4.  **Do the Opposite:** If the emotion is not justified or helpful, act opposite to the urge. (e.g., If you feel fear, approach. If you feel sad, get active. If you feel angry, gently avoid or be kind).`
        },
        {
            id: 'intervention-dear-man',
            title: 'DEAR MAN: For Interpersonal Effectiveness',
            category: 'Intervention',
            color: 'blue',
            tags: ['dbt', 'communication', 'assertiveness', 'boundaries', 'needs'],
            content: `### Core Rationale\nA structured way to ask for something you want or to say "no" effectively and assertively.\n\n### D - Describe\n"Just the facts. What is the specific, objective situation? (e.g., 'The last three times we planned to meet, you cancelled on the day.')"\n\n### E - Express\n"Clearly state your feelings using 'I-statements'. (e.g., 'I feel frustrated and a bit hurt when this happens.')"\n\n### A - Assert\n"Clearly state what you need or want. Be direct. (e.g., 'I would like us to find a way to make our plans more reliable...')"\n\n### R - Reinforce\n"Explain the positive outcome if your request is met. (e.g., 'It would help me feel more secure in our friendship...')"\n\n### M - (Stay) Mindful\n"Keep your focus on your goal. Avoid getting sidetracked."\n\n### A - Appear Confident\n"Use a confident tone and body language, even if you feel nervous."\n\n### N - Negotiate\n"Be willing to listen and find a workable compromise, but don't give up on your core need."`
        },
        {
            id: 'intervention-ifs-parts',
            title: 'Acknowledging an Emotional Part (IFS-Informed)',
            category: 'Intervention',
            color: 'blue',
            tags: ['ifs', 'parts work', 'internal family systems', 'self-compassion'],
            content: `### Core Rationale\nThe Internal Family Systems (IFS) model suggests our minds are made up of multiple "parts," each with its own feelings and roles. Recognizing these as "parts" helps create distance and allows for a compassionate, curious relationship with our inner world.\n\n### How to Practice\n1.  **Identify the Part:** "It sounds like there's a part of you that feels very [angry/scared]. Can we get curious about it?"\n2.  **Locate it in the Body:** "Where do you feel that part in your body?"\n3.  **Ask it Questions:** "What does this part want you to know? What is it afraid would happen if it didn't feel/act this way?"\n4.  **Offer Understanding:** "How do you (from your calm, compassionate self) feel towards this part? Can we offer it some understanding?"`
        },
        {
            id: 'intervention-somatic-anchors',
            title: 'Simple Somatic Anchors',
            category: 'Intervention',
            color: 'blue',
            tags: ['somatic', 'grounding', 'body', 'anxiety', 'dissociation'],
            content: `### Core Rationale\nImmediate ways to connect with the present moment using bodily sensations. These anchors signal safety to the nervous system and pull your attention out of overwhelming internal states.\n\n* **Noticing Feet on Floor:** "Just bring your attention down to your feet. Can you feel them on the floor? Notice the sensation of contact."\n* **Butterfly Tapping:** "Cross your arms over your chest, with hands on opposite shoulders. Start gently tapping your hands, one after the other, in a slow, rhythmic way."\n* **Hand on Heart:** "If it feels comfortable, you might try placing a hand gently on your heart. Just notice the warmth and gentle pressure."\n* **Pressing Fingertips Together:** "Try gently pressing the tips of your fingers on one hand against the tips of your fingers on the other. Just notice the sensation."`
        },
        {
            id: 'intervention-54321',
            title: 'Grounding Through Senses (5-4-3-2-1 Technique)',
            category: 'Intervention',
            color: 'blue',
            tags: ['grounding', 'anxiety', 'panic', 'senses', 'mindfulness'],
            content: `### Core Rationale\nAnchoring in the present by noticing things through all five senses. This pulls your focus out of anxious thoughts and into your immediate, safe environment.\n\n### How to Practice\n"Let’s walk through your senses to ground you in the here and now."\n\n* **5 THINGS YOU CAN SEE:** Look around and name five things you see. (e.g., "I see a lamp, a blue pen, a window...")\n* **4 THINGS YOU CAN FEEL:** Notice four things you can feel with your body. (e.g., "I feel the chair under me, my feet on the floor...")\n* **3 THINGS YOU CAN HEAR:** Listen carefully and name three sounds. (e.g., "I hear the fan, a car outside...")\n* **2 THINGS YOU CAN SMELL:** Notice two scents. (e.g., "I can smell coffee, the soap on my hands...")\n* **1 THING YOU CAN TASTE:** Name one thing you can taste. (e.g., "I can taste my toothpaste," or just notice the taste in your mouth).`
        },
        {
            id: 'intervention-act-defusion',
            title: 'ACT Defusion: Distancing from Thoughts',
            category: 'Intervention',
            color: 'blue',
            tags: ['act', 'defusion', 'thoughts', 'mindfulness', 'acceptance'],
            content: `### Core Rationale\nTechniques from Acceptance and Commitment Therapy (ACT) to change the way we relate to thoughts, rather than changing their content, to reduce their power and believability.\n\n* **"I'm having the thought that..."**: "When a difficult thought gets sticky, try adding this phrase at the beginning: 'I'm having the thought that...' So, 'I'm a failure' becomes, 'I'm having the thought that I'm a failure.' Notice if that creates any space."\n* **Thanking Your Mind**: "Acknowledge the thought and then gently thank your mind for offering it up. 'Thanks, mind, for that really interesting thought!'"\n* **Silly Voice / Singing the Thought**: "Try taking a powerful negative thought and saying it repeatedly in a silly voice, or singing it to the tune of 'Happy Birthday,' to strip away its seriousness."`
        },
        {
            id: 'intervention-values-clarification',
            title: 'Values Clarification & Committed Action',
            category: 'Intervention',
            color: 'blue',
            tags: ['act', 'values', 'purpose', 'motivation', 'goals'],
            content: `### Core Rationale\nIdentifying core values and exploring small, concrete actions aligned with those values, even when difficult thoughts and feelings are present.\n\n### How to Practice\n1.  **Explore Values:** "When you think about the kind of person you want to be, what qualities are most important? (e.g., Kindness, Courage, Connection, Growth)." \n2.  **Brainstorm Committed Actions:** "Even with all the challenges, what's one small step you could take this week that would move you even 1% closer to living by that value of [Chosen Value]?"\n3.  **Set an Intention:** "Would you be willing to commit to taking that one small step this week?"`
        },
        {
            id: 'intervention-thought-challenging',
            title: 'Thought Challenging (Cognitive Restructuring)',
            category: 'Intervention',
            color: 'blue',
            tags: ['cbt', 'thoughts', 'reframing', 'cognitive distortions'],
            content: `### Core Rationale\nExamining the evidence for and against automatic negative thoughts and considering alternative, more balanced perspectives.\n\n### How to Practice\n1.  **Identify the Hot Thought:** "When you felt that strong emotion, what specific thought was going through your mind?"\n2.  **Examine the Evidence For:** "What evidence or experiences make you believe this thought is true?"\n3.  **Examine the Evidence Against:** "Now, let's play detective. What evidence suggests this thought isn't 100% true?"\n4.  **Consider Alternatives:** "If that thought isn't completely true, what's a more balanced or alternative way to think about this situation?"\n5.  **Assess the Impact:** "How does believing the hot thought affect you? How would believing the balanced thought change things?"`
        },
        {
            id: 'intervention-sfbt-miracle-question',
            title: 'SFBT: The Miracle Question',
            category: 'Intervention',
            color: 'blue',
            tags: ['sfbt', 'solution focused', 'hope', 'goals', 'future'],
            content: `### Core Rationale\nA future-focused question from Solution-Focused Brief Therapy (SFBT) that helps clients describe their desired future in detail, bypassing problem-talk.\n\n### How to Ask\n"Let's try a little thought experiment. Imagine tonight while you're asleep, a miracle happens, and the problem that brought you here is completely solved. But since you were asleep, you don't know it's solved."\n\n"When you wake up tomorrow morning, what would be the very first small thing you would notice that would tell you, 'Wow, something must have happened... the miracle must have occurred'?"\n\n"What would be different? What would you be doing? What would others notice about you?"`
        },
        {
            id: 'intervention-self-compassion-break',
            title: 'Self-Compassion Break (Kristin Neff)',
            category: 'Intervention',
            color: 'blue',
            tags: ['self-compassion', 'mindfulness', 'kindness', 'shame'],
            content: `### Core Rationale\nA brief, structured practice to offer oneself kindness in moments of suffering, based on three core components.\n\n### How to Practice\n1.  **Acknowledge the Pain (Mindfulness):** "Right now, it sounds like you're really going through a hard time. Can we just pause and acknowledge that? 'This is a moment of suffering,' or 'This really hurts.'"\n2.  **Connect to Common Humanity:** "Now, can you remind yourself that suffering and feeling this way is part of being human? 'I'm not alone in feeling this way.'"\n3.  **Offer Self-Kindness:** "And now, if you feel comfortable, maybe place a hand on your heart. Ask yourself, 'What do I need to hear right now?' Try saying something gentle, like 'May I be kind to myself.'"`
        },
        {
            id: 'intervention-circles-of-control',
            title: 'Circles of Control, Influence, and Concern',
            category: 'Intervention',
            color: 'blue',
            tags: ['control', 'anxiety', 'worry', 'problem solving', 'acceptance'],
            content: `### Core Rationale\nA visual tool to differentiate between what one can control, influence, or only be concerned about, helping to focus energy effectively.\n\n### How to Practice\n"Imagine three concentric circles."\n\n1.  **Inner Circle (Control):** "In the very middle, let's list the things you have direct control over. These are usually your own thoughts, attitudes, choices, actions, and responses."\n2.  **Middle Circle (Influence):** "In the next circle, let's put things you don't control, but you might be able to influence. This could be how others respond to you, or your relationships."\n3.  **Outer Circle (Concern/No Control):** "In the outermost circle, let's list the things that concern you but that you have little to no control over, like other people's choices, past events, or global issues."\n\n"Looking at this map, where are you spending most of your energy? What would it be like to shift more focus onto your Circle of Control?"`
        },
    ];

    const scriptsData = [
        {
            id: 'script-boundary-setting',
            title: 'Foundational Boundary Setting',
            category: 'Script',
            color: 'indigo',
            tags: ['boundaries', 'role setting', 'containment', 'scripts'],
            content: `### Standard Framing\n“Before we get started—my role isn’t for processing, but to make sure you’re safe and help get you grounded so you can rejoin group. We’ve got about 20 minutes, can you tell me what’s going on that brought you to reach out for support?”\n\n### For Clients Expecting Therapy\n“My role’s a bit different than a therapist’s—I’m not here to fully process, but I am here to check in on your safety and help you feel a little more steady before heading back to group. Want to tell me what’s weighing on you today?”\n\n### Quick Boundary Phrases\n* "I can’t go deep with you here, but I can help you feel safer and more grounded right now."\n* "Let’s slow it down together. I’m here to help steady things—not unpack everything."`
        },
        {
            id: 'script-stabilize',
            title: 'Stabilization Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['stabilize', 'grounding', 'containment', 'validation', 'scripts'],
            content: `### Validate & Contain\n“You’ve been dealing with a lot, and your mind and body are hitting a limit. That’s okay. There’s no rush to fix anything right now. We’re not trying to erase that heaviness — but to hold it in a way that feels manageable enough for this moment."\n\n### Slow Nervous System\n“Let’s take a moment to slow things down together. There’s no rush here and no pressure to fix anything. Let's try one slow breath together. Inhale and notice your lungs filling... hold it for a second... now exhale nice and slow."\n\n### Empower & Redirect\n“Your courage in acknowledging how intense this feels is really powerful. Remember, our goal isn’t to solve everything right now — it’s just to get you steady enough that you can leave here feeling a bit more centered.”`
        },
        {
            id: 'script-end-of-session',
            title: 'End-of-Session Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['end of session', 'survey', 'closure', 'scripts'],
            content: `### Survey\n“Before you go back to group, I do have a brief survey that I’m required to provide. It's very short, just a thumbs up or thumbs down. Do you see the link in the chat?”\n“Great! Let me know when you are done and then I will get you back into group.”\n\n### If Still Heavy\n"You’re still carrying a lot — I see that. We haven’t solved everything, and we’re not supposed to in these few minutes. I just want to make sure that what you’re feeling now is something you can handle for now. Does it feel safe enough for you to wrap up, even if it’s still heavy?"\n\n### If Still in Distress\n"I don’t want to send you back in this state. Why don’t we take another minute here? We can try another grounding technique or even get additional support if you need it. My priority is that you leave feeling safe enough. How are you feeling about continuing a bit longer until this eases?"`
        },
        {
            id: 'script-trauma-dumping-containment',
            title: 'Trauma-Dumping Containment Scripts',
            category: 'Script',
            color: 'indigo',
            tags: ['trauma', 'containment', 'boundaries', 'safety', 'scripts'],
            content: `### Mid-Session Redirect\n“I really hear that this is painful, and it makes sense that you’d want to process it. But because we only have a few minutes and I’m not in the role of a therapist, I want to be careful we don’t go too deep here and leave you feeling more overwhelmed.”\n\n### Gentle Wall for Immediate Flooding\n“I know it can feel urgent to get it all out, but my role is to support you in feeling safe—not to unpack everything. If we open something deep in this short space, there’s a chance you’ll end up carrying it alone after we disconnect—and I want to avoid that.”\n\n### Emergency Stop – Already Flooded\n“You’ve shared something really heavy, and I can tell this matters. But we’re in a short space right now, and going deeper might actually make things harder for you when I have to end the session. Let’s focus on helping you stabilize.”`
        },
    ];


    // ---- STATE AND DATA ----
    const state = {
        favorites: [],
        checkedScenarios: [],
        recentlyViewed: [],
        contentMap: new Map(),
        currentView: 'dashboard',
        currentOpenScenario: null,
        scratchpadContent: '',
        scratchpadMode: 'write', 
    };

    const colorMap = {
        red: { border: "border-l-4 border-red-500", bg: "bg-red-50 dark:bg-red-900/20" },
        orange: { border: "border-l-4 border-orange-500", bg: "bg-orange-50 dark:bg-orange-900/20" },
        yellow: { border: "border-l-4 border-yellow-500", bg: "bg-yellow-50 dark:bg-yellow-900/20" },
        green: { border: "border-l-4 border-green-500", bg: "bg-green-50 dark:bg-green-900/20" },
        blue: { border: "border-l-4 border-blue-500", bg: "bg-blue-50 dark:bg-blue-900/20" },
        indigo: { border: "border-l-4 border-indigo-500", bg: "bg-indigo-50 dark:bg-indigo-900/20" },
    };

    // ---- DOM REFERENCES ----
    const dom = {
        contentArea: document.getElementById('content-area'),
        searchBox: document.getElementById('search-box'),
        toast: document.getElementById('toast'),
        scenarioModal: document.getElementById('scenario-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalBody: document.getElementById('modal-body'),
        closeModal: document.getElementById('close-modal'),
        usedThisSession: document.getElementById('used-this-session'),
        themeToggle: document.getElementById('theme-toggle'),
        copyModalContentBtn: document.getElementById('copy-modal-content-to-scratchpad'),
        confirmationModal: document.getElementById('confirmation-modal'),
        confirmationTitle: document.getElementById('confirmation-title'),
        confirmationMessage: document.getElementById('confirmation-message'),
        confirmationConfirm: document.getElementById('confirmation-confirm'),
        confirmationCancel: document.getElementById('confirmation-cancel'),
    };

    // ---- STATE PERSISTENCE ----
    function saveState() {
        localStorage.setItem('clinicalFavorites', JSON.stringify(state.favorites));
        localStorage.setItem('clinicalRecents', JSON.stringify(state.recentlyViewed));
        localStorage.setItem('clinicalScratchpad', state.scratchpadContent);
    }

    function loadState() {
        const savedFavorites = localStorage.getItem('clinicalFavorites');
        if (savedFavorites) state.favorites = JSON.parse(savedFavorites);
        const savedRecents = localStorage.getItem('clinicalRecents');
        if (savedRecents) state.recentlyViewed = JSON.parse(savedRecents);
        const savedScratchpad = localStorage.getItem('clinicalScratchpad');
        if (savedScratchpad !== null) state.scratchpadContent = savedScratchpad;
    }

    // ---- INITIALIZATION ----
    function initializeDataMap() {
        clinicalData.forEach(s => state.contentMap.set(s.id, s));
        interventionsData.forEach(s => state.contentMap.set(s.id, s));
        scriptsData.forEach(s => state.contentMap.set(s.id, s));
    }

    // ---- RENDERING ----
    function createScenarioCard(scenario) {
        const isFavorite = state.favorites.includes(scenario.id);
        const colors = colorMap[scenario.color] || colorMap.indigo;
        return `
        <div class="scenario-card bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 flex flex-col ${colors.border}">
            <div class="p-4 flex-1 flex flex-col">
                <h3 class="font-bold text-gray-800 dark:text-gray-100 flex-1">${scenario.title}</h3>
                <div class="mt-3 flex justify-between items-center">
                    <button class="view-btn text-sm text-indigo-600 dark:text-indigo-400 hover:underline" data-id="${scenario.id}">View Details</button>
                    <button class="favorite-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" data-id="${scenario.id}" title="Add to favorites">
                        <i data-lucide="star" class="w-5 h-5 ${isFavorite ? 'text-yellow-500 fill-current' : 'text-gray-400'}"></i>
                    </button>
                </div>
            </div>
        </div>
        `;
    }

    function renderCardList(container, items, message) {
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
        if (items.length === 0) {
            container.innerHTML = `<div class="col-span-full text-center text-gray-500 py-12">${message}</div>`;
            return;
        }
        container.innerHTML = items.map(createScenarioCard).join('');
        lucide.createIcons();
    }

    function renderDashboard() {
        dom.contentArea.className = '';
        const zones = ['Red Zone', 'Orange Zone', 'Yellow Zone', 'Green Zone'];
        let dashboardHtml = '';

        zones.forEach(zone => {
            const itemsInZone = clinicalData.filter(item => item.category === zone);
            if (itemsInZone.length > 0) {
                const zoneColor = itemsInZone[0].color;
                dashboardHtml += `
                    <div class="mb-10">
                        <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-${zoneColor}-500 text-${zoneColor}-600 dark:text-${zoneColor}-400">${zone}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${itemsInZone.map(createScenarioCard).join('')}
                        </div>
                    </div>
                `;
            }
        });

        dom.contentArea.innerHTML = dashboardHtml;
        lucide.createIcons();
    }

    function renderUsedThisSession() {
        // This function can be expanded later if needed
    }

    function openModal(scenarioId) {
        const scenario = state.contentMap.get(scenarioId);
        if (!scenario) return;

        state.currentOpenScenario = scenario;
        dom.modalTitle.textContent = scenario.title;
        dom.modalBody.innerHTML = marked.parse(scenario.content);
        dom.scenarioModal.classList.remove('hidden');
        
        // Add to recently viewed
        if (!state.recentlyViewed.includes(scenarioId)) {
            state.recentlyViewed.unshift(scenarioId);
            state.recentlyViewed = state.recentlyViewed.slice(0, 20);
            saveState();
            if (state.currentView === 'recents') {
                 switchView('recents'); 
            }
        }
    }

    function renderScratchpad() {
        dom.contentArea.className = '';
        dom.contentArea.innerHTML = `
        <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <div class="flex items-center mb-4">
                <i data-lucide="edit-3" class="w-5 h-5 text-teal-500 mr-2"></i>
                <h2 class="text-xl font-bold flex-1">Scratchpad</h2>
                <div class="flex items-center gap-2">
                    <button id="toggle-scratchpad-mode" class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">
                        ${state.scratchpadMode === 'write' ? 'Preview' : 'Edit'}
                    </button>
                    <button id="clear-scratchpad" class="text-sm text-red-500 hover:underline">Clear</button>
                </div>
            </div>
            <div id="scratchpad-write-area" class="${state.scratchpadMode === 'write' ? '' : 'hidden'}">
                <textarea id="scratchpad-textarea"
                    class="w-full p-4 border border-gray-300 dark:bg-gray-700 dark:border-gray-600 rounded-lg scratchpad-resize text-sm font-mono focus:ring-2 focus:ring-teal-500 focus:outline-none"
                    rows="12"
                    placeholder="Type notes, scripts, or plans here... (Markdown supported)">${state.scratchpadContent || ''}</textarea>
                <div class="flex mt-3 gap-2">
                    <button id="copy-scratchpad" class="flex items-center text-xs px-3 py-1 bg-indigo-100 dark:bg-indigo-900 rounded-md text-indigo-700 dark:text-indigo-200 hover:bg-indigo-200 dark:hover:bg-indigo-800">
                        <i data-lucide="copy" class="w-4 h-4 mr-1"></i>Copy
                    </button>
                    <button id="download-scratchpad" class="flex items-center text-xs px-3 py-1 bg-green-100 dark:bg-green-900 rounded-md text-green-700 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800">
                        <i data-lucide="download" class="w-4 h-4 mr-1"></i>Download
                    </button>
                </div>
            </div>
            <div id="scratchpad-preview-area" class="prose dark:prose-invert max-w-none ${state.scratchpadMode === 'preview' ? '' : 'hidden'} p-4 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg min-h-[12rem] bg-gray-50 dark:bg-gray-900/50">
                ${marked.parse(state.scratchpadContent || '_Nothing here yet. Type in Edit mode!_')}
            </div>
        </div>
        `;
        lucide.createIcons();

        // Re-attach events for scratchpad
        document.getElementById('toggle-scratchpad-mode')?.addEventListener('click', () => {
            state.scratchpadMode = (state.scratchpadMode === 'write') ? 'preview' : 'write';
            renderScratchpad();
        });
        document.getElementById('clear-scratchpad')?.addEventListener('click', () => {
            showConfirmationModal('Clear all notes in your scratchpad?', 'This action cannot be undone.', () => {
                state.scratchpadContent = '';
                saveState();
                renderScratchpad();
                showToast('Scratchpad cleared.', 'success');
            });
        });
        document.getElementById('scratchpad-textarea')?.addEventListener('input', (e) => {
            state.scratchpadContent = e.target.value;
            saveState();
        });
        document.getElementById('copy-scratchpad')?.addEventListener('click', () => copyToClipboard(state.scratchpadContent));
        document.getElementById('download-scratchpad')?.addEventListener('click', downloadScratchpad);
    }

    // ---- TABS & VIEWS ----
    function switchView(viewId) {
        state.currentView = viewId;
        document.querySelectorAll('.sidebar-link').forEach(link => {
            const isSelected = link.dataset.tab === viewId;
            const isScratchpad = viewId === 'scratchpad';
            
            link.classList.toggle('bg-indigo-100', isSelected && !isScratchpad);
            link.classList.toggle('dark:bg-indigo-800', isSelected && !isScratchpad);
            link.classList.toggle('bg-teal-100', isSelected && isScratchpad);
            link.classList.toggle('dark:bg-teal-900', isSelected && isScratchpad);
            link.classList.toggle('text-indigo-700', isSelected && !isScratchpad);
            link.classList.toggle('dark:text-indigo-200', isSelected && !isScratchpad);
            link.classList.toggle('text-teal-700', isSelected && isScratchpad);
            link.classList.toggle('dark:text-teal-200', isSelected && isScratchpad);
            link.classList.toggle('font-semibold', isSelected);
        });

        renderUsedThisSession();
        dom.searchBox.value = ''; // Clear search on tab switch

        if (viewId === 'dashboard') {
            renderDashboard();
            return;
        } else if (viewId === 'scratchpad') {
            renderScratchpad();
            return;
        }

        let items = [];
        let message = 'No items found.';
        if (viewId === 'favorites') {
            items = state.favorites.map(id => state.contentMap.get(id)).filter(Boolean);
            message = 'No favorites yet. Click the star on a card to add one.';
        } else if (viewId === 'recents') {
            items = state.recentlyViewed.map(id => state.contentMap.get(id)).filter(Boolean);
            message = 'No recently viewed items.';
        } else if (viewId === 'interventions') {
            items = Array.from(state.contentMap.values()).filter(item => item.category === 'Intervention');
            message = 'No interventions found.';
        } else if (viewId === 'scripts') {
            items = Array.from(state.contentMap.values()).filter(item => item.category === 'Script');
            message = 'No scripts found.';
        }
        renderCardList(dom.contentArea, items, message);
    }

    // ---- EVENT HANDLERS & LOGIC ----
    function handleContentInteraction(e) {
        const target = e.target;
        if (target.closest('.view-btn')) {
            openModal(target.closest('.view-btn').dataset.id);
        }
        if (target.closest('.favorite-btn')) {
            const id = target.closest('.favorite-btn').dataset.id;
            const isFavorite = state.favorites.includes(id);
            if (isFavorite) {
                state.favorites = state.favorites.filter(favId => favId !== id);
                showToast('Removed from favorites', 'info');
            } else {
                state.favorites.push(id);
                showToast('Added to favorites!', 'success');
            }
            saveState();
            // Re-render current view to reflect favorite change
            switchView(state.currentView);
        }
    }

    dom.searchBox?.addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase().trim();
        if (state.currentView === 'scratchpad') return;

        if (!q) {
            switchView(state.currentView);
            return;
        }
        
        const filtered = Array.from(state.contentMap.values()).filter(
            item =>
                item.title.toLowerCase().includes(q) ||
                (item.content && item.content.toLowerCase().includes(q)) ||
                (item.tags && item.tags.some(tag => tag.toLowerCase().includes(q)))
        );
        renderCardList(dom.contentArea, filtered, 'No matches found for your search.');
    });

    // ---- UTILITIES ----
    function showToast(message, type = 'info') { // types: success, info, error
        const colors = {
            success: 'bg-green-500',
            info: 'bg-gray-600 dark:bg-gray-700',
            error: 'bg-red-500'
        };
        dom.toast.textContent = message;
        dom.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${colors[type]}`;
        dom.toast.classList.remove('hidden');
        dom.toast.classList.add('opacity-100');
        setTimeout(() => { dom.toast.classList.remove('opacity-100'); }, 2700);
        setTimeout(() => { dom.toast.classList.add('hidden'); }, 3000);
    }

    function copyToClipboard(text) {
        // Basic Markdown to plain text conversion
        const plainText = text
            .replace(/###\s/g, '')
            .replace(/##\s/g, '')
            .replace(/#\s/g, '')
            .replace(/\*\*/g, '')
            .replace(/\*/g, '')
            .replace(/>\s/g, '');

        const textArea = document.createElement('textarea');
        textArea.value = plainText;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showToast("Copied to clipboard!", 'success');
        } catch (err) {
            showToast("Failed to copy.", 'error');
        }
        document.body.removeChild(textArea);
    }
    
    function downloadScratchpad() {
        const blob = new Blob([state.scratchpadContent], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'scratchpad.md';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        showToast('Scratchpad downloaded.', 'success');
    }
    
    function showConfirmationModal(title, message, onConfirm) {
        dom.confirmationTitle.textContent = title;
        dom.confirmationMessage.textContent = message;
        dom.confirmationModal.classList.remove('hidden');
        
        const confirmHandler = () => {
            onConfirm();
            hideConfirmationModal();
        };
        
        const cancelHandler = () => {
            hideConfirmationModal();
        };

        const hideConfirmationModal = () => {
            dom.confirmationModal.classList.add('hidden');
            dom.confirmationConfirm.removeEventListener('click', confirmHandler);
            dom.confirmationCancel.removeEventListener('click', cancelHandler);
        };
        
        dom.confirmationConfirm.addEventListener('click', confirmHandler);
        dom.confirmationCancel.addEventListener('click', cancelHandler);
    }


    // ---- THEME ----
    function applyTheme(isDark) {
        if (isDark) {
            document.documentElement.classList.add('dark');
            dom.themeToggle.innerHTML = '<i data-lucide="sun" class="w-5 h-5"></i>';
        } else {
            document.documentElement.classList.remove('dark');
            dom.themeToggle.innerHTML = '<i data-lucide="moon" class="w-5 h-5"></i>';
        }
        lucide.createIcons();
    }

    // ---- MAIN INITIALIZATION ----
    function main() {
        loadState();
        initializeDataMap();

        // Event listeners
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => switchView(link.dataset.tab));
        });
        dom.contentArea.addEventListener('click', handleContentInteraction);
        dom.closeModal.addEventListener('click', () => dom.scenarioModal.classList.add('hidden'));
        dom.themeToggle?.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            applyTheme(isDarkMode);
        });
        dom.copyModalContentBtn.addEventListener('click', () => {
            if (state.currentOpenScenario) {
                const contentToCopy = `### ${state.currentOpenScenario.title}\n\n${state.currentOpenScenario.content}`;
                state.scratchpadContent += (state.scratchpadContent ? '\n\n---\n\n' : '') + contentToCopy;
                saveState();
                showToast('Copied to scratchpad!', 'success');
                if (state.currentView === 'scratchpad') {
                    renderScratchpad(); // Refresh if on scratchpad view
                }
            }
        });

        // Initial theme setup
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme === 'dark' || (savedTheme === null && prefersDark));

        // Initial view
        switchView(state.currentView || 'dashboard');
        renderUsedThisSession();
        lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
